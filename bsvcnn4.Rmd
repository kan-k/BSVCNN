---
title: "bsvcnn3"
output: html_document
---

Use a new (smaller) mask `/well/nichols/users/kfh142/data/Atlas/CIC/MultRes` namely `CICatlas_Res3_2mm.nii.gz`

```{r}
temp.img <-oro.nifti::readNIfTI('/well/nichols/users/kfh142/data/Atlas/CIC/MultRes/CICatlas_Res3_2mm.nii.gz')
length(unique(c(temp.img))) #number of region
```
Take `Res3` where `HO-combined-fin.nii.gz` is non-zero

```{r}
mask.com<-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bsvcnn/pile/HO-combined-fin.nii.gz')

temp.img[mask.com==0] <- 0
temp.img@datatype = 2
temp.img@bitpix = 8
writeNIfTI(temp.img,paste0('/well/nichols/users/qcv214/bnn2/res3/res3mask'))
```
Then only keep GM using `CICatlas_Res3_trunc.txt`.


In fact let's not threshold by `HO-combined-fin.nii.gz`

`CICatlas_Res3_trunc.txt ` says everything above label 12 is not GM, then threshold at 0.1, so 
```{r}
temp.img <-oro.nifti::readNIfTI('/well/nichols/users/kfh142/data/Atlas/CIC/MultRes/CICatlas_Res3_2mm.nii.gz')
#Take only grey matter
temp.img[temp.img>12] <- 0
temp.img@datatype = 2
temp.img@bitpix = 8
writeNIfTI(temp.img,paste0('/well/nichols/users/qcv214/bnn2/res3/res3mask'))
#Load data with new unthreshold mask
part_list<-read.table('/well/nichols/users/qcv214/Placement_2/participant_list.txt', header = FALSE, sep = "", dec = ".") #4529 participants
part_list$exist_vbm <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_list[,1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz'))
part_use<-part_list[part_list$exist_vbm==1,] #4263 participants left
list_of_all_images<-paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_use[1:(dim(part_use)[1]),1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz')
res3.dat <- fast_read_imgs_mask(list_of_all_images,'/well/nichols/users/qcv214/bnn2/res3/res3mask') 
#threshold at 0.1
dat_colmeans<-colMeans(res3.dat)
temp.img[temp.img>1][dat_colmeans<0.1] <- 0 
temp.img@datatype = 2
temp.img@bitpix = 8
writeNIfTI(temp.img,'/well/nichols/users/qcv214/bnn2/res3/res3mask')
#Load data again using the new thresholded mask
res3.dat <- fast_read_imgs_mask(list_of_all_images,'/well/nichols/users/qcv214/bnn2/res3/res3mask') # 4263 x 163375
#save datat
write_feather(as.data.frame(res3.dat), '/well/nichols/users/qcv214/bnn2/res3/res3_dat.feather')
#reload data and mask
res3.dat <- read_feather('/well/nichols/users/qcv214/bnn2/res3/res3_dat.feather') #dim = 4263 124859
res3.mask <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/res3mask.nii.gz')
res3.mask.reg <- setdiff(sort(unique(c(res3.mask))),0)
```

##Create mask ROI
Don't RUN
```{r}
#Don't RUN
res3.mask.reg <- sort(unique(c(res3.mask)))
for(i in res3.mask.reg){
  temp.img <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/res3mask.nii.gz')
  temp.img <- temp.img == i 
  temp.img@datatype = 2
  temp.img@bitpix = 8
  writeNIfTI(temp.img,paste0('/well/nichols/users/qcv214/bnn2/res3/roi/mask_ROI_',i))
  temp.dat <- fast_read_imgs_mask(list_of_all_images,paste0('/well/nichols/users/qcv214/bnn2/res3/roi/mask_ROI_',i)) # 4263 x 163375
  write_feather(as.data.frame(temp.dat), paste0('/well/nichols/users/qcv214/bnn2/res3/roi/dat_ROI_',i))
}
```

Create `rearranged data`
```{r}
#dat.temp <- matrix(nrow = nrow(res3.dat),ncol = sum(res3.mask>0))
dat.temp <- matrix(nrow = nrow(res3.dat),ncol = 1)
  cum.length <- 0
for(i in res3.mask.reg){
  roi.reg<- read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/roi/dat_ROI_",i,'.feather'))
  print(dim(roi.reg))
  cum.length <- cum.length + ncol(roi.reg)
  print(cum.length)
  roi.reg<- as.matrix(roi.reg)
  dat.temp <- cbind(dat.temp, roi.reg)
}
colnames(dat.temp) <- NULL
dat.temp <- as.data.frame(dat.temp[,-1])
dat.temp <- as.matrix(dat.temp)
write_feather(as.data.frame(dat.temp), '/well/nichols/users/qcv214/bnn2/res3/dat_rearranged.feather')
```

Try loading partial gp from `partial_gp.R`
```{r}
  poly_degree = 10
  a_concentration = 0.5
  b_smoothness = 40
test.partial.gp <- read_feather("/well/nichols/users/qcv214/bnn2/res3/roi/partial_gp_1_fixed_100.540.feather")
```


#7 Mar
Save age to a file
```{r}
part_list<-read.table('/well/nichols/users/qcv214/Placement_2/participant_list.txt', header = FALSE, sep = "", dec = ".") #4529 participants
part_list$exist_vbm <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_list[,1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz'))
part_use<-part_list[part_list$exist_vbm==1,] #4263 participants left
# 
agetab<-read.table(file = '/well/nichols/projects/UKB/SMS/ukb_latest-Age.tsv', sep = '\t', header = TRUE)
age_tab<-as.data.frame(matrix(,nrow = length(part_use$V1),ncol = 2)) #id, age, number of masked voxels
colnames(age_tab)[1:2]<-c('id','age')
age_tab$id<-part_use$V1
for(i in 1:length(part_use$V1)){
  age_tab$age[i]<-agetab$X21003.2.0[agetab$eid_8107==sub(".", "",age_tab$id[i])]
}
write_feather(age_tab, '/well/nichols/users/qcv214/bnn2/res3/age.feather')
```

#8 Mar
Load data from `nn_lr.R`
```{r}
num.batch <- 4
epoch <- 10

lr_vec <- c(1,10^-(5:11)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,8,num.batch*epoch )) 
for( i in lr_vec){  
  res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_loss_",i,".csv")))
}
```
Plot training rmse
```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))))
# lines(sqrt(res.nn.loss[1,2,]),type=line.type,col = 2)
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 3)
# lines(sqrt(res.nn.loss[1,4,]),type=line.type,col = 4)
lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 5)
# lines(sqrt(res.nn.loss[1,6,]),type=line.type,col = 6)
lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 7)
# lines(sqrt(res.nn.loss[1,8,]),type=line.type,col = 8)

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))))
# lines(sqrt(res.nn.loss[2,2,]),type=line.type,col = 2)
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 3)
# lines(sqrt(res.nn.loss[2,4,]),type=line.type,col = 4)
lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 5)
# lines(sqrt(res.nn.loss[2,6,]),type=line.type,col = 6)
lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 7)
# lines(sqrt(res.nn.loss[2,8,]),type=line.type,col = 8)
```



plot some
```{r}
line.type <- 'b'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE")
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:10,lwd=0.2)

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE")
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:10,lwd=0.2)

legend('bottomright',legend = c('learning_rate','1e-4','1e-6','1e-8','1e-10'), pch = 1,col=c("white",1,3,10,12))
```
14 Mar

Get the weights
```{r}
num.batch <- 4
epoch <- 10

#Get the best performance
w.1e10 <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_weights_",10^-10,".feather")))
```

```{r}
plot(density(w.1e10[1,]))
# lines(density(w.1e10[2,]))
# lines(density(w.1e10[3,]))
for(i in 1:12){
  qqnorm(w.1e10[i,])
  #abline(a=0,b=1, col = 'red')
  qqline(w.1e10[i,])
}
```




#21 Mar
Load data from `nn_lr3.R`
```{r}
num.batch <- 4
epoch <- 30

failed_run <- c(5,7,9,10)
lr_vec <- c(10^- setdiff((1:11),failed_run)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,11,num.batch*epoch )) 
for( i in lr_vec){  
  res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn3_loss_",i,".csv")))
}

res.nn.loss <- res.nn.loss[, 1:length(lr_vec),]

```
```{r}
line.type <- 'b'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE")
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:10,lwd=0.2)

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE")
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:10,lwd=0.2)

legend('bottomright',legend = c('learning_rate','1e-01','1e-3','1e-6','1e-8'), pch = 1,col=c("white",1,3,10,12))
```
Get the weights
```{r}
num.batch <- 4
epoch <- 30
#Get the best performance
w.1e10 <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn3_weights_",10^-1,".feather")))
```

```{r}
plot(density(w.1e10[1,]))
# lines(density(w.1e10[2,]))
# lines(density(w.1e10[3,]))
for(i in 1:12){
  qqnorm(w.1e10[i,])
  #abline(a=0,b=1, col = 'red')
  qqline(w.1e10[i,])
}
```


#22 Mar
Load data from `nn_lr4.R`
```{r}
num.batch <- 4
epoch <- 30

failed_run <- c(4,5,9)
lr_vec <- c(10^(-1)*setdiff((1:9),failed_run)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,9,num.batch*epoch )) 
for( i in lr_vec){  
  res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn4_loss_",i,".csv")))
}
res.nn.loss <- res.nn.loss[, 1:length(lr_vec),]
```
```{r}
line.type <- 'b'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 10,lwd=2)
#lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('learning_rate','0.1','0.3','0.7'), pch = 1,col=c("white",1,3,10))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 10,lwd=2)
#lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

legend('topright',legend = c('learning_rate','0.1','0.3','0.7'), pch = 1,col=c("white",1,3,10))
```
Get theta
```{r}
num.batch <- 4
epoch <- 30
#Get the best performance
w.1e10 <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn4_theta_",0.3,".feather")))
plot(density(w.1e10[1,]))
# lines(density(w.1e10[2,]))
# lines(density(w.1e10[3,]))
for(i in 1:12){
  qqnorm(w.1e10[i,], main = paste0("Normal Q-Q Plot of Region #",i))
  #abline(a=0,b=1, col = 'red')
  qqline(w.1e10[i,])
}
```


Load data from `nn_lr5.R`

40 iterations in 2hrs and 20 mins
```{r}
num.batch <- 4
epoch <- 40

failed_run <- c(5,9)
lr_vec <- c(10^(-1)*setdiff((1:9),failed_run)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,9,num.batch*epoch )) 
for( i in lr_vec){  
  res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn5_loss_",i,".csv")))
}
res.nn.loss <- res.nn.loss[, 1:length(lr_vec),]
```
```{r}
line.type <- 'b'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 10,lwd=2)
#lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('learning_rate','0.2','0.4','0.7'), pch = 1,col=c("white",1,3,10))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 10,lwd=2)
#lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

legend('topright',legend = c('learning_rate','0.1','0.3','0.6'), pch = 1,col=c("white",1,3,10))
```
Get theta
```{r}
#Get the best performance
w.1e10 <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn5_theta_",0.6,".feather")))
plot(density(w.1e10[1,]))
# lines(density(w.1e10[2,]))
# lines(density(w.1e10[3,]))
for(i in 1:12){
  qqnorm(w.1e10[i,], main = paste0("Normal Q-Q Plot of Region #",i))
  #abline(a=0,b=1, col = 'red')
  qqline(w.1e10[i,])
}
```



#23 Mar
##Newton method
Load data from `nn_lr_nm1.R`
```{r}
num.batch <- 4
epoch <- 30
failed_run<-c()
res.nn.loss <- array(, dim = c(2,3,num.batch*epoch )) 
for( i in setdiff(2:4,failed_run)){  
  res.nn.loss[,which(i==2:4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_nm1_loss_jobid_",i,".csv")))
}

```
```{r}
line.type <- 'b'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,2,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 4,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('run','1','2'), pch = 1,col=c("white",1,3))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,2,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 4,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

legend('topright',legend = c('run','1','2'), pch = 1,col=c("white",1,3))

plot(sqrt(res.nn.loss[2,1,]),type=line.type,lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,2,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 4,lwd=2)
legend('bottomleft',legend = c('run','1','2'), pch = 1,col=c("white",1,3))


plot(sqrt(res.nn.loss[2,3,]),type=line.type,lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,1,]),type=line.type,col = 4,lwd=2)
legend('bottomleft',legend = c('run','1','2'), pch = 1,col=c("white",1,3))

```
It's not working.. and green line is kinda unpredictable 










#24 Mar
Load whole brain for benchmark from `whole_brain.R`
poly_degree = 10
a_concentration = 0.5
b_smoothness = 40
```{r}
poly_degree = 10
a_concentration = 0.5
b_smoothness = 40
wb_23mar<-array(,dim=c(50,3,14))
failed_run<-c()
for(i in setdiff(1:50,failed_run)){
      wb_23mar[i,,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/whole_brain",poly_degree,a_concentration,b_smoothness,"_",i,".csv")))
}
#bsvcnn.11feb.def<-bsvcnn.11feb.def[-failed_run,,]
wb_23mar.m<-apply(wb_23mar, c(2,3), median)
plot.box(wb_23mar)
wb_23mar.m[1,3]
```

```{r}
plot.box(wb_23mar)
```


#25 Mar and 27 mar
I think batch size too small 
##Adam
Load data from `nn_adam.R`
```{r}
num.batch <- 20
epoch <- 50

failed_run <- c()
lr_vec <- c(10^(-1)*setdiff((1:9),failed_run)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,9,num.batch*epoch )) 
for( i in lr_vec){
  # print(i)
  res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam1_loss_",i,".csv")))
}
res.nn.loss <- res.nn.loss[, 1:length(lr_vec),] #set range
```

```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
legend('topleft',legend = c('learning_rate',as.character(lr_vec[c(1,3,5,7)])), pch = 1,col=c("white",1,3,10,12))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

legend('topright',legend = c('learning_rate',as.character(lr_vec[c(1,3,5,7)])), pch = 1,col=c("white",1,3,10,12))
```
Get theta
```{r}
num.batch <- 4
epoch <- 20
#Get the best performance
w.1e10 <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam1_theta_",0.1,".feather")))
plot(density(w.1e10[4,]))
# lines(density(w.1e10[2,]))
# lines(density(w.1e10[3,]))
for(i in 1:12){
  qqnorm(w.1e10[i,], main = paste0("Normal Q-Q Plot of Region #",i))
  #abline(a=0,b=1, col = 'red')
  qqline(w.1e10[i,])
}
```

##Adam with de-coupled weights
Load data from `nn_adamW.R`

```{r}
num.batch <- 20
epoch <- 50

failed_run <- c(4,5)
lr_vec <- c(10^(-1)*setdiff((1:9),failed_run)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,9,num.batch*epoch )) 
for( i in lr_vec){  
  res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adamW1_loss_",i,".csv")))
}
res.nn.loss <- res.nn.loss[, 1:length(lr_vec),]
```

```{r}
line.type <- 'b'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('learning_rate','0.1','0.2','0.3'), pch = 1,col=c("white",1,3,10))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

legend('topright',legend = c('learning_rate','0.1','0.2','0.3'), pch = 1,col=c("white",1,3,10))
```
Get theta
```{r}
num.batch <- 4
epoch <- 10
#Get the best performance
w.1e10 <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adamW1_theta_",0.1,".feather")))
plot(density(w.1e10[1,]))
# lines(density(w.1e10[2,]))
# lines(density(w.1e10[3,]))
for(i in 1:12){
  qqnorm(w.1e10[i,], main = paste0("Normal Q-Q Plot of Region #",i))
  #abline(a=0,b=1, col = 'red')
  qqline(w.1e10[i,])
}
```


#28 Mar
##Adam
Load data from `nn_adam.R`
```{r}
num.batch <- 4
epoch <- 20

failed_run <- c(4,5,6,7)
lr_vec <- c(10^(-1)*setdiff((1:9),failed_run)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,9,num.batch*epoch )) 
for( i in lr_vec){
   print(i)
  print(which(i==lr_vec))
  if(i == 1){res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam3_loss_",i,".csv")))}
  else{res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam2_loss_",i,".csv")))[,1:80]}
}
res.nn.loss <- res.nn.loss[, 1:length(lr_vec),] #set range
```
```{r}
num.batch <- 4
epoch <- 20

failed_run <- c(4,5,6,7)
lr_vec <- c(10^(-1)*setdiff((1:9),failed_run)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,9,num.batch*epoch )) 
res.nn.loss[,1,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam3_loss_",0.1,".csv")))
for( i in lr_vec){
   print(i)
  print(which(i==lr_vec))
res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam2_loss_",i,".csv")))[,1:80]
}
res.nn.loss <- res.nn.loss[, 1:length(lr_vec),] #set range
```

```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('learning_rate',as.character(lr_vec[c(1,3,5)])), pch = 1,col=c("white",1,3,10))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

legend('topright',legend = c('learning_rate',as.character(lr_vec[c(1,3,5)])), pch = 1,col=c("white",1,3,10))

plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")

res.nn.loss2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam3_loss_",0.1,".csv")))
plot(sqrt(res.nn.loss2[2,]),type=line.type, ylim = c(min(sqrt(res.nn.loss2[2,])), max(sqrt(res.nn.loss2[2,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
```
Get theta
```{r}
num.batch <- 4
epoch <- 20
#Get the best performance
w.1e10 <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam3_theta_",0.1,".feather")))
plot(density(w.1e10[7,]))
# lines(density(w.1e10[2,]))
# lines(density(w.1e10[3,]))
for(i in 1:12){
  qqnorm(w.1e10[i,], main = paste0("Normal Q-Q Plot of Region #",i))
  #abline(a=0,b=1, col = 'red')
  qqline(w.1e10[i,])
}
```


##AdamW
Load data from `nn_adamW.R`
```{r}
num.batch <- 4
epoch <- 30

failed_run <- c(3,5,7,8,9)
lr_vec <- c(10^(-1)*setdiff((1:9),failed_run)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,9,num.batch*epoch )) 
for( i in lr_vec){
   print(i)
  res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adamW2_loss_",i,".csv")))
}
res.nn.loss <- res.nn.loss[, 1:length(lr_vec),] #set range
```
```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,2,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,4,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('learning_rate',as.character(lr_vec[c(1,3,5)])), pch = 1,col=c("white",1,3,10))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,2,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,4,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

legend('topright',legend = c('learning_rate',as.character(lr_vec[c(1,2,4)])), pch = 1,col=c("white",1,3,10))
```
Get theta
```{r}
num.batch <- 4
epoch <- 30
#Get the best performance
w.1e10 <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adamW2_theta_",0.1,".feather")))
plot(density(w.1e10[4,]))
# lines(density(w.1e10[2,]))
# lines(density(w.1e10[3,]))
for(i in 1:12){
  qqnorm(w.1e10[i,], main = paste0("Normal Q-Q Plot of Region #",i))
  #abline(a=0,b=1, col = 'red')
  qqline(w.1e10[i,])
}
```


##Summmary so far
In the setting of 2,000 training, 2,000 testing with 500 batch size and 20 epochs
1.SGD with lr = 0.6 (originally had 40 epochs) `nn_lr5.R`
2.newton method jobid 2
3. Adam with lr = 0.1, too many hyperparameters to set 
4. Adam with weight decay with lr = 0.3
5. Adam with small batch (not working so well), lr = 0.1
6. [Benchmark] whole brain 
###Load all data 
```{r}
#SGD
res.nn.loss.sgd <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn5_loss_",0.6,".csv")))
#Newton
res.nn.loss.nm <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_nm1_loss_jobid_",4,".csv")))
#Adam
res.nn.loss.adam <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam3_loss_",0.1,".csv")))
#Adam with decoupled weight decay
res.nn.loss.adamw <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adamW2_loss_",0.3,".csv")))
#Adam with small batch
res.nn.loss.adam_s <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam1_loss_",0.1,".csv")))
```
###Load whole brain
```{r}
poly_degree = 10
a_concentration = 0.5
b_smoothness = 40
wb_23mar<-array(,dim=c(50,3,14))
failed_run<-c()
for(i in setdiff(1:50,failed_run)){
      wb_23mar[i,,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/whole_brain",poly_degree,a_concentration,b_smoothness,"_",i,".csv")))
}
wb_23mar.m<-apply(wb_23mar, c(2,3), median)
```

###Concat the results
```{r}
min.it <- min(ncol(res.nn.loss.sgd),ncol(res.nn.loss.nm),ncol(res.nn.loss.adam),ncol(res.nn.loss.adamw),ncol(res.nn.loss.adam_s))
full.res.out <- rbind(sqrt(res.nn.loss.sgd[2,1:min.it]),sqrt(res.nn.loss.nm[2,1:min.it]), sqrt(res.nn.loss.adam[2,1:min.it]), sqrt(res.nn.loss.adamw[2,1:min.it]), sqrt(res.nn.loss.adam_s[2,1:min.it]),wb_23mar.m[1,6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd[1,1:min.it]),sqrt(res.nn.loss.nm[1,1:min.it]), sqrt(res.nn.loss.adam[1,1:min.it]), sqrt(res.nn.loss.adamw[1,1:min.it]), sqrt(res.nn.loss.adam_s[1,1:min.it]),wb_23mar.m[1,5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```

```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,],type=line.type,col = 3,lwd=2)
lines(full.res[1,4,],type=line.type,col = 4,lwd=2)
lines(full.res[1,5,],type=line.type,col = 5,lwd=2)
lines(full.res[1,6,],type=line.type,col = 6,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomright',legend = c('method',"SGD","Newton","Adam", "AdamW", "Adam_s","Whole"), pch = 1,col=c("white",1:6))

#out-of-sample
plot(full.res[2,1,],type=line.type, ylim = c(min(full.res[2,,]), 
                                             7#max(full.res[2,,])
                                             ),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,],type=line.type,col = 3,lwd=2)
lines(full.res[2,4,],type=line.type,col = 4,lwd=2)
lines(full.res[2,5,],type=line.type,col = 5,lwd=2)
lines(full.res[2,6,],type=line.type,col = 6,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomright',legend = c('method',"SGD","Newton","Adam", "AdamW", "Adam_s","Whole"), pch = 1,col=c("white",1:6))
```


Deleting Newton and Adam_s

```{r}
min.it <- min(ncol(res.nn.loss.sgd),ncol(res.nn.loss.adam),ncol(res.nn.loss.adamw),ncol(res.nn.loss.adam_s))
full.res.out <- rbind(sqrt(res.nn.loss.sgd[2,1:min.it]), sqrt(res.nn.loss.adam[2,1:min.it]), sqrt(res.nn.loss.adamw[2,1:min.it]),wb_23mar.m[1,6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd[1,1:min.it]), sqrt(res.nn.loss.adam[1,1:min.it]), sqrt(res.nn.loss.adamw[1,1:min.it]),wb_23mar.m[1,5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```

```{r}
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,-c(2,5),]), max(full.res[1,-c(2,5),])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
# lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[1,5,],type=line.type,col = 5,lwd=2)
lines(full.res[1,4,],type=line.type,col = 6,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomright',legend = c('method',"SGD","Adam", "AdamW","WB_Reg"),lty=c(1,1,2,3,1), pch = c(1,1,2,3,20),col=c("white",1,3,4,6))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,-c(2,5),]), max(full.res[2,-c(2,5),])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
# lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[2,5,],type=line.type,col = 5,lwd=2)
lines(full.res[2,4,],type=line.type,col = 6,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomright',legend = c('method',"SGD","Adam", "AdamW","WB_Reg"),lty=c(1,1,2,3,1), pch = c(1,1,2,3,20),col=c("white",1,3,4,6))
```

Tom's meeting 28 March

1. deffo fix bias for each regression
2. Look into the scattered mask
3.Investigate loading time
Maybe
4. Try to mimic the neural nets to look similar to whole brain GP

Investigating mask
`CICatlas_Res3_trunc.txt ` says everything above label 12 is not GM, then threshold at 0.1, so 
```{r}
temp.img <-oro.nifti::readNIfTI('/well/nichols/users/kfh142/data/Atlas/CIC/MultRes/CICatlas_Res3_2mm.nii.gz')
#Take only grey matter
temp.img[temp.img>12] <- 0
temp.img@datatype = 2
temp.img@bitpix = 8
writeNIfTI(temp.img,paste0('/well/nichols/users/qcv214/bnn2/res3/maskfix/res3mask_1'))
#Load data with new unthreshold mask
part_list<-read.table('/well/nichols/users/qcv214/Placement_2/participant_list.txt', header = FALSE, sep = "", dec = ".") #4529 participants
part_list$exist_vbm <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_list[,1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz'))
part_use<-part_list[part_list$exist_vbm==1,] #4263 participants left
list_of_all_images<-paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_use[1:(dim(part_use)[1]),1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz')
res3.dat <- fast_read_imgs_mask(list_of_all_images,'/well/nichols/users/qcv214/bnn2/res3/maskfix/res3mask_1') 
#threshold at 0.1
dat_colmeans<-colMeans(res3.dat)
#Originally I had temp.img > 1, that means it's not thresholded by 
# temp.img[temp.img>1][dat_colmeans<0.1] <- 0 
# temp.img@datatype = 2
# temp.img@bitpix = 8
# writeNIfTI(temp.img,'/well/nichols/users/qcv214/bnn2/res3/maskfix/res3mask_2')

#
temp.img[temp.img>0][dat_colmeans<0.1] <- 0 
temp.img@datatype = 2
temp.img@bitpix = 8
writeNIfTI(temp.img,'/well/nichols/users/qcv214/bnn2/res3/maskfix/res3mask_3') #Correct
writeNIfTI(temp.img,'/well/nichols/users/qcv214/bnn2/res3/res3mask')

#Load data again using the new thresholded mask
res3.dat <- fast_read_imgs_mask(list_of_all_images,'/well/nichols/users/qcv214/bnn2/res3/res3mask') # 4263 x 156812
#save datat
write_feather(as.data.frame(res3.dat), '/well/nichols/users/qcv214/bnn2/res3/res3_dat.feather')
#reload data and mask
res3.dat <- read_feather('/well/nichols/users/qcv214/bnn2/res3/res3_dat.feather') #dim = 4263 156812
res3.mask <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/res3mask.nii.gz')
res3.mask.reg <- setdiff(sort(unique(c(res3.mask))),0)
```

Create mean mask
```{r}
dat_colmeans<-colMeans(res3.dat)

temp.img <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/res3mask.nii.gz')
temp.img[temp.img>0] <- dat_colmeans 
temp.img@datatype = 16
temp.img@bitpix = 32
writeNIfTI(temp.img,'/well/nichols/users/qcv214/bnn2/res3/mean_mask') #Correct
```


Create `rearranged data`
```{r}
#dat.temp <- matrix(nrow = nrow(res3.dat),ncol = sum(res3.mask>0))
dat.temp <- matrix(nrow = nrow(res3.dat),ncol = 1)
  cum.length <- 0
for(i in res3.mask.reg){
  roi.reg<- read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/roi/dat_ROI_",i,'.feather'))
  print(dim(roi.reg))
  cum.length <- cum.length + ncol(roi.reg)
  print(cum.length)
  roi.reg<- as.matrix(roi.reg)
  dat.temp <- cbind(dat.temp, roi.reg)
}
colnames(dat.temp) <- NULL
dat.temp <- as.data.frame(dat.temp[,-1])
dat.temp <- as.matrix(dat.temp)
write_feather(as.data.frame(dat.temp), '/well/nichols/users/qcv214/bnn2/res3/dat_rearranged.feather')
```


Load data from `nn_lr6.R`
```{r}
num.batch <- 4
epoch <-30

failed_run <- c(3,5,7,8,9)
lr_vec <- c(10^(-1)*setdiff((1:9),failed_run)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,9,num.batch*epoch )) 
for( i in lr_vec){  
  res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn6_loss_",i,".csv")))
}
res.nn.loss <- res.nn.loss[, 1:length(lr_vec),]
```
```{r}
line.type <- 'b'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,4,]),type=line.type,col = 10,lwd=2)
#lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('learning_rate',as.character(lr_vec[c(1,3,4)])), pch = 1,col=c("white",1,3,10))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,4,]),type=line.type,col = 10,lwd=2)
#lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

legend('topright',legend = c('learning_rate',as.character(lr_vec[c(1,3,4)])), pch = 1,col=c("white",1,3,10))
```

##Summmary so far
In the setting of 2,000 training, 2,000 testing with 500 batch size and 20 epochs
1.SGD with lr = 0.6 (originally had 40 epochs) `nn_lr5.R`
2.newton method jobid 2
3. Adam with lr = 0.1, too many hyperparameters to set 
4. Adam with weight decay with lr = 0.3
5. Adam with small batch (not working so well), lr = 0.1
6. [Benchmark] whole brain 
###Load all data 
```{r}
#SGD
res.nn.loss.sgd <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn6_loss_",0.6,".csv")))
#Newton
res.nn.loss.nm <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_nm1_loss_jobid_",4,".csv")))
#Adam
res.nn.loss.adam <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam3_loss_",0.1,".csv")))
#Adam with decoupled weight decay
res.nn.loss.adamw <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adamW2_loss_",0.1,".csv")))
#Adam with small batch
res.nn.loss.adam_s <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam1_loss_",0.1,".csv")))
```
###Load whole brain
```{r}
poly_degree = 10
a_concentration = 0.5
b_smoothness = 40
wb_23mar<-array(,dim=c(50,3,14))
failed_run<-c()
for(i in setdiff(1:50,failed_run)){
      wb_23mar[i,,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/whole_brain",poly_degree,a_concentration,b_smoothness,"_",i,".csv")))
}
wb_23mar.m<-apply(wb_23mar, c(2,3), median)
```

###Concat the results
```{r}
min.it <- min(ncol(res.nn.loss.sgd),ncol(res.nn.loss.nm),ncol(res.nn.loss.adam),ncol(res.nn.loss.adamw),ncol(res.nn.loss.adam_s))
full.res.out <- rbind(sqrt(res.nn.loss.sgd[2,1:min.it]),sqrt(res.nn.loss.nm[2,1:min.it]), sqrt(res.nn.loss.adam[2,1:min.it]), sqrt(res.nn.loss.adamw[2,1:min.it]), sqrt(res.nn.loss.adam_s[2,1:min.it]),wb_23mar.m[1,6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd[1,1:min.it]),sqrt(res.nn.loss.nm[1,1:min.it]), sqrt(res.nn.loss.adam[1,1:min.it]), sqrt(res.nn.loss.adamw[1,1:min.it]), sqrt(res.nn.loss.adam_s[1,1:min.it]),wb_23mar.m[1,5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```

```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,],type=line.type,col = 3,lwd=2)
lines(full.res[1,4,],type=line.type,col = 4,lwd=2)
lines(full.res[1,5,],type=line.type,col = 5,lwd=2)
lines(full.res[1,6,],type=line.type,col = 6,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomright',legend = c('method',"SGD","Newton","Adam", "AdamW", "Adam_s","Whole"), pch = 1,col=c("white",1:6))

#out-of-sample
plot(full.res[2,1,],type=line.type, ylim = c(min(full.res[2,,]), min(max(full.res[2,,]),7)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,],type=line.type,col = 3,lwd=2)
lines(full.res[2,4,],type=line.type,col = 4,lwd=2)
lines(full.res[2,5,],type=line.type,col = 5,lwd=2)
lines(full.res[2,6,],type=line.type,col = 6,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomright',legend = c('method',"SGD","Newton","Adam", "AdamW", "Adam_s","Whole"), pch = 1,col=c("white",1:6))
```

Deleting Newton and Adam_s

```{r}
min.it <- min(ncol(res.nn.loss.sgd),ncol(res.nn.loss.adam),ncol(res.nn.loss.adamw),ncol(res.nn.loss.adam_s))
full.res.out <- rbind(sqrt(res.nn.loss.sgd[2,1:min.it]), sqrt(res.nn.loss.adam[2,1:min.it]), sqrt(res.nn.loss.adamw[2,1:min.it]),wb_23mar.m[1,6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd[1,1:min.it]), sqrt(res.nn.loss.adam[1,1:min.it]), sqrt(res.nn.loss.adamw[1,1:min.it]),wb_23mar.m[1,5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```

```{r}
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
# lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[1,5,],type=line.type,col = 5,lwd=2)
lines(full.res[1,4,],type=line.type,col = 6,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('method',"SGD","Adam", "AdamW","WB_Reg"),lty=c(1,1,2,3,1), pch = c(1,1,2,3,20),col=c("white",1,3,4,6))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
# lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[2,5,],type=line.type,col = 5,lwd=2)
lines(full.res[2,4,],type=line.type,col = 6,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('method',"SGD","Adam", "AdamW","WB_Reg"),lty=c(1,1,2,3,1), pch = c(1,1,2,3,20),col=c("white",1,3,4,6))
```

```{r}
plot(sqrt(res.nn.loss.adam[2,1:min.it]))
```




#After adding bias
##Adam
Load data from `nn_adam_b1.R`
```{r}
num.batch <- 4
epoch <- 20

failed_run <- c(1,3,6,8)
lr_vec <- c(10^(-1)*setdiff((1:9),failed_run)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,9,num.batch*epoch )) 
for( i in lr_vec){
  res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb_adam1_loss_",i,".csv")))
}
res.nn.loss <- res.nn.loss[, 1:length(lr_vec),] #set range
```
```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('learning_rate',as.character(lr_vec[c(1,3,5)])), pch = 1,col=c("white",1,3,10))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

legend('topright',legend = c('learning_rate',as.character(lr_vec[c(1,3,5)])), pch = 1,col=c("white",1,3,10))
```

Get bias
```{r}
num.batch <- 4
epoch <- 20
#Get the best performance
w.1e10 <- as.matrix(read.csv('/well/nichols/users/qcv214/bnn2/res3/pile/nnb_adam1_theta_0.2.csv'))
plot(w.1e10)
```

##SGD
Load data from `nnb1.R`
Not working great
```{r}
num.batch <- 4
epoch <- 20

failed_run <- c(1:6,9)
lr_vec <- c(10^(-1)*setdiff((1:9),failed_run)) #Note that 1 is not lr = 1, but lr = 1e-4
res.nn.loss <- array(, dim = c(2,9,num.batch*epoch )) 
for( i in lr_vec){
  res.nn.loss[,which(i==lr_vec),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb1_loss_",i,".csv")))
}
res.nn.loss <- res.nn.loss[, 1:length(lr_vec),] #set range
```
```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,2,]),type=line.type,col = 3,lwd=2)
# lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",12))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,2,]),type=line.type,col = 3,lwd=2)
# lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

legend('topright',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",1,2))
```


##Comparison of Adam with and without bias
```{r}
num.batch <- 4
epoch <- 20
res.nn.loss <- array(, dim = c(2,2,num.batch*epoch )) 
res.nn.loss[,1,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_adam3_loss_",0.1,".csv")))
res.nn.loss[,2,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb_adam1_loss_",0.2,".csv")))
```

```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,2,]),type=line.type,col = 3,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c('method','w/o bias','w bias'), pch = 1,col=c("white",1,3))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,2,]),type=line.type,col = 3,lwd=2)

abline(v=4*1:epoch,lwd=0.2)

legend('topright',legend = c('method','w/o bias','w bias'), pch = 1,col=c("white",1,3))
```


#30 mar
- Look at time taken to load data on Rstudio vs R (ivybridge).... it only takes 1.77 mintues to load on Rstudio

- Visualise the GP of each region (actually probably don't need that) but lets try it anyway, and maybe the ReLU??


*** I am starting t osuspect that my way of inputting data has been wrong, I have been inputting re-arranged data as oppposed to raw data. But I believe that my GP copes with raw data

##Check the result from `viz_gp_test.R`

plotting partial GP (first term of basis)
```{r}
bases.nb <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/roi/partial_gp_",2,"_fixed_",poly_degree,a_concentration,b_smoothness,".feather")))
gp.mask.hs <- mask_subcor
gp.mask.hs[gp.mask.hs!=0] <-bases.nb[1,]
gp.mask.hs@datatype = 16
gp.mask.hs@bitpix = 32
writeNIfTI(gp.mask.hs,paste0('/well/nichols/users/qcv214/bnn2/res3/viz/Reg2_partial_gp'))
```

##Check the test result from `nn_dat_test.R`
This is for re-arranged data
```{r}
num.batch <- 4
epoch <- 10
failed_run <- c(1,3,4)
res.nn.loss.t1 <- array(, dim = c(2,5,num.batch*epoch )) 
for( i in setdiff(1:5,failed_run)){
  res.nn.loss.t1[,i,] <-as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/test_re-arranged_nnb1_loss_0.7_jobid_",i,".csv")))
}
res.nn.loss.t1 <- res.nn.loss.t1[,-failed_run,] #set range
```
```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss.t1[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss.t1[1,,])), max(sqrt(res.nn.loss.t1[1,,])))
     ,lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
 lines(sqrt(res.nn.loss.t1[1,2,]),type=line.type,col = 3,lwd=2)
# lines(sqrt(res.nn.loss.t1[1,3,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss.t1[1,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
# legend('bottomleft',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",12))

#out-of-sample
plot(sqrt(res.nn.loss.t1[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss.t1[2,,])), max(sqrt(res.nn.loss.t1[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
 lines(sqrt(res.nn.loss.t1[2,2,]),type=line.type,col = 3,lwd=2)
#  lines(sqrt(res.nn.loss.t1[2,3,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss.t1[2,7,]),type=line.type,col = 12,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

# legend('topright',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",1,2))
```


This is for raw data
```{r}
num.batch <- 4
epoch <- 10

failed_run <- c()
res.nn.loss.t2 <- array(, dim = c(2,5,num.batch*epoch )) 
for( i in setdiff(1:5,failed_run)){
  res.nn.loss.t2[,i,] <-as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/test_raw_nnb1_loss_0.7_jobid_",i+5,".csv")))
}
 # res.nn.loss.t2 <- res.nn.loss.t2[,-failed_run,] #set range
```
```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss.t2[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss.t2[1,,])), max(sqrt(res.nn.loss.t2[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss.t2[1,2,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss.t2[1,3,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss.t2[1,4,]),type=line.type,col = 12,lwd=2)
lines(sqrt(res.nn.loss.t2[1,5,]),type=line.type,col = 14,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
# legend('bottomleft',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",12))

#out-of-sample
plot(sqrt(res.nn.loss.t2[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss.t2[2,,])), max(sqrt(res.nn.loss.t2[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss.t2[2,2,]),type=line.type,col = 3,lwd=2)
 lines(sqrt(res.nn.loss.t2[2,3,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss.t2[2,4,]),type=line.type,col = 12,lwd=2)
lines(sqrt(res.nn.loss.t2[2,5,]),type=line.type,col = 14,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

# legend('topright',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",1,2))
```




#31 Mar
After fixing data

##SGD
Load data from `nnb2.R` run 4 is the best
```{r}
learning_rate <- 0.6
num.batch <- 4
epoch <- 40

failed_run <- c(2,3,5,6,7,8,9)
res.nn.loss <- array(, dim = c(2,10,num.batch*epoch )) 
for( i in setdiff(1:10,failed_run)){
  res.nn.loss[,i,] <-as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb2_loss_",learning_rate,"_jobid_",i,".csv")))
}
res.nn.loss <- res.nn.loss[,-failed_run,] #set range
```
```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,2,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[1,4,]),type=line.type,col = 12,lwd=2)
# lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 14,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
# legend('bottomleft',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",12))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,2,]),type=line.type,col = 3,lwd=2)
 lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[2,4,]),type=line.type,col = 12,lwd=2)
# lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 14,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

# legend('topright',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",1,2))
```

##Adam
Load data from `nn_adamb2.R` run 4 
```{r}
learning_rate <- 0.1
num.batch <- 4
epoch <- 40

failed_run <- c(2,3,5,6,8)
res.nn.loss <- array(, dim = c(2,10,num.batch*epoch )) 
for( i in setdiff(1:10,failed_run)){
  res.nn.loss[,i,] <-as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb_adam2_loss_",learning_rate,"_jobid_",i,".csv")))
}
res.nn.loss <- res.nn.loss[,-failed_run,] #set range
```
```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,2,]),type=line.type,col = 3,lwd=2)
lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss[1,4,]),type=line.type,col = 12,lwd=2)
lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 14,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
# legend('bottomleft',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",12))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,2,]),type=line.type,col = 3,lwd=2)
 lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 10,lwd=2)
lines(sqrt(res.nn.loss[2,4,]),type=line.type,col = 12,lwd=2)
lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 14,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

# legend('topright',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",1,2))
```

##AdamW
Load data from `nn_adamWb2.R` run 10
```{r}
learning_rate <- 0.1
num.batch <- 4
epoch <- 40

failed_run <- c(1,2,3,4,5,6,8,9)
res.nn.loss <- array(, dim = c(2,10,num.batch*epoch )) 
for( i in setdiff(1:10,failed_run)){
  res.nn.loss[,i,] <-as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb_adamW2_loss_",learning_rate,"_jobid_",i,".csv")))
}
res.nn.loss <- res.nn.loss[,-failed_run,] #set range
```
```{r}
line.type <- 'l'
plot(sqrt(res.nn.loss[1,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[1,,])), max(sqrt(res.nn.loss[1,,]))),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[1,2,]),type=line.type,col = 3,lwd=2)
# lines(sqrt(res.nn.loss[1,3,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[1,4,]),type=line.type,col = 12,lwd=2)
# lines(sqrt(res.nn.loss[1,5,]),type=line.type,col = 14,lwd=2)
abline(v=4*1:epoch,lwd=0.2)
# legend('bottomleft',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",12))

#out-of-sample
plot(sqrt(res.nn.loss[2,1,]),type=line.type, ylim = c(min(sqrt(res.nn.loss[2,,])), max(sqrt(res.nn.loss[2,,]))),lwd=2,
     main = "Out-of-sample RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(sqrt(res.nn.loss[2,2,]),type=line.type,col = 3,lwd=2)
#  lines(sqrt(res.nn.loss[2,3,]),type=line.type,col = 10,lwd=2)
# lines(sqrt(res.nn.loss[2,4,]),type=line.type,col = 12,lwd=2)
# lines(sqrt(res.nn.loss[2,5,]),type=line.type,col = 14,lwd=2)
abline(v=4*1:epoch,lwd=0.2)

# legend('topright',legend = c('learning_rate',as.character(lr_vec[c(1,2)])), pch = 1,col=c("white",1,2))
```

##Combining all results
```{r}
#SGD
res.nn.loss.sgd <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb2_loss_",0.6,"_jobid_",4,".csv")))
#Adam
res.nn.loss.adam <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb_adam2_loss_",0.1,"_jobid_",4,".csv")))
#Adam with decoupled weight decay
res.nn.loss.adamw <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb_adamW2_loss_",0.1,"_jobid_",10,".csv")))
```
###Load whole brain
```{r}
poly_degree = 10
a_concentration = 0.5
b_smoothness = 40
wb_23mar<-array(,dim=c(50,3,14))
failed_run<-c()
for(i in setdiff(1:50,failed_run)){
      wb_23mar[i,,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/whole_brain",poly_degree,a_concentration,b_smoothness,"_",i,".csv")))
}
wb_23mar.m<-apply(wb_23mar, c(2,3), median)
```
##Fit horseshoe directly for benchmark
```{r}
hs_31mar<-array(,dim=c(50,13))
failed_run<-c(16,22,39)
for(i in setdiff(1:50,failed_run)){
      hs_31mar[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/hs_noscale_",i,".csv"))))
}
hs_31mar <- hs_31mar[-failed_run,]
hs_31mar.m<-apply(hs_31mar, c(2), median)

```
```{r}
min.it <- min(ncol(res.nn.loss.sgd),ncol(res.nn.loss.adam),ncol(res.nn.loss.adamw))
full.res.out <- rbind(sqrt(res.nn.loss.sgd[2,1:min.it]), sqrt(res.nn.loss.adam[2,1:min.it]), sqrt(res.nn.loss.adamw[2,1:min.it]),wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd[1,1:min.it]), sqrt(res.nn.loss.adam[1,1:min.it]), sqrt(res.nn.loss.adamw[1,1:min.it]),wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
SGD took 3.7 hours
Adam took 5 hours
Adam with decoupled weight decay took 9 hours (the other job took 3.5hrs), I think it mainly to do with waiting time
I think the usual time is ~3.5hrs
```{r}
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
lines(full.res[1,4,],type=line.type,col = 6,lwd=2)
lines(full.res[1,5,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('method',"SGD","Adam", "AdamW","GP_reg","Horseshoe"),lty=c(1,1,2,3,1,1), pch = c(1,1,2,3,20,20),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
lines(full.res[2,4,],type=line.type,col = 6,lwd=2)
lines(full.res[2,5,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c('method',"SGD","Adam", "AdamW","GP_reg","Horseshoe"),lty=c(1,1,2,3,1,1), pch = c(1,1,2,3,20,20),col=c("white",1,3,4,6,2))
```


To do grid search on prior variance
1.First we can fix all prior variance to be the same then adjust it
2. Second we can vary all prior variance, I think that it should be directly proportional to volume of each region but this is extremely computational intensive and I'd need to re-structure my code as well

To do (1) I will need to
a) find the seed that allow computations to be done on all epochs (is it possible tho since I randomise every epoch... probably not)
b) Vary the prior







#1 April
After meeting with Tom
For variance, we can use the Bayes Empirical Estimator for variance, i.e. use the sample variance (the one generated by our updates). And cross-validate it on another set of data
Also change Cv to 1/2tau^2

Since GP favour thalamus (centre part of brain), try using PCA and see if it detects importance there as well


#2 April

##Grid search
Load my grid search for initial value
```{r}
num.run <- 1:5
prior.var.vec <- c(0.0001,0.0005,0.001,0.01,0.1,0.5,1,5,10)
prior.var.mat <- expand.grid(num.run,prior.var.vec)
```
0.0005, 6
1. 0.001, 11 is interesting (U shape)
2. 0.01, 16 is interesting, 19 is good (U shape)
3. 0.1, 21 is best (validation 22)
4. 0.5, 29 is best (validation 24)
1, 31 (validation 25)

Plot
```{r}
# res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb2_loss_",0.6,"_jobid_",11,".csv")))
# res.nn.loss.sgd.1[2,30] <-39.8
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb2_loss_",0.6,"_jobid_",16,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb2_loss_",0.6,"_jobid_",21,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb2_loss_",0.6,"_jobid_",29,".csv")))

full.res.out <- rbind( sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.2[1,]), sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
# plot(res.nn.loss.sgd.1[2,])
```

```{r}
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[1,4,], type = "o", lty = 3,pch=3,col = 5,lwd=2)
lines(full.res[1,4,],type=line.type,col = 6,lwd=2)
lines(full.res[1,5,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('pri-var',"0.01", "0.1","0.5","GP_reg","Horseshoe"),lty=c(1,1,2,3,1,1), pch = c(1,1,2,3,20,20),col=c("white",1,3,4,5,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[2,4,], type = "o", lty = 3,pch=3,col = 5,lwd=2)
lines(full.res[2,4,],type=line.type,col = 6,lwd=2)
lines(full.res[2,5,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c('pri-var',"0.01", "0.1","0.5","GP_reg","Horseshoe"),lty=c(1,1,2,3,1,1), pch = c(1,1,2,3,20,20),col=c("white",1,3,4,5,2))
```


##Empirical Bayes Estimator
Load theta from SGD with prior var = 0.9
```{r}
theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb2_theta_",0.6,"_jobid_",4,".feather")))
apply(theta.sgd, 1, sd)
```
Load theta from SGD with prior var = 0.1
```{r}
theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb2_theta_",0.6,"_jobid_",21,".feather")))
apply(theta.sgd, 1, sd)
```

Compare 0.1 and 0.9
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb2_loss_",0.6,"_jobid_",21,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb2_loss_",0.6,"_jobid_",4,".csv")))


full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```

```{r}
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
# lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[1,4,], type = "o", lty = 3,pch=3,col = 5,lwd=2)
lines(full.res[1,3,],type=line.type,col = 6,lwd=2)
lines(full.res[1,4,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('pri-var',"0.1", "0.9","GP_reg","Horseshoe"),lty=c(1,2,1,1), pch = c(1,2,20,20),col=c("white",1,3,5,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
# lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[2,4,], type = "o", lty = 3,pch=3,col = 5,lwd=2)
lines(full.res[2,3,],type=line.type,col = 6,lwd=2)
lines(full.res[2,4,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c('pri-var',"0.1", "0.9","GP_reg","Horseshoe"),lty=c(1,2,1,1), pch = c(1,2,20,20),col=c("white",1,3,5,2))
```

#10 April

Assess theta variance
num.run <- 1:5
prior.var.vec <- c(0.1,0.5,0.9)
prior.var.mat <- expand.grid(num.run,prior.var.vec)

Compare 0.1, 0.5 and 0.9
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb3_loss_",0.6,"_jobid_",3,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb3_loss_",0.6,"_jobid_",6,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb3_loss_",0.6,"_jobid_",15,".csv")))

full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]) ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]) , sqrt(res.nn.loss.sgd.3[1,]) ,wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[1,4,], type = "o", lty = 3,pch=3,col = 5,lwd=2)
lines(full.res[1,4,],type=line.type,col = 6,lwd=2)
lines(full.res[1,5,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c('pri-var',"0.1","0.5", "0.9","GP_reg","Horseshoe"),lty=c(1,1,2,3,1,1), pch = c(1,1,2,3,20,20),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[2,4,], type = "o", lty = 3,pch=3,col = 5,lwd=2)
lines(full.res[2,4,],type=line.type,col = 6,lwd=2)
lines(full.res[2,5,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c('pri-var',"0.1","0.5", "0.9","GP_reg","Horseshoe"),lty=c(1,1,2,3,1,1), pch = c(1,1,2,3,20,20),col=c("white",1,3,4,6,2))
```
```{r}
theta.sd.mat <- matrix(,ncol=12,nrow = 3)
counter <- 1
for(i in c(3,6,15)){
  theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb3_theta_",0.6,"_jobid_",i,".feather")))
  theta.sd.mat[counter,] <- apply(theta.sgd, 1, sd)
  counter <- counter+1
}
theta.sd.mat
```
```{r}
plot(theta.sd.mat[1,], ylim = c(0,1), type = "o", lty = 1,pch=1, ylab="s.d.", main = "Region-wise s.d. after 160 iterations", xlab='Region number')
lines(theta.sd.mat[2,], type = "o", lty = 2,pch=2,col = 3)
lines(theta.sd.mat[3,], type = "o", lty = 3,pch=3,col = 4)
legend('right',legend = c('prior-var',"0.1","0.5", "0.9"),lty=c(1,1,2,3), pch = c(1,1,2,3),col=c("white",1,3,4))
```


##Load with seed 2
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb4_loss_",0.6,"_seed__jobid_",1,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb4_loss_",0.6,"_seed__jobid_",11,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb4_loss_",0.6,"_seed__jobid_",21,".csv")))

full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]) ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]) , sqrt(res.nn.loss.sgd.3[1,]) ,wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[1,4,], type = "o", lty = 3,pch=3,col = 5,lwd=2)
lines(full.res[1,4,],type=line.type,col = 6,lwd=2)
lines(full.res[1,5,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c(expression(tau),"0.1","0.5", "0.9","GP_reg","Horseshoe"),lty=c(1,1,2,3,1,1), pch = c(1,1,2,3,20,20),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[2,4,], type = "o", lty = 3,pch=3,col = 5,lwd=2)
lines(full.res[2,4,],type=line.type,col = 6,lwd=2)
lines(full.res[2,5,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c(expression(tau),"0.1","0.5", "0.9","GP_reg","Horseshoe"),lty=c(1,1,2,3,1,1), pch = c(1,1,2,3,20,20),col=c("white",1,3,4,6,2))
```

```{r}
seed <- 2
theta.sd.mat <- matrix(,ncol=12,nrow = 3)
counter <- 1
for(i in c(1,11,21)){
  theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb4_theta_",0.6,"_seed_",seed,"_jobid_",i,".feather")))
  theta.sd.mat[counter,] <- apply(theta.sgd, 1, sd)
  counter <- counter+1
}
theta.sd.mat
```
```{r}
plot(theta.sd.mat[1,], ylim = c(0,1.1), type = "o", lty = 1,pch=1, ylab="s.d.", main = "Region-wise s.d. after 160 iterations", xlab='Region number')
lines(theta.sd.mat[2,], type = "o", lty = 2,pch=2,col = 3)
lines(theta.sd.mat[3,], type = "o", lty = 3,pch=3,col = 4)
abline(h=0.1,lty=2,col='grey')
abline(h=0.5,lty=2,col='grey')
abline(h=0.9,lty=2,col='grey')
legend('right',legend = c(expression(tau),"0.1","0.5", "0.9"),lty=c(1,1,2,3), pch = c(1,1,2,3),col=c("white",1,3,4))
```

#7 april

Load result from `privar_tune4.R`
only 13 and 15 (is good) worked
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb5_loss_",0.6,"_seed_",6,"_jobid_",15,".csv")))


full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]) ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]),wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
# lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
# lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[1,4,], type = "o", lty = 3,pch=3,col = 5,lwd=2)
lines(full.res[1,2,],type=line.type,col = 6,lwd=2)
lines(full.res[1,3,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c(expression(tau),"0.1","0.5", "0.9","GP_reg","Horseshoe"),lty=c(1,1,2,3,1,1), pch = c(1,1,2,3,20,20),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
# lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
# lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
# lines(full.res[2,4,], type = "o", lty = 3,pch=3,col = 5,lwd=2)
lines(full.res[2,2,],type=line.type,col = 6,lwd=2)
lines(full.res[2,3,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c(expression(tau),"0.1","0.5", "0.9","GP_reg","Horseshoe"),lty=c(1,1,2,3,1,1), pch = c(1,1,2,3,20,20),col=c("white",1,3,4,6,2))
```


Load grid search
```{r}
  deg_vec<- c(10)
  a_vec  <- c(0.001,0.01,0.1,0.5,1,2,3)
  b_vec  <- 40
  param_grid <- as.matrix(expand.grid(deg_vec,a_vec,b_vec))
  gs.opt <- matrix(,ncol=2,nrow = length(mask.reg))
for(i in sort(mask.reg)){
  gs.opt[which(i==(mask.reg)),]<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/gs5april_ROI_",i,".csv")))
}
# table(param_grid[gs.opt[,1],1])
table(param_grid[gs.opt[,1],2])
# table(param_grid[gs.opt[,1],3])
```


#11 April
Load data from `privar_tune5.R`
First two sec unusable
25 vs 35
45, 55
65
75, 85 (starting to go up)
##Load with seed 16
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",25,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",35,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",45,".csv"))) #this is the best
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",55,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",65,".csv")))
res.nn.loss.sgd.6 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",75,".csv")))
res.nn.loss.sgd.7 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",85,".csv")))

full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]), sqrt(res.nn.loss.sgd.4[2,]), sqrt(res.nn.loss.sgd.5[2,]), sqrt(res.nn.loss.sgd.6[2,]), sqrt(res.nn.loss.sgd.7[2,])
                       ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]), sqrt(res.nn.loss.sgd.3[1,]) , sqrt(res.nn.loss.sgd.4[1,]), sqrt(res.nn.loss.sgd.5[1,]), sqrt(res.nn.loss.sgd.6[1,]), sqrt(res.nn.loss.sgd.7[1,])
                     ,wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
prior.var.vec <- c(0.0001,0.0005,0.001,0.01,0.1,0.5,1,5,10)
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[1,5,], type = "o", lty = 5,pch=5,col = 6,lwd=1)
lines(full.res[1,6,], type = "o", lty = 6,pch=6,col = 7,lwd=1)
lines(full.res[1,7,], type = "o", lty = 7,pch=7,col = 8,lwd=1)
lines(full.res[1,8,],type=line.type,col = 6,lwd=2)
lines(full.res[1,9,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c(expression(tau^2),as.character(prior.var.vec[-c(1:2)])),lty=c(1,c(1:7)), pch = c(1,c(1:7)),col=c("white",1,3:8))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=2)
lines(full.res[2,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[2,5,], type = "o", lty = 5,pch=5,col = 6,lwd=1)
lines(full.res[2,6,], type = "o", lty = 6,pch=6,col = 7,lwd=1)
lines(full.res[2,7,], type = "o", lty = 7,pch=7,col = 8,lwd=1)
lines(full.res[2,8,],type=line.type,col = 6,lwd=2)
lines(full.res[2,9,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c(expression(tau^2),as.character(prior.var.vec[-c(1:2)])),lty=c(1,c(1:7)), pch = c(1,c(1:7)),col=c("white",1,3:8))
```
lr = 0.1 (or 0.5) seems the best 
Look at the theta dist
8 is Basal_Ganglia
```{r}
 theta.sd.mat <- matrix(,ncol=12,nrow = 2)
 counter <- 1
 for(i in c(45,55)){
   theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_theta_",0.6,"_jobid_",i,".feather")))
   theta.sd.mat[counter,] <- apply(theta.sgd, 1, var)
   counter <- counter+1
 }
# theta.sd.mat
```
```{r}
 plot(theta.sd.mat[1,], ylim = c(0,1.1), type = "o", lty = 1,pch=1, ylab="var", main = "Region-wise var after 160 iterations", xlab='Region number')
 lines(theta.sd.mat[2,], type = "o", lty = 2,pch=2,col = 3)
 abline(h=0.1,lty=2,col='grey')
 abline(h=0.5,lty=2,col='grey')
 legend('topright',legend = c(expression(tau^2),"0.1","0.5"),lty=c(1,1,2), pch = c(1,1,2),col=c("white",1,3))
```
Finally we have something in agreement with variance update


##Load result of gp reg
from `region_gp1`
```{r}
reg_gp<-matrix(,nrow=50,ncol=14)
failed_run<-c()
for(i in setdiff(1:50,failed_run)){
      reg_gp[i,] <- c(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/pile/region_gp_11apr_",i,".csv"))))
}
reg_gp.m<-apply(reg_gp, c(2), median)
#plot
reg_gp.m[6]
```

Assess theta dist for each region? I'd have to solve a system of lin equations


#Load result of seed 16
```{r}
reg_gp16 <- c(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/region_gp_11apr_seed16_",1,".csv"))))
reg_gp16[6]
wb_23mar[16,1,6]
```
Look at the theta distribution by solving system of lin equations... can't actually use solve though, solve requires a square matrix.... otherwise not invertible... or need to compute the left inverse 
Moore-penrose generalised inverse `ginv()` from `MASS`
```{r}
library(MASS)
```
Load the fitted horseshoe coef
```{r}
reg_gp16_fitted<- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/region_gp_11apr_coef_seed16_",1,'.feather')))
```

```{r}
norm.func <- function(x){ 2*(x - min(x))/(max(x)-min(x)) -1 }

res3.mask <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/res3mask.nii.gz')
res3.mask.reg <- sort(setdiff(unique(c(res3.mask)),0))
dimension = 3
deg_vec<- c(10)
a_vec  <- c(0.001,0.01,0.1,0.5,1,2,3)
b_vec  <- 40
param_grid <- as.matrix(expand.grid(deg_vec,a_vec,b_vec))
gs.opt <- matrix(,ncol=2,nrow = length(res3.mask.reg))
for(i in sort(res3.mask.reg)){
  gs.opt[which(i==(res3.mask.reg)),]<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/gs5april_ROI_",i,".csv")))
}
bases.nb.temp <- matrix(,ncol=1,nrow= choose(max(deg_vec)+dimension,dimension)) 

for(i in res3.mask.reg){
  poly_degree = param_grid[gs.opt[which(i==(res3.mask.reg)),1],1] #######I forgot that it must the same poly degree....
  a_concentration= param_grid[gs.opt[which(i==(res3.mask.reg)),1],2]
  b_smoothness= param_grid[gs.opt[which(i==(res3.mask.reg)),1],3]
  mask.temp<-oro.nifti::readNIfTI(paste0('/well/nichols/users/qcv214/bnn2/res3/roi/mask_ROI_',i))
  
  nb <- find_brain_image_neighbors(img1, mask.temp, radius=1)
  #re-scale the coordinates
  nb.centred<- apply(nb$maskcoords,2,norm.func)
  #re-centre each region
  #get psi
  psi.mat.nb <- GP.eigen.funcs.fast(nb.centred, poly_degree = poly_degree, a = a_concentration, b = b_smoothness)
  #get lambda
  lambda.nb <- GP.eigen.value(poly_degree = poly_degree, a = a_concentration, b = b_smoothness, d = dimension)
  #Use Karhunen-Loeve expansion/Mercer's theorem to represent our GP as a combination of gaussian realisation, lambda and psi
  sqrt.lambda.nb <- sqrt(lambda.nb)
  bases.nb <- t(psi.mat.nb)*sqrt.lambda.nb
  if(nrow(bases.nb) < choose(max(deg_vec)+dimension,dimension)){
    empty.expansion <- matrix(0, nrow= choose(max(deg_vec)+dimension,dimension)-nrow(bases.nb), ncol= ncol(bases.nb))
    bases.nb <- rbind(bases.nb,empty.expansion)
  }
  #print(paste0("here, ",i)
  bases.nb.temp <- cbind(as.matrix(bases.nb.temp),as.matrix(bases.nb))
}
colnames(bases.nb.temp) <- NULL
bases.nb <- as.data.frame(bases.nb.temp[,-1])
bases.nb <- as.matrix(bases.nb)
```
Since I fit horseshoe prior as a whole, I shouldn't segment the bases...
This involves finding inverse of the whole matrix
```{r}
overall_theta <- ginv(t(bases.nb))%*%reg_gp16_fitted
qqnorm(overall_theta)
qqline(overall_theta)
```




Load good result so far
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",45,".csv")))
full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]),reg_gp16[6] ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]),reg_gp16[5],wb_23mar.m[1,5],hs_31mar.m[5])
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = line.type, lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[1,3,],type=line.type,col = 6,lwd=2)
lines(full.res[1,4,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c("NN","Region_gp","GP_reg","Horseshoe"),lty=c(1,2,1,1), pch = c(1,20,20,20),col=c(1,3,6,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=1,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = line.type, lty = 2,pch=2,col = 3,lwd=2)
lines(full.res[2,3,],type=line.type,col = 6,lwd=2)
lines(full.res[2,4,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c("NN","Region_gp","GP_reg","Horseshoe"),lty=c(1,2,1,1), pch = c(1,20,20,20),col=c(1,3,6,2))
```

#14 April

##Load `privar_tune6` for case with inhomogeneous prior variance
And compare it with previous
```{r}
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb7_loss_",0.6,"_jobid_",5,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb7_loss_",0.6,"_jobid_",14,".csv"))) #JobId here didn't work, so not the same initialisation
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",45,".csv"))) #this is the best
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",55,".csv")))

full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]), sqrt(res.nn.loss.sgd.4[2,])
                       ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]), sqrt(res.nn.loss.sgd.3[1,]) , sqrt(res.nn.loss.sgd.4[1,])
                     ,wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
prior.var.vec <- c("0.1","0.5","0.1b","0.5b")
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[1,5,],type=line.type,col = 6,lwd=2)
lines(full.res[1,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:6,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=1,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
# lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
# lines(full.res[2,4,], type = "o", lty = 4,pch=4,col = 14,lwd=1)
lines(full.res[2,5,],type=line.type,col = 6,lwd=2)
lines(full.res[2,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:4,14,6,2))
#####
plot(full.res[2,2,], type = "o", lty = 2,pch=3, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=1,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration", col =3)
# lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
# lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[2,4,], type = "o", lty = 4,pch=4,col = 14,lwd=1)
lines(full.res[2,5,],type=line.type,col = 6,lwd=2)
lines(full.res[2,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:4,14,6,2))
```
Plot theta
```{r}
 theta.sd.mat <- matrix(,ncol=12,nrow = 4)
 counter <- 1
 for(i in c(5,14)){
   theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb7_theta_",0.6,"_jobid_",i,".feather")))
   theta.sd.mat[counter,] <- apply(theta.sgd, 1, var)
   counter <- counter+1
 }
 for(i in c(45,55)){
   theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_theta_",0.6,"_jobid_",i,".feather")))
   theta.sd.mat[counter,] <- apply(theta.sgd, 1, var)
   counter <- counter+1
 } 
# theta.sd.mat
```
```{r}
 plot(theta.sd.mat[1,], ylim = c(0,1.1), type = "o", lty = 1,pch=1, ylab="var", main = "Region-wise var after 160 iterations", xlab='Region number')
 lines(theta.sd.mat[2,], type = "o", lty = 2,pch=2,col = 3)
 lines(theta.sd.mat[3,], type = "o", lty = 3,pch=4,col = 'grey')
 lines(theta.sd.mat[4,], type = "o", lty = 3,pch=4,col = 'grey')
 abline(h=0.1,lty=1,col='grey')
 abline(h=0.5,lty=1,col='grey')
 legend('topright',legend = c(expression(tau^2),"0.1b","0.5b"),lty=c(1,1,2), pch = c(1,1,2),col=c("white",1,3))
```

##Load region-wise NN
Use seed 18 since they are comparable to each other
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb7_loss_",0.6,"_jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb7_loss_",0.6,"_jobid_",14,".csv"))) #JobId here didn't work, so not the same initialisation
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_reg1_loss_",0.6,"_jobid_",7,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_reg1_loss_",0.6,"_jobid_",17,".csv")))

full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]), sqrt(res.nn.loss.sgd.4[2,])
                       ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]), sqrt(res.nn.loss.sgd.3[1,]) , sqrt(res.nn.loss.sgd.4[1,])
                     ,wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
prior.var.vec <- c("0.1b","0.5b","0.1 reg-nn","0.5 reg-nn")
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[1,5,],type=line.type,col = 6,lwd=2)
lines(full.res[1,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:6,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=1,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[2,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[2,5,],type=line.type,col = 6,lwd=2)
lines(full.res[2,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:6,2))
```

```{r}
 theta.sd.mat <- matrix(,ncol=12,nrow = 4)
 counter <- 1
 for(i in c(7,17)){
   theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_reg1_theta_",0.6,"_jobid_",i,".feather")))
   theta.sd.mat[counter,] <- apply(theta.sgd, 1, var)
   counter <- counter+1
 }
# theta.sd.mat
```
```{r}
 plot(theta.sd.mat[1,], ylim = c(0,1.1), type = "o", lty = 1,pch=1, ylab="var", main = "Region-wise var after 160 iterations", xlab='Region number')
 lines(theta.sd.mat[2,], type = "o", lty = 2,pch=2,col = 3)
 abline(h=0.1,lty=1,col='grey')
 abline(h=0.5,lty=1,col='grey')
 legend('topright',legend = c(expression(tau^2),"0.1","0.5"),lty=c(1,1,2), pch = c(1,1,2),col=c("white",1,3))
```

Region-wise NN against normal NN
##Load region-wise NN
Use seed 18 since they are comparable to each other
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",45,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb6_loss_",0.6,"_jobid_",55,".csv"))) #JobId here didn't work, so not the same initialisation
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_reg1_loss_",0.6,"_jobid_",7,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nn_reg1_loss_",0.6,"_jobid_",17,".csv")))

full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]), sqrt(res.nn.loss.sgd.4[2,])
                       ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]), sqrt(res.nn.loss.sgd.3[1,]) , sqrt(res.nn.loss.sgd.4[1,])
                     ,wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
prior.var.vec <- c("0.1","0.5","0.1 reg-nn","0.5 reg-nn")
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[1,5,],type=line.type,col = 6,lwd=2)
lines(full.res[1,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:6,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=1,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[2,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[2,5,],type=line.type,col = 6,lwd=2)
lines(full.res[2,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:6,2))
```


#21 April
sgd `sgld_sgd1` and `sgld_sgld2`
Learning rate `2*((1e-6)+it.num)^-0.6/2`

```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd1_loss_","_jobid_",1,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd1_loss_","_jobid_",11,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld2_loss_","_jobid_",1,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld2_loss_","_jobid_",11,".csv")))

full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]), sqrt(res.nn.loss.sgd.4[2,])
                       ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]), sqrt(res.nn.loss.sgd.3[1,]) , sqrt(res.nn.loss.sgd.4[1,])
                     ,wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
prior.var.vec <- c("0.1","0.5","0.1 reg-nn","0.5 reg-nn")
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[1,5,],type=line.type,col = 6,lwd=2)
lines(full.res[1,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:6,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=1,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[2,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[2,5,],type=line.type,col = 6,lwd=2)
lines(full.res[2,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:6,2))
```
##Load result with amended 
lr = `1*(0.5+it.num)^-0.6/2`
I accidentally fixed prior var to 0.1
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd2_loss_","_jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd2_loss_","_jobid_",15,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld3_loss_","_jobid_",6,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld3_loss_","_jobid_",16,".csv")))

full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]), sqrt(res.nn.loss.sgd.4[2,])
                       ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]), sqrt(res.nn.loss.sgd.3[1,]) , sqrt(res.nn.loss.sgd.4[1,])
                     ,wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
prior.var.vec <- c("0.1","0.5","0.1 reg-nn","0.5 reg-nn")
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[1,5,],type=line.type,col = 6,lwd=2)
lines(full.res[1,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:6,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=1,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[2,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[2,5,],type=line.type,col = 6,lwd=2)
lines(full.res[2,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:6,2))
```



##Gridsearch from `gs21april`
Load grid search
```{r}
  deg_vec<- c(10) 
  a_vec  <- c(1,2,3,4,5)
  b_vec  <- c(30,40,50,60,70,80,90,100)
  param_grid <- as.matrix(expand.grid(deg_vec,a_vec,b_vec))
  gs.opt <- matrix(,ncol=2,nrow = length(mask.reg))
for(i in sort(mask.reg)){
  gs.opt[which(i==(mask.reg)),]<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/gs21april_ROI_",i,".csv")))
}
# table(param_grid[gs.opt[,1],1])
table(param_grid[gs.opt[,1],2])
 table(param_grid[gs.opt[,1],3])
```

#22 April
##Load results fater redoing gridsearch
lr = `1*(0.5+it.num)^-0.6/2`
I accidentally over wrote the result of  `nnsgdlsgd2`
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd2_loss_","_jobid_",4,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd2_loss_","_jobid_",14,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld4_loss_","_jobid_",2,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld4_loss_","_jobid_",12,".csv")))

full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]), sqrt(res.nn.loss.sgd.4[2,])
                       ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]), sqrt(res.nn.loss.sgd.3[1,]) , sqrt(res.nn.loss.sgd.4[1,])
                     ,wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
prior.var.vec <- c("0.1","0.5","0.1 reg-nn","0.5 reg-nn")
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[1,5,],type=line.type,col = 6,lwd=2)
lines(full.res[1,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:6,2))

#out-of-sample
plot(full.res[2,1,], type = "o", lty = 1,pch=1, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=1,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,3,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[2,4,], type = "o", lty = 4,pch=4,col = 5,lwd=1)
lines(full.res[2,5,],type=line.type,col = 6,lwd=2)
lines(full.res[2,6,],type=line.type,col = 2,lwd=2)
#abline(v=4*1:epoch,lwd=0.2)
legend('topright',legend = c(expression(tau^2),as.character(prior.var.vec)),lty=c(1,c(1:6)), pch = c(1,c(1:6)),col=c("white",1,3:6,2))
```
Load theta for sgd
```{r}
 theta.sd.mat <- matrix(,ncol=12,nrow = 2)
 counter <- 1
 for(i in c(4,14)){
   theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd2_theta_","_jobid_",i,".feather")))
   theta.sd.mat[counter,] <- apply(theta.sgd, 1, var)
   counter <- counter+1
 }

 plot(theta.sd.mat[1,], ylim = c(0,0.7), type = "o", lty = 1,pch=1, ylab="var", main = "Region-wise var after 240 iterations", xlab='Region number')
 lines(theta.sd.mat[2,], type = "o", lty = 2,pch=2,col = 3)
 abline(h=0.1,lty=1,col='grey')
 abline(h=0.5,lty=1,col='grey')
 legend('topright',legend = c(expression(tau^2),"0.1","0.5"),lty=c(1,1,2), pch = c(1,1,2),col=c("white",1,3))
```
Load theta for sgld
```{r}
 theta.sd.mat <- matrix(,ncol=12,nrow = 2)
 counter <- 1
 for(i in c(2,12)){
   theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld4_theta_","_jobid_",i,".feather")))
   theta.sd.mat[counter,] <- apply(theta.sgd, 1, var)
   counter <- counter+1
 }

 plot(theta.sd.mat[1,], type = "o", lty = 1,pch=1, ylab="var", main = "Region-wise var after 240 iterations", xlab='Region number')
 lines(theta.sd.mat[2,], type = "o", lty = 2,pch=2,col = 3)
 abline(h=0.1,lty=1,col='grey')
 abline(h=0.5,lty=1,col='grey')
 legend('topright',legend = c(expression(tau^2),"0.1","0.5"),lty=c(1,1,2), pch = c(1,1,2),col=c("white",1,3))
```
Since prior of 0.1 is the best I will focus on this

plot of training vs validation
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd2_loss_","_jobid_",4,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld4_loss_","_jobid_",2,".csv")))

full.res.out <- rbind( sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,])
                       ,wb_23mar.m[1,6],hs_31mar.m[6])
full.res.in <- rbind(sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,])
                     ,wb_23mar.m[1,5],hs_31mar.m[5])

full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
#SGD
prior.var.vec <- c("training","validation")
line.type <- 'l'
plot(full.res[1,1,], type = "o", lty = 1,pch=1,lwd=2,
     main = "RMSE (SGD with prior variance 0.1)",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,1,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomleft',legend = c(as.character(prior.var.vec)),lty=c(1,2), pch = c(1,2),col=c(1,3))

#SGLD
prior.var.vec <- c("training","validation")
line.type <- 'l'
plot(full.res[1,2,], type = "o", lty = 1,pch=1,lwd=2,
     main = "RMSE (SGDL with prior variance 0.1)",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,], type = "o", lty = 2,pch=2,col = 3,lwd=1)

legend('bottomleft',legend = c(as.character(prior.var.vec)),lty=c(1,2), pch = c(1,2),col=c(1,3))
```
Plot of learning rate
```{r}
plot(x=1:240, y =1*(0.5+1:240)^-0.6/2, ylab = "learning rate", xlab = 'iteration',ylim = c(0,0.45))
abline(h=0,lwd=2,col='red')
```

#24 April
lr = `1*(0.5+it.num)^-0.6/2`

##SGD vs 12x12GP SGD
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd2_loss_","_jobid_",2,".csv")))[,1:160]
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd4_loss_","_jobid_",2,".csv")))

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD","SGD_2","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD","SGD_2","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```

Load the result with 12 x 12 gp

```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd4_loss_","_jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld5_loss_","_jobid_",4,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld6_loss_","_jobid_",9,".csv")))

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]), sqrt(res.nn.loss.sgd.3[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
legend('topright',legend = c("method","SGD","SGLD","SGLD_2","GP Reg","HS-prior"),lty=c(1,c(1:5)), pch = c(1,c(1:5)),col=c("white",1,3:4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
#abline(v=4*1:epoch,lwd=0.2)
# legend('topright',legend = c("method","SGD","SGLD","SGLD_2","GP Reg","HS-prior"),lty=c(1,c(1:5)), pch = c(1,c(1:5)),col=c("white",1,3:4,6,2))
```

Can use a more refined mask

#25 April
Consider Cis 4 mask
Note that region `46` and `47` 46,Globus_Pallidus_L 47,Globus_Pallidus_R
`CICatlas_Res4_trunc.txt ` says everything above label 55 is not GM, then threshold at 0.1, so 
```{r}
temp.img <-oro.nifti::readNIfTI('/well/nichols/users/kfh142/data/Atlas/CIC/MultRes/CICatlas_Res4_2mm.nii.gz')
#Take only grey matter
temp.img[temp.img>55] <- 0
temp.img[temp.img==46] <- 0
temp.img[temp.img==47] <- 0
temp.img@datatype = 2
temp.img@bitpix = 8
writeNIfTI(temp.img,paste0('/well/nichols/users/qcv214/bnn2/res3/maskfix/res4mask_1'))
#Load data with new unthreshold mask
part_list<-read.table('/well/nichols/users/qcv214/Placement_2/participant_list.txt', header = FALSE, sep = "", dec = ".") #4529 participants
part_list$exist_vbm <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_list[,1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz'))
part_use<-part_list[part_list$exist_vbm==1,] #4263 participants left
list_of_all_images<-paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_use[1:(dim(part_use)[1]),1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz')
res4.dat <- fast_read_imgs_mask(list_of_all_images,'/well/nichols/users/qcv214/bnn2/res3/maskfix/res4mask_1') 
#threshold at 0.1
dat_colmeans<-colMeans(res4.dat)

#
temp.img[temp.img>0][dat_colmeans<0.1] <- 0 

temp.img@datatype = 2
temp.img@bitpix = 8
writeNIfTI(temp.img,'/well/nichols/users/qcv214/bnn2/res3/maskfix/res4mask_3') #Correct
writeNIfTI(temp.img,'/well/nichols/users/qcv214/bnn2/res3/res4mask')

#Load data again using the new thresholded mask
res4.dat <- fast_read_imgs_mask(list_of_all_images,'/well/nichols/users/qcv214/bnn2/res3/res4mask') # 4263 x 156812
#save datat
write_feather(as.data.frame(res4.dat), '/well/nichols/users/qcv214/bnn2/res3/res4_dat.feather')
#reload data and mask
res4.dat <- read_feather('/well/nichols/users/qcv214/bnn2/res3/res4_dat.feather') #dim = 4263 156812
res4.mask <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/res4mask.nii.gz')
res4.mask.reg <- setdiff(sort(unique(c(res3.mask))),0)
```

#26 April

##Compare SGD with no tuning smoothness and tuning smoothness
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnb7_loss_",0.6,"_jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd2_loss_","_jobid_",5,".csv")))[,1:160]

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD","SGD_2","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD","SGD with smoothness tuning","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```


##Compare SGD with fixed lr, 12 GP vs 12x12 GP
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd2_loss_","_jobid_",1,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd5_loss_","_jobid_",8,".csv")))

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD","SGD_2","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD","SGD 12x12 GP","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```

##Compare SGD with decaying lr and fixed lr 
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd5_loss_","_jobid_",8,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd4_loss_","_jobid_",8,".csv")))

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD","SGD_2","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD fixed lr","SGD decay lr","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```

##Comparing SGLD with noise variance reduced by 1, 2, 5
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld5_loss_","_jobid_",4,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld6_loss_","_jobid_",9,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld7_loss_","_jobid_",4,".csv")))

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]), sqrt(res.nn.loss.sgd.3[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]), sqrt(res.nn.loss.sgd.3[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
legend('topright',legend = c("method","SGD","SGLD","SGLD_2","GP Reg","HS-prior"),lty=c(1,c(1:5)), pch = c(1,c(1:5)),col=c("white",1,3:4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "o", lty = 3,pch=3,col = 4,lwd=1)
#abline(v=4*1:epoch,lwd=0.2)
legend('bottomleft',legend = c("method","SGLD","SGLD 1/2","SGLD 1/5","GP Reg","HS-prior"),lty=c(1,c(1:5)), pch = c(1,c(1:5)),col=c("white",1,3:4,6,2))
```
Observe theta at original SGLD
```{r}
theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/short_nnsgdlsgld5_theta_","_jobid_",1,".feather")))
```
```{r}
plot(x=1:12,y=theta.sgd[,8])
```


##Comparing SGLD with noise variance reduced by factor of 5 and fixed lr
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld7_loss_","_jobid_",4,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgld8_loss_","_jobid_",4,".csv")))

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD","SGD_2","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE of SGLD with 1/5 noise variance",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGLD decay","SGLD fixed","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```




##Comparing res3 vs res 4 SGD fixed lr
res4 SGD: `66590926`
none of the jobs manage to finished but also didn't show any error
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd5_loss_","_jobid_",8,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/res4_nnsgdlsgd1_loss_","_jobid_",1,".csv")))

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
Observe sgd5 jobid 8, and Manually load the res 4 sgd job id 8 too

I used `grep -i "training loss" nn.sh.o66590926.8 > ../res4temp.txt`
and `grep -i "validation loss" nn.sh.o66590926.8 > ../res4temp_val.txt`
```{r}
res4.train <- as.matrix(read.delim("/users/nichols/qcv214/res4temp.txt", header = FALSE))
res4.train <- as.numeric(gsub(".*:","",res4.train))
res4.val <- as.matrix(read.delim("/users/nichols/qcv214/res4temp_val.txt", header = FALSE))
res4.val <- as.numeric(gsub(".*:","",res4.val))
```
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd5_loss_","_jobid_",8,".csv")))[,1:192]
res.nn.loss.sgd.2 <- rbind(res4.train,res4.val)[,1:192]

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```


```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(3.5, max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
# lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","12 Regions","55 Regions","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","12 Regions","55 Regions","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```

#27 April

Assess magnitude of theta after 2 epochs/8 ietrations from job `66165476`
```{r}
theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/short_nnsgdlsgld5_theta_","_jobid_",1,".feather")))
```
```{r}
gaus.noise <- matrix(,nrow=12, ncol= 286)
set.seed(12)
for(i in 1:12){
      gaus.noise[i,] <- rnorm(286,0,sqrt((1*(0.5+8)^-0.6/2)*2))
}

```
```{r}
c1 <- rgb(173,216,230,max = 255, alpha = 80, names = "lt.blue")
c2 <- rgb(255,192,203, max = 255, alpha = 80, names = "lt.pink")
for(i in 1:nrow(theta.sgd)){
  hist.temp<-hist(theta.sgd[i,], breaks = seq(from=-10, to=10, by=0.5))
  hist.gaus<-hist(gaus.noise[i,], breaks = seq(from=-10, to=10, by=0.5))
  plot(hist.temp, main = paste0("Region ",i),col=c1, ylim=c(0,120))
  plot(hist.gaus, add = TRUE, col = c2)
}
```

```{r}
for(i in 1:12){
  boxplot(
    abs(gaus.noise[i,]/theta.sgd[i,]), ylab = "Magnitude of relative strength of noise", main = paste0("Boxplot of Region ", i))
}
```

Plot the % changed after adding gaussing noise to theta
```{r}
for(i in 1:12){
  plot((
    gaus.noise[i,])/theta.sgd[i,]*100, ylab=paste0("% change in ", "theta","  with noise"), xlab="basis #", main = paste0("Region ", i))
}
```





#28 Apr 

##Sign wrong for L2 reg
I think I got the sign wrong for penalty, according to https://arxiv.org/pdf/1904.10939 C2 should be negative

Compare if sign had an effect,
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd5_loss_","_jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd7_loss_","_jobid_",10,".csv")))

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD","SGD_2","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD wrong penalty","SGD corrected penalty","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```



#1 May
##Simulation study
Sub-sample res3 by 1/10
```{r}
# res3.dat <- read_feather('/well/nichols/users/qcv214/bnn2/res3/res3_dat.feather') #dim = 4263 124859
res3.mask <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/res3mask.nii.gz')
res3.mask.reg <- setdiff(sort(unique(c(res3.mask))),0)
```

```{r}
masked.index <- seq_along(res3.mask[res3.mask>0])
res3.mask[res3.mask>0][(masked.index%%10)!=0] <- 0
res3.mask@datatype = 2
res3.mask@bitpix = 8
writeNIfTI(res3.mask,paste0('/well/nichols/users/qcv214/bnn2/res3/sim/res3_sub'))
```
```{r}
sub.res3.mask <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/sim/res3_sub.nii.gz')
sub.res3.mask.reg <- setdiff(sort(unique(c(res3.mask))),0)
```
```{r}
part_list<-read.table('/well/nichols/users/qcv214/Placement_2/participant_list.txt', header = FALSE, sep = "", dec = ".") #4529 participants
part_list$exist_vbm <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_list[,1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz'))
part_use<-part_list[part_list$exist_vbm==1,] #4263 participants left
# 
list_of_all_images<-paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_use[1:(dim(part_use)[1]),1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz')
sub.res3.dat <- fast_read_imgs_mask(list_of_all_images,'/well/nichols/users/qcv214/bnn2/res3/sim/res3_sub') # 4263 x 156812
#save datat
write_feather(as.data.frame(sub.res3.dat), '/well/nichols/users/qcv214/bnn2/res3/sim/sub_res3_dat.feather')
```


#2 May
##Plot `sim_hs`
```{r}
hs_2may<-array(,dim=c(20,13))
failed_run<-c(1)
for(i in setdiff(1:20,failed_run)){
      hs_2may[i,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hs_noscale_",i,".csv")))
}
hs_2may <- hs_2may[-failed_run,]
hs_2may.m<-apply(hs_2may, c(2), median)
hs_2may.m[6]

```


##Plot `sim_hs`
```{r}
poly_degree = 10
a_concentration = 0.5
b_smoothness = 40
wb_2may<-array(,dim=c(20,14))
failed_run<-c(1)
for(i in setdiff(1:20,failed_run)){
      wb_2may[i,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb_",poly_degree,a_concentration,b_smoothness,"_",i,".csv")))
}
wb_2may <- wb_2may[-failed_run,]
wb_2may.m<-apply(wb_2may, c(2), median)
wb_2may.m[6]
```

```{r}
plot(hs_2may[,6],ylim = c(4.5,5))
lines(wb_2may[,6],col='red')
abline(v=4)
```
From the plot, use `seed 4`

Sanity check if seed 4 of `sim_hs` and `sim_wb` give the same 
```{r}
ind.hs <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hs_index_",4,".csv"))
ind.wb <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb_index_",4,".csv"))
(sum(ind.hs[1,] == ind.wb[1,])) == 2000 #Yes
```

Load `nnvtrue`
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvtrue_loss__jobid_",1,".csv")))

full.res.out <- rbind( wb_2may[4,6],hs_2may[4,6],
                       sqrt(res.nn.loss.sgd.1[2,]))
full.res.in <- rbind(wb_2may[4,5],hs_2may[4,5],
                     sqrt(res.nn.loss.sgd.1[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
legend('topright',legend = c("method","SGD","GP Reg","HS-prior"),lty=c(1,c(1:3)), pch = c(1,c(1:3)),col=c("white",1,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
legend('topright',legend = c("method","SGD ","GP Reg","HS-prior"),lty=c(1,c(1:3)), pch = c(1,c(1:3)),col=c("white",1,6,2))
```



#3May

##Assess decreasing poly_degree
`sgd4.R` vs `sgd5.R`
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd5_loss_","_jobid_",3,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd6_loss_","_jobid_",13,".csv")))

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(3.5, max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","poly_deg = 10","poly_deg = 6","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","poly_deg = 10","poly_deg = 6","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```


##Assess changing penalty sign
`sgd5.R` vs `sgd6.R`
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd6_loss_","_jobid_",3,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd7_loss_","_jobid_",3,".csv")))

full.res.out <- rbind( wb_23mar.m[1,6],hs_31mar.m[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb_23mar.m[1,5],hs_31mar.m[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(3.5, max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD wrong penalty","SGD corrected penalty","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","SGD wrong penalty","SGD corrected penalty","GP Reg","HS-prior"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```




##For simulation
`gs_v_hs.R` is still not working, I keep getting `warning: chol(): given matrix is not symmetric`
Some are NA because it's my 4000 subjects don't span the entire 4xxx indices in dat.age
<<< Fix, see `gs_v_wb.R`

#5 May
##gs_v_wb
From looking at result of `gs_v_wb` and `gs_v_wb_test`, I have realised that `gs_v_wb` tries to achieve `sim_wb` parameters but cannot as the set of parameter isn't included


## wb2 vs Others

nn_v_wb2:Note that my sim_wb2 and gs uses poly deg = 10, but my nn will use poly_deg = 6

### First plot wb prediction against true
```{r}
#true age
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age <- age_tab$age
#wb2
wb2.ind.train <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))[1,])
wb2.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_noscale_",4,".csv")))
```
```{r}
plot(x=age[wb2.ind.train], y = wb2.pred.train, ylab="Predicted age (years)", xlab = "True age (years)", main = "True against Predicted age of GP Regression model")
abline(a=0,b=1,lwd=2,col="red")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width

```

###So let wb be the artificial data data, compare nn and hs against it

```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwb_loss__jobid_",1,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
legend('topright',legend = c("method","SGD vs GP-Reg","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:3)), pch = c(1,c(1:3)),col=c("white",1,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
legend('topright',legend = c("method","SGD vs GP-Reg","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:3)), pch = c(1,c(1:3)),col=c("white",1,6,2))
```

plot of predictions for HSP vs whole-brain
```{r}
wb2.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_inpred_noscale_",1,".csv")))
```
```{r}
plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Predicted age (years)", xlab = "Synthetic response (years)", main = "Synthetic response against HSP")
abline(a=0,b=1,lwd=2,col="red")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width

```
Calculate mean and variance of the differences between the coefficients
```{r}
hs.coef <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_coef_',1,'.feather')))[-1]
wb.coef <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_coef_',4,'.feather')))[-1]

summary(abs((hs.coef-wb.coef)/wb.coef))
```
```{r}
sum(sign(hs.coef)==sign(wb.coef))/length(hs.coef)
```


visualise wb2 as real then vs hs coefficients
```{r}
gp.mask.hs <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/sim/res3_sub.nii.gz')
gp.mask.hs[gp.mask.hs!=0] <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_coef_',4,'.feather')))[-1]
gp.mask.hs@datatype = 16
gp.mask.hs@bitpix = 32
writeNIfTI(gp.mask.hs,paste0('/well/nichols/users/qcv214/bnn2/res3/sim/viz/wb2_true'))
```

```{r}
gp.mask.hs <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/sim/res3_sub.nii.gz')
gp.mask.hs[gp.mask.hs!=0] <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_coef_',1,'.feather')))[-1]
gp.mask.hs@datatype = 16
gp.mask.hs@bitpix = 32
writeNIfTI(gp.mask.hs,paste0('/well/nichols/users/qcv214/bnn2/res3/sim/viz/hs_vs_wb2'))
```



#8 May

##Increasing number of basis


##More epochs

##Lower lr and more epochs

I am starting to think if I should set learning rate really low and let them use many epochs?


#9 May
6 updates
1. `nnvwb_highdeg` => Higher degree of polynomial
2. `nnvwb2` => increasing num epochs
3. `nnvwb3` => increasing num epochs AND decreasing lr to fixed at 0.05
4. `nnvwb_bayes` => the penalty Cv is updated after every iterations
5. `nnvwb_bayes_declr` => Updating Cv and decreasing lr
6. `nnvwb_bayes_sgld` => Updating Cv and SGLD


##Increasing poly deg
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwb_loss__jobid_",11,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwbhighdeg_loss__jobid_",11,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2, max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = c("method","polydeg=6","polydeg=15","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","polydeg=6","polydeg=15","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```


##Inc num epoch
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwb_loss__jobid_",1,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwb2_loss__jobid_",1,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","40 epochs", "200 epochs","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(0, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##Decreasing lr to 0.05
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwb2_loss__jobid_",9,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwb3_loss__jobid_",9,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","lr=0.6", "lr=0.05","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(0, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##CV bayes estimator
lr=0.6
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwb2_loss__jobid_",1,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwbbayes_loss__jobid_",11,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","fixed Cv", "Emp. Bayes Cv","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(0, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##CV bayes estimator wityh dec lr 
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwbbayes_loss__jobid_",11,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwbbayesdec_loss__jobid_",11,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","Fixed lr=0.6", "Decreasing lr","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(0, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##Bayes SGLD
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwbbayesdec_loss__jobid_",11,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvwbbayessgld_loss__jobid_",11,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","SGD", "SGLD","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(0, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('right',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
# legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```




#9 May
After meeting with Tom
1. Make a comparison graph to show the results of the downsmapling e.g. trade-off between speed and accuracy
2. Add gaussian noise using RMSE to the predicted age for simulated data 
3. Hyperprior
4. Assessing SGLD by comparing it's sd to RMSE

##Comparing normal data vs downsampled data
Only job id = 10 is comparable,
so `nnsgdlsgd7_loss__jobid_10.csvz` and `sim_nnvtrue_loss__jobid_10.csv`
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/nnsgdlsgd7_loss__jobid_10.csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_nnvtrue_loss__jobid_10.csv")))

full.res.out <- rbind( c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","Original NN", "Downsampled")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 1, ylim = c(4, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 3,lwd=2, lty=3)
# lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
# lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('right',legend = leglab,lty=c(1,c(1:2)),col=c("white",1,3))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 1, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 3,lwd=2, lty=3)
# lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
# lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:2)),col=c("white",1,3))
```

Computational time:
-full data: 1.25 minutes per iteration (or 75 seconds)
-Downsampled data: 7.5 seconds
*Coincidentally* downscaling by factor of 10 also reduce computational time by exactly 10 times per iterations

##Creating a realisation of random noise and add it to an existing file
```{r}
wb.in.pred<- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_noscale_",4,".csv")))
set.seed(2022)
wb.in.pred.addnoise <- rnorm(length(wb.in.pred),mean = wb.in.pred,sd = wb.res[5]) #rnorm()
write.csv(c(wb.in.pred.addnoise),paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv"), row.names = FALSE)
```
Plot the added noise
```{r}
plot(x=wb.in.pred,y=wb.in.pred.addnoise, ylab = "Synthetic response", xlab = "Predicted response", main = "Synthetic data")
abline(a=0,b=1,lwd=2,col="red")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```
##For out-of-sample prediction
Creating a realisation of random noise and add it to an existing file
```{r}
wb.out.pred<- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_noscale_",4,".csv")))
set.seed(2021) #Changed seeds
wb.out.pred.addnoise <- rnorm(length(wb.out.pred),mean = wb.out.pred,sd = wb.res[5]) #rnorm()
write.csv(c(wb.out.pred.addnoise),paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv"), row.names = FALSE)
```



Plot hsp vs simulated age
plot of predictions for HSP vs whole-brain
```{r}
wb2.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_inpred_noscale_",1,".csv")))
```
```{r}
plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Predicted age (years)", xlab = "Synthetic response (years)", main = "Synthetic response against HSP")
abline(a=0,b=1,lwd=2,col="red")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```

6 updates
1. `nnvwb_highdeg` => Higher degree of polynomial
2. `nnvwb2` => increasing num epochs
3. `nnvwb3` => increasing num epochs AND decreasing lr to fixed at 0.05
4. `nnvwb_bayes` => the penalty Cv is updated after every iterations
5. `nnvwb_bayes_declr` => Updating Cv and decreasing lr
6. `nnvwb_bayes_sgld` => Updating Cv and SGLD

## nnvwb
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwb_loss__jobid_",1,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
legend('topright',legend = c("method","SGD vs GP-Reg","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:3)), pch = c(1,c(1:3)),col=c("white",1,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
legend('topright',legend = c("method","SGD vs GP-Reg","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:3)), pch = c(1,c(1:3)),col=c("white",1,6,2))
```

##Increasing poly deg
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwb_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwbhighdeg_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2, max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = c("method","polydeg=6","polydeg=15","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","polydeg=6","polydeg=15","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```


##Inc num epoch
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwb_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwb2_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","40 epochs", "200 epochs","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##Decreasing lr to 0.05
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwb2_loss__jobid_",2,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwb4_loss__jobid_",2,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","lr=0.6", "lr=0.01","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##CV bayes estimator
lr=0.6
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwb2_loss__jobid_",13,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwbbayes_loss__jobid_",13,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","fixed Cv", "Emp. Bayes Cv","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##CV bayes estimator wityh dec lr 
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwbbayes_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwbbayesdec_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","Fixed lr=0.6", "Decreasing lr","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##Bayes SGLD
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwbbayesdec_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n9_nnvwbbayessgld_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","SGD", "SGLD","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
# legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```



#12 May
6 updates
1. `nnvwb_highdeg` => Higher degree of polynomial
2. `nnvwb2` => increasing num epochs
3. `nnvwb3` => increasing num epochs AND decreasing lr to fixed at 0.05
4. `nnvwb_bayes` => the penalty Cv is updated after every iterations
5. `nnvwb_bayes_declr` => Updating Cv and decreasing lr
6. `nnvwb_bayes_sgld` => Updating Cv and SGLD

## nnvwb
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb_loss__jobid_",10,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
legend('bottomright',legend = c("method","SGD vs GP-Reg","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:3)), pch = c(1,c(1:3)),col=c("white",1,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
legend('topright',legend = c("method","SGD vs GP-Reg","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:3)), pch = c(1,c(1:3)),col=c("white",1,6,2))
```

##Increasing poly deg
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwbhighdeg_loss__jobid_",10,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = c("method","polydeg=6","polydeg=15","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","polydeg=6","polydeg=15","GP-Reg vs truth","HSP vs GP-Reg"),lty=c(1,c(1:4)), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```


##Inc num epoch
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb2_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","40 epochs", "200 epochs","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##Decreasing lr to 0.01
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb2_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb4_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","lr=0.6", "lr=0.01","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##CV bayes estimator
lr=0.6
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb2_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwbbayes_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","fixed Cv", "Emp. Bayes Cv","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##CV bayes estimator wityh dec lr 
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwbbayes_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwbbayesdec_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","Fixed lr=0.6", "Decreasing lr","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

##Bayes SGLD
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwbbayesdec_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwbbayessgld_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","SGD", "SGLD","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```





#13 May

##SGLD with inverse-gamma 
Run after nnvwb4
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb4_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwbsgldig_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[6],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","SGD", "SGLD","GP-Reg vs truth","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:4)),col=c("white",1,3,6,2))
```

#15 May
##Compare RMSE of wb and hs
```{r}
hs.coef <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_coef_',1,'.feather')))[-1]
wb.coef <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_coef_',4,'.feather')))[-1]

summary(abs((hs.coef-wb.coef)/wb.coef))
sqrt(mean((hs.coef-wb.coef)^2)) #RMSE
sqrt(sum((wb.coef - hs.coef)**2)/sum((wb.coef - mean(wb.coef))**2)) #RRSE

1-sqrt(sum((wb.coef - hs.coef)^2)/sum((wb.coef - mean(wb.coef))^2)) #RRSE = 1-Rsq
```

##Compare distribution
```{r}
# plot(density(wb.coef),xlim= c(-3,3))
plot(density(hs.coef),xlim= c(-3,3), main = 'Coefficient Densities')
lines(density(wb.coef),col='red',lwd=2)
legend('topright',legend = c("True Coef", "HSP Coef"),lty=1,lwd = 2,col=c("red","black"))
```



##Plot hsp vs simulated age
plot of predictions for HSP vs whole-brain
```{r}
wb2.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_inpred_noscale_",1,".csv")))
```
```{r}
plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Predicted age (years)", xlab = "Synthetic response (years)", main = "Synthetic response against HSP (in-sample)")
abline(a=0,b=1,lwd=2,col="red")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```

```{r}
wb2.pred.test <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
hs.pred.test <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_outpred_noscale_",1,".csv")))
```
```{r}
plot(y=hs.pred.test, x = wb2.pred.test, ylab="HSP Predicted age (years)", xlab = "Synthetic response (years)", main = "Synthetic response against HSP (out-of-sample)")
abline(a=0,b=1,lwd=2,col="red")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```







#17 May

##Find R^2 of hsp
Beta RMSE may not be represenative as beta may not be unique due to collinearity 
```{r}
hs.res[1]
hs.res[3]
```

##Plot densities of coeff
```{r}
# plot(density(wb.coef),xlim= c(-3,3))
plot(density(hs.coef),xlim= c(-3,3), main = 'Coefficient Densities')
lines(density(wb.coef),col='red',lwd=2)
legend('topright',legend = c("True Coef", "HSP Coef"),lty=1,lwd = 2,col=c("red","black"))

plot(density(hs.coef),xlim= c(-0.45,0.45), main = 'Coefficient Densities')
lines(density(wb.coef),col='red',lwd=2)
legend('topright',legend = c("True Coef", "HSP Coef"),lty=1,lwd = 2,col=c("red","black"))

# plot(density(hs.coef),xlim= c(-0.35,-0.3), ylim = c(0,0.5), main = 'Coefficient Densities')
# lines(density(wb.coef),col='red',lwd=2)
# legend('topright',legend = c("True Coef", "HSP Coef"),lty=1,lwd = 2,col=c("red","black"))
```

#Show gridsearch result
truth: 
concentration = 2
smoothness = 40

Load grid search
```{r}
  deg_vec<- c(10)
  a_vec  <- c(1,2,3,4,5)
  b_vec  <- c(30,40,50,60,70,80,90,100)
  param_grid <- as.matrix(expand.grid(deg_vec,a_vec,b_vec))
  gs.opt <- matrix(,ncol=2,nrow = length(mask.reg))
for(i in sort(mask.reg)){
  gs.opt[which(i==(mask.reg)),]<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_gs_v_wb2_ROI_",i,".csv")))
}
# table(param_grid[gs.opt[,1],1])
table(param_grid[gs.opt[,1],2])/12
table(param_grid[gs.opt[,1],3])/12
```



##Plot all NNs
### nnvwb
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb_loss__jobid_",10,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]))
                     
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(min(full.res[1,,]), max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
legend('bottomright',legend = c("method","SGD vs GP-Reg","Synthetic noise","HSP vs GP-Reg"),lty=c(1,c(1:3)), pch = c(1,c(1:3)),col=c("white",1,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
legend('topright',legend = c("method","SGD vs GP-Reg","Synthetic noise","HSP vs GP-Reg"),lty=c(1,c(1:3)), pch = c(1,c(1:3)),col=c("white",1,6,2))
```

### Increasing poly deg
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwbhighdeg_loss__jobid_",10,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = c("method","polydeg=6","polydeg=15","Synthetic noise","HSP vs GP-Reg"),lty=c(1,c(1:2),1,1), pch = c(1,c(1:4)),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = c("method","polydeg=6","polydeg=15","Synthetic noise","HSP vs GP-Reg"),lty=c(1,c(1:2),1,1), pch = c(1,c(1:4)),col=c("white",1,3,6,2))
```


##Decreasing lr to 0.01
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb2_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb4_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","lr=0.6", "lr=0.01","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:2),1,1),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:2),1,1),col=c("white",1,3,6,2))
```


##Decreasing lr and extending epoch


##CV bayes estimator
lr=0.6
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwb2_loss__jobid_",5,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_nnvwbbayes_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","fixed Cv", "Emp. Bayes Cv","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:2),1,1),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:2),1,1),col=c("white",1,3,6,2))
```


##SGD with inverse-gamma
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",20,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwbig_loss__jobid_",20,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","SGD", "SGD-IG","Synthetic noise","HSP vs GP-Reg")

line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,])),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:2),1,1),col=c("white",1,3,6,2), pch = c(1,c(1:4)))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,]), max(full.res[2,,])),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "o", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "o", lty = 2,pch=2,col = 3,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:2),1,1),col=c("white",1,3,6,2), pch = c(1,c(1:4)))

```


##SGLD with inverse-gamma 
Run after nnvwb4
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwbsgldig_loss__jobid_",10,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","SGD", "SGLD","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:2),1,1),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:2),1,1),col=c("white",1,3,6,2))
```

##SGLD with inverse-gamma Compare
Run after nnvwb4
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwbsgldig_loss__jobid_",10,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwbsgldig3_loss__jobid_",10,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","SGD", "SGLD", "SGLD-reduced","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```

##SGLD with inverse-gamma vs hs
Run after nnvwb4
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwbsgldig_loss__jobid_",19,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwbsgldhc_loss__jobid_",19,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","SGD", "SGLD-IG", "SGLD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```


#21 May
Corrected Inverse-Gamma update
##SGLD with inverse-gamma Compare
Run after nnvwb4
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n21_nnvwbsgldig_loss__jobid_",11,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n21_nnvwbsgldig3_loss__jobid_",10,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","SGD", "SGLD", "SGLD-reduced","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```

#27 May

##SGLD Half Cauchy
25 May
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n21_nnvwbsgldig_loss__jobid_",11,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n25_nnvwbsgldhc_loss__jobid_",14,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","SGD", "SGLD-IG", "SGLD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```

##SGD with IG and Half Cauchy
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",16,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n26_nnvwbig_loss__jobid_",16,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n26_nnvwbhc_loss__jobid_",16,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out
```
```{r}
leglab <- c("method","SGD", "SGD-IG", "SGD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```

```{r}
density(c(beta_fit$HS %*% (relu.prime(bias+weights%*%res3.dat[1,])*weights)))
```



#5 June
Load compiled saliency from `saliency3.R`
load `sgld_ig4.R` and `sgld_hc3.R` for low starting noise SGLD

##Saliency variance
Use seed 11 
```{r}
saliency.array <- array(,dim=c(3,2000,p.dat))
for(e in c(100,150,200)){
  saliency.array[which(e==c(100,150,200)),,] <- as.matrix(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/saliencymatrix_j1_seed_',11,"_epoch_",e)))
}
saliency.array.m <-apply(saliency.array, c(1,3), var)
for(e in c(100,150,200)){
  print(summary(saliency.array.m[which(e==c(100,150,200)),]))
}

```
```{r}
boxplot(t(saliency.array.m), ylab="variance",main = "Voxel saliency variance by number of epochs", xlab="epochs")
```

```{r}
for(e in c(100,150,200)){
      gp.mask.hs <- res3.mask
      gp.mask.hs[gp.mask.hs!=0] <- saliency.array.m[which(e==c(100,150,200)),]
      gp.mask.hs@datatype = 16
      gp.mask.hs@bitpix = 32
      writeNIfTI(gp.mask.hs,paste0('/well/nichols/users/qcv214/bnn2/res3/sim/viz/saliency_variance_seed_',11,"_epoch_",e))
}
```
##SGLD IG and HC
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j1_nnvwbsgldig_loss__jobid_",5,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j1_nnvwbsgldhc_loss__jobid_",5,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-IG", "SGLD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```
```{r}
plot(y=(0.5+1:800)^-0.6/2,x=1:800,type='l', main= "Learning rate", ylab = "learning rate", xlab = "# iteration",lwd=2)
lines((50+1:800)^-0.9/2,col='red',lwd=2)
legend('topright',legend = c('High','Low'),lty=c(1,1),col=c(1,2))
```


#6 June

Transform saliency variance
Tom suggest can look at s.d. (e.g. sqrt the variance)
But doing log() can amplify the effect
so
```{r}
saliency.array <- array(,dim=c(3,2000,p.dat))
for(e in c(100,150,200)){
  saliency.array[which(e==c(100,150,200)),,] <- as.matrix(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/saliencymatrix_j1_seed_',11,"_epoch_",e)))
}
saliency.array.m <-apply(saliency.array, c(1,3), var)
saliency.array.m <- log(saliency.array.m + 1e-13)
for(e in c(100,150,200)){
  print(summary(saliency.array.m[which(e==c(100,150,200)),]))
}
#Box plot
boxplot(t(saliency.array.m), ylab="variance",main = "Voxel saliency variance by number of epochs", xlab="epochs")
#Save viz
for(e in c(100,150,200)){
      gp.mask.hs <- res3.mask
      gp.mask.hs[gp.mask.hs!=0] <- saliency.array.m[which(e==c(100,150,200)),]
      gp.mask.hs@datatype = 16
      gp.mask.hs@bitpix = 32
      writeNIfTI(gp.mask.hs,paste0('/well/nichols/users/qcv214/bnn2/res3/sim/viz/saliency_LOGvariance_seed_',11,"_epoch_",e))
}
```

visualising on FSLeyes will invert the image, so the sign will be flipped hence I will translate the image insteat
```{r}
saliency.array <- array(,dim=c(3,2000,p.dat))
for(e in c(100,150,200)){
  saliency.array[which(e==c(100,150,200)),,] <- as.matrix(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/saliencymatrix_j1_seed_',11,"_epoch_",e)))
}
saliency.array.m <-apply(saliency.array, c(1,3), var)
saliency.array.m <- log(saliency.array.m + 1e-13)+24
for(e in c(100,150,200)){
  print(summary(saliency.array.m[which(e==c(100,150,200)),]))
}
#Box plot
boxplot(t(saliency.array.m), ylab="variance",main = "Voxel saliency variance by number of epochs", xlab="epochs")
#Save viz
for(e in c(100,150,200)){
      gp.mask.hs <- res3.mask
      gp.mask.hs[gp.mask.hs!=0] <- saliency.array.m[which(e==c(100,150,200)),]
      gp.mask.hs@datatype = 16
      gp.mask.hs@bitpix = 32
      writeNIfTI(gp.mask.hs,paste0('/well/nichols/users/qcv214/bnn2/res3/sim/viz/saliency_translatedLOGvariance_seed_',11,"_epoch_",e))
}
```
Since log invert the effect,
Try squarerooting 
```{r}
saliency.array <- array(,dim=c(3,2000,p.dat))
for(e in c(100,150,200)){
  saliency.array[which(e==c(100,150,200)),,] <- as.matrix(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/saliencymatrix_j1_seed_',11,"_epoch_",e)))
}
saliency.array.m <-apply(saliency.array, c(1,3), sd)
# saliency.array.m <- log(saliency.array.m + 1e-13)
for(e in c(100,150,200)){
  print(summary(saliency.array.m[which(e==c(100,150,200)),]))
}
#Box plot
boxplot(t(saliency.array.m), ylab="variance",main = "Voxel saliency sd by number of epochs", xlab="epochs")
abline(h=0.0005,col='red')
# abline(h=0.0045,col='red')
#Save viz
for(e in c(100,150,200)){
      gp.mask.hs <- res3.mask
      gp.mask.hs[gp.mask.hs!=0] <- saliency.array.m[which(e==c(100,150,200)),]
      gp.mask.hs@datatype = 16
      gp.mask.hs@bitpix = 32
      writeNIfTI(gp.mask.hs,paste0('/well/nichols/users/qcv214/bnn2/res3/sim/viz/saliency_sd_seed_',11,"_epoch_",e))
}
```

Squarerooting s.d.
```{r}
saliency.array <- array(,dim=c(3,2000,p.dat))
for(e in c(100,150,200)){
  saliency.array[which(e==c(100,150,200)),,] <- as.matrix(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/saliencymatrix_j1_seed_',11,"_epoch_",e)))
}
saliency.array.m <-apply(saliency.array, c(1,3), sd)
saliency.array.m <- sqrt(saliency.array.m)
for(e in c(100,150,200)){
  print(summary(saliency.array.m[which(e==c(100,150,200)),]))
}
#Box plot
boxplot(t(saliency.array.m), ylab="variance",main = "Voxel saliency sd by number of epochs", xlab="epochs")
#Save viz
for(e in c(100,150,200)){
      gp.mask.hs <- res3.mask
      gp.mask.hs[gp.mask.hs!=0] <- saliency.array.m[which(e==c(100,150,200)),]
      gp.mask.hs@datatype = 16
      gp.mask.hs@bitpix = 32
      writeNIfTI(gp.mask.hs,paste0('/well/nichols/users/qcv214/bnn2/res3/sim/viz/saliency_sqrtsd_seed_',11,"_epoch_",e))
}
```


#7 June
Compare the SGLD with low and high learning rate
##Low
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j1_nnvwbsgldig_loss__jobid_",5,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j1_nnvwbsgldhc_loss__jobid_",5,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-IG", "SGLD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```

##High lr
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n21_nnvwbsgldig_loss__jobid_",11,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n25_nnvwbsgldhc_loss__jobid_",14,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-IG", "SGLD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```


#8 June
##Produce mean map of saliency
```{r}
saliency.array <- array(,dim=c(3,2000,p.dat))
for(e in c(100,150,200)){
  saliency.array[which(e==c(100,150,200)),,] <- as.matrix(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/saliencymatrix_j1_seed_',11,"_epoch_",e)))
}
saliency.array.m <-apply(saliency.array, c(1,3), mean)
# saliency.array.m <- log(saliency.array.m + 1e-13)
for(e in c(100,150,200)){
  print(summary(saliency.array.m[which(e==c(100,150,200)),]))
}
#Box plot
boxplot(t(saliency.array.m), ylab="variance",main = "Voxel saliency mean by number of epochs", xlab="epochs")
#Save viz
for(e in c(100,150,200)){
      gp.mask.hs <- res3.mask
      gp.mask.hs[gp.mask.hs!=0] <- saliency.array.m[which(e==c(100,150,200)),]
      gp.mask.hs@datatype = 16
      gp.mask.hs@bitpix = 32
      writeNIfTI(gp.mask.hs,paste0('/well/nichols/users/qcv214/bnn2/res3/sim/viz/saliency_mean_seed_',11,"_epoch_",e))
}
```

##SGLD with fixed lr = 0.043
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j8_nnvwbsgldig_loss__jobid_",5,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j8_nnvwbsgldhc_loss__jobid_",5,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-IG", "SGLD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```

##Look at 1 May for downscaling the study
Sub-sample res3 by 1/3 or 1/2
```{r}
# res3.dat <- read_feather('/well/nichols/users/qcv214/bnn2/res3/res3_dat.feather') #dim = 4263 124859
res3.mask <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/res3mask.nii.gz')
res3.mask.reg <- setdiff(sort(unique(c(res3.mask))),0)

masked.index <- seq_along(res3.mask[res3.mask>0])
res3.mask[res3.mask>0][(masked.index%%5)!=0] <- 0
res3.mask@datatype = 2
res3.mask@bitpix = 8
writeNIfTI(res3.mask,paste0('/well/nichols/users/qcv214/bnn2/res3/sim/res3_sub_5'))
```
I think 1/3 is decent 



#10 June

SGLD start from the beginning, with low lr = 7.513173e-07 did not work at all, the matrix decompositions in horseshoe prediction model fails after a number of epochs

So we only have SGLD with high lr = 0.043
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j8_longsgldig_loss__jobid_",5,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j8_longsgldhc_loss__jobid_",5,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-IG", "SGLD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j8_longsgldig_loss__jobid_",5,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j8_longsgldhc_loss__jobid_",5,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGD-IG", "SGD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```


From this observation, we may ignore the correspondence between LR and gaussian noise in SGLD, I think the lr can be kept fixed but the gaussian noise should be related to the actual size of theta, unless I am getting something wrong.



#12 June

Note that none of the SGLD with #sd of added noise = 0.293 all failed
And only a few of SGLD with #sd of added noise = 0.00122582 survived
pile/sim_j10_longsgldhc_loss__jobid_16.csv
pile/sim_j10_longsgldig_loss__jobid_18.csv
pile/sim_j10_longsgldig_loss__jobid_7.csv

```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j10_longsgldig_loss__jobid_",18,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j10_longsgldhc_loss__jobid_",16,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGD-IG", "SGD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```


#13 June

Jian suggest that I could look at 

#17 June 
Note after speaking with Tom and Jian's discussion
1. Run SGLD once SGD converged (or do "burn in" to ignore the first few iterations) =>no need for burn in if i always keep the the lr same
2. Assess the uncertainty or fluctation via computing the standard errors, means, standard deviations of EACH subject based on the number of iterations (n=number of iterations)
3. To compute posterior MSE, for each subject, compute the mean of the SGLD predictions and then compute MSE
4. To assess calibration,
  construct 95% posterior predictive interval (credible interval) captures true age 95% of the time.
  
#22 June
Look at sgld_ig6/hc6which produced `j22`
##Loss
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldig_loss__jobid_",14,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldhc_loss__jobid_",5,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-IG", "SGLD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```
##Prediction
###Read in the insample and outsample prediction for each
```{r}
p.in.ig <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldig_inpred__jobid_14.feather', columns = 1:8e5
))
p.out.ig <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldig_outpred__jobid_14.feather'))
p.in.hc <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldhc_inpred__jobid_5.feather'))
p.out.hc <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldhc_outpred__jobid_5.feather'))
```

#26 June
Above failed with loading data
##Loss
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldig_2_loss__jobid_",7,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldhc_2_loss__jobid_",16,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-IG", "SGLD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```
##Prediction
###Read in the insample and outsample prediction for each 
```{r}
p.in.ig <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldig_2_inpred__jobid_7.feather'))
p.out.ig <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldig_2_outpred__jobid_7.feather'))
p.in.hc <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldhc_2_inpred__jobid_16.feather'))
p.out.hc <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j22_nnvwbsgldhc_2_outpred__jobid_16.feather'))
```
Above doesn't work due to `Error in writeFeather(x, path) : Not compatible with STRSXP: [type=NULL].` which is because of denaming the columns

Test: writing feather without a name
```{r}
#Test: writing feather without a name
temp.f<-as.data.frame(matrix(1:4,nrow=2))
colnames(temp.f) <- NULL
# temp.f
colnames(temp.f) <- 1:ncol(temp.f)
write_feather(temp.f,'/well/nichols/users/qcv214/bnn2/res3/pile/temp_frame')
```


#27 June
##Loss
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j26_nnvwbsgldig_loss__jobid_",2,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j26_nnvwbsgldhc_loss__jobid_",2,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-IG", "SGLD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```
##Prediction
###Read in the insample and outsample prediction for each 
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j26_nnvwbsgldig_inpred__jobid_2.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j26_nnvwbsgldig_outpred__jobid_2.feather')))
p.in.hc <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j26_nnvwbsgldhc_inpred__jobid_2.feather')))
# p.out.hc <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j26_nnvwbsgldhc_outpred__jobid_2.feather'))
```

###Computing statistics
To compute any statistics based on row/column, use `aggregate`
First, turn the result into a dataframe
Consider in-sample only
```{r}
colnames(p.in.ig) <- c('id','pred')
colnames(p.in.hc) <- c('id','pred')
```

####For IG insample
in-sample statistics
```{r}
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/400)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)
```
Plot mean prediction against synthetic age

First load the synthetic age and its subject id
```{r}
wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
```
merge
```{r}
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')
```

```{r}
plot(y=stat.in.ig$mean, x = stat.in.ig$true, ylab="Mean Predicted age (years)", xlab = "Synthetic response (years)", main = "Synthetic response against SGLD")
abline(a=0,b=1,lwd=2,col="red")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```

Use prediction interval from https://en.wikipedia.org/wiki/Prediction_interval for the case of unknown mean and unknown variance
Note that n=400 and the dof=399 for T dist, the dof is large enough to make it look like a normal dist

95% prediction interval
```{r}
stat.in.ig$lwr <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$adjstderr
stat.in.ig$upr <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$adjstderr
```

```{r}
plot(y=stat.in.ig$mean, x = stat.in.ig$true, ylab="Mean Predicted age (years)", xlab = "Synthetic response (years)", main = "Synthetic response against SGLD")
abline(a=0,b=1,lwd=2,col="red")

points(stat.in.ig$lwr,x = stat.in.ig$true,col='red')
points(stat.in.ig$upr,x = stat.in.ig$true,col='blue' )

grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```

####Define proportion counting
```{r}
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwr[i],stat.in.ig$upr[i]))/400*100)
}
stat.in.ig$within.pred <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwr[i],stat.in.ig$upr[i])))
}
stat.in.ig$true.cover <- within.pred
```
Plot of predictions
```{r}
plot(y=stat.in.ig$within.pred,x=stat.in.ig$id,main = '% of predictions that lie within 95% Prediction Interval for each subject',
     xlab='Subject number',ylab='%', pch = 20)
abline(h=95,col='red',lwd=2)
```
```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.pred>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.cover)/2000*100))

```
Mean
s.d.

Plot of true
```{r}
no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwr[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$upr[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.cover[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.cover[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```

Check if true fall within 95% prediction coverage
```{r}
print(paste0('Proprtion of subject with true within 95%: ',sum(stat.in.ig$within.pred>=95)/2000*100))
```

Compute RMSE
```{r}
print(paste0('RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('True noise: 4.58'))
```



###For IG Out-of-sample
```{r}
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)
# plot(y=stat.out.ig$sd,x=stat.out.ig$id)
```
Plot mean prediction against synthetic age

First load the synthetic age and its subject id
```{r}
wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')
```
merge
```{r}
stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')
```

```{r}
plot(y=stat.out.ig$mean, x = stat.out.ig$true, ylab="Mean Predicted age (years)", xlab = "Synthetic response (years)", main = "Synthetic response against SGLD")
abline(a=0,b=1,lwd=2,col="red")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```

Use prediction interval from https://en.wikipedia.org/wiki/Prediction_interval for the case of unknown mean and unknown variance
Note that n=1600 and the dof=399 for T dist, the dof is large enough to make it look like a normal dist

95% prediction interval
```{r}
stat.out.ig$lwr <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$adjstderr
stat.out.ig$upr <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$adjstderr
```

```{r}
plot(y=stat.out.ig$mean, x = stat.out.ig$true, ylab="Mean Predicted age (years)", xlab = "Synthetic response (years)", main = "Synthetic response against SGLD")
abline(a=0,b=1,lwd=2,col="red")

points(stat.out.ig$lwr,x = stat.out.ig$true,col='red')
points(stat.out.ig$upr,x = stat.out.ig$true,col='blue' )

grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```

####Define proportion counting
```{r}
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwr[i],stat.out.ig$upr[i]))/1600*100)
}
stat.out.ig$within.pred <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwr[i],stat.out.ig$upr[i])))
}
stat.out.ig$true.cover <- within.pred
```
Plot
```{r}
plot(y=stat.out.ig$within.pred,x=stat.out.ig$id,main = '% of predictions lie within 95% Prediction Interval for each subject',
     xlab='Subject number',ylab='%', pch = 20)
abline(h=95,col='red',lwd=2)
```
```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.pred>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.cover)/2000*100))
```
```{r}
no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwr[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$upr[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.cover[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.cover[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```

Compute RMSE
```{r}
print(paste0('RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
```




#27 June
Compute the coverage rate for each subject according to the interval
Look at Marco's paper for age visualisation https://www.sciencedirect.com/science/article/pii/S1053811920304249?via%3Dihub
Rank age.... for coverage, compute the difference between  

#28 June
R-squared function
```{r}
rsqcal <- function(true,pred){
  RSS <-sum((true - pred)^2)
  TSS <- sum((true - mean(true))^2)
  return(1 - RSS/TSS)
}
```

```{r}
#SGLD
rsqcal(stat.in.ig$true,stat.in.ig$mean) # In-sample
rsqcal(stat.out.ig$true,stat.out.ig$mean) #Out-of-sample
#SGD
```

To get predictions from SGD, Load the parameters for SGD and do the matrix mult
Actually this may take some time, will skip for now
```{r}

```


#29 June

##I have run nnvwb5 with 400 epochs, now with predictions also to calculate the R^2

##Also after yesterday Tuesday meeting
I will re-calculate my prediction interval, now use Xbar ± T*sqrt(global MSE + point MSE/n) this means that as n gets large, gloval MSE will dominate for sure. And thus this is the case for out-of-sample prediction

###For IG insample
in-sample statistics
```{r}
stat.in.ig$stderrglob <- sqrt(wb.res[5]^2+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)
```

95% prediction interval
```{r}
stat.in.ig$lwrglob <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrglob
stat.in.ig$uprglob <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrglob
```

####Define proportion counting
```{r}
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrglob[i],stat.in.ig$uprglob[i]))/400*100)
}
stat.in.ig$within.predglob <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrglob[i],stat.in.ig$uprglob[i])))
}
stat.in.ig$true.coverglob <- within.pred
```
Plot of predictions
```{r}
plot(y=stat.in.ig$within.predglob,x=stat.in.ig$id,main = '% of predictions that lie within 95% Prediction Interval for each subject',
     xlab='Subject number',ylab='%', pch = 20)
abline(h=95,col='red',lwd=2)
```
```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predglob>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.coverglob)/2000*100))

```

Plot of true
```{r}
no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrglob[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprglob[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.coverglob[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.coverglob[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```


###For IG Out-of-sample
```{r}
stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)
```

Use prediction interval from https://en.wikipedia.org/wiki/Prediction_interval for the case of unknown mean and unknown variance
Note that n=1600 and the dof=399 for T dist, the dof is large enough to make it look like a normal dist

95% prediction interval
```{r}
stat.out.ig$lwrglob <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrglob
stat.out.ig$uprglob <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrglob
```

####Define proportion counting
```{r}
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrglob[i],stat.out.ig$uprglob[i]))/1600*100)
}
stat.out.ig$within.predglob <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrglob[i],stat.out.ig$uprglob[i])))
}
stat.out.ig$true.coverglob <- within.pred
```
Plot
```{r}
plot(y=stat.out.ig$within.predglob,x=stat.out.ig$id,main = '% of predictions lie within 95% Prediction Interval for each subject',
     xlab='Subject number',ylab='%', pch = 20)
abline(h=95,col='red',lwd=2)
```
```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predglob>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.coverglob)/2000*100))
```
```{r}
no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrglob[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprglob[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.coverglob[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.coverglob[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```
RMSE of true or rmse of the model


#3 July

Run nnvwb4 against nnbwb5
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_j29_nnvwb4_loss__jobid_",2,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGD_long","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
# lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('topright',legend = leglab,lty=c(1,c(1:2),1,1),col=c("white",1,3,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
# lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:2),1,1),col=c("white",1,3,6,2))
```
RMSE:
```{r}
sqrt(res.nn.loss.sgd.2[,1600])
```

Find R-square too
Load 
```{r}
p.in.sgd <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j29_nnvwb4_inpred__jobid_2.feather')))
p.out.sgd <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j29_nnvwb4_outpred__jobid_2.feather')))
colnames(p.in.sgd) <- c('id','pred')
colnames(p.out.sgd) <- c('id','pred')

```
In
```{r}
stat.in.sgd <- aggregate(.~id,data=p.in.sgd,FUN = tail, n = 1)
colnames(stat.in.sgd) <- c('id','pred')

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')

stat.in.sgd <- merge(stat.in.sgd,true.train, by = 'id')
```
Out
```{r}
stat.out.sgd <- aggregate(.~id,data=p.out.sgd,FUN = tail, n = 1)
colnames(stat.out.sgd) <- c('id','pred')


wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.sgd <- merge(stat.out.sgd,true.test, by = 'id')
```

```{r}
#SGLD
rsqcal(stat.in.sgd$true,stat.in.sgd$pred) # In-sample
rsqcal(stat.out.sgd$true,stat.out.sgd$pred) #Out-of-sample
#SGD
```


##variance using model MSE

(in-sample) model MSE:
```{r}
in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)
```

###For IG insample
in-sample statistics
```{r}
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)
```

95% prediction interval
```{r}
stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrmod
```

####Define proportion counting
```{r}
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/400*100)
}
stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred
```
Plot of predictions
```{r}
plot(y=stat.in.ig$within.predmod,x=stat.in.ig$id,main = '% of predictions that lie within 95% Prediction Interval for each subject',
     xlab='Subject number',ylab='%', pch = 20)
abline(h=95,col='red',lwd=2)
```
```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

```

Plot of true
```{r}
no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```


###For IG Out-of-sample
```{r}
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)
```

Use prediction interval from https://en.wikipedia.org/wiki/Prediction_interval for the case of unknown mean and unknown variance
Note that n=1600 and the dof=399 for T dist, the dof is large enough to make it look like a normal dist

95% prediction interval
```{r}
stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrmod
```

####Define proportion counting
```{r}
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/1600*100)
}
stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred
```
Plot
```{r}
plot(y=stat.out.ig$within.predmod,x=stat.out.ig$id,main = '% of predictions lie within 95% Prediction Interval for each subject',
     xlab='Subject number',ylab='%', pch = 20)
abline(h=95,col='red',lwd=2)
```
```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))
```
```{r}
no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```


##Compute R^2 of SGD

Load result to compre ==> pretty similar
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju3_nnvwb4_loss__jobid_",3,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,ncol(res.nn.loss.sgd.2)-ncol(res.nn.loss.sgd.1))), sqrt(res.nn.loss.sgd.2[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGD_long", "SGD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
# lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
# lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```
Load 
```{r}
p.in.sgd <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju3_nnvwb4_inpred__jobid_3.feather')))
p.out.sgd <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju3_nnvwb4_outpred__jobid_3.feather')))
colnames(p.in.sgd) <- c('id','pred')
colnames(p.out.sgd) <- c('id','pred')

```
In
```{r}
stat.in.sgd <- aggregate(.~id,data=p.in.sgd,FUN = tail, n = 1)
colnames(stat.in.sgd) <- c('id','pred')

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')

stat.in.sgd <- merge(stat.in.sgd,true.train, by = 'id')
```
Out
```{r}
stat.out.sgd <- aggregate(.~id,data=p.out.sgd,FUN = tail, n = 1)
colnames(stat.out.sgd) <- c('id','pred')


wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.sgd <- merge(stat.out.sgd,true.test, by = 'id')
```

```{r}
#SGLD
rsqcal(stat.in.sgd$true,stat.in.sgd$pred) # In-sample
rsqcal(stat.out.sgd$true,stat.out.sgd$pred) #Out-of-sample
#SGD
```


##Look as bias, some are 0... does that mean there are no updates and contributions from those regions
SGD
```{r}
(bias<- as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_bias__jobid_10.csv'))))
which(bias==0)
```
SGD-long
```{r}
(bias<- as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/pile/sim_j29_nnvwb4_bias__jobid_2.csv'))))
which(bias==0)
```
SGLD-IG
```{r}
(bias<- as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju3_nnvwbsgldig_bias__jobid_12.csv'))))
which(bias==0)
```


## Load results of sgld_ig/hc9
###Loss
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju3_nnvwbsgldig_loss__jobid_",12,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju3_nnvwbsgldhc_loss__jobid_",7,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-IG", "SGLD-HC","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```

## Predictive interval
###Using RMSE of True model

```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju3_nnvwbsgldig_inpred__jobid_12.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju3_nnvwbsgldig_outpred__jobid_12.feather')))
colnames(p.in.ig) <- c('id','pred')
```

####For IG insample
in-sample statistics
```{r}
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/400)
```

```{r}
wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
```

```{r}
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')
```

####For IG insample
in-sample statistics
```{r}
stat.in.ig$stderrglob <- sqrt(wb.res[5]^2+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)
```

95% prediction interval
```{r}
stat.in.ig$lwrglob <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrglob
stat.in.ig$uprglob <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrglob
```

#####Define proportion counting
```{r}
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrglob[i],stat.in.ig$uprglob[i]))/400*100)
}
stat.in.ig$within.predglob <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrglob[i],stat.in.ig$uprglob[i])))
}
stat.in.ig$true.coverglob <- within.pred
```
Plot of predictions
```{r}
# plot(y=stat.in.ig$within.predglob,x=stat.in.ig$id,main = '% of predictions that lie within 95% Prediction Interval for each subject',
#      xlab='Subject number',ylab='%', pch = 20)
# abline(h=95,col='red',lwd=2)
```
```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predglob>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.coverglob)/2000*100))

```

Plot of true
```{r}
no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrglob[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprglob[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.coverglob[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.coverglob[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```


####For IG Out-of-sample

```{r}
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)
```

```{r}
wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')
```

```{r}
stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)
```

Use prediction interval from https://en.wikipedia.org/wiki/Prediction_interval for the case of unknown mean and unknown variance
Note that n=1600 and the dof=399 for T dist, the dof is large enough to make it look like a normal dist

95% prediction interval
```{r}
stat.out.ig$lwrglob <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrglob
stat.out.ig$uprglob <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrglob
```

#####Define proportion counting
```{r}
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrglob[i],stat.out.ig$uprglob[i]))/1600*100)
}
stat.out.ig$within.predglob <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrglob[i],stat.out.ig$uprglob[i])))
}
stat.out.ig$true.coverglob <- within.pred
```
Plot
```{r}
# plot(y=stat.out.ig$within.predglob,x=stat.out.ig$id,main = '% of predictions lie within 95% Prediction Interval for each subject',
#      xlab='Subject number',ylab='%', pch = 20)
# abline(h=95,col='red',lwd=2)
```
```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predglob>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.coverglob)/2000*100))
```
```{r}
no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrglob[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprglob[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.coverglob[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.coverglob[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```


###Using RMSE of the fitted model
##variance using model MSE

(in-sample) model MSE:
```{r}
in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)
```

####For IG insample
in-sample statistics
```{r}
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)
```

95% prediction interval
```{r}
stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrmod
```

#####Define proportion counting
```{r}
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/400*100)
}
stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred
```
Plot of predictions
```{r}
# plot(y=stat.in.ig$within.predmod,x=stat.in.ig$id,main = '% of predictions that lie within 95% Prediction Interval for each subject',
#      xlab='Subject number',ylab='%', pch = 20)
# abline(h=95,col='red',lwd=2)
```
```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

```

Plot of true
```{r}
no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```


####For IG Out-of-sample
```{r}
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)
```

Use prediction interval from https://en.wikipedia.org/wiki/Prediction_interval for the case of unknown mean and unknown variance
Note that n=1600 and the dof=399 for T dist, the dof is large enough to make it look like a normal dist

95% prediction interval
```{r}
stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrmod
```

#####Define proportion counting
```{r}
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/1600*100)
}
stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred
```
Plot
```{r}
# plot(y=stat.out.ig$within.predmod,x=stat.out.ig$id,main = '% of predictions lie within 95% Prediction Interval for each subject',
#      xlab='Subject number',ylab='%', pch = 20)
# abline(h=95,col='red',lwd=2)
```
```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))
```
```{r}
no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```
RMSE and Rsq

```{r}
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
```
```{r}
#SGLD
rsqcal(stat.in.ig$true,stat.in.ig$mean) # In-sample
rsqcal(stat.out.ig$true,stat.out.ig$mean) #Out-of-sample

```

#6 July

Plot of predictions against truth

```{r}
plot(y=stat.in.ig$mean, x = stat.in.ig$true, ylab="Mean Predicted age (years)", xlab = "Synthetic response (years)", main = "Synthetic response against SGLD")
abline(a=0,b=1,lwd=2,col="red")
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
```
correlation
```{r}
cor(y=stat.in.ig$mean-stat.in.ig$true, x = stat.in.ig$true) #Correlation of brain age delta and true age 
```
This shows underestimation for higher age and overestimatikon for lower age

```{r}
plot(y=stat.out.ig$mean, x = stat.out.ig$true, ylab="Mean Predicted age (years)", xlab = "Synthetic response (years)", main = "Synthetic response against SGLD")
abline(a=0,b=1,lwd=2,col="red")
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)  
```
correlation
```{r}
cor(y=stat.out.ig$mean-stat.out.ig$true, x = stat.out.ig$true) #Correlation of brain age delta and true age 
```
This shows underestimation for higher age and overestimatikon for lower age

#7 July
##Assessing how initial randomisation affect the importance of regions/bias

###SGD 
```{r}
for(i in c(10,3,4,9,20)){
  bias <- as.vector(unlist(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_bias__jobid_',i,'.csv'))))
  print(paste0('Max: ', max(bias),', Min: ', min(bias), ', Inactive: '))
  print(which(bias==0))
}
```
Appears at random

Look at the theta/basis or weights of the NN... but in fact theta is allowed to adapt over time evven without loss, this is from the l2 regularisa5tion (weight decay)... perhaps look at initialisation of seed 4, but then to get the exact same answer... hm
Perhaps look at theta
```{r}
# write_feather(as.data.frame(weights),paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_weights_',"_jobid_",4,'.feather'))
nn.theta<- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_theta_',"_jobid_",4,'.feather')))
summary(t(nn.theta)[])
```

Look at results
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",3,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",9,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",20,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))

full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]))


full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","bias=0|5 silent", "bias=0|3 silent", "bias=0|3 silent","bias=0|4 silent","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 4,pch=3,col = 5,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4),1,1),col=c("white",1,3,4,5,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[2,6,], type = "l", lty = 4,pch=3,col = 5,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4),1,1),col=c("white",1,3,4,5,6,2))
```

###SGD_long
```{r}
for(i in c(2,7,8)){
  bias <- as.vector(unlist(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/sim_j29_nnvwb4_bias__jobid_',i,'.csv'))))
  print(paste0('Max: ', max(bias),', Min: ', min(bias), ', Inactive: '))
  print(which(bias==0))
}
```
Also appears random

###SGLD_IG
```{r}
for(i in c(1,3,5,12)){
  bias <- as.vector(unlist(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju3_nnvwbsgldig_bias__jobid_',i,'.csv'))))
  print(paste0('Max: ', max(bias),', Min: ', min(bias), ', Inactive: '))
  print(which(bias==0))
}
```
Tends to be 0 inactive regions



#11 July

Some notes for what to do
1. Include a range of different initial prior variance for sgd (previously done)
2. Assess the effects of hyperpriors and systematically compare it to doing gridsearch THIS IS FOR SGD 
2.1 Contrast the hyperpriors with empirical updates
3. Assess different parameterisation of GP (currently done via gridsearch)
4. Average across runs to assess different initial conditions? To assess non-identifiability
5. Re do the real-data comparison
6.ACTUALLY do  different number of injected noise in LD, and see if fitted MSE is the same, but the personal variance is different.
7. Contrast inverse gamma hyperprior and half cauchy hyperprior
8. Contrast 

#14 July
##Bias
Look at `nnvwb6` for initialising bias to be 0.01
###SGD 
```{r}
for(i in c(10,2,3,4,7)){
  bias <- as.vector(unlist(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju12_nnvwb4_bias__jobid_',i,'.csv'))))
  print(paste0('Max: ', max(bias),', Min: ', min(bias), ', Inactive: '))
  print(which(bias==0.01)) ##0.01
}
```
####Look at the result
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju12_nnvwb4_loss__jobid_",2,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju12_nnvwb4_loss__jobid_",7,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju12_nnvwb4_loss__jobid_",10,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))


full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]))


full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","bias=0|5 silent", "bias=0.1|3 silent", "bias=0.1|4 silent","bias=0.1|6 silent","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 4,pch=3,col = 5,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4),1,1),col=c("white",1,3,4,5,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[2,6,], type = "l", lty = 4,pch=3,col = 5,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4),1,1),col=c("white",1,3,4,5,6,2))
```

##personal variance
Look at magnitude of individual variance.
```{r}
summary(stat.in.ig$sd^2)
summary(stat.out.ig$sd^2)
```


#15 July

##Changing hyperprior params
Changing inverse gamma distribution  from (3,0.5) to (1,1) ACTUALLY this become negligible from the updates 

job 5,15,20 survived
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",10,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju3_nnvwbsgldig_loss__jobid_",12,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju14_nnvwbsgldig_loss__jobid_",20,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-IG(3,0.5)", "SGLD-IG(1,1)","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)

legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))
```
This shows that even though the initial distribution looks very different, it will eventually be the same from the conjugate updates


##Point 2 from the goal
Assess the effects of hyperpriors and systematically compare it to doing gridsearch THIS IS FOR SGD

So for inverse gamma I have `nnvwbig3_initvarlR` which completes jib8,9, 11,16,17 and corresponds to var = `0.1,0,5,0.5,1,10`
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",16,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",8,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",9,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",16,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",17,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","GS", "0.1", "0.5","1","10","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 4,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 5,pch=3,col = 7,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[2,6,], type = "l", lty = 4,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 5,pch=3,col = 7,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:5),1,1),col=c("white",1,3,4,5,7,6,2))
```


#16 July
##Point 2 initial variance assessment
Assess different static SGD initial variance`nnvwb7_initvar.R`
successful run: `1,3,5,6,7,8,12,13,14,16,17`
```{r}
prior.var.mat[c(1,3,5,6,7,8,12,13,14,16,17),2]
```
want 8,12,16,17

```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",16,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",8,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",9,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",16,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",17,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","GS", "0.1", "0.5","1","10","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 4,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 5,pch=3,col = 7,lwd=1)
legend('bottomright',legend = leglab,lty=c(1,c(1:3),1,1),col=c("white",1,3,4,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[2,6,], type = "l", lty = 4,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 5,pch=3,col = 7,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:5),1,1),col=c("white",1,3,4,5,7,6,2))
```

##Compare SGD with and without hyperprior
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",16,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",8,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",9,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",16,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",17,".csv")))
#hyperprior
res.nn.loss.sgd.6 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",8,".csv")))
res.nn.loss.sgd.7 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",9,".csv")))
res.nn.loss.sgd.8 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",16,".csv")))
res.nn.loss.sgd.9 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",17,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]),
                       sqrt(res.nn.loss.sgd.6[2,]),sqrt(res.nn.loss.sgd.7[2,]),sqrt(res.nn.loss.sgd.8[2,]),sqrt(res.nn.loss.sgd.9[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]),
                     sqrt(res.nn.loss.sgd.6[1,]),sqrt(res.nn.loss.sgd.7[1,]),sqrt(res.nn.loss.sgd.8[1,]),sqrt(res.nn.loss.sgd.9[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","GS", "0.1", "0.5","1","10","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[1,8,], type = "b", lty = 2,pch=3,col = 3,lwd=1)
lines(full.res[1,9,], type = "b", lty = 2,pch=3,col = 4,lwd=1)
lines(full.res[1,10,], type = "b", lty = 2,pch=3,col = 5,lwd=1)
lines(full.res[1,11,], type = "b", lty = 2,pch=3,col = 7,lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[2,8,], type = "b", lty = 2,pch=3,col = 3,lwd=.2)
lines(full.res[2,9,], type = "b", lty = 2,pch=3,col = 4,lwd=.2)
lines(full.res[2,10,], type = "b", lty = 2,pch=3,col = 5,lwd=.2)
lines(full.res[2,11,], type = "b", lty = 2,pch=3,col = 7,lwd=.2)
legend('topright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))
```
#18 July

Tom suggests doing the predictive interval plot without personal variance

####For IG insample
in-sample statistics
```{r}
stat.in.ig$modmse <- sqrt(in.mse)
```

95% prediction interval
```{r}
stat.in.ig$lwrmodmse <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$modmse
stat.in.ig$uprmodmse <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$modmse
```

#####Define proportion counting
```{r}
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i]))/400*100)
}
stat.in.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i])))
}
stat.in.ig$true.covermodmse <- within.pred
```
Plot of predictions
```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermodmse)/2000*100))

```

Plot of true
```{r}
no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmodmse[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmodmse[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermodmse[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermodmse[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```


####For IG Out-of-sample
```{r}
stat.out.ig$modmsemse <- sqrt(in.mse)
```

Use prediction interval from https://en.wikipedia.org/wiki/Prediction_interval for the case of unknown mean and unknown variance
Note that n=1600 and the dof=399 for T dist, the dof is large enough to make it look like a normal dist

95% prediction interval
```{r}
stat.out.ig$lwrmodmse <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$modmse
stat.out.ig$uprmodmse <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$modmse
```

#####Define proportion counting
```{r}
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i]))/1600*100)
}
stat.out.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i])))
}
stat.out.ig$true.covermodmse <- within.pred
```
Plot

```{r}
print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermodmse)/2000*100))
```
```{r}
no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmodmse[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmodmse[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermodmse[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermodmse[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)
```
RMSE and Rsq

```{r}
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
```


#20 July

##Low init variance
Look at jobs done
```{r}
prior.var.mat <- expand.grid(1:10,c(0.001,0.01))
prior.var.mat[c(1,16,20,10,13,16,9),2]
```


Compare method
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",16,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",8,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",9,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju18_nnvwb4_lowinitvar_loss__jobid_",16,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju18_nnvwb4_lowinitvar_loss__jobid_",1,".csv")))
#hyperprior
res.nn.loss.sgd.6 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",8,".csv")))
res.nn.loss.sgd.7 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",9,".csv")))
res.nn.loss.sgd.8 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju18_nnvwbig_lowinitvar_loss__jobid_",16,".csv")))
res.nn.loss.sgd.9 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju18_nnvwbig_lowinitvar_loss__jobid_",9,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]),
                       sqrt(res.nn.loss.sgd.6[2,]),sqrt(res.nn.loss.sgd.7[2,]),sqrt(res.nn.loss.sgd.8[2,]),sqrt(res.nn.loss.sgd.9[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]),
                     sqrt(res.nn.loss.sgd.6[1,]),sqrt(res.nn.loss.sgd.7[1,]),sqrt(res.nn.loss.sgd.8[1,]),sqrt(res.nn.loss.sgd.9[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","GS", "0.1", "0.5","0.01","0.001","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[1,8,], type = "b", lty = 2,pch=3,col = 3,lwd=1)
lines(full.res[1,9,], type = "b", lty = 2,pch=3,col = 4,lwd=1)
lines(full.res[1,10,], type = "b", lty = 2,pch=3,col = 5,lwd=1)
lines(full.res[1,11,], type = "b", lty = 2,pch=3,col = 7,lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[2,8,], type = "b", lty = 2,pch=3,col = 3,lwd=.2)
lines(full.res[2,9,], type = "b", lty = 2,pch=3,col = 4,lwd=.2)
lines(full.res[2,10,], type = "b", lty = 2,pch=3,col = 5,lwd=.2)
lines(full.res[2,11,], type = "b", lty = 2,pch=3,col = 7,lwd=.2)
legend('topright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))
```

#23 July

##Assess Empirical bayes variance
```{r}
prior.var.mat <- expand.grid(1:25,c(0.001,0.01,0.1,0.5))
prior.var.mat[c(11,27,52,79),2]
```
11,27,52,79 corresponds to 0.001,0.01,0.1,0.5
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",16,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju20_nnvwbbayes_initvar_loss__jobid_",52,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju20_nnvwbbayes_initvar_loss__jobid_",79,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju20_nnvwbbayes_initvar_loss__jobid_",27,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju20_nnvwbbayes_initvar_loss__jobid_",11,".csv")))
#hyperprior
res.nn.loss.sgd.6 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",8,".csv")))
res.nn.loss.sgd.7 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",9,".csv")))
res.nn.loss.sgd.8 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju18_nnvwbig_lowinitvar_loss__jobid_",16,".csv")))
res.nn.loss.sgd.9 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju18_nnvwbig_lowinitvar_loss__jobid_",9,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]),
                       sqrt(res.nn.loss.sgd.6[2,]),sqrt(res.nn.loss.sgd.7[2,]),sqrt(res.nn.loss.sgd.8[2,]),sqrt(res.nn.loss.sgd.9[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]),
                     sqrt(res.nn.loss.sgd.6[1,]),sqrt(res.nn.loss.sgd.7[1,]),sqrt(res.nn.loss.sgd.8[1,]),sqrt(res.nn.loss.sgd.9[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","GS", "0.1", "0.5","0.01","0.001","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[1,8,], type = "b", lty = 2,pch=3,col = 3,lwd=1)
lines(full.res[1,9,], type = "b", lty = 2,pch=3,col = 4,lwd=1)
lines(full.res[1,10,], type = "b", lty = 2,pch=3,col = 5,lwd=1)
lines(full.res[1,11,], type = "b", lty = 2,pch=3,col = 7,lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 1,pch=2,col = 3,lwd=3)
lines(full.res[2,5,], type = "l", lty = 1,pch=3,col = 4,lwd=3)
lines(full.res[2,6,], type = "l", lty = 1,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[2,8,], type = "b", lty = 2,pch=3,col = 3,lwd=.2)
lines(full.res[2,9,], type = "b", lty = 2,pch=3,col = 4,lwd=.2)
lines(full.res[2,10,], type = "b", lty = 2,pch=3,col = 5,lwd=.2)
lines(full.res[2,11,], type = "b", lty = 2,pch=3,col = 7,lwd=.2)
legend('topright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))
```
###Assess the end variance of theta
```{r}
 theta.sd.mat <- matrix(,ncol=12,nrow = 4)
 counter <- 1
 for(i in c(11,27,52,79)){
   theta.sgd <- as.matrix(read_feather(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju20_nnvwbbayes_initvar_theta_","_jobid_",i,".feather")))
   theta.sd.mat[counter,] <- apply(theta.sgd, 1, var)
   counter <- counter+1
 }

 plot(theta.sd.mat[1,], ylim = c(0,7), type = "o", lty = 1,pch=1, ylab="var", main = "Region-wise var after 240 iterations", xlab='Region number')
 lines(theta.sd.mat[2,], type = "o", lty = 2,pch=2,col = 3)
 lines(theta.sd.mat[3,], type = "o", lty = 2,pch=2,col = 4)
 lines(theta.sd.mat[4,], type = "o", lty = 2,pch=2,col = 5)

 abline(h=0.1,lty=1,col='grey')
 abline(h=0.5,lty=1,col='grey')
 abline(h=0.01,lty=1,col='grey')
 abline(h=0.001,lty=1,col='grey')
 legend('topright',legend = c(expression(tau^2),as.character(c(0.001,0.01,0.1,0.5))),lty=c(1,1,2,2,2), pch = c(1,1,2,2,2),col=c("white",1,3:5))
```
I have just noticed that for the above, the learning rate was set to be 0.6, hence the fast learning at the beginning

##Assess IG updates with IG-random initial value
Only jobid (15,17,20)
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",16,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",8,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwb4_loss__jobid_",9,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju18_nnvwb4_lowinitvar_loss__jobid_",16,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju18_nnvwb4_lowinitvar_loss__jobid_",1,".csv")))
#hyperprior
res.nn.loss.sgd.6 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju20_nnvwbig_raninitvar_loss__jobid_",15,".csv")))
res.nn.loss.sgd.7 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju20_nnvwbig_raninitvar_loss__jobid_",17,".csv")))
res.nn.loss.sgd.8 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju20_nnvwbig_raninitvar_loss__jobid_",20,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]),
                       sqrt(res.nn.loss.sgd.6[2,]),sqrt(res.nn.loss.sgd.7[2,]),sqrt(res.nn.loss.sgd.8[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]),
                     sqrt(res.nn.loss.sgd.6[1,]),sqrt(res.nn.loss.sgd.7[1,]),sqrt(res.nn.loss.sgd.8[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","GS", "0.1", "0.5","0.01","0.001","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[1,8,], type = "b", lty = 2,pch=3,col = 8,lwd=1)
lines(full.res[1,9,], type = "b", lty = 2,pch=3,col = 9,lwd=1)
lines(full.res[1,10,], type = "b", lty = 2,pch=3,col = 10,lwd=1)
# lines(full.res[1,11,], type = "b", lty = 2,pch=3,col = 7,lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[2,8,], type = "b", lty = 2,pch=3,col = 8,lwd=.2)
lines(full.res[2,9,], type = "b", lty = 2,pch=3,col = 9,lwd=.2)
lines(full.res[2,10,], type = "b", lty = 2,pch=3,col = 10,lwd=.2)
# lines(full.res[2,11,], type = "b", lty = 2,pch=3,col = 7,lwd=.2)
legend('topright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))
```
Actually not bad


#24 July
##Assess Empirical bayes variance
```{r}
prior.var.mat <- expand.grid(1:25,c(0.001,0.01,0.1,0.5))
prior.var.mat[c(10,26,53,77),2]
```
11,27,52,79 corresponds to 0.001,0.01,0.1,0.5
53,77
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n16_nnvwb4_loss__jobid_",16,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju24_nnvwbbayes_initvar_loss__jobid_",62,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju24_nnvwbbayes_initvar_loss__jobid_",89,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju24_nnvwbbayes_initvar_loss__jobid_",26,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju24_nnvwbbayes_initvar_loss__jobid_",10,".csv")))
#hyperprior
res.nn.loss.sgd.6 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",8,".csv")))
res.nn.loss.sgd.7 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju15_nnvwbig_loss__jobid_",9,".csv")))
res.nn.loss.sgd.8 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju18_nnvwbig_lowinitvar_loss__jobid_",16,".csv")))
res.nn.loss.sgd.9 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju18_nnvwbig_lowinitvar_loss__jobid_",9,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]),
                       sqrt(res.nn.loss.sgd.6[2,]),sqrt(res.nn.loss.sgd.7[2,]),sqrt(res.nn.loss.sgd.8[2,]),sqrt(res.nn.loss.sgd.9[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]),
                     sqrt(res.nn.loss.sgd.6[1,]),sqrt(res.nn.loss.sgd.7[1,]),sqrt(res.nn.loss.sgd.8[1,]),sqrt(res.nn.loss.sgd.9[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","GS", "0.1", "0.5","0.01","0.001","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[1,8,], type = "b", lty = 2,pch=3,col = 3,lwd=1)
lines(full.res[1,9,], type = "b", lty = 2,pch=3,col = 4,lwd=1)
lines(full.res[1,10,], type = "b", lty = 2,pch=3,col = 5,lwd=1)
lines(full.res[1,11,], type = "b", lty = 2,pch=3,col = 7,lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 1,pch=2,col = 3,lwd=3)
lines(full.res[2,5,], type = "l", lty = 1,pch=3,col = 4,lwd=3)
lines(full.res[2,6,], type = "l", lty = 1,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[2,8,], type = "b", lty = 2,pch=3,col = 3,lwd=.2)
lines(full.res[2,9,], type = "b", lty = 2,pch=3,col = 4,lwd=.2)
lines(full.res[2,10,], type = "b", lty = 2,pch=3,col = 5,lwd=.2)
lines(full.res[2,11,], type = "b", lty = 2,pch=3,col = 7,lwd=.2)
legend('topright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))
```
For empirical bayes, 0.1 and 0.5 seem to have faster convergence than inverse gamma (it's all by chance).



#25 July

##Observe different distribution of invgamma
```{r}
install.packages("invgamma")
library(invgamma)
```

```{r}
plot(density(rinvgamma(n=100000,shape=3,rate=0.5)), ylab = "p(x)", main = "Densities of IG distributions", xlim = c(0,15))
lines(density(rinvgamma(n=100000,shape=1,rate=0.5)),col='red')
```
```{r}
x.temp <- rinvgamma(n=100000,shape=1,rate=1)
x.temp.norm <- (x.temp - mean(x.temp))/sd(x.temp)
plot(density(x.temp.norm), xlim = c(0,5))
# plot(density(rinvgamma(n=1000000,shape=1,rate=1)),xlim=c(0,1000))
```
```{r}
plot(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),1,0.5),type='l')
```
Plot via density `dinvgamma`
```{r}
plot(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),3,0.5), ylab = "p(x)", main = "Densities of IG distributions",type='l',col='red',xlab='x')
lines(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),1,0.5),col='blue')
legend('topright',legend = c(paste0("IG(3,0.5)")
                             ,paste0("IG(1,0.5)")),lty=c(1),col=c("red",'blue'))
```
```{r}
plot(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),shape=3,rate=0.5), ylab = "p(x)", main = "Densities of IG distributions",type='l',col='red',xlab='x')
lines(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),shape=1,rate=0.5),col='blue')
legend('topright',legend = c(paste0("IG(3,0.5)")
                             ,paste0("IG(1,0.5)")),lty=c(1),col=c("red",'blue'))
```

```{r}
plot(density(runif(100000,min=50,max=100)))
```

Shape determines the "peakiness', the lower, the more towards uniform
Rate determines location of peak

##Assess stability

###Peak Gamma, a = 3, beta = 0.5

```{r}
runs <- c(10,12,14,15,16,18,20,23,26,27,36,4,42,44,45,50,6,8,9)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_peakran_loss__jobid_",i,".csv")))
    
}
```

/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_peakran_loss__jobid_10.csv
12,14,15,16,18,20,23,26,27,36,4,42,44,45,50,6,8,9

```{r}
# library(ggplot2)
# set.seed(47)
ggplot(tibble::tibble(x = rep(1:800,19), 
                       y = sqrt(c(t(res.mat[2,,]))))
                      # y= rnorm(20)*x)
                      , aes(x, y)) +
geom_point(alpha = 0.1) +
geom_smooth(fill = 'darkblue') +
geom_smooth(stat = 'summary', color = 'red', fill = 'red', alpha = 0.2,
            fun.data = median_hilow, fun.args = list(conf.int = 0.5))

```

Plot using normal plot
Finding IQR
```{r}
runs <- c(10,12,14,15,16,18,20,23,26,27,36,4,42,44,45,50,6,8,9)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_peakran_loss__jobid_",i,".csv")))
}
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x = rep(1:800,19), y = sqrt(c(t(res.mat[2,,]))))
lines(x=1:800,y=sqrt(res.iqr[2,]),col='blue',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[1,]),col='red',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='red',lwd=2)

res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x = rep(1:800,19), y = sqrt(c(t(res.mat[1,,]))))
lines(x=1:800,y=sqrt(res.iqr[2,]),col='blue',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[1,]),col='red',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='red',lwd=2)
```
Plot without datapoints
```{r}
runs <- c(10,12,14,15,16,18,20,23,26,27,36,4,42,44,45,50,6,8,9)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_peakran_loss__jobid_",i,".csv")))
}
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x = 1:800,y=sqrt(res.iqr[2,]),col='blue',lwd=2, type = 'l',main = paste0("Test RMSE, (n = ",length(runs), ")"))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='red',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='red',lwd=2)

res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='blue',lwd=2, type = 'l',
     main = paste0("Train RMSE, (n = ",length(runs), ")"))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='red',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='red',lwd=2)
```


###Peak Gamma, a = 1, beta = 0.5

```{r}
runs <- c(11,13,14,2,20,24,26,28,29,30,31,36,40,41,43,5,6,8)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_unfran_loss__jobid_",i,".csv")))
}
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x = rep(1:800,length(runs)), y = sqrt(c(t(res.mat[2,,]))))
lines(x=1:800,y=sqrt(res.iqr[2,]),col='blue',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[1,]),col='red',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='red',lwd=2)

res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x = rep(1:800,length(runs)), y = sqrt(c(t(res.mat[1,,]))))
lines(x=1:800,y=sqrt(res.iqr[2,]),col='blue',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[1,]),col='red',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='red',lwd=2)
```
```{r}
runs <- c(11,13,14,2,20,24,26,28,29,30,31,36,40,41,43,5,6,8)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_unfran_loss__jobid_",i,".csv")))
}
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x = 1:800,y=sqrt(res.iqr[2,]),col='blue',lwd=2, type = 'l',main = paste0("Test RMSE, (n = ",length(runs), ")"))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='red',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='red',lwd=2)

res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='blue',lwd=2, type = 'l',main = paste0("Train RMSE, (n = ",length(runs), ")"))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='red',lwd=2)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='red',lwd=2)
```

###Put everything into one graph
```{r}
runs <- c(10,12,14,15,16,18,20,23,26,27,36,4,42,44,45,50,6,8,9)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_peakran_loss__jobid_",i,".csv")))
}

runs2 <- c(11,13,14,2,20,24,26,28,29,30,31,36,40,41,43,5,6,8)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_unfran_loss__jobid_",i,".csv")))
}

res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x = 1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=1)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=1)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=1)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c(paste0("IG(3,0.5)",", n=",length(runs))
                             ,paste0("IG(1,0.5)",", n=",length(runs2))),lty=c(1),col=c("red",'blue'))

res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=1)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=1)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=1)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c(paste0("IG(3,0.5)",", n=",length(runs))
                             ,paste0("IG(1,0.5)",", n=",length(runs2))),lty=c(1),col=c("red",'blue'))
```

##Stability of empirical bayes
```{r}
prior.var.mat <- expand.grid(1:25,c(0.001,0.01,0.1,0.5))
```

```{r}
runs <- c(10,14,15,17,18,2,4)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju24_nnvwbbayes_initvar_loss__jobid_",i,".csv")))
}

runs2 <- c(53,55,57,59,62,63,71,73,77,78,81,89,90,94)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju24_nnvwbbayes_initvar_loss__jobid_",i,".csv")))
}

res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x = 1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=1)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=1)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=1)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2) 
legend('topright',legend = c(paste0("EB-0.001",", n=",length(runs))
                             ,paste0("EB-0.1",", n=",length(runs2))),lty=c(1),col=c("red",'blue'))

res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=1)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=1)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=1)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=1)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c(paste0("EB-0.001",", n=",length(runs))
                             ,paste0("EB-0.1",", n=",length(runs2))),lty=c(1),col=c("red",'blue'))
```

###Put everthing together
```{r}
#Emiprical bayes
runs <- c(10,14,15,17,18,2,4)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju24_nnvwbbayes_initvar_loss__jobid_",i,".csv")))
}
runs2 <- c(53,55,57,59,62,63,71,73,77,78,81,89,90,94)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju24_nnvwbbayes_initvar_loss__jobid_",i,".csv")))
}
#IG
runs3 <- c(10,12,14,15,16,18,20,23,26,27,36,4,42,44,45,50,6,8,9)
res.mat3 <- array(,dim=c(2,length(runs3),800))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_peakran_loss__jobid_",i,".csv")))
}
runs4 <- c(11,13,14,2,20,24,26,28,29,30,31,36,40,41,43,5,6,8)
res.mat4 <- array(,dim=c(2,length(runs4),800))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_unfran_loss__jobid_",i,".csv")))
}
#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)  
legend('topright',legend = c(paste0("EB-0.001",", n=",length(runs))
                             ,paste0("EB-0.1",", n=",length(runs2))
                             ,paste0("IG(3,0.5)",", n=",length(runs3))
                             ,paste0("IG(1,0.5)",", n=",length(runs4))),lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = c(paste0("EB-0.001",", n=",length(runs))
                             ,paste0("EB-0.1",", n=",length(runs2))
                             ,paste0("IG(3,0.5)",", n=",length(runs3))
                             ,paste0("IG(1,0.5)",", n=",length(runs4))),lty=c(1),col=c("red",'blue','darkgreen','orange'))
 


```



##Assess bias = 50
```{r}
for(i in c(11,12,17,18,19,3,4,7)){
  bias <- as.vector(unlist(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwb4_bias50_bias__jobid_',i,'.csv'))))
  print(paste0('Max: ', max(bias),', Min: ', min(bias), ', Inactive: '))
  print(which(bias==0))
}
```
All bias is non zero, in fact, it's aroun the initial bias
Look at results
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwb4_bias50_loss__jobid_",11,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwb4_bias50_loss__jobid_",3,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwb4_bias50_loss__jobid_",4,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwb4_bias50_loss__jobid_",7,".csv")))


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))

full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]))


full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","bias=50|0 silent", "bias=50|0 silent", "bias=50|0 silent","bias=50|0 silent","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.9, 7.1),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 4,pch=3,col = 5,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4),1,1),col=c("white",1,3,4,5,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(#min(full.res[2,,],na.rm = TRUE)
                                                     4, max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 2,pch=2,col = 3,lwd=1)
lines(full.res[2,5,], type = "l", lty = 3,pch=3,col = 4,lwd=1)
lines(full.res[2,6,], type = "l", lty = 4,pch=3,col = 5,lwd=1)
legend('topright',legend = leglab,lty=c(1,c(1:4),1,1),col=c("white",1,3,4,5,6,2))
```

Despite having extremely high bias, we see that the NN can learn the true noise as well, so silent region has bare impact


#27July

Perhaps I should use IG with defind 4th moments, ie alpha > 4
Plot via density `dinvgamma`
```{r}
plot(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),10,0.5), ylab = "p(x)", main = "Densities of IG distributions",type='l',col='red',xlab='x',lwd=2)
lines(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),21,0.1),col='blue',lwd=2)
lines(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),1,0.5),col='darkgreen',lwd=2)
lines(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),5,0.5),col='orange',lwd=2)

legend('topright',legend = c(paste0("IG(1,0.5)")
                             ,paste0("IG(3,0.5)"),"IG(5,0.5)","IG(10,0.5)")
       ,lty=c(1),col=c("darkgreen","blue",'orange',"red"))
```
```{r}
plot(density(rinvgamma(1000,6+141.5,0.9)*500),col='blue')

```


```{r}
plot(density(rinvgamma(1000,11,500)))
lines(density(rinvgamma(1000,6,0.5)*500),col='red')
lines(density(rinvgamma(1000,6+141.5,0.9)*500),col='blue')
lines(density(rinvgamma(1000,7,300)),col='magenta')
```


```{r}
plot(density(rinvgamma(1000,11,500)))
lines(density(rinvgamma(1000,6,0.5)*500),col='red')
lines(density(rinvgamma(1000,9,400)),col='blue')
lines(density(rinvgamma(1000,7,300)),col='magenta')
```


```{r}
plot(x=seq(0.001,100, by = 0.2),dinvgamma(x= seq(0.001,100, by = 0.2),11,500), ylab = "p(x)", main = "Densities of IG distributions",type='l',col='red',xlab='x',lwd=2)
lines(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),21,0.1),col='blue',lwd=2)
# lines(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),1,0.5),col='darkgreen',lwd=2)
# lines(x=seq(0.001,5, by = 0.002),dinvgamma(x= seq(0.001,5, by = 0.002),5,0.5),col='orange',lwd=2)

legend('topright',legend = c(paste0("IG(1,0.5)")
                             ,paste0("IG(3,0.5)"),"IG(5,0.5)","IG(10,0.5)")
       ,lty=c(1),col=c("darkgreen","blue",'orange',"red"))
```


##First test SGD IG with alpha = 5 and 10
Then can do SGLD
```{r}
#IG with alpha = 5,10 and initialisation with mean
runs <- c(11,14,15,16,18,19,2,21,24,25,3,33,34,36,37,38,4,40,41,42,43,48,49,6,7,8)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",i,".csv")))
}
runs2 <- c(10,11,13,17,18,19,20,21,24,30,33,34,35,39,4,40,42,50,7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a10_loss__jobid_",i,".csv")))
}
#IG with random initialisation
runs3 <- c(10,12,14,15,16,18,20,23,26,27,36,4,42,44,45,50,6,8,9)
res.mat3 <- array(,dim=c(2,length(runs3),800))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_peakran_loss__jobid_",i,".csv")))
}
runs4 <- c(11,13,14,2,20,24,26,28,29,30,31,36,40,41,43,5,6,8)
res.mat4 <- array(,dim=c(2,length(runs4),800))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_unfran_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(1,0.5)",", n=",length(runs4)),paste0("IG(3,0.5)",", n=",length(runs3)),paste0("IG(5,0.5)",", n=",length(runs))
                             ,paste0("IG(10,0.5)",", n=",length(runs2)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)  
legend('topright',legend = leglab,lty=c(1),col=c('orange','darkgreen',"red",'blue'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration", ylim = c(4.25,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c('orange','darkgreen',"red",'blue'))
```


Maybe will use result from IG(5,0.5) as it has the same test RMSE as IG(10,0.5) but parameter isn't as extreme
##Select a run from IG(5,0.5)
c(11,14,15,16,18,19,2,21,24,25,3,33,34,36,37,38,4,40,41,42,43,48,49,6,7,8)
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",16,".csv")))

#IG with alpha = 5,10 and initialisation with mean
runs <- c(11,14,15,16,18,19,2,21,24,25,3,33,34,36,37,38,4,40,41,42,43,48,49,6,7,8)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",i,".csv")))
}
runs2 <- c(10,11,13,17,18,19,20,21,24,30,33,34,35,39,4,40,42,50,7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a10_loss__jobid_",i,".csv")))
}


res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",6,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",7,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",8,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",11,".csv")))
res.nn.loss.sgd.6 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",14,".csv")))
res.nn.loss.sgd.7 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",15,".csv")))
res.nn.loss.sgd.8 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",16,".csv")))
res.nn.loss.sgd.9 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",18,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]),
                       sqrt(res.nn.loss.sgd.6[2,]),sqrt(res.nn.loss.sgd.7[2,]),sqrt(res.nn.loss.sgd.8[2,]),sqrt(res.nn.loss.sgd.9[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]),
                     sqrt(res.nn.loss.sgd.6[1,]),sqrt(res.nn.loss.sgd.7[1,]),sqrt(res.nn.loss.sgd.8[1,]),sqrt(res.nn.loss.sgd.9[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","GS", "6", "7","8","11","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[1,8,], type = "b", lty = 2,pch=3,col = 3,lwd=1)
lines(full.res[1,9,], type = "b", lty = 2,pch=3,col = 4,lwd=1)
lines(full.res[1,10,], type = "b", lty = 2,pch=3,col = 5,lwd=1)
lines(full.res[1,11,], type = "b", lty = 2,pch=3,col = 7,lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 1,pch=2,col = 3,lwd=3)
lines(full.res[2,5,], type = "l", lty = 1,pch=3,col = 4,lwd=3)
lines(full.res[2,6,], type = "l", lty = 1,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[2,8,], type = "b", lty = 2,pch=3,col = 3,lwd=.2)
lines(full.res[2,9,], type = "b", lty = 2,pch=3,col = 4,lwd=.2)
lines(full.res[2,10,], type = "b", lty = 2,pch=3,col = 5,lwd=.2)
lines(full.res[2,11,], type = "b", lty = 2,pch=3,col = 7,lwd=.2)
legend('topright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))
```
Pick run 8

##Plot SG+LD

corresponding lr and noise: 11,13,16,29,35,36,37
previous lr and noise: 21,29,3,34,49,6,7
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_8.csv")))

#Load many runs of LD:
runs <- c(11,13,16,29,35,36,37)
res.mat <- array(,dim=c(2,length(runs),1600))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbsgldig_lowlr_loss__jobid_",i,".csv")))
}
runs2 <- c(21,29,3,34,49,6,7)
res.mat2 <- array(,dim=c(2,length(runs2),1600))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbsgldig_norlr_loss__jobid_",i,".csv")))
}

res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
res.iqr2.train <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
res.iqr2.test <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- res.iqr[2,]

res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])
#Previous lr and noise:
res.nn.loss.sgd.5 <- rbind(res.iqr2.train[2,],res.iqr2.test[2,])
res.nn.loss.sgd.6 <- rbind(res.iqr2.train[1,],res.iqr2.test[1,])
res.nn.loss.sgd.7 <- rbind(res.iqr2.train[3,],res.iqr2.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.5[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.6[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.7[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.5[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.6[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.7[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-1","SGLD-2","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,col = 'blue',lwd=2)
lines(full.res[1,8,], type = "l", lty = 1,col = 'lightblue',lwd=1)
lines(full.res[1,9,], type = "l", lty = 1,col = 'lightblue',lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,col = 'blue',lwd=2)
lines(full.res[2,8,], type = "l", lty = 1,col = 'lightblue',lwd=1)
lines(full.res[2,9,], type = "l", lty = 1,col = 'lightblue',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```

#28 July
Reduce the corresponding case even further
```{r}
#IG with alpha = 5,10 and initialisation with mean
runs <- c(11,14,15,16,18,19,2,21,24,25,3,33,34,36,37,38,4,40,41,42,43,48,49,6,7,8)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",i,".csv")))
}
runs2 <- c(10,11,13,17,18,19,20,21,24,30,33,34,35,39,4,40,42,50,7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a10_loss__jobid_",i,".csv")))
}
#IG with random initialisation
runs3 <- c(10,12,14,15,16,18,20,23,26,27,36,4,42,44,45,50,6,8,9)
res.mat3 <- array(,dim=c(2,length(runs3),800))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_peakran_loss__jobid_",i,".csv")))
}
runs4 <- c(11,13,14,2,20,24,26,28,29,30,31,36,40,41,43,5,6,8)
res.mat4 <- array(,dim=c(2,length(runs4),800))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_unfran_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(5,0.5)",", n=",length(runs))
                             ,paste0("IG(10,0.5)",", n=",length(runs2))
                             ,paste0("IG(3,0.5)",", n=",length(runs3))
                             ,paste0("IG(1,0.5)",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)  
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```


Maybe will use result from IG(5,0.5) as it has the same test RMSE as IG(10,0.5) but parameter isn't as extreme
##Select a run from IG(5,0.5)
c(11,14,15,16,18,19,2,21,24,25,3,33,34,36,37,38,4,40,41,42,43,48,49,6,7,8)
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",16,".csv")))

#IG with alpha = 5,10 and initialisation with mean
runs <- c(11,14,15,16,18,19,2,21,24,25,3,33,34,36,37,38,4,40,41,42,43,48,49,6,7,8)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",i,".csv")))
}
runs2 <- c(10,11,13,17,18,19,20,21,24,30,33,34,35,39,4,40,42,50,7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a10_loss__jobid_",i,".csv")))
}


res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",6,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",7,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",8,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",11,".csv")))
res.nn.loss.sgd.6 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",14,".csv")))
res.nn.loss.sgd.7 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",15,".csv")))
res.nn.loss.sgd.8 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",16,".csv")))
res.nn.loss.sgd.9 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",18,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]),
                       sqrt(res.nn.loss.sgd.6[2,]),sqrt(res.nn.loss.sgd.7[2,]),sqrt(res.nn.loss.sgd.8[2,]),sqrt(res.nn.loss.sgd.9[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]),
                     sqrt(res.nn.loss.sgd.6[1,]),sqrt(res.nn.loss.sgd.7[1,]),sqrt(res.nn.loss.sgd.8[1,]),sqrt(res.nn.loss.sgd.9[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","GS", "6", "7","8","11","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[1,8,], type = "b", lty = 2,pch=3,col = 3,lwd=1)
lines(full.res[1,9,], type = "b", lty = 2,pch=3,col = 4,lwd=1)
lines(full.res[1,10,], type = "b", lty = 2,pch=3,col = 5,lwd=1)
lines(full.res[1,11,], type = "b", lty = 2,pch=3,col = 7,lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 1,pch=2,col = 3,lwd=3)
lines(full.res[2,5,], type = "l", lty = 1,pch=3,col = 4,lwd=3)
lines(full.res[2,6,], type = "l", lty = 1,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[2,8,], type = "b", lty = 2,pch=3,col = 3,lwd=.2)
lines(full.res[2,9,], type = "b", lty = 2,pch=3,col = 4,lwd=.2)
lines(full.res[2,10,], type = "b", lty = 2,pch=3,col = 5,lwd=.2)
lines(full.res[2,11,], type = "b", lty = 2,pch=3,col = 7,lwd=.2)
legend('topright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))
```
Pick run 8

##Plot SG+LD

corresponding lr and noise: 11,13,16,29,35,36,37
previous lr and noise: 21,29,3,34,49,6,7
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",8,".csv")))

#Load many runs of LD:
runs <- c(10,11,18,33,36,45,47,6)
res.mat <- array(,dim=c(2,length(runs),1600))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju28_nnvwbsgldig_lowlr_loss__jobid_",i,".csv")))
}
runs2 <- c(21,29,3,34,49,6,7)
res.mat2 <- array(,dim=c(2,length(runs2),1600))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbsgldig_norlr_loss__jobid_",i,".csv")))
}

res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
res.iqr2.train <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
res.iqr2.test <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- res.iqr[2,]

res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])
#Previous lr and noise:
res.nn.loss.sgd.5 <- rbind(res.iqr2.train[2,],res.iqr2.test[2,])
res.nn.loss.sgd.6 <- rbind(res.iqr2.train[1,],res.iqr2.test[1,])
res.nn.loss.sgd.7 <- rbind(res.iqr2.train[3,],res.iqr2.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.5[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.6[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.7[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.5[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.6[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.7[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-1","SGLD-2","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,col = 'blue',lwd=2)
lines(full.res[1,8,], type = "l", lty = 1,col = 'lightblue',lwd=1)
lines(full.res[1,9,], type = "l", lty = 1,col = 'lightblue',lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,col = 'blue',lwd=2)
lines(full.res[2,8,], type = "l", lty = 1,col = 'lightblue',lwd=1)
lines(full.res[2,9,], type = "l", lty = 1,col = 'lightblue',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```
#29 July

A modify lowlr SGLD (slightly higher than ytd)
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",8,".csv")))

#Load many runs of LD:
runs <- c(11,17,2,28,32,34,35,37,40)
res.mat <- array(,dim=c(2,length(runs),1600))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju28_nnvwbsgldig_lowlr2_loss__jobid_",i,".csv")))
}
runs2 <- c(21,29,3,34,49,6,7)
res.mat2 <- array(,dim=c(2,length(runs2),1600))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbsgldig_norlr_loss__jobid_",i,".csv")))
}

res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
res.iqr2.train <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
res.iqr2.test <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- res.iqr[2,]

res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])
#Previous lr and noise:
res.nn.loss.sgd.5 <- rbind(res.iqr2.train[2,],res.iqr2.test[2,])
res.nn.loss.sgd.6 <- rbind(res.iqr2.train[1,],res.iqr2.test[1,])
res.nn.loss.sgd.7 <- rbind(res.iqr2.train[3,],res.iqr2.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.5[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.6[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.7[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.5[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.6[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.7[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-1","SGLD-2","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,col = 'blue',lwd=2)
lines(full.res[1,8,], type = "l", lty = 1,col = 'lightblue',lwd=1)
lines(full.res[1,9,], type = "l", lty = 1,col = 'lightblue',lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,col = 'blue',lwd=2)
lines(full.res[2,8,], type = "l", lty = 1,col = 'lightblue',lwd=1)
lines(full.res[2,9,], type = "l", lty = 1,col = 'lightblue',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```

#31 July

##SGLD noise 0.05
A modify lowlr SGLD (slightly higher than ytd)
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",8,".csv")))

#Load many runs of LD:
runs <- c(10,16,18,22,27)
res.mat <- array(,dim=c(2,length(runs),1600))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju29_nnvwbsgldig_lowlr_loss__jobid_",i,".csv")))
}
runs2 <- c(21,29,3,34,49,6,7)
res.mat2 <- array(,dim=c(2,length(runs2),1600))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbsgldig_norlr_loss__jobid_",i,".csv")))
}

res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
res.iqr2.train <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
res.iqr2.test <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- res.iqr[2,]

res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])
#Previous lr and noise:
res.nn.loss.sgd.5 <- rbind(res.iqr2.train[2,],res.iqr2.test[2,])
res.nn.loss.sgd.6 <- rbind(res.iqr2.train[1,],res.iqr2.test[1,])
res.nn.loss.sgd.7 <- rbind(res.iqr2.train[3,],res.iqr2.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.5[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.6[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.7[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.5[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.6[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.7[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLDcorNoise0.005","SGLD_prev noise","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,col = 'blue',lwd=2)
lines(full.res[1,8,], type = "l", lty = 1,col = 'lightblue',lwd=1)
lines(full.res[1,9,], type = "l", lty = 1,col = 'lightblue',lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,col = 'blue',lwd=2)
lines(full.res[2,8,], type = "l", lty = 1,col = 'lightblue',lwd=1)
lines(full.res[2,9,], type = "l", lty = 1,col = 'lightblue',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```

##SGD HSP
```{r}
#IG with alpha = 5,10 and initialisation with mean
runs <- c(11,14,15,16,18,19,2,21,24,25,3,33,34,36,37,38,4,40,41,42,43,48,49,6,7,8)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a5_loss__jobid_",i,".csv")))
}
runs2 <- c(10,11,13,17,18,19,20,21,24,30,33,34,35,39,4,40,42,50,7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbig_a10_loss__jobid_",i,".csv")))
}
#IG with random initialisation
runs3 <- c(10,12,14,15,16,18,20,23,26,27,36,4,42,44,45,50,6,8,9)
res.mat3 <- array(,dim=c(2,length(runs3),800))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju25_nnvwbig_peakran_loss__jobid_",i,".csv")))
}
runs4 <- c(1,  34,14, 35,16, 36,17, 38,22, 41,24, 48,30, 6,33, 8)
res.mat4 <- array(,dim=c(2,length(runs4),800))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju31_nnvwbhc_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(5,0.5)",", n=",length(runs))
                             ,paste0("IG(10,0.5)",", n=",length(runs2))
                             ,paste0("IG(3,0.5)",", n=",length(runs3))
                             ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)  
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```

#1 Aug

##Predictive interval of SGLD with IG(5,0.5) and noise = 0.001
Load data
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju28_nnvwbsgldig_lowlr2_inpred__jobid_17.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju28_nnvwbsgldig_lowlr2_outpred__jobid_17.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/400)

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)
```


```{r}
in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/400*100)
}
stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/1600*100)
}
stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```
This shows an undercoverage (92.85% for held-out)

##Predictive interval of SGLD with IG(5,0.5) and noise = 0.01
Load data
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbsgldig_lowlr_inpred__jobid_11.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju27_nnvwbsgldig_lowlr_outpred__jobid_11.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/400)

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/400*100)
}
stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/1600*100)
}
stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```

#3 Aug 
EDA

##Observe age distribution of my dataset

###True age

```{r}
#true age
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age <- age_tab$age
#wb2
wb2.ind.train <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))[1,])
wb2.ind.test <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))[2,])

c1 <- rgb(173,216,230,max = 255, alpha = 80, names = "lt.blue")
c2 <- rgb(255,192,203, max = 255, alpha = 80, names = "lt.pink")

hist.train <- hist(age[wb2.ind.train], breaks = seq(from=35, to=95, by=5))
hist.test  <- hist(age[wb2.ind.test], breaks = seq(from=35, to=95, by=5))
plot(hist.train,col=c1,ylim=c(0,600), main = "Histogram of Age in the datasets", xlab = "Age (years)")
plot(hist.test, add = TRUE, col = c2)
legend("topright", pch=15, legend = c("Train set", "Test set"), col = c("lightblue","pink"))
```
plot(x=age[wb2.ind.train]

###Simulated age
```{r}
#Train
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
#Test
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))

c1 <- rgb(173,216,230,max = 255, alpha = 80, names = "lt.blue")
c2 <- rgb(255,192,203, max = 255, alpha = 80, names = "lt.pink")

hist.train <- hist(wb2.train.pred, breaks = seq(from=35, to=95, by=5))
hist.test  <- hist(wb2.test.pred, breaks = seq(from=35, to=95, by=5))
plot(hist.train,col=c1,ylim=c(0,600), main = "Histogram of the response variable in the simulation datasets", xlab = "Response variable")
plot(hist.test, add = TRUE, col = c2)
legend("topright", pch=15, legend = c("Train set", "Test set"), col = c("lightblue","pink"))
```

###Predicted age

##To do
Observe the variance of voxels perhaps? and visualise
--- Done via `viz_vox_info`

#8 August

##Load MCMC Predictive Interval
```{r}
hs.int<-matrix(,nrow=50,ncol=4)
for(i in 1:50){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug11_hsvwb_coverage_",i,".csv")))
}
colMeans(hs.int)
```
This shows that all 50 runs of HSP has 
98.9% in-sample truth coverage
and 89% out-of-sample truth coverage

Calculate mean/sd for rmse, mae and rsq of hsp
out$inrsq<-round(1-sserr_ridge/sstot,5)*100
  out$inmae<-round(median(abs(y-ridge_pred)),4)
  out$outrsq<-round(1-sserr_ridge_new/sstot_new,5)*100
  out$outmae<-round(median(abs(y_new-ridge_pred_new)),4)
  out$inrmse <-round(sqrt(mean((y-ridge_pred)^2)),4)
  out$outrmse <-round(sqrt(mean((y_new-ridge_pred_new)^2)),4)
```{r}
hs.int<-matrix(,nrow=50,ncol=13)
for(i in 1:50){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug11_hsvwb_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
colMeans(hs.int[,1:6])
 library(matrixStats)
sqrt(colVars(hs.int[,1:6]))

```

##Big CHANGES
I will change the setting of SGD-IG to (6,0.5) s.t. the expectation is 0.1
check a run: from pile/sim_aug8_nnvwbig_a6_loss__jobid_
`15,16,17,22,26,27,28,3,30,36,39,4,47,49,50,7,8`
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_loss__jobid_",3,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_loss__jobid_",4,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_loss__jobid_",7,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_loss__jobid_",8,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_loss__jobid_",15,".csv")))
res.nn.loss.sgd.6 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_loss__jobid_",16,".csv")))
res.nn.loss.sgd.7 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_loss__jobid_",17,".csv")))
res.nn.loss.sgd.8 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_loss__jobid_",22,".csv")))
res.nn.loss.sgd.9 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_loss__jobid_",26,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]),
                       sqrt(res.nn.loss.sgd.6[2,]),sqrt(res.nn.loss.sgd.7[2,]),sqrt(res.nn.loss.sgd.8[2,]),sqrt(res.nn.loss.sgd.9[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]),
                     sqrt(res.nn.loss.sgd.6[1,]),sqrt(res.nn.loss.sgd.7[1,]),sqrt(res.nn.loss.sgd.8[1,]),sqrt(res.nn.loss.sgd.9[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","3", "4", "7","8","15","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[1,8,], type = "b", lty = 2,pch=3,col = 3,lwd=1)
lines(full.res[1,9,], type = "b", lty = 2,pch=3,col = 4,lwd=1)
lines(full.res[1,10,], type = "b", lty = 2,pch=3,col = 5,lwd=1)
lines(full.res[1,11,], type = "b", lty = 2,pch=3,col = 7,lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 1,pch=2,col = 3,lwd=3)
lines(full.res[2,5,], type = "l", lty = 1,pch=3,col = 4,lwd=3)
lines(full.res[2,6,], type = "l", lty = 1,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[2,8,], type = "b", lty = 2,pch=3,col = 3,lwd=.2)
lines(full.res[2,9,], type = "b", lty = 2,pch=3,col = 4,lwd=.2)
lines(full.res[2,10,], type = "b", lty = 2,pch=3,col = 5,lwd=.2)
lines(full.res[2,11,], type = "b", lty = 2,pch=3,col = 7,lwd=.2)
legend('topright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))
```
Pick run 7


##Stochastic phase
Plot of SGD, EMB SGD, IG, HC
```{r}
#IG with alpha = 6 and initialisation with mean
runs <- c(15,16,17,22,26,27,28,3,30,36,39,4,47,49,50,7,8)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(1,11,14,15,2,21,23,27,31,33,35,36,39,40,46,6,7)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbbayes_initvar_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- c(16,17,23,25,26,30,31,33,36,38,39,42,46,48,5,50,8)
res.mat3 <- array(,dim=c(2,length(runs3),800))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwb4_loss__jobid_",i,".csv")))
}
#HSP
runs4 <- c(1,  34,14, 35,16, 36,17, 38,22, 41,24, 48,30, 6,33, 8)
res.mat4 <- array(,dim=c(2,length(runs4),800))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju31_nnvwbhc_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3))
                             ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)  
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```
Only observe from epoch 200 to 800 of IG, EB, Vanilla
```{r}
#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=200:800,y=sqrt(res.iqr[2,])[200:800],col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5.05,5.31))
lines(x=200:800,y=sqrt(res.iqr[1,])[200:800],col='pink',lwd=0.5)
lines(x=200:800,y=sqrt(res.iqr[3,])[200:800],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 200:800,y=sqrt(res.iqr2[2,])[200:800],col='blue',lwd=1, type = 'l',lty=2)
lines(x=200:800,y=sqrt(res.iqr2[1,])[200:800],col='lightblue',lwd=0.5)
lines(x=200:800,y=sqrt(res.iqr2[3,])[200:800],col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 200:800,y=sqrt(res.iqr3[2,])[200:800],col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=200:800,y=sqrt(res.iqr3[1,])[200:800],col='green',lwd=0.5)
lines(x=200:800,y=sqrt(res.iqr3[3,])[200:800],col='green',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =200:800,y=sqrt(res.iqr[2,])[200:800],col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,5.25))
lines(x=200:800,y=sqrt(res.iqr[1,])[200:800],col='pink',lwd=0.5)
lines(x=200:800,y=sqrt(res.iqr[3,])[200:800],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 200:800,y=sqrt(res.iqr2[2,])[200:800],col='blue',lwd=2, type = 'l',lty=2)
lines(x=200:800,y=sqrt(res.iqr2[1,])[200:800],col='lightblue',lwd=0.5)
lines(x=200:800,y=sqrt(res.iqr2[3,])[200:800],col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =200:800,y=sqrt(res.iqr3[2,])[200:800],col='darkgreen',lwd=2, type = 'l',lty=2)
lines(x=200:800,y=sqrt(res.iqr3[1,])[200:800],col='green',lwd=0.5)
lines(x=200:800,y=sqrt(res.iqr3[3,])[200:800],col='green',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```
Look at mean RMSE and R^2 and MAE

```{r}
stat.ig <- meanstats.sim("aug8_nnvwbig_a6",c(15,16,17,22,26,27,28,3,30,36,39,4,47,49,50,7,8))
stat.eb <-meanstats.sim("aug8_nnvwbbayes_initvar", c(1,11,14,15,2,21,23,27,31,33,35,36,39,40,46,6,7))
stat.vanilla <- meanstats.sim("aug8_nnvwb4",c(16,17,23,25,26,30,31,33,36,38,39,42,46,48,5,50,8))
stat.hcp <- meanstats.sim("ju31_nnvwbhc",c(1,  34,14, 35,16, 36,17, 38,22, 41,24, 48,30, 6,33, 8))
```

```{r}
stat.ig
stat.eb
stat.vanilla
stat.hcp
```


#9Aug
Look at SGLD, initialise by IG run #7
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_loss__jobid_",7,".csv")))

#Load many runs of LD:
runs <- c(13,23,24,25,27,29,31,33,42,49)
res.mat <- array(,dim=c(2,length(runs),1600))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbsgldig_lowlr2_loss__jobid_",i,".csv")))
}
runs2 <- c(10,13,21,23,27,30,46,9)
res.mat2 <- array(,dim=c(2,length(runs2),1600))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbsgldig_lowlr_loss__jobid_",i,".csv")))
}

res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
res.iqr2.train <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
res.iqr2.test <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
# res.nn.loss.sgd.2 <- res.iqr[2,]

res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])
#Previous lr and noise:
res.nn.loss.sgd.5 <- rbind(res.iqr2.train[2,],res.iqr2.test[2,])
res.nn.loss.sgd.6 <- rbind(res.iqr2.train[1,],res.iqr2.test[1,])
res.nn.loss.sgd.7 <- rbind(res.iqr2.train[3,],res.iqr2.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.5[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.6[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.7[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.5[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.6[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.7[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-0.001","SGLD-0.01","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,col = 'blue',lwd=2)
lines(full.res[1,8,], type = "l", lty = 1,col = 'lightblue',lwd=1)
lines(full.res[1,9,], type = "l", lty = 1,col = 'lightblue',lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,col = 'blue',lwd=2)
lines(full.res[2,8,], type = "l", lty = 1,col = 'lightblue',lwd=1)
lines(full.res[2,9,], type = "l", lty = 1,col = 'lightblue',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```
I think we are only interested in noise sd = 0.001 from the graph, since 0.01 seems to be misleading the updates and take away from MAP


##Assess Posterior predictive interval of SGLD 0.001
Pick a random run
Load data
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbsgldig_lowlr2_inpred__jobid_13.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbsgldig_lowlr2_outpred__jobid_13.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/400)

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/400*100)
}
stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/1600*100)
}
stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
print(paste0('in MAE: ',(mean(abs(stat.in.ig$mean-stat.in.ig$true)))))
print(paste0('out MAE: ',(mean(abs(stat.out.ig$mean-stat.out.ig$true)))))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```
###Compare to without personalised variance
####For IG insample
in-sample statistics
```{r}
stat.in.ig$modmse <- sqrt(in.mse)

stat.in.ig$lwrmodmse <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$modmse
stat.in.ig$uprmodmse <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$modmse

#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i]))/400*100)
}
stat.in.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i])))
}
stat.in.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermodmse)/2000*100))

stat.out.ig$modmsemse <- sqrt(in.mse)

stat.out.ig$lwrmodmse <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$modmse
stat.out.ig$uprmodmse <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$modmse

within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i]))/1600*100)
}
stat.out.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i])))
}
stat.out.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermodmse)/2000*100))

print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
```

##Assess Posterior predictive interval of SGLD 0.01
Pick a random run
Load data
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbsgldig_lowlr_inpred__jobid_10.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbsgldig_lowlr_outpred__jobid_10.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/400)

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/400*100)
}
stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/1600*100)
}
stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```






Slightly better coverage but every other metric is lower, so not really useful, this is just because higher noise leads to volatile predictions


##Summary of 
For SGLD-IG 0.001 with personal variance
In-PPI = 95.25 (95.05 without PV)
in-RMSE = 4.54
in-MAE = 3.64
in-RSQ = 64.0%
out-RMSE = 5.09
out-MAE = 4.07
Out-PPI = 92.25 (91.9 without PV)
out-RSQ = 55.2%


#12 Aug mainly REAL-DATA

##Load SGD real-data
```{r}
#IG with alpha = 6 and initialisation with mean
runs <- c(1,12,15,18,2,20,28,39,4,41,45,48,50)
res.mat <- array(,dim=c(2,length(runs),280))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(11,18,21,3,35,45,46,47,9)
res.mat2 <- array(,dim=c(2,length(runs2),280))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbbayes_initvar_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- c(14,20,38,4,40,49,6)
res.mat3 <- array(,dim=c(2,length(runs3),280))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwb4_loss__jobid_",i,".csv")))
}
#HSP
runs4 <- c(24,27,3,30,31,32,39,42)
res.mat4 <- array(,dim=c(2,length(runs4),280))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbhc_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3))
                             ,paste0("HC",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:280,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:280,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:280,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)  
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:280,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:280,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:280,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```
Run time 5.5hrs 

ALSO need to look at the mean stats of the results

##Contrast with doing HSP and GPR

###GPR
```{r}
hs.int<-matrix(,nrow=50,ncol=14)
for(i in 1:50){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug12_gpr_",i,".csv"))))[,1]
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
colMeans(hs.int[,1:6])
 library(matrixStats)
sqrt(colVars(hs.int[,1:6]))
```
running time 15-20 seconds (not minutes??)

###HSP
```{r}
hs.int<-matrix(,nrow=50,ncol=4)
for(i in 1:50){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug12_hsvwb_coverage_",i,".csv")))
}
colMeans(hs.int)
```
This shows that all 50 runs of HSP has 
98.9% in-sample truth coverage
and 89% out-of-sample truth coverage

```{r}
hs.int<-matrix(,nrow=50,ncol=13)
for(i in 1:50){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug12_hsvwb_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
colMeans(hs.int[,1:6])
 library(matrixStats)
sqrt(colVars(hs.int[,1:6]))
```


##Create a plot that contains all GP NN, GPR and HSP


##SG+LD
Choose a run from IG
c(1,12,15,18,2,20,28,39,4,41,45,48,50)
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",1,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",2,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",4,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",12,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",15,".csv")))
res.nn.loss.sgd.6 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",18,".csv")))
res.nn.loss.sgd.7 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",20,".csv")))
res.nn.loss.sgd.8 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",28,".csv")))
res.nn.loss.sgd.9 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",39,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]),
                       sqrt(res.nn.loss.sgd.6[2,]),sqrt(res.nn.loss.sgd.7[2,]),sqrt(res.nn.loss.sgd.8[2,]),sqrt(res.nn.loss.sgd.9[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]),
                     sqrt(res.nn.loss.sgd.6[1,]),sqrt(res.nn.loss.sgd.7[1,]),sqrt(res.nn.loss.sgd.8[1,]),sqrt(res.nn.loss.sgd.9[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","1", "2", "4","12","15","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[1,8,], type = "b", lty = 2,pch=3,col = 3,lwd=1)
lines(full.res[1,9,], type = "b", lty = 2,pch=3,col = 4,lwd=1)
lines(full.res[1,10,], type = "b", lty = 2,pch=3,col = 5,lwd=1)
lines(full.res[1,11,], type = "b", lty = 2,pch=3,col = 7,lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 1,pch=2,col = 3,lwd=3)
lines(full.res[2,5,], type = "l", lty = 1,pch=3,col = 4,lwd=3)
lines(full.res[2,6,], type = "l", lty = 1,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[2,8,], type = "b", lty = 2,pch=3,col = 3,lwd=.2)
lines(full.res[2,9,], type = "b", lty = 2,pch=3,col = 4,lwd=.2)
lines(full.res[2,10,], type = "b", lty = 2,pch=3,col = 5,lwd=.2)
lines(full.res[2,11,], type = "b", lty = 2,pch=3,col = 7,lwd=.2)
legend('topright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))
```
Pick run 4
Look at SGLD, initialise by IG run #7
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",4,".csv")))
#Load many runs of LD:
runs <- c(1,14,16,31,36,47)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug12_nnvwbsgldig_lowlr2_loss__jobid_",i,".csv")))
}


res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-0.001","SGLD-0.01","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```

##Assess Posterior predictive interval of SGLD 0.001
Pick a random run
Load data
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_aug12_nnvwbsgldig_lowlr2_inpred__jobid_14.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_aug12_nnvwbsgldig_lowlr2_outpred__jobid_14.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/400)

age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- age_tab$age[wb2.train.id]


true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- age_tab$age[wb2.test.id]
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/400*100)
}
stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/1600*100)
}
stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
print(paste0('in MAE: ',(mean(abs(stat.in.ig$mean-stat.in.ig$true)))))
print(paste0('out MAE: ',(mean(abs(stat.out.ig$mean-stat.out.ig$true)))))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```
[1] "Proprtion of subject within 95%: 0"
[1] "Proprtion of true lying within subject 95% prediction interval: 95.45"
[1] "Proprtion of subject within 95%: 0"
[1] "Proprtion of true lying within subject 95% prediction interval: 92"
[1] "in RMSE: 4.34060658117254"
[1] "out RMSE: 4.97635368291087"
[1] "True noise: 4.58"
[1] "in MAE: 3.46720334009228"
[1] "out MAE: 3.96393497759566"
[1] "in R-square: 0.681491419047454"
[1] "in R-square: 0.582988922513948"

###Compare to without personalised variance
####For IG insample
in-sample statistics
```{r}
stat.in.ig$modmse <- sqrt(in.mse)

stat.in.ig$lwrmodmse <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$modmse
stat.in.ig$uprmodmse <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$modmse

#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i]))/400*100)
}
stat.in.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i])))
}
stat.in.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermodmse)/2000*100))

stat.out.ig$modmsemse <- sqrt(in.mse)

stat.out.ig$lwrmodmse <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$modmse
stat.out.ig$uprmodmse <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$modmse

within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i]))/1600*100)
}
stat.out.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i])))
}
stat.out.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermodmse)/2000*100))

print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
```
Took 7 hours to run 100 epochs




#16 Aug

##Assess numerical performane of SGD (Real data)
runs <- c(1,12,15,18,2,20,28,39,4,41,45,48,50)
res.mat <- array(,dim=c(2,length(runs),280))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(11,18,21,3,35,45,46,47,9)
res.mat2 <- array(,dim=c(2,length(runs2),280))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbbayes_initvar_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- c(14,20,38,4,40,49,6)
res.mat3 <- array(,dim=c(2,length(runs3),280))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwb4_loss__jobid_",i,".csv")))
}
#HSP
runs4 <- c(24,27,3,30,31,32,39,42)
res.mat4 <- array(,dim=c(2,length(runs4),280))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbhc_loss__jobid_",i,".csv")))
}
```{r}
stat.ig.re <- meanstats.re("aug11_nnvwbig_a6",c(1,12,15,18,2,20,28,39,4,41,45,48,50))
stat.eb.re <-meanstats.re("aug11_nnvwbbayes_initvar",  c(11,18,21,3,35,45,46,47,9))
stat.vanilla.re <- meanstats.re("aug11_nnvwb4",c(14,20,38,4,40,49,6))
stat.hcp.re <- meanstats.re("aug11_nnvwbhc",c(24,27,3,30,31,32,39,42))
```

```{r}
signif(stat.ig.re,3)
signif(stat.eb.re,3)
signif(stat.vanilla.re,3)
signif(stat.hcp.re,3)
```

##Load MCMC Predictive Interval
```{r}
hs.int<-matrix(,nrow=50,ncol=4)
for(i in 1:50){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug12_hsvwb_coverage_",i,".csv")))
}
colMeans(hs.int)
```


```{r}
hs.int<-matrix(,nrow=50,ncol=13)
for(i in 1:50){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug12_hsvwb_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)

```


#18 August


##Simulation
###Load GPR
```{r}
hs.int<-matrix(,nrow=50,ncol=4)
for(i in 1:50){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug16_gpr_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=50,ncol=13)
for(i in 1:50){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug16_gpr_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)

```

###Load res4 sgd
####Stochastic phase
Plot of SGD, EMB SGD, IG, HC
```{r}
#IG with alpha = 6 and initialisation with mean
runs <- c(10,11,12,13,15,17,2,21,25,26,27,28,29,3,30,31,33,37,38,4,43,44,45,47,48,49,5,50,6,7,8)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_res4_aug17_nnvwbig_a6_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(1,10,11,12,13,15,16,17,19,2,20,23,24,29,3,30,33,34,37,39,4,40,42,44,48,5,50,6,8)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_res4_aug17_nnvwbbayes_initvar_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- c(10,12,15,17,2,21,24,25,26,27,29,3,30,33,34,35,36,38,41,44,46,47,48,5,50,6,7,9)
res.mat3 <- array(,dim=c(2,length(runs3),800))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_res4_aug17_nnvwb4_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)  
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen'))
```
Use `res4_summary_script.R`
```{r}
# stat.ig <- meanstats.sim("res4_aug17_nnvwbig_a6",c(10,11,12,13,15,17,2,21,25,26,27,28,29,3,30,31,33,37,38,4,43,44,45,47,48,49,5,50,6,7,8))
# stat.eb <-meanstats.sim("res4_aug17_nnvwbbayes_initvar", c(1,10,11,12,13,15,16,17,19,2,20,23,24,29,3,30,33,34,37,39,4,40,42,44,48,5,50,6,8))
# stat.vanilla <- meanstats.sim("res4_aug17_nnvwb4", c(10,12,15,17,2,21,24,25,26,27,29,3,30,33,34,35,36,38,41,44,46,47,48,5,50,6,7,9))
# stat.hcp <- meanstats.sim("ju31_nnvwbhc",c(1,  34,14, 35,16, 36,17, 38,22, 41,24, 48,30, 6,33, 8))
```

```{r}
(stat.ig <- read.csv("/well/nichols/users/qcv214/bnn2/res3/pile/sim_res4_summary_ig.csv"))
(stat.eb <- read.csv("/well/nichols/users/qcv214/bnn2/res3/pile/sim_res4_summary_eb.csv"))
(stat.vanilla <- read.csv("/well/nichols/users/qcv214/bnn2/res3/pile/sim_res4_summary_van.csv"))
```


##Real

###Load SGLD 300 epochs
Pick a random run
Load data
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_nnvwbsgldig_lowlr2_inpred__jobid_20.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_nnvwbsgldig_lowlr2_outpred__jobid_20.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/400)

age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- age_tab$age[wb2.train.id]


true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- age_tab$age[wb2.test.id]
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/400*100)
}
stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/1600*100)
}
stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
print(paste0('in MAE: ',(mean(abs(stat.in.ig$mean-stat.in.ig$true)))))
print(paste0('out MAE: ',(mean(abs(stat.out.ig$mean-stat.out.ig$true)))))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```
Compare to without personalised variance
```{r}
stat.in.ig$modmse <- sqrt(in.mse)

stat.in.ig$lwrmodmse <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$modmse
stat.in.ig$uprmodmse <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$modmse

#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i]))/400*100)
}
stat.in.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i])))
}
stat.in.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermodmse)/2000*100))

stat.out.ig$modmsemse <- sqrt(in.mse)

stat.out.ig$lwrmodmse <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$modmse
stat.out.ig$uprmodmse <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$modmse

within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i]))/1600*100)
}
stat.out.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i])))
}
stat.out.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermodmse)/2000*100))

print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
```
###Load GPR
```{r}
hs.int<-matrix(,nrow=50,ncol=4)
for(i in 1:50){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=50,ncol=13)
for(i in 1:50){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)

```


#26 August
Do real-data res4
```{r}
(stat.ig <- read.csv("/well/nichols/users/qcv214/bnn2/res3/pile/re_res4_summary_ig.csv"))
(stat.eb <- read.csv("/well/nichols/users/qcv214/bnn2/res3/pile/re_res4_summary_eb.csv"))
(stat.vanilla <- read.csv("/well/nichols/users/qcv214/bnn2/res3/pile/re_res4_summary_van.csv"))
```

#28 Aug
For relu and failed decomposition assess.
Run 5 was successful `/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug28_nnvwb4_zmat_*`
Run 8 is a short example of failure 172 seems good `/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug28_nnvwb4_zmat__jobid_8_172.csv `
```{r}
relu.val <- read.csv("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug28_nnvwb4_hidmat__jobid_8_172.csv")
znb <- read.csv("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug28_nnvwb4_zmat__jobid_8_172.csv")
```

```{r}
lmtest<- fast_horseshoe_lm(1:30,as.matrix(znb)) #This also gives the bias term
```

```{r}
relu.val #30 x 12
znb #30 x 121 (where does 120 column comes from ===> from choose(7+3,3))
```

```{r}
library(matrixcalc)
is.positive.definite(as.matrix(znb), tol=1e-8)

```

```{r}
svd.z <- svd(znb)
plot(svd.z$d[2:30])
```

#29 Aug

##Observe prediction bias towards younger/olderage *TEST
### Simulation

#### HSP
```{r}
wb2.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug11_hsvwb_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Prediction", xlab = "Truth", main = "Out-of-sample HSP against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
# print(coef(lm(hs.pred.train ~ wb2.pred.train))[2])
```
#### GPR
```{r}
wb2.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug16_gpr_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "Out-of-sample GPR against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
# print(coef(lm(hs.pred.train ~ wb2.pred.train))[2])

```
#### GPNN-IG
```{r}
wb2.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
# hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_outpred_",7,".csv")))
# as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_outpred__jobid_7.feather'))
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbig_a6_outpred__jobid_7.feather'))
hs.pred.train <- tail(pred.test[2,],2000)
plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPNN-IG Prediction (posterior mode)", xlab = "Truth", main = "Out-of-sample GPNN-IG against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
# print(coef(lm(hs.pred.train ~ wb2.pred.train))[2])
```

#### LD
```{r}
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug8_nnvwbsgldig_lowlr2_outpred__jobid_13.feather')))

colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

wb2.pred.train <- stat.out.ig$true
hs.pred.train <- stat.out.ig$mean
plot(y=hs.pred.train, x = wb2.pred.train, ylab="LD-IG Prediction (posterior mean)", xlab = "Truth", main = "Out-of-sample LD-IG against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
# print(coef(lm(hs.pred.train ~ wb2.pred.train))[2])

```

### Real data

#### HSP
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.pred.train <- age_tab$age[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug12_hsvwb_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Prediction", xlab = "Truth", main = "Out-of-sample HSP against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
# print(coef(lm(hs.pred.train ~ wb2.pred.train))[2])
```
#### GPR
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.pred.train <- age_tab$age[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "Out-of-sample GPR against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
# print(coef(lm(hs.pred.train ~ wb2.pred.train))[2])

```
#### GPNN-IG
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.pred.train <- age_tab$age[ind.to.use$test]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_outpred__jobid_4.feather'))
hs.pred.train <- tail(pred.test[2,],2000)
plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPNN-IG Prediction (posterior mode)", xlab = "Truth", main = "Out-of-sample GPNN-IG against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
# print(coef(lm(hs.pred.train ~ wb2.pred.train))[2])
```

#### LD
```{r}
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_nnvwbsgldig_lowlr2_outpred__jobid_20.feather')))

colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- age_tab$age[ind.to.use$test]
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

wb2.pred.train <- stat.out.ig$true
hs.pred.train <- stat.out.ig$mean
plot(y=hs.pred.train, x = wb2.pred.train, ylab="LD-IG Prediction (posterior mean)", xlab = "Truth", main = "Out-of-sample LD-IG against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
# print(coef(lm(hs.pred.train ~ wb2.pred.train))[2])

```

###Actually do Brain Age Gap for real data
#### HSP
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.pred.train <- age_tab$age[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug12_hsvwb_outpred_noscale_",1,".csv")))
hs.pred.train <- hs.pred.train - wb2.pred.train
boxplot(hs.pred.train ~wb2.pred.train, ylab="BAG (years)", xlab = "Truth (years)", main = "Out-of-sample HSP against Truth",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width

```


#### GPR
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.pred.train <- age_tab$age[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_outpred_noscale_",1,".csv")))
hs.pred.train <- hs.pred.train - wb2.pred.train
boxplot(hs.pred.train ~wb2.pred.train, ylab="BAG (years)", xlab = "Truth (years)", main = "Out-of-sample GPR against Truth",ylim=c(-15,22))

grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width


```
#### GPNN-IG
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.pred.train <- age_tab$age[ind.to.use$test]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_outpred__jobid_4.feather'))
hs.pred.train <- tail(pred.test[2,],2000)
hs.pred.train <- hs.pred.train - wb2.pred.train
boxplot(hs.pred.train ~wb2.pred.train, ylab="BAG (years)", xlab = "Truth (years)", main = "Out-of-sample GPNN-IG against Truth",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```

#### LD
```{r}
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_nnvwbsgldig_lowlr2_outpred__jobid_20.feather')))

colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- age_tab$age[ind.to.use$test]
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

wb2.pred.train <- stat.out.ig$true
hs.pred.train <- stat.out.ig$mean
hs.pred.train <- hs.pred.train - wb2.pred.train

boxplot(hs.pred.train ~wb2.pred.train, ylab="BAG (years)", xlab = "Truth (years)", main = "Out-of-sample LD-IG against Truth",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width

```

After meeting on 30 Aug, Tom says that it is known for BAG study to have such a bias
either 
1. Correct
2. Plot against predictions, which, in linear model, Yhat - Y (residual) is known to be orthogonal to Y and Yhat 

#30 Aug
Doing option 2 of the above
##BAG
#### HSP
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.pred.train <- age_tab$age[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug12_hsvwb_outpred_noscale_",1,".csv")))
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of HSP model",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width

```

#### GPR
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.pred.train <- age_tab$age[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_outpred_noscale_",1,".csv")))
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPR model",ylim=c(-15,22))

grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width


```
#### GPNN-IG
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.pred.train <- age_tab$age[ind.to.use$test]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_aug11_nnvwbig_a6_outpred__jobid_4.feather'))
hs.pred.train <- tail(pred.test[2,],2000)
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN model",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```

#### LD
```{r}
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_nnvwbsgldig_lowlr2_outpred__jobid_20.feather')))

colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- age_tab$age[ind.to.use$test]
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

wb2.pred.train <- stat.out.ig$true
hs.pred.train <- stat.out.ig$mean
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of LD-IG model",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width

```


#28 Aug
For relu and failed decomposition assess.
Run 5 was successful `/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug30_nnvwb4_zmat_*`
Run 8 is a short example of failure 172 seems good `/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug28_nnvwb4_zmat__jobid_8_172.csv `
```{r}
relu.val <- as.matrix(read.csv("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug30_nnvwb4_hidmat__jobid_3_576.csv"))
znb <- as.matrix(read.csv("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug30_nnvwb4_zmat__jobid_3_576.csv"))
age.val <- as.matrix(read.csv("/well/nichols/users/qcv214/bnn2/res3/pile/sim_aug30_nnvwb4_age__jobid_3_576.csv"))

```

```{r}
lmtest<- fast_horseshoe_lm(c(age.val),znb) #This also gives the bias term
```


#1 Sep
##Stochastic phase
Plot of SGD, EMB SGD, IG, HC
```{r}
#IG with alpha = 6 and initialisation with mean
runs <- c(1,10,11,12,13,14,15,2,21,24,26,27,30,6,7,8,9)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep1_nnvwb13_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(11,12,16,17,18,19,20,23,26,27,28,29,3,5,6)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbbayes14_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- c(11,15,16,17,19,20,22,27,28,30,7)
res.mat3 <- array(,dim=c(2,length(runs3),800))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep1_nnvwb7_loss__jobid_",i,".csv")))
}
# HSP
runs4 <- c(1,11,18,21,22,25,28,3,6,7,9)
res.mat4 <- array(,dim=c(2,length(runs4),800))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep1_nnvwb14_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3))
                             ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```

```{r}
#IG with alpha = 6 and initialisation with mean
runs <- c(11,15,20,22,24,25,27,29,4,7)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a11_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(17,24,26,29,3,4,5,8)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- c(11,15,16,17,19,20,22,27,28,30,7)
res.mat3 <- array(,dim=c(2,length(runs3),800))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep1_nnvwb7_loss__jobid_",i,".csv")))
}
# HSP
runs4 <- c(1,11,18,21,22,25,28,3,6,7,9)
res.mat4 <- array(,dim=c(2,length(runs4),800))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep1_nnvwb14_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3))
                             ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```


Test for nnvwb5
```{r}
#IG with alpha = 6 and initialisation with mean
runs <- c(1,10,13,14,15,16,17,19,20,27,28,3,8)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep2_nnvwbbayes10_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(1,11,12,14,16,17,19,20,21,22,24,25,27,28,29,30,4,5,6,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),280))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep1_nnvwb5_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- c(15,23,27,29,30,4,7)
res.mat3 <- array(,dim=c(2,length(runs3),800))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep1_nnvwb10_loss__jobid_",i,".csv")))
}
#HSP
# runs4 <- c(1,  34,14, 35,16, 36,17, 38,22, 41,24, 48,30, 6,33, 8)
# res.mat4 <- array(,dim=c(2,length(runs4),800))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_ju31_nnvwbhc_loss__jobid_",i,".csv")))
# }

#define legends
leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3)))
                             # ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```


#2 sep
real data
##Stochastic phase
Plot of SGD, EMB SGD, IG, HC
```{r}
#IG with alpha = 6 and initialisation with mean
runs <- c(1,16,21,8)
res.mat <- array(,dim=c(2,length(runs),280))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwb14_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(12,15,20,24,4,6,9,30)
res.mat2 <- array(,dim=c(2,length(runs2),280))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbbayes14_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- c(17,27)
res.mat3 <- array(,dim=c(2,length(runs3),280))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbig14_loss__jobid_",i,".csv")))
}
# HSP
# runs4 <- c(2,26,3,30,4,6)
# res.mat4 <- array(,dim=c(2,length(runs4),280))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep2_nnvwbhc_loss__jobid_",i,".csv")))
# }

#define legends
# leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
#                              ,paste0("EB",", n=",length(runs2))
#                              ,paste0("Vanilla",", n=",length(runs3)))
#                              # ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:280,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:280,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:280,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:280,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:280,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:280,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:280,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:280,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:280,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:280,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:280,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:280,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

# legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```

#3 Sep
From looking at sim data, these are the best
`nnvwbig14_a7`, `nnvwb14` and bad `nnvwbbayes14`

Pick run of nnvwbig14_a7 for SGLD
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",12,".csv")))
res.nn.loss.sgd.2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",17,".csv")))
res.nn.loss.sgd.3 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",24,".csv")))
res.nn.loss.sgd.4 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",26,".csv")))
res.nn.loss.sgd.5 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",29,".csv")))
res.nn.loss.sgd.6 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",3,".csv")))
res.nn.loss.sgd.7 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",30,".csv")))
res.nn.loss.sgd.8 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",4,".csv")))
res.nn.loss.sgd.9 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",5,".csv")))

poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       sqrt(res.nn.loss.sgd.1[2,]), sqrt(res.nn.loss.sgd.2[2,]),
                        sqrt(res.nn.loss.sgd.3[2,]),sqrt(res.nn.loss.sgd.4[2,]),sqrt(res.nn.loss.sgd.5[2,]),
                       sqrt(res.nn.loss.sgd.6[2,]),sqrt(res.nn.loss.sgd.7[2,]),sqrt(res.nn.loss.sgd.8[2,]),sqrt(res.nn.loss.sgd.9[2,]))
full.res.in <- rbind(wb.res[5],hs.res[5],
                     sqrt(res.nn.loss.sgd.1[1,]), sqrt(res.nn.loss.sgd.2[1,]),
                     sqrt(res.nn.loss.sgd.3[1,]),sqrt(res.nn.loss.sgd.4[1,]),sqrt(res.nn.loss.sgd.5[1,]),
                     sqrt(res.nn.loss.sgd.6[1,]),sqrt(res.nn.loss.sgd.7[1,]),sqrt(res.nn.loss.sgd.8[1,]),sqrt(res.nn.loss.sgd.9[1,]))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","GS", "6", "7","8","11","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[1,4,], type = "l", lty = 1,pch=2,col = 3,lwd=1)
lines(full.res[1,5,], type = "l", lty = 1,pch=3,col = 4,lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,pch=3,col = 5,lwd=1)
lines(full.res[1,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[1,8,], type = "b", lty = 2,pch=3,col = 3,lwd=1)
lines(full.res[1,9,], type = "b", lty = 2,pch=3,col = 4,lwd=1)
lines(full.res[1,10,], type = "b", lty = 2,pch=3,col = 5,lwd=1)
lines(full.res[1,11,], type = "b", lty = 2,pch=3,col = 7,lwd=1)

legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Validation RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,pch=1,col = 1,lwd=1)
lines(full.res[2,4,], type = "l", lty = 1,pch=2,col = 3,lwd=3)
lines(full.res[2,5,], type = "l", lty = 1,pch=3,col = 4,lwd=3)
lines(full.res[2,6,], type = "l", lty = 1,pch=2,col = 5,lwd=1)
lines(full.res[2,7,], type = "l", lty = 1,pch=3,col = 7,lwd=1)

lines(full.res[2,8,], type = "b", lty = 2,pch=3,col = 3,lwd=.2)
lines(full.res[2,9,], type = "b", lty = 2,pch=3,col = 4,lwd=.2)
lines(full.res[2,10,], type = "b", lty = 2,pch=3,col = 5,lwd=.2)
lines(full.res[2,11,], type = "b", lty = 2,pch=3,col = 7,lwd=.2)
legend('topright',legend = leglab,lty=c(1),col=c("white",1,3,4,5,7,6,2))
```
All looks the same, will pick run 17
## plot SGLD
0001
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",17,".csv")))
#Load many runs of LD:
# runs <- c(11,16,20,5,6,7) #for 001
runs <- c(11,13,14,19,28,6)
res.mat <- array(,dim=c(2,length(runs),1600))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbsgldig_0001_loss__jobid_",i,".csv")))
}


res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-0.001","SGLD-0.01","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```
0005
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",17,".csv")))
#Load many runs of LD:
runs <- c(22,26,27,5)
res.mat <- array(,dim=c(2,length(runs),1600))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbsgldig_0005_loss__jobid_",i,".csv")))
}


res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-0.001","SGLD-0.01","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```

For SGLD, use
Use 0001 `sep3_nnvwbsgldig_0001`
Just pick a random run: 6



##Assess real-data IG
```{r}
#IG with alpha = 6 and initialisation with mean
runs <- c(17,27)
res.mat <- array(,dim=c(2,length(runs),280))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbig14_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(16,18,24,27,6,9)
res.mat2 <- array(,dim=c(2,length(runs2),280))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbig15_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- c(11,13,25,27,28,9)
res.mat3 <- array(,dim=c(2,length(runs3),280))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbig16_loss__jobid_",i,".csv")))
}
# HSP
runs4 <- c(1,13,15,17,2,24,28,6)
res.mat4 <- array(,dim=c(2,length(runs4),280))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbig17_loss__jobid_",i,".csv")))
}

#define legends
# leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
#                              ,paste0("EB",", n=",length(runs2))
#                              ,paste0("Vanilla",", n=",length(runs3)))
#                              # ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:280,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:280,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:280,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:280,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:280,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:280,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

# legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```
`gpnnig 15,16,17` works, 15 is the best
Pick a random run for SGLD, try `24`, taken from `res.mat2[1,,280]`

Also waiting for saliency, and 4xsgld, sim res4, real res4, 
SGLD is 50 epochs only


#4 sep

##SGLD for real-data
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbig15_loss__jobid_",24,".csv")))
#Load many runs of LD:
runs <- c(1,10,17,18,19,20,23,24,25,29,30,9) #for 001
# runs <- c(10,12,13,16,18,26,27,28,3,5,6,7,8,9) #for 0005
res.mat <- array(,dim=c(2,length(runs),200))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbsgldig_001_loss__jobid_",i,".csv")))
}


res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-0.001","SGLD-0.01","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```
`001` is already overfitting which is interesting, so pick 001
Randomly use run 1 from that.

##Computing BAG

#### GPNN-IG
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.pred.train <- age_tab$age[ind.to.use$test]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbig15_outpred__jobid_24.feather'))
hs.pred.train <- tail(pred.test[2,],2000)
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-IG model",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```

#### LD
```{r}
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbsgldig_001_outpred__jobid_1.feather')))

colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- age_tab$age[ind.to.use$test]
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

wb2.pred.train <- stat.out.ig$true
hs.pred.train <- stat.out.ig$mean
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of LD-IG model",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width

```

##Sumamry results of SGLD real data 

###Load SGLD 50 epochs
Pick a random run
Load data
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbsgldig_001_inpred__jobid_1.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbsgldig_001_outpred__jobid_1.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/50)

age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- age_tab$age[wb2.train.id]


true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/200)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- age_tab$age[wb2.test.id]
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,50-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,50-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/50*100)
}
stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,200-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,200-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/200*100)
}
stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
print(paste0('in MAE: ',(mean(abs(stat.in.ig$mean-stat.in.ig$true)))))
print(paste0('out MAE: ',(mean(abs(stat.out.ig$mean-stat.out.ig$true)))))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```
Compare to without personalised variance
```{r}
stat.in.ig$modmse <- sqrt(in.mse)

stat.in.ig$lwrmodmse <- stat.in.ig$mean - qt(0.975,50-1)*stat.in.ig$modmse
stat.in.ig$uprmodmse <- stat.in.ig$mean + qt(0.975,50-1)*stat.in.ig$modmse

#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i]))/50*100)
}
stat.in.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i])))
}
stat.in.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermodmse)/2000*100))

stat.out.ig$modmsemse <- sqrt(in.mse)

stat.out.ig$lwrmodmse <- stat.out.ig$mean - qt(0.975,200-1)*stat.out.ig$modmse
stat.out.ig$uprmodmse <- stat.out.ig$mean + qt(0.975,200-1)*stat.out.ig$modmse

within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i]))/200*100)
}
stat.out.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i])))
}
stat.out.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermodmse)/2000*100))

print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
```

##Summary results of SGLD sim data
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbsgldig_0001_inpred__jobid_6.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbsgldig_0001_outpred__jobid_6.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/400)

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/400*100)
}
stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/1600*100)
}
stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
print(paste0('in MAE: ',(mean(abs(stat.in.ig$mean-stat.in.ig$true)))))
print(paste0('out MAE: ',(mean(abs(stat.out.ig$mean-stat.out.ig$true)))))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```
Compare to without personalised variance
```{r}
stat.in.ig$modmse <- sqrt(in.mse)

stat.in.ig$lwrmodmse <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$modmse
stat.in.ig$uprmodmse <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$modmse

#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i]))/400*100)
}
stat.in.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i])))
}
stat.in.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermodmse)/2000*100))

stat.out.ig$modmsemse <- sqrt(in.mse)

stat.out.ig$lwrmodmse <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$modmse
stat.out.ig$uprmodmse <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$modmse

within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i]))/1600*100)
}
stat.out.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i])))
}
stat.out.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermodmse)/2000*100))

print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
```
shows undercoverage
###Try sgld 0005
##Summary results of SGLD sim data
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbsgldig_0005_inpred__jobid_26.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbsgldig_0005_outpred__jobid_26.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/400)

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/400*100)
}
stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/1600*100)
}
stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
print(paste0('in MAE: ',(mean(abs(stat.in.ig$mean-stat.in.ig$true)))))
print(paste0('out MAE: ',(mean(abs(stat.out.ig$mean-stat.out.ig$true)))))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```
Compare to without personalised variance
```{r}
stat.in.ig$modmse <- sqrt(in.mse)

stat.in.ig$lwrmodmse <- stat.in.ig$mean - qt(0.975,400-1)*stat.in.ig$modmse
stat.in.ig$uprmodmse <- stat.in.ig$mean + qt(0.975,400-1)*stat.in.ig$modmse

#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i]))/400*100)
}
stat.in.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i])))
}
stat.in.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermodmse)/2000*100))

stat.out.ig$modmsemse <- sqrt(in.mse)

stat.out.ig$lwrmodmse <- stat.out.ig$mean - qt(0.975,1600-1)*stat.out.ig$modmse
stat.out.ig$uprmodmse <- stat.out.ig$mean + qt(0.975,1600-1)*stat.out.ig$modmse

within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i]))/1600*100)
}
stat.out.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i])))
}
stat.out.ig$true.covermodmse <- within.pred

print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermodmse)/2000*100))

print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
```


##Currently waiting for results of real res4, & hc14 


#5 Sep
Assessing HC
##Real data
```{r}
#IG with alpha = 6 and initialisation with mean
runs3 <- c(1,16,21,8)
res.mat3<- array(,dim=c(2,length(runs3),280))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwb14_loss__jobid_",i,".csv")))
}

runs1 <- c(16,18,24,27,6,9)
res.mat1 <- array(,dim=c(2,length(runs1),280))
for(i in runs1){
  res.mat1[,which(i==runs1),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbig15_loss__jobid_",i,".csv")))
}

runs4 <- c(16,17,2,20,22,23,5,6)
res.mat4 <- array(,dim=c(2,length(runs4),280))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep4_nnvwbhc14_loss__jobid_",i,".csv")))
}


# HSP
runs2 <- c(12,15,20,24,30,4,6,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),280))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbbayes14_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(7,300)",", n=",length(runs1))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3))
                             ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat1[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:280,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:280,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:280,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat1[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:280,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:280,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:280,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```


##Sim data
```{r}
#IG with alpha = 6 and initialisation with mean
runs2 <- c(11,12,16,17,18,19,20,23,26,27,28,29,3,5,6)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbbayes14_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs1 <- c(17,24,26,29,3,4,5,8)
res.mat1 <- array(,dim=c(2,length(runs1),800))
for(i in runs1){
  res.mat1[,which(i==runs1),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep3_nnvwbig14_a7_loss__jobid_",i,".csv")))
}
#SGD
runs4 <- c(10,13,14,15,17,18,2,20,25,28,3,4,6,7,8)
res.mat4 <- array(,dim=c(2,length(runs4),800))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep4_nnvwbhc14_loss__jobid_",i,".csv")))
}
# HSP
runs3 <- c(1,11,18,21,22,25,28,3,6,7,9)
res.mat3 <- array(,dim=c(2,length(runs3),800))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep1_nnvwb14_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(7,300)",", n=",length(runs1))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3))
                             ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat1[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat1[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```







#8 Sep

Re-define work with sigma

##Sim
Plot nnvwb
```{r}
#IG with alpha = 6 and initialisation with mean
runs <- c(12,15,2,22,26)
res.mat <- array(,dim=c(2,length(runs),800))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb3_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(12,15,2,22,26)
res.mat2 <- array(,dim=c(2,length(runs2),800))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb3_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- c(11,15,17,2,20,22,28,29,6)
res.mat3 <- array(,dim=c(2,length(runs3),800))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb4_loss__jobid_",i,".csv")))
}
# HSP
runs4 <- c(11,15,17,2,20,22,28,29,6)
res.mat4 <- array(,dim=c(2,length(runs4),800))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb4_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3))
                             ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:800,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:800,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:800,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:800,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:800,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:800,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```
##Plot for other stuff, eb and ig
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(10,12,13,17,24,29,30,6,7,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnig_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(14,19,21,23,26,27,29,30)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nneb_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,10,12,17,19,24,25,3,30,4,5,6)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nneb2_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3))
                             ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 
nnig, nnvwb, nneb2
##Real data
Result of nnvwb3 has too low lr
also nnig3 need higher lr too
```{r}
#IG with alpha = 6 and initialisation with mean
runs <- c(16,20,22,26,7)
num.it <- 80*4
res.mat <- array(,dim=c(2,length(runs),320))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_nnvwb5_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- c(17,31,35,40,42,46)
res.mat2 <- array(,dim=c(2,length(runs2),320))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_nneb2_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- c(12,14,17,21,3,31,36,4,7)
res.mat3 <- array(,dim=c(2,length(runs3),320))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_nnig4_loss__jobid_",i,".csv")))
}
# HSP
runs4 <- c(12,17,18,24,25,27,28,29,8,9)
res.mat4 <- array(,dim=c(2,length(runs4),320))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_nnvwb2_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3))
                             ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:320,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:320,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:320,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:320,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:320,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:320,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:320,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:320,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:320,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:320,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:320,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:320,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:320,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:320,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:320,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:320,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:320,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:320,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:320,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:320,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:320,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:320,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:320,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:320,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 
Perhaps use nnig4  PICK RUN 12
and nnwb2? 
And nneb2

#8 sep
##Simulation

#9 Sep
91 is re nnvwb4/
job 99 ld0001 => loss keeps rising
job 30 ld001 => loss keeps rising
31 is re ig4 /
32 is re eb2 => stopped for allowing more room
03 is ld00005 /
04 is ld00001 /
06 is sim eb2 /
33 is re eb2 /
78 is re nnvwb5 / 
79 is re nnvwb6 => gave up 
74 is re ld00001 /
95 is re ld000001 /
96 is re ld0001 /

28 is sim res4 nn /
29 is sim res4 ig /
39 is sim res4 eb /

33 - saliency /
34 - re res4 nn /
35 - re res4 nneb / accidentally saved as sep7_nned
36 - re res4 nnig /

bs - 57 saliency viz

##Assess simulation SGLD
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnig_loss__jobid_",10,".csv")))
#Load many runs of LD:
# runs <- c(11,16,20,5,6,7) #for 001
# runs <- c(1,10,11,13,14,15,16,19,2,21,24,25,26,30,4,5,6,7,8) #00005
runs <- c(1,11,13,14,15,17,18,19,22,23,24,25,26,27,28,29,30,5,6,7,9) #00001

res.mat <- array(,dim=c(2,length(runs),400))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_sgld00001_loss__jobid_",i,".csv")))
}


res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-0.001","SGLD-0.01","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```
ld0001 is still too bad.
ld00005 shows slightly increasing loss but not too bad, PICK run 1
ld00001 shows constant loss PICK run 15


##Simulation LD result 
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_sgld00001_inpred__jobid_15.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_sgld00001_outpred__jobid_15.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/100)

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/400)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,100-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,100-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
# for(i in 1:nrow(stat.in.ig)){
#   within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/100*100)
# }
# stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,400-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,400-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
# within.pred <- vector(mode='numeric')
# for(i in 1:nrow(stat.out.ig)){
#   within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/400*100)
# }
# stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
print(paste0('in MAE: ',(mean(abs(stat.in.ig$mean-stat.in.ig$true)))))
print(paste0('out MAE: ',(mean(abs(stat.out.ig$mean-stat.out.ig$true)))))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```
For sgld00005
[1] "Proprtion of true lying within subject 95% prediction interval: 95.7"
[1] "Proprtion of true lying within subject 95% prediction interval: 91.45"
[1] "in RMSE: 4.50777102867092"
[1] "out RMSE: 5.07341902657775"
[1] "True noise: 4.58"
[1] "in MAE: 3.61614782727669"
[1] "out MAE: 4.025246700031"
[1] "in R-square: 0.645421836476188"
[1] "in R-square: 0.554568301387521"

Compare to without personalised variance
```{r}
stat.in.ig$modmse <- sqrt(in.mse)

stat.in.ig$lwrmodmse <- stat.in.ig$mean - qt(0.975,100-1)*stat.in.ig$modmse
stat.in.ig$uprmodmse <- stat.in.ig$mean + qt(0.975,100-1)*stat.in.ig$modmse

#Prediction
library("dplyr")
# within.pred <- vector(mode='numeric')
# for(i in 1:nrow(stat.in.ig)){
#   within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i]))/100*100)
# }
# stat.in.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i])))
}
stat.in.ig$true.covermodmse <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermodmse)/2000*100))

stat.out.ig$modmsemse <- sqrt(in.mse)

stat.out.ig$lwrmodmse <- stat.out.ig$mean - qt(0.975,400-1)*stat.out.ig$modmse
stat.out.ig$uprmodmse <- stat.out.ig$mean + qt(0.975,400-1)*stat.out.ig$modmse

# within.pred <- vector(mode='numeric')
# for(i in 1:nrow(stat.out.ig)){
#   within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i]))/400*100)
# }
# stat.out.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i])))
}
stat.out.ig$true.covermodmse <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermodmse)/2000*100))

print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
```
[1] "Proprtion of true lying within subject 95% prediction interval: 95.4"
[1] "Proprtion of true lying within subject 95% prediction interval: 91"
[1] "in RMSE: 4.50777102867092"
[1] "out RMSE: 5.07341902657775"
[1] "True noise: 4.58"
for sgld00005

From this, use sgld with nosie 


##real SGLD
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_nnig4_loss__jobid_",12,".csv")))
#Load many runs of LD:
# runs <- c(11,16,20,5,6,7) #for 001
# runs <- c(10,11,15,16,17,20,22,24,6) #00005
runs <- c(11,12,13,17,2,22,3,5,6,9) #0001

res.mat <- array(,dim=c(2,length(runs),200))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_sgld0001_loss__jobid_",i,".csv")))
}


res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-0.001","SGLD-0.01","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```
`ld0001` is okay, rising loss in test PICK RUN 6
ld00001 is too over fitting
###Summary result
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_sgld0001_inpred__jobid_6.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_sgld0001_outpred__jobid_6.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/50)

age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- age_tab$age[wb2.train.id]


true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/200)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- age_tab$age[wb2.test.id]
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,50-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,50-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
# within.pred <- vector(mode='numeric')
# for(i in 1:nrow(stat.in.ig)){
#   within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/50*100)
# }
# stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,200-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,200-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
# within.pred <- vector(mode='numeric')
# for(i in 1:nrow(stat.out.ig)){
#   within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/200*100)
# }
# stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

no.obs <- 50
plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
     xlab='Subject Number',ylab='Age (years)', pch = 20)
abline(h=95,col='red',lwd=2)
points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )

abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
print(paste0('in MAE: ',(mean(abs(stat.in.ig$mean-stat.in.ig$true)))))
print(paste0('out MAE: ',(mean(abs(stat.out.ig$mean-stat.out.ig$true)))))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```
Compare to without personalised variance
```{r}
stat.in.ig$modmse <- sqrt(in.mse)

stat.in.ig$lwrmodmse <- stat.in.ig$mean - qt(0.975,50-1)*stat.in.ig$modmse
stat.in.ig$uprmodmse <- stat.in.ig$mean + qt(0.975,50-1)*stat.in.ig$modmse

#Prediction
library("dplyr")
# within.pred <- vector(mode='numeric')
# for(i in 1:nrow(stat.in.ig)){
#   within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i]))/50*100)
# }
# stat.in.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmodmse[i],stat.in.ig$uprmodmse[i])))
}
stat.in.ig$true.covermodmse <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermodmse)/2000*100))

stat.out.ig$modmsemse <- sqrt(in.mse)

stat.out.ig$lwrmodmse <- stat.out.ig$mean - qt(0.975,200-1)*stat.out.ig$modmse
stat.out.ig$uprmodmse <- stat.out.ig$mean + qt(0.975,200-1)*stat.out.ig$modmse

# within.pred <- vector(mode='numeric')
# for(i in 1:nrow(stat.out.ig)){
#   within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i]))/200*100)
# }
# stat.out.ig$within.predmodmse <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmodmse[i],stat.out.ig$uprmodmse[i])))
}
stat.out.ig$true.covermodmse <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmodmse>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermodmse)/2000*100))

print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
```

###Computing BAG

#### GPNN-IG
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.pred.train <- age_tab$age[ind.to.use$test]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_nnig4_outpred__jobid_12.feather'))
hs.pred.train <- tail(pred.test[2,],2000)
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of GPNN-IG model",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
```

#### LD
```{r}
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_sgld0001_outpred__jobid_6.feather')))

colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/1600)

ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"));ind.to.use <- list()
ind.to.use$test <- unlist(ind.temp[2,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- age_tab$age[ind.to.use$test]
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

wb2.pred.train <- stat.out.ig$true
hs.pred.train <- stat.out.ig$mean
rd.pred <- round(hs.pred.train)
hs.pred.train <- hs.pred.train - wb2.pred.train
missing.pred <- setdiff(43:88,rd.pred)
rd.pred <- c(rd.pred,missing.pred)
hs.pred.train <- c(hs.pred.train,rep(100,length(missing.pred)))
boxplot(hs.pred.train ~rd.pred, ylab="BAG (years)", xlab = "Age Prediction (years)", main = "Brain Age Gap of LD-IG model",ylim=c(-15,22))
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width

```


#14 sep
Use of dti
`/well/win-biobank/projects/imaging/data/data3/subjectsAll/21000260/dMRI/TBSS/FA`

#15 Sep
##Simulation GPNN HSP
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(10,15,18,19,2,20,23,25,26,27,28,29,3,4,6,7,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep16_nnhc_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- c(1,13,14,15,16,18,19,2,21,22,23,27,29,3,30,4,5,6,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep15_nnhc2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,10,12,13,15,16,17,2,27,28,30,4,5,8)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep15_nnhc3_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNN-HSP, lr = 0.6")
                             ,paste0("GPNN-HSP, lr = 0.05")
                             ,paste0("GPNN-HSP, lr = 0.1")
                             ,paste0("GPNN, lr = 0.02"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 



#27 sep
##HSP of Real data
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 70*4
runs3 <- c(15,17,19,27,28,9)
res.mat3<- array(,dim=c(2,length(runs3),280))
for(i in runs3){
  # res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwb14_loss__jobid_",i,".csv")))
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep19_nnhc_loss__jobid_",i,".csv")))[,1:num.it]
}

runs1 <- c(16,18,24,27,6,9)
res.mat1 <- array(,dim=c(2,length(runs1),280))
for(i in runs1){
  res.mat1[,which(i==runs1),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbig15_loss__jobid_",i,".csv")))
}

runs4 <- c(1,17,2,20,22,28)
res.mat4 <- array(,dim=c(2,length(runs4),280))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep19_nnhc2_loss__jobid_",i,".csv")))[,1:num.it]
}


# HSP
runs2 <- c(12,15,20,24,30,4,6,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),280))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep3_nnvwbbayes14_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(7,300)",", n=",length(runs1))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3))
                             ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat1[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:280,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:280,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:280,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat1[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:280,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:280,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:280,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:280,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:280,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:280,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```


#29 sep
##Simulation with sigma
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(1,10,13,14,15,18,2,20,21,27,29,4,7,8)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep28_nnvwb_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- c(1,10,12,16,19,20,25,4,6,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep29_nnvwb_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(10,11,12,14,16,17,2,21,25,29,3,4,7,8)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep29_sig_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("IG(6,0.5)",", n=",length(runs))
                             ,paste0("EB",", n=",length(runs2))
                             ,paste0("Vanilla",", n=",length(runs3))
                             ,paste0("HSP",", n=",length(runs4)))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 

#30 sep
##Assess different lr for sigma
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(11,12,13,14,15,16,20,21,22,24,27,3,30,5,6,7,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep29_sig2_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- c(1,2,7,8)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep29_sig4_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,2,6,8,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep29_sig5_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("Sigma lr = 1e-4")
                             ,paste0("Sigma lr = 1e-3")
                             ,paste0("Sigma lr = 1e-2")
                             ,paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 
even `1e-4` produces stable res, look at `1e-3` and `1e-2`

##Look at Gaussian bias
with gaussian variance 1
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(10,12,13,15,16,17,2,20,21,23,26,27,30,4,6,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep29_nnbias_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- c(10,12,13,15,16,17,2,20,21,23,26,27,30,4,6,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep29_nnbias_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(10,12,13,15,16,17,2,20,21,23,26,27,30,4,6,8,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep29_nnbias_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNN+Gaussian prior on bias"),paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
# res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
# lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
# 
# res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
# lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
# res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
# 
# res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
``` 

Essentially stgp is drop-out?

##STGP
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(1,10,12,13,2,20,7)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep30_stgp_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- c(1,10,11,13,15,18,19,20,6,7,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep30_stgp2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,11,13,17,2,3,4,7,8,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep30_stgp3_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("STGP,0.25")
                             ,paste0("STGP,0.15")
                             ,paste0("STGP,0.05")
                             ,paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 


#3 Oct 

##Assess unbiased estimate GPNN
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(1,12,19,2,3,4,5,7)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct3_nnvwb_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- c(10,14,16,18,19,2,20,4,5,6)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct3_nnvwb2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,11,12,16,17,18,19,2,3)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct3_nnvwb3_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNNadj,lr = 0.05")
                             ,paste0("GPNNadj,lr = 0.005")
                             ,paste0("GPNNadj,lr = 0.0005")
                             ,paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 

##Assess OLS last layer
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(1,11,2,3,4,5,6,7,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct3_nnvwb_ols_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNN+OLS"),paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
``` 

##GPNN adjusted and sigma
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(6,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct3_adjsigma_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- c(12,13,6,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct3_adjsigma2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
# runs3 <- c(1,11,13,17,2,3,4,7,8,9)
# res.mat3 <- array(,dim=c(2,length(runs3),num.it))
# for(i in runs3){
#   res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep30_stgp3_loss__jobid_",i,".csv")))[,1:num.it]
# }
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNNadj&sigma^2, lr = 0.05")
                             ,paste0("GPNNadj&sigma^2, lr = 0.005")
                             # ,paste0("STGP,0.05")
                             ,paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

# res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
# lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

# res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange'))
``` 

#4 oct
Redo everything in this order
1.Correct MAP
2. Add sigma
3. Add bias prior
4. STGP
5. OLS

##MAP
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(4,17)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_nnvwb_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- c(1,13,14,15,18,2,20,4,5,6,7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_nnvwb2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(12,15,3,5)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_nnvwb3_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNN-MAP,lr = 0.05")
                             ,paste0("GPNN-MAP,lr = 0.005")
                             ,paste0("GPNN-MAP,lr = 0.0005")
                             ,paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 

##Adding Sigma
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(1,14,17,18)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigma_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- c(10,14,19,2,20,3,5,6,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigma2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
# runs3 <- c(1,11,13,17,2,3,4,7,8,9)
# res.mat3 <- array(,dim=c(2,length(runs3),num.it))
# for(i in runs3){
#   res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep30_stgp3_loss__jobid_",i,".csv")))[,1:num.it]
# }
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNN-MAP-sigma, lr = 0.05")
                             ,paste0("GPNN-MAP-sigma, lr = 0.005")
                             # ,paste0("STGP,0.05")
                             ,paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

# res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
# lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

# res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange'))
``` 

##Adding bias prior
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(1,10,12,14,15,17,18,19,2,4,6,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigmabias_loss__jobid_",i,".csv")))[,1:num.it]
}

# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNN-MAP-sigma-bias"),paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
``` 

##STGP
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(1,10,13,17,19,2,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigmabiasstgp_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- c(11,13,2,20,5,7)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigmabiasstgp2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(12,15,17,18,19,2,20,4,5,6,7)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigmabiasstgp3_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("STGP,0.05")
                             ,paste0("STGP,0.15")
                             ,paste0("STGP,0.25")
                             ,paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(1,10,13,17,19,2,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigmabiasstgp_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- c(1,11,14,16,5)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigmabiasstgp6_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,10,18,3,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigmabiasstgp7_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("STGP,0.05")
                             ,paste0("STGP,0.5")
                             ,paste0("STGP,0.75")
                             ,paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,9))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,9))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 


## OLS
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 150*4
runs <- c(1:20)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigmabiasstgpols_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
# HSP
runs4 <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("STGP0.05+OLS"),paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
``` 

##Summary
```{r}
#GPNN
num.it <- 150*4
runs <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <- c(1,13,14,15,18,2,20,4,5,6,7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_nnvwb2_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- c(1,10,12,14,15,17,18,19,2,4,6,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigmabias_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:20
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigmabiasstgpols_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNN")
                             ,paste0("GPNN-MAP")
                             ,paste0("GPNN-MAP-sigma-bias")
                             ,paste0("STGP-OLS"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 

#5 oct

##stgp ols at v=.25
```{r}
#GPNN
num.it <- 150*4
runs <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <- c(1,13,14,15,18,2,20,4,5,6,7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_nnvwb2_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- c(1,10,12,14,15,17,18,19,2,4,6,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct4_adjsigmabias_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:20
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct5_adjsigmabiasstgpols_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNN")
                             ,paste0("GPNN-MAP")
                             ,paste0("GPNN-MAP-sigma-bias")
                             ,paste0("STGP-OLS"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 

##sgld
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct5_adjsigmabiasstgpols_loss__jobid_",1,".csv")))
#Load many runs of LD:
runs <- 1:20


res.mat <- array(,dim=c(2,length(runs),400))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct5_sgld001_loss__jobid_",i,".csv")))
}


res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-0.001","SGLD-0.01","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, 6),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), 6),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```
0001 is decent
0005 is also decent
****001 is also fine*****
01 isn't fine



#6 Oct

##Assess res4
```{r}
#GPNN
num.it <- 150*4
runs <- c(12,13,15,16,18,19,20,21,23,24,25,28,29,3,4,8)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_sep7_nnvwb_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct5_adjsigmabiasstgpols_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- c(10,11,13,15,16,17,19,20,21,23,24,25,26,27,28,29,4,7,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_res4_sep7_nnvwb_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:20
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_res4_oct5_adjsigmabiasstgpols_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("12R-GPNN")
                             ,paste0("12R-STGP")
                             ,paste0("52R-GPNN")
                             ,paste0("52R-STGP"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 
52R stgp has lower training and higher training => definitely overfitting.

##SGLD full
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct5_adjsigmabiasstgpols_loss__jobid_",1,".csv")))
#Load many runs of LD:
runs <- 1:20


res.mat <- array(,dim=c(2,length(runs),400))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct6_sgldfull_loss__jobid_",i,".csv")))
}


res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-0.001","SGLD-0.01","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, 6),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), 6),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```
Not really working.. Need to find another way...

##Real data 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 80*4
runs <- setdiff(1:20,c(1,6,18))
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_oct6_stgpols_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- setdiff(1:20,c(8,14,19))
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_oct6_stgpols4_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- setdiff(1:20,c(3))
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_oct6_stgpols5_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,17,18,24,25,27,28,29,8,9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_nnvwb2_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("STGP,0.25")
                             ,paste0("STGP,0.35")
                             ,paste0("STGP,0.40")
                             ,paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,9))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,9))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 
This graph is good, higher threshold => worse performance

Do all stgp graphs suggest that no threshold are actually needed, GP takes good care already?

##Plot real-data SGLD
```{r}
res.nn.loss.sgd.1 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_oct6_stgpols_loss__jobid_",1,".csv")))
#Load many runs of LD:

runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),400))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_oct7_sgld001_loss__jobid_",i,".csv")))
}


res.iqr.train <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))

res.iqr.test <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))



#Corresponding lr:
res.nn.loss.sgd.2 <- rbind(res.iqr.train[2,],res.iqr.test[2,])
res.nn.loss.sgd.3 <- rbind(res.iqr.train[1,],res.iqr.test[1,])
res.nn.loss.sgd.4 <- rbind(res.iqr.train[3,],res.iqr.test[3,])


poly_degree = 10
a_concentration = 2 #picked so that it's in the middle of my nn grid search
b_smoothness = 40
wb.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_",poly_degree,a_concentration,b_smoothness,"_",4,".csv")))
hs.res <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_n12_hsvwb_noscale_",1,".csv")))
full.res.out <- rbind( wb.res[5],hs.res[6],
                       c(sqrt(res.nn.loss.sgd.1[2,]),rep(NA,length(res.nn.loss.sgd.2[2,]))), c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.2[2,])),
                        c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.3[2,])),
                       c(rep(NA,length(res.nn.loss.sgd.1[2,])),sqrt(res.nn.loss.sgd.4[2,])))

full.res.in <- rbind(wb.res[5],hs.res[5],
                     c(sqrt(res.nn.loss.sgd.1[1,]),rep(NA,length(res.nn.loss.sgd.2[1,]))), c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.2[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.3[1,])),
                     c(rep(NA,length(res.nn.loss.sgd.1[1,])),sqrt(res.nn.loss.sgd.4[1,])))
full.res <- array(,dim=c(2,dim(full.res.in)))
full.res[1,,] <- full.res.in
full.res[2,,] <- full.res.out

leglab <- c("method","SGD", "SGLD-0.001","SGLD-0.01","Synthetic noise","HSP vs GP-Reg")
line.type <- 'l'
plot(full.res[1,1,],type=line.type,col = 6, ylim = c(2.5, max(full.res[1,,],na.rm = TRUE)),lwd=2,
     main = "Training RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[1,2,],type=line.type,col = 2,lwd=2)
lines(full.res[1,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[1,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[1,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[1,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('bottomright',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))

#out-of-sample
plot(full.res[2,1,],type=line.type,col = 6, ylim = c(min(full.res[2,,],na.rm = TRUE), max(full.res[2,,],na.rm = TRUE)),lwd=2,
     main = "Test RMSE",
     ylab = "Batch RMSE",xlab= "Iteration")
lines(full.res[2,2,],type=line.type,col = 2,lwd=2)
lines(full.res[2,3,], type = "l", lty = 1,col = 1,lwd=2)
lines(full.res[2,4,], type = "l", lty = 1,col = 'red',lwd=2)
lines(full.res[2,5,], type = "l", lty = 1,col = 'pink',lwd=1)
lines(full.res[2,6,], type = "l", lty = 1,col = 'pink',lwd=1)
legend('top',legend = leglab,lty=c(1),col=c("white",1,"red","blue",6,2))
```

#7 Oct
Create summary of results

#11 Oct

##SGLD

###simulation
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct5_sgld001_inpred__jobid_1.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/sim_oct5_sgld001_outpred__jobid_1.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/100)

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_inpred_4_addednoise.csv")))
true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/400)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_outpred_4_addednoise.csv")))
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,100-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,100-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")
within.pred <- vector(mode='numeric')
# for(i in 1:nrow(stat.in.ig)){
#   within.pred <- c(within.pred,sum(between(p.in.ig$pred[p.in.ig$id==stat.in.ig$id[i]],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i]))/100*100)
# }
# stat.in.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

# no.obs <- 50
# plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
#      xlab='Subject Number',ylab='Age (years)', pch = 20)
# abline(h=95,col='red',lwd=2)
# points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
# points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
# abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
# abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
# abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,400-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,400-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")
# within.pred <- vector(mode='numeric')
# for(i in 1:nrow(stat.out.ig)){
#   within.pred <- c(within.pred,sum(between(p.out.ig$pred[p.out.ig$id==stat.out.ig$id[i]],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i]))/400*100)
# }
# stat.out.ig$within.predmod <- within.pred

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))

# no.obs <- 50
# plot(y=stat.out.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
#      xlab='Subject Number',ylab='Age (years)', pch = 20)
# abline(h=95,col='red',lwd=2)
# points(stat.out.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
# points(stat.out.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
# 
# abline(v=(1:no.obs)*stat.out.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
# abline(v=(1:no.obs)*(1-stat.out.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
# abline(v=0,col='white',lwd=3)

# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
print(paste0('in MAE: ',(mean(abs(stat.in.ig$mean-stat.in.ig$true)))))
print(paste0('out MAE: ',(mean(abs(stat.out.ig$mean-stat.out.ig$true)))))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```


###real data
sgld 001
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_oct7_sgld001_inpred__jobid_1.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_oct7_sgld001_outpred__jobid_1.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/100)

age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- age_tab$age[wb2.train.id]


true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/400)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- age_tab$age[wb2.test.id]
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,100-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,100-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

# no.obs <- 50
# plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
#      xlab='Subject Number',ylab='Age (years)', pch = 20)
# abline(h=95,col='red',lwd=2)
# points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
# points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
# abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
# abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
# abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,400-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,400-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))


# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
print(paste0('in MAE: ',(mean(abs(stat.in.ig$mean-stat.in.ig$true)))))
print(paste0('out MAE: ',(mean(abs(stat.out.ig$mean-stat.out.ig$true)))))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```

sgld 01
```{r}
p.in.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_oct7_sgld01_inpred__jobid_1.feather')))
p.out.ig <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/pile/re_oct7_sgld01_outpred__jobid_1.feather')))
colnames(p.in.ig) <- c('id','pred')

#### In
mean.in.ig <- aggregate(.~id,data=p.in.ig,mean)
sd.in.ig <-  aggregate(.~id,data=p.in.ig,sd)
library(plotrix)
ser.in.ig <- aggregate(.~id,data=p.in.ig,std.error)
stat.in.ig <- cbind(mean.in.ig,sd.in.ig$pred,ser.in.ig$pred)
colnames(stat.in.ig) <- c('id','mean','sd','stderr')
stat.in.ig$adjstderr <- stat.in.ig$sd*sqrt(1+1/100)

age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

wb2.train.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[1,]
wb2.train.pred <- age_tab$age[wb2.train.id]


true.train<- data.frame(wb2.train.id,wb2.train.pred,row.names = NULL)
colnames(true.train) <- c('id','true')
stat.in.ig <- merge(stat.in.ig,true.train, by = 'id')

#### Out
colnames(p.out.ig) <- c('id','pred')
mean.out.ig <- aggregate(.~id,data=p.out.ig,mean)
sd.out.ig <-  aggregate(.~id,data=p.out.ig,sd)
library(plotrix)
ser.out.ig <- aggregate(.~id,data=p.out.ig,std.error)
stat.out.ig <- cbind(mean.out.ig,sd.out.ig$pred,ser.out.ig$pred)
colnames(stat.out.ig) <- c('id','mean','sd','stderr')
stat.out.ig$adjstderr <- stat.out.ig$sd*sqrt(1+1/400)

wb2.test.id<- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv")))[2,]
wb2.test.pred <- age_tab$age[wb2.test.id]
true.test<- data.frame(wb2.test.id,wb2.test.pred,row.names = NULL)
colnames(true.test) <- c('id','true')

stat.out.ig <- merge(stat.out.ig,true.test, by = 'id')

stat.out.ig$stderrglob <- sqrt(wb.res[5]^2+stat.out.ig$sd^2)

in.mse <- mean((stat.in.ig$mean-stat.in.ig$true)^2)

####For IG insample
# in-sample statistics
stat.in.ig$stderrmod <- sqrt(in.mse+stat.in.ig$sd^2)
# plot(y=stat.in.ig$sd,x=stat.in.ig$id)

stat.in.ig$lwrmod <- stat.in.ig$mean - qt(0.975,100-1)*stat.in.ig$stderrmod
stat.in.ig$uprmod <- stat.in.ig$mean + qt(0.975,100-1)*stat.in.ig$stderrmod

#####Define proportion counting
#Prediction
library("dplyr")

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.in.ig)){
  within.pred <- c(within.pred,(between(stat.in.ig$true[i],stat.in.ig$lwrmod[i],stat.in.ig$uprmod[i])))
}
stat.in.ig$true.covermod <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.in.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.in.ig$true.covermod)/2000*100))

# no.obs <- 50
# plot(y=stat.in.ig$true[1:no.obs],x=1:no.obs ,main = 'True age and the 95% Prediction Interval',
#      xlab='Subject Number',ylab='Age (years)', pch = 20)
# abline(h=95,col='red',lwd=2)
# points(stat.in.ig$lwrmod[1:no.obs],x = 1:no.obs,col='red',pch=15)
# points(stat.in.ig$uprmod[1:no.obs],x = 1:no.obs,col='blue',pch=15 )
# abline(v=(1:no.obs)*stat.in.ig$true.covermod[1:no.obs],lty=2,col='darkgreen',lwd=1)
# abline(v=(1:no.obs)*(1-stat.in.ig$true.covermod[1:no.obs]),lty=2,col='grey',lwd=0.5)
# abline(v=0,col='white',lwd=3)



####For IG Out-of-sample#########
stat.out.ig$stderrmod <- sqrt(in.mse+stat.out.ig$sd^2)

stat.out.ig$lwrmod <- stat.out.ig$mean - qt(0.975,400-1)*stat.out.ig$stderrmod
stat.out.ig$uprmod <- stat.out.ig$mean + qt(0.975,400-1)*stat.out.ig$stderrmod

#####Define proportion counting
library("dplyr")

#True
within.pred <- vector(mode='numeric')
for(i in 1:nrow(stat.out.ig)){
  within.pred <- c(within.pred,(between(stat.out.ig$true[i],stat.out.ig$lwrmod[i],stat.out.ig$uprmod[i])))
}
stat.out.ig$true.covermod <- within.pred

# print(paste0('Proprtion of subject within 95%: ',sum(stat.out.ig$within.predmod>=95)/2000*100))
print(paste0('Proprtion of true lying within subject 95% prediction interval: ',sum(stat.out.ig$true.covermod)/2000*100))


# RMSE and Rsq
print(paste0('in RMSE: ',sqrt(mean((stat.in.ig$mean-stat.in.ig$true)^2))))
print(paste0('out RMSE: ',sqrt(mean((stat.out.ig$mean-stat.out.ig$true)^2))))
print(paste0('True noise: 4.58'))
print(paste0('in MAE: ',(mean(abs(stat.in.ig$mean-stat.in.ig$true)))))
print(paste0('out MAE: ',(mean(abs(stat.out.ig$mean-stat.out.ig$true)))))
#SGLD
print(paste0('in R-square: ',rsqcal(stat.in.ig$true,stat.in.ig$mean))) # In-sample
print(paste0('in R-square: ',rsqcal(stat.out.ig$true,stat.out.ig$mean))) #Out-of-sample
```





#14 Oct
Fluid Intelligence

## plot gpnn and stgp for FI
```{r}
#GPNN
num.it <-80*4
runs <- c(11,15)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct13_gpnn_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <- c(11,15)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct13_gpnn_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- 1:20
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct13_stgp_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- setdiff(1:20,14)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct13_stgp2_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNN")
                             ,paste0("GPNN")
                             ,paste0("STGP")
                             ,paste0("STGP2"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.7,2.2))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.7,2.2))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 

##Plot GPR
Test gpr against truth
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct12_gpr_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "Out-of-sample GPR against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```

Coverage & Accuracy
```{r}
hs.int<-matrix(,nrow=20,ncol=4)
for(i in 1:20){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct12_gpr_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=20,ncol=13)
for(i in 1:20){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct12_gpr_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)
```

##Plot HSP
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct12_hsvwb_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Prediction", xlab = "Truth", main = "Out-of-sample HSP against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```
`summary()` gives min =2.99, max = 10.09, so more variety than gpr

Coverage & Performance
```{r}
hs.int<-matrix(,nrow=20,ncol=4)
for(i in 1:20){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct12_hsvwb_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=20,ncol=13)
for(i in 1:20){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct12_hsvwb_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)
```

##Plot stgp fi

```{r}
#GPNN
num.it <-80*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr5_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr05_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr0005_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr00005_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("lr=0.5")
                             ,paste0("lr=0.05")
                             ,paste0("lr=0.0005")
                             ,paste0("lr=0.00005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.7,2.2))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.7,2.2))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 
lr doesn't have to seem to have an effect



#15 Oct

##Observing gradients
Look at `78559604` to observe summary of gradients with theta initialise around 50 `stgp_lr00005_init` => gradients are very small e.g. min/max 1e-4
Look at `78557304` to observe summary of gradients `stgp_lr0000005` => gradients are of scale 10e-2
Look at `78557305` to observe summary of gradients `stgp_lr00000005` => gradients are of scale 10e-2

##Plot loss
```{r}
#GPNN
num.it <-80*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr5_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr00005_init_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr0000005_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr00000005_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("lr=0.5")
                             ,paste0("lr=lr00005_init")
                             ,paste0("lr=0000005")
                             ,paste0("lr=0.00000005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.7,2.2))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.7,2.2))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 
##Plot predictions

##Mix of HSP and GPR
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct12_hsvwb_outpred_noscale_",1,".csv")))
gpr.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct12_gpr_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Prediction", xlab = "Truth", main = "Out-of-sample HSP against Truth")
lines(x=wb2.pred.train, y=gpr.pred.train, type = "p", col='blue',pch=2)

abline(a=0,b=1,lwd=2,col="red")
# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```

###Init at 50
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr00005_init_outpred__jobid_1.feather'))
hs.pred.train <- tail(pred.test[2,],1869)
plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Prediction", xlab = "Truth", main = "Out-of-sample HSP against Truth")

abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```
###lr = 0000005
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr00005_outpred__jobid_1.feather'))
hs.pred.train <- tail(pred.test[2,],1869)
plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Prediction", xlab = "Truth", main = "Out-of-sample HSP against Truth")

abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```

###HSP, GPR and STGP
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct12_hsvwb_outpred_noscale_",1,".csv")))
gpr.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct12_gpr_outpred_noscale_",1,".csv")))
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr00005_outpred__jobid_1.feather'))
stgp.pred.train <- tail(pred.test[2,],1869)

plot(y=hs.pred.train, x = wb2.pred.train, ylab="FI Prediction", xlab = "True FI", main = "Out-of-sample Predictions against Truth",lwd=0.5)
lines(x=wb2.pred.train, y=gpr.pred.train, type = "p", col='blue',pch=2,lwd=0.5)
lines(x=wb2.pred.train, y=stgp.pred.train, type = "p", col='darkgreen',pch=3,lwd=0.5)

abline(a=0,b=1,lwd=2,col="red")
# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("HSP","GPR","STGP","y=x, m=1"),col=c("black","blue","darkgreen","red"), pch = c(1,2,3,15))
```
## Plot distribution of response
```{r}
#true age
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/fi.feather')
age <- age_tab$fi
#wb2
wb2.ind.train <-read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/train_index.csv')$x
wb2.ind.test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/test_index.csv')$x

c1 <- rgb(173,216,230,max = 255, alpha = 80, names = "lt.blue")
c2 <- rgb(255,192,203, max = 255, alpha = 80, names = "lt.pink")

hist.train <- hist(age[wb2.ind.train], breaks = seq(from=0, to=13, by=1))
hist.test  <- hist(age[wb2.ind.test], breaks = seq(from=0, to=13, by=1))
plot(hist.train,col=c1,ylim=c(0,400), main = "Histogram of Fluid Intelligence score in the datasets", xlab = "Fluid Intelligence score")
plot(hist.test, add = TRUE, col = c2)
legend("topright", pch=15, legend = c("Train set", "Test set"), col = c("lightblue","pink"))
```

#16 Oct

GPNN
```{r}
#GPNN
num.it <-80*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr0000005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct14_stgp_lr00005_init_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- c(22,28)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct15_gpnn_lr00005_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- c(12,15,21,24,6)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct15_gpnn_lr00005_init_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("stgp, lr00005")
                             ,paste0("stgp, lr00005_init")
                             ,paste0("gpnn, lr00005")
                             ,paste0("gpnn, lr00005_init"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.2))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.2))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 


#17 Oct

Work lost


#19 Oct

##Default network
Observe a few participants
```{r}
part_list<-read.table('/well/nichols/users/qcv214/Placement_2/participant_list.txt', header = FALSE, sep = "", dec = ".") #4529 participants
part_list$exist_vbm <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_list[,1],'/T1/T1_vbm/T1_GM_to_template_GM_mod.nii.gz'))
part_use<-part_list[part_list$exist_vbm==1,] #4263 participants left

img1 <- oro.nifti::readNIfTI(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_use[1,1],'/fMRI/rfMRI_25.dr/dr_stage2.nii.gz'))
```

```{r}
for(i in 1:3){
  writeNIfTI((oro.nifti::readNIfTI(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_use[i,1],'/fMRI/rfMRI_25.dr/dr_stage2.nii.gz')))[,,,1], paste0('/well/nichols/users/qcv214/bnn2/res3/viz/dfn_',i))
}
```
These are indeed default mode network




#22 Oct

##Plot stgp
```{r}
#GPNN
num.it <-80*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_stgp_lr5_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_stgp_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_stgp_lr0005_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_stgp_lr00005_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("stgp, lr5")
                             ,paste0("stgp, lr005")
                             ,paste0("gpnn, lr0005")
                             ,paste0("gpnn, lr00005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```

##Plot gpnn
```{r}
#GPNN
num.it <-80*4
runs <- c(12,16,17,24,28,3,4,5,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct21_gpnn_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <- c(12,16,17,24,28,3,4,5,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct21_gpnn_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- c(11,12,15,18,21,27,3,7,8)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct21_gpnn_lr0005_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- c(1,12,15,2,21,23,25,27,5,7)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct21_gpnn_lr00005_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("gpnn, lr005")
                             ,paste0("gpnn, lr005")
                             ,paste0("gpnn, lr0005")
                             ,paste0("gpnn, lr00005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```

##Plot GPR
Test gpr against truth
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_gpr_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "Out-of-sample GPR against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```

Coverage & Accuracy
```{r}
hs.int<-matrix(,nrow=20,ncol=4)
for(i in 1:20){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_gpr_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=20,ncol=13)
for(i in 1:20){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_gpr_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)
```

##Plot HSP
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_hsvwb_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Prediction", xlab = "Truth", main = "Out-of-sample HSP against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```
`summary()` gives min =2.99, max = 10.09, so more variety than gpr
Coverage & Performance
```{r}
hs.int<-matrix(,nrow=20,ncol=4)
for(i in 1:20){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_hsvwb_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=20,ncol=13)
for(i in 1:20){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_hsvwb_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)
```
##Predictions

###In-sample
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$train]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_hsvwb_inpred_noscale_",1,".csv")))
gpr.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_gpr_inpred_noscale_",1,".csv")))
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_stgp_lr00005_inpred__jobid_1.feather'))
stgp.pred.train <- tail(pred.test[2,],1611)
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct21_gpnn_lr00005_inpred__jobid_1.feather'))
gpnn.pred.train <- tail(pred.test[2,],1611)

plot(y=hs.pred.train, x = wb2.pred.train, ylab="FI Prediction", xlab = "True FI", main = "In-sample Predictions against Truth",lwd=0.5, ylim=c(0,13),xlim=c(0,13))
lines(x=wb2.pred.train, y=gpr.pred.train, type = "p", col='blue',pch=2,lwd=0.5)
lines(x=wb2.pred.train, y=stgp.pred.train, type = "p", col='darkgreen',pch=3,lwd=0.5)
lines(x=wb2.pred.train, y=gpnn.pred.train, type = "p", col='magenta',pch=4,lwd=0.5)

abline(a=0,b=1,lwd=2,col="red")
abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="orange")

# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("HSP","GPR","STGP",'GPNN',"y=x, m=1"),col=c("black","blue","darkgreen",'magenta',"red"), pch = c(1,2,3,4,15))
```
###Out-of-sample
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_hsvwb_outpred_noscale_",1,".csv")))
gpr.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_gpr_outpred_noscale_",1,".csv")))
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct19_stgp_lr00005_outpred__jobid_1.feather'))
stgp.pred.train <- tail(pred.test[2,],1642)
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct21_gpnn_lr00005_outpred__jobid_1.feather'))
gpnn.pred.train <- tail(pred.test[2,],1642)

plot(y=hs.pred.train, x = wb2.pred.train, ylab="FI Prediction", xlab = "True FI", main = "Out-of-sample Predictions against Truth",lwd=0.5, ylim=c(0,13),xlim=c(0,13))
lines(x=wb2.pred.train, y=gpr.pred.train, type = "p", col='blue',pch=2,lwd=0.5)
lines(x=wb2.pred.train, y=stgp.pred.train, type = "p", col='darkgreen',pch=3,lwd=0.5)
lines(x=wb2.pred.train, y=gpnn.pred.train, type = "p", col='magenta',pch=4,lwd=0.5)

abline(a=0,b=1,lwd=2,col="red")
abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="orange")

# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("HSP","GPR","STGP",'GPNN',"y=x, m=1"),col=c("black","blue","darkgreen",'magenta',"red"), pch = c(1,2,3,4,15))
```


#23 Oct

##Note that all of the above for FI with Default Mode Network (dfn) is just without thresholding
I will do thresholding on `dfn_get_mask`

#24 Oct
##Plot GPR
Test gpr against truth
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_gpr_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "Out-of-sample GPR against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```

Coverage & Accuracy
```{r}
hs.int<-matrix(,nrow=20,ncol=4)
for(i in 1:20){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_gpr_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=20,ncol=13)
for(i in 1:20){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_gpr_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)
```

##Plot HSP
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_hsvwb_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Prediction", xlab = "Truth", main = "Out-of-sample HSP against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```
`summary()` gives min =2.99, max = 10.09, so more variety than gpr
Coverage & Performance
```{r}
hs.int<-matrix(,nrow=20,ncol=4)
for(i in 1:20){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_hsvwb_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=20,ncol=13)
for(i in 1:20){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_hsvwb_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)
```

#25 Oct

##Plot stgp
```{r}
#GPNN
num.it <-80*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_stgp_lr5_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_stgp_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_stgp_lr0005_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_stgp_lr00005_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("lr= 0.5")
                             ,paste0("lr= 005")
                             ,paste0("lr= 0005")
                             ,paste0("lr= 00005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```

##Plot gpnn
```{r}
#GPNN
num.it <-80*4
runs <- c(10,11,12,2,20,21,24,26,3,4,6)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_gpnn_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <- c(10,11,12,2,20,21,24,26,3,4,6)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_gpnn_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- c(14,17,20,24,26,27,30,6,7)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_gpnn_lr0005_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- c(11,21,22,24,25,29,3,6,9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_gpnn_lr00005_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("lr= 005")
                             ,paste0("lr= 005")
                             ,paste0("lr= 0005")
                             ,paste0("lr= 00005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```

##Predictions

###In-sample
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$train]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_hsvwb_inpred_noscale_",1,".csv")))
gpr.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_gpr_inpred_noscale_",1,".csv")))
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_stgp_lr00005_inpred__jobid_1.feather'))
stgp.pred.train <- tail(pred.test[2,],1611)
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_gpnn_lr00005_inpred__jobid_11.feather'))
gpnn.pred.train <- tail(pred.test[2,],1611)

plot(y=hs.pred.train, x = wb2.pred.train, ylab="FI Prediction", xlab = "True FI", main = "In-sample Predictions against Truth",lwd=0.5, ylim=c(0,13),xlim=c(0,13))
lines(x=wb2.pred.train, y=gpr.pred.train, type = "p", col='blue',pch=2,lwd=0.5)
lines(x=wb2.pred.train, y=stgp.pred.train, type = "p", col='darkgreen',pch=3,lwd=0.5)
lines(x=wb2.pred.train, y=gpnn.pred.train, type = "p", col='magenta',pch=4,lwd=0.5)

abline(a=0,b=1,lwd=2,col="red")
abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="orange")

# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("HSP","GPR","STGP",'GPNN',"y=x, m=1"),col=c("black","blue","darkgreen",'magenta',"red"), pch = c(1,2,3,4,15))
```
###Out-of-sample
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_hsvwb_outpred_noscale_",1,".csv")))
gpr.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_gpr_outpred_noscale_",1,".csv")))
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_stgp_lr00005_outpred__jobid_1.feather'))
stgp.pred.train <- tail(pred.test[2,],1642)
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct24_gpnn_lr00005_outpred__jobid_11.feather'))
gpnn.pred.train <- tail(pred.test[2,],1642)

plot(y=hs.pred.train, x = wb2.pred.train, ylab="FI Prediction", xlab = "True FI", main = "Out-of-sample Predictions against Truth",lwd=0.5, ylim=c(0,13),xlim=c(0,13))
lines(x=wb2.pred.train, y=gpr.pred.train, type = "p", col='blue',pch=2,lwd=0.5)
lines(x=wb2.pred.train, y=stgp.pred.train, type = "p", col='darkgreen',pch=3,lwd=0.5)
lines(x=wb2.pred.train, y=gpnn.pred.train, type = "p", col='magenta',pch=4,lwd=0.5)

abline(a=0,b=1,lwd=2,col="red")
abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="orange")

# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("HSP","GPR","STGP",'GPNN',"y=x, m=1"),col=c("black","blue","darkgreen",'magenta',"red"), pch = c(1,2,3,4,15))
```

#27 Oct
New mask thresholded using s.d. with 125k voxels
##Plot stgp
```{r}
#GPNN
num.it <-80*4
runs <- 1:30
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_stgp_lr5_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <-1:30
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_stgp_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- 1:30
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_stgp_lr0005_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:30
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_stgp_lr00005_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("lr= 0.5")
                             ,paste0("lr= 005")
                             ,paste0("lr= 0005")
                             ,paste0("lr= 00005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=4, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```

##Plot gpnn
```{r}
#GPNN
num.it <-80*4
runs <- c(11,14,17,20,22,24)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_gpnn_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <- c(11,14,17,20,22,24)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_gpnn_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- c(1,12,14,15,17,18,26,27,28,5)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_gpnn_lr0005_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- c(1,12,13,14,16,18,20,22,25,26,29,7,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_gpnn_lr00005_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("lr= 005")
                             ,paste0("lr= 005")
                             ,paste0("lr= 0005")
                             ,paste0("lr= 00005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```

lr doesn't have much effect



##Observe effects of threshold in STGP
```{r}
#GPNN
num.it <-80*4
runs <- 1:5
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th25_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <-1:5
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th45_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj sigma and bias
runs3 <- 1:5
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th75_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:5
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th100_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("threshold= 0.25")
                             ,paste0("threshold= 0.45")
                             ,paste0("threshold= 0.75")
                             ,paste0("threshold= 1"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=4, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
```

Consider only 2 extreme
```{r}
#GPNN
num.it <-80*4
runs <- 1:5
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th25_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
# runs2 <-1:5
# res.mat2 <- array(,dim=c(2,length(runs2),num.it))
# for(i in runs2){
#   res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th45_loss__jobid_",i,".csv")))[,1:num.it]
# }
# #GPNN adj sigma and bias
# runs3 <- 1:5
# res.mat3 <- array(,dim=c(2,length(runs3),num.it))
# for(i in runs3){
#   res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th75_loss__jobid_",i,".csv")))[,1:num.it]
# }
# stgp
runs4 <- 1:5
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th100_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("threshold= 0.25")
                             # ,paste0("threshold= 0.45")
                             # ,paste0("threshold= 0.75")
                             ,paste0("threshold= 1"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=4, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
# res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
# lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
# 
# res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
# lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
# res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
# 
# res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red"
                                                 # ,'blue','darkgreen'
                                                 ,'orange'))
```

STGP with threshold = 1 has lower test than train.

##Plot GPR
Test gpr against truth
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_gpr_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "Out-of-sample GPR against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```

Coverage & Accuracy
```{r}
hs.int<-matrix(,nrow=20,ncol=4)
for(i in 1:20){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_gpr_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=20,ncol=13)
for(i in 1:20){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_gpr_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)
```

##Plot HSP
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_hsvwb_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="HSP Prediction", xlab = "Truth", main = "Out-of-sample HSP against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```
`summary()` gives min =2.99, max = 10.09, so more variety than gpr
Coverage & Performance
```{r}
hs.int<-matrix(,nrow=20,ncol=4)
for(i in 1:20){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_hsvwb_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=20,ncol=13)
for(i in 1:20){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_hsvwb_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)
```


#28 Oct

##GPR-Normal
Test gpr against truth
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_gprnm_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "Out-of-sample GPR against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```

Coverage & Accuracy
```{r}
hs.int<-matrix(,nrow=20,ncol=4)
for(i in 1:20){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_gprnm_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=20,ncol=13)
for(i in 1:20){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_gprnm_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6]),3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)
```

##GPNN-Normal
```{r}
#GPNN
num.it <-80*4
runs <-  c(11,21,22,24,25,29,3,6,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile//re_oct24_gpnn_lr00005_loss__jobid_",i,".csv")))[,1:num.it]
}

runs4 <- 1:25
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_gpnnnm_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("GPNN")
                             ,paste0("GPNN-normal"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=4, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red"
                                                 # ,'blue','darkgreen'
                                                 ,'orange'))
```

#31 oct
Producing previous plots for presentation
##GPNN
```{r}
#GPNN
num.it <-80*4
runs <- c(11,14,17,20,22,24)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_gpnn_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}

# stgp
runs4 <- c(1,12,13,14,16,18,20,22,25,26,29,7,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_gpnn_lr00005_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("lr= 0.005"),paste0("lr= 0.00005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
```
##Plot stgp
```{r}
#GPNN
num.it <-80*4
runs <- 1:30
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_stgp_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
# stgp
runs4 <- 1:30
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_stgp_lr00005_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("lr= 0.005"),paste0("lr= 0.00005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=4, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
```
##Observe effects of threshold in STGP
```{r}
#GPNN
num.it <-80*4
runs <- 1:5
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th25_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:5
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th100_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("threshold= 0.25"),paste0("threshold= 1"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
```

##All stgp with th
##Plot stgp
```{r}
#GPNN
num.it <-80*4
runs <- 1:30
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_stgp_lr005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <-1:30
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_stgp_lr00005_loss__jobid_",i,".csv")))[,1:num.it]
}

# stgp
runs4 <- 1:5
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th100_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("lr= 0.005, thr= 0.25")
                             ,paste0("lr= 0.00005, thr= 0.25")
                             ,paste0("lr= 0.00005, thr= 1"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange'))
```

##GPNN but doing root first
```{r}
#GPNN
num.it <-80*4
runs <- c(11,14,17,20,22,24)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- sqrt(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_gpnn_lr005_loss__jobid_",i,".csv")))[,1:num.it])
}

# stgp
runs4 <- c(1,12,13,14,16,18,20,22,25,26,29,7,8)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- sqrt(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct26_gpnn_lr00005_loss__jobid_",i,".csv"))))
}

#define legends
leglab <- c(paste0("lr= 0.005"),paste0("lr= 0.00005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr4[2,],col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr4[1,],col='yellow',lwd=0.5)
lines(x=1:num.it,y=res.iqr4[3,],col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
abline(v=4*1:80,lwd=0.2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr4[2,],col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr4[1,],col='yellow',lwd=0.5)
lines(x=1:num.it,y=res.iqr4[3,],col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
```

#1 Nov

Try to tackle Tom's points
##1. Check CSF 
=> the lowest part is number 10, Ventral_Cerebellum
##2. Check the size of each region
```{r}
mask.com<- oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/res3mask.nii.gz')
table(c(mask.com))
```
Insular_cortex_L => 285
Insular_cortex_R => 441
Basal_Ganglia => 77
Thalasmus => 45



##3. Check periodicity of random subset
I think perhaps it's to do with small subset, lets see `stgp_th25_lb`
```{r}
#GPNN
#num.it <-80*4
num.it <- 150
runs <- 1:5
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- sqrt(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_oct27_stgp_th25_loss__jobid_",i,".csv")))[,1:num.it])
}

# stgp
runs4 <-1:5
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- sqrt(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov1_stgp_th25_loss__jobid_",i,".csv"))))
}

#define legends
leglab <- c(paste0("mini_batch(500,500,500,111)"),paste0("mini_batch(537,537,537)"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr4[2,],col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr4[1,],col='yellow',lwd=0.5)
lines(x=1:num.it,y=res.iqr4[3,],col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
abline(v=4*1:80,lwd=0.2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr4[2,],col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr4[1,],col='yellow',lwd=0.5)
lines(x=1:num.it,y=res.iqr4[3,],col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
```

##4. Get saliency mean
using fslmerge
`fslmerge -t oct27_stgp_th100_salcomplied.nii.gz oct27_stgp_th100_sal_*80*`
then fslmaths
`fslmaths oct27_stgp_th100_salcomplied.nii.gz -Tmean sum/oct27_stgp_th100_meansal.nii.gz`
(py3) -bash-4.2$ fslmerge -t sub_gpr_compiled.nii.gz sub_gpr_*
(py3) -bash-4.2$ fslmerge -t nov2_gpnn_lr00005_compiled.nii.gz nov2_gpnn_lr00005_sal_*
(py3) -bash-4.2$ fslmerge -t nov2_stgp_th25_compiled.nii.gz nov2_stgp_th25_sal*
(py3) -bash-4.2$ fslmerge -t nov2_stgp_th100_compiled.nii.gz nov2_stgp_th100_sal*
(py3) -bash-4.2$ fslmaths sub_gpr_compiled.nii.gz -Tmean sum/gpr_mean.nii.gz
(py3) -bash-4.2$ fslmaths nov2_gpnn_lr00005_compiled.nii.gz -Tmean sum/gpnn_mean.nii.gz
(py3) -bash-4.2$ fslmaths nov2_stgp_th25_compiled.nii.gz -Tmean sum/stgp_th25_mean.nii.gz
(py3) -bash-4.2$ fslmaths nov2_stgp_th100_compiled.nii.gz -Tmean sum/stgp_th100_mean.nii.gz

##5. sort out the unmatching results
I think it comes from, in the gpnn/stgp
            >`age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')`
[THIS LINE] >`age_tab <- age_tab[order(age_tab$id),]`
            >`age <- age_tab$fi`

###check distribution if age is NOT re-order
```{r}
#true age
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
# age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$fi
#wb2
wb2.ind.train <-read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
wb2.ind.test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x

c1 <- rgb(173,216,230,max = 255, alpha = 80, names = "lt.blue")
c2 <- rgb(255,192,203, max = 255, alpha = 80, names = "lt.pink")

hist.train <- hist(age[wb2.ind.train], breaks = seq(from=0, to=13, by=1))
hist.test  <- hist(age[wb2.ind.test], breaks = seq(from=0, to=13, by=1))
plot(hist.train,col=c1,ylim=c(0,400), main = "Histogram of Fluid Intelligence score in the datasets", xlab = "Fluid Intelligence score")
plot(hist.test, add = TRUE, col = c2)
legend("topright", pch=15, legend = c("Train set", "Test set"), col = c("lightblue","pink"))
```
###check distribution if age is re-order
```{r}
#true age
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$fi
#wb2
wb2.ind.train <-read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
wb2.ind.test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x

c1 <- rgb(173,216,230,max = 255, alpha = 80, names = "lt.blue")
c2 <- rgb(255,192,203, max = 255, alpha = 80, names = "lt.pink")

hist.train <- hist(age[wb2.ind.train], breaks = seq(from=0, to=13, by=1))
hist.test  <- hist(age[wb2.ind.test], breaks = seq(from=0, to=13, by=1))
plot(hist.train,col=c1,ylim=c(0,400), main = "Histogram of Fluid Intelligence score in the datasets", xlab = "Fluid Intelligence score")
plot(hist.test, add = TRUE, col = c2)
legend("topright", pch=15, legend = c("Train set", "Test set"), col = c("lightblue","pink"))
```
##GPR
GPR from sub data
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
age_tab <- age_tab[order(age_tab$id),]
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov1_re_gpr_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "Out-of-sample GPR against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```

Coverage & Accuracy
```{r}
hs.int<-matrix(,nrow=1,ncol=4)
for(i in 1){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov1_re_gpr_coverage_",i,".csv")))
}
colMeans(hs.int)

hs.int<-matrix(,nrow=1,ncol=13)
for(i in 1){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov1_re_gpr_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(hs.int[1:6],3)
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)
```

###Try plotting stgp
```{r}
#GPNN
num.it <-80*4
runs <- 1:5
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- sqrt(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov1_sub_stgp_th25_loss__jobid_",i,".csv")))[,1:num.it])
}

# stgp
runs4 <- 1:5
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- sqrt(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov1_sub_stgp_th100_loss__jobid_",i,".csv"))))
}

#define legends
leglab <- c(paste0("lr= 0.005"),paste0("lr= 0.00005"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr4[2,],col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr4[1,],col='yellow',lwd=0.5)
lines(x=1:num.it,y=res.iqr4[3,],col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
abline(v=4*1:80,lwd=0.2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr4[2,],col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr4[1,],col='yellow',lwd=0.5)
lines(x=1:num.it,y=res.iqr4[3,],col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'orange'))
```
```{r}
#GPNN
num.it <-80*4
runs <- c(10,15,16,19,7)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov1_sub_gpnn_lr00005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <-1:5
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov1_sub_stgp_th25_loss__jobid_",i,".csv")))[,1:num.it]
}

# stgp
runs4 <- 1:5
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov1_sub_stgp_th100_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("gpnn")
                             ,paste0("stgp, thr= 0.25")
                             ,paste0("stgp, thr= 1"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.85,2.4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange'))
```

##FSLeyes
45 57 43

45 51 43 is better

#2 Nov

##Plot results
```{r}
#GPNN
num.it <-100*3
runs <- c(14,17,2,22,3,7,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2_gpnn_lr00005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <-1:5
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2_stgp_th25_loss__jobid_",i,".csv")))[,1:num.it]
}

# stgp
runs4 <- 1:5
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2_stgp_th100_loss__jobid_",i,".csv")))
}

#define legends
leglab <- c(paste0("gpnn")
                             ,paste0("stgp, thr= 0.25")
                             ,paste0("stgp, thr= 1"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,2.15))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
abline(v=3*1:100,lwd=0.2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,2.15))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange'))
```
##Get results of GPR
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
# age_tab <- age_tab[order(age_tab$id),]
wb2.pred.train <- age_tab$fi[ind.to.use$test]
hs.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov1_re_gpr_outpred_noscale_",1,".csv")))

plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "Out-of-sample GPR against Truth")
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```

Coverage & Accuracy
```{r}
failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=4)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- unlist(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_coverage_",i,".csv")))
}
hs.int <- hs.int[-failed.run,]
colMeans(hs.int)

hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE"))
signif(colMeans(hs.int[,1:6],3))
 library(matrixStats)
signif(sqrt(colVars(hs.int[,1:6])),3)
```

#3 Nov

FSLeyes: 44 52 43
```{r}
#GPNN
num.it <-100*3
runs <- c(14,17,2,22,3,7,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2_gpnn_lr00005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <-1:30
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2_stgp_th25_loss__jobid_",i,".csv")))[,1:num.it]
}

# stgp
runs4 <- 1:30
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2_stgp_th100_loss__jobid_",i,".csv")))
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn")
                             ,paste0("stgp, thr= 0.25")
                             ,paste0("stgp, thr= 1"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,2.15))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,2.15))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange','magenta'))
```

#6 Nov

##Plot GPNN HC
```{r}
#GPNN
num.it <-100*3
runs <- c(14,17,2,22,3,7,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2_gpnn_lr00005_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <- c(12,14,17,2,6,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov4_gpnnhc_loss__jobid_",i,".csv")))[,1:num.it]
}

# stgp
runs4 <- 1:30
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2_stgp_th100_loss__jobid_",i,".csv")))
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn")
                             ,paste0("gpnn-HorseshoePrior")
                             ,paste0("stgp, thr= 1"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,2.15))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,2.15))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','orange','magenta'))
```

#7 Nov
Some participants are now missing ====> see `generate_dfn_dat.R` 7 nov update part for new file.
```{r}
part_use<- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/part_id.csv')$x
part.exist <- file.exists(paste0('/well/win-biobank/projects/imaging/data/data3/subjectsAll/',part_use,'/fMRI/rfMRI_25.dr/dr_stage2.nii.gz'))

print(paste0('Missing total: ', length(part.exist) - sum(part.exist)))
print(paste0('Missing train: ', length(part.exist[1:1611]) - sum(part.exist[1:1611])))
print(paste0('Missing test: ', length(part.exist[1612:3253]) - sum(part.exist[1612:3253])))
```

Generate
`'/well/nichols/users/qcv214/bnn2/res3/fi/dfn/part_id2.csv'`
`'/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index2.csv'`
`'/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index2.csv'`

This is actually temporary 9 Nov

#9 Nov

Fixing Sigma
results based on fewer number of participants
```{r}
#GPNN
num.it <-150*3
runs <- c(1,1)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov9_gpnn_linreg_loss__jobid_",i,".csv")))[,1:num.it]
}
#GPNN adj 
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov9_gpnn7_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov9_gpnn8_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov9_gpnn9_loss__jobid_",i,".csv")))
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_linreg")
                             ,paste0("gpnn7")
                             ,paste0("gpnn8")
                             ,paste0("gpnn9, thr= 1"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```

#10 Nov

Trying to find the right hyper variance in last layer

ONLY `GPNN10_3` was saved 
##Plot
```{r}
#GPNN
num.it <-250*3
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov9_gpnn10_loss__jobid_",i,".csv")))[,1:num.it]
 }
# #GPNN adj 
# runs2 <- 1:10
# res.mat2 <- array(,dim=c(2,length(runs2),num.it))
# for(i in runs2){
#   res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov9_gpnn7_loss__jobid_",i,".csv")))[,1:num.it]
# }
# runs3 <- 1:10
# res.mat3 <- array(,dim=c(2,length(runs3),num.it))
# for(i in runs3){
#   res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov9_gpnn8_loss__jobid_",i,".csv")))[,1:num.it]
# }
# # stgp
# runs4 <- 1:10
# res.mat4 <- array(,dim=c(2,length(runs4),num.it))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov9_gpnn9_loss__jobid_",i,".csv")))
# }

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_linreg")
                             ,paste0("gpnn7")
                             ,paste0("gpnn8")
                             ,paste0("gpnn9, thr= 1"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
# res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
# res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
# res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
# res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```



#11 Nov
## Results
```{r}
#GPNN
num.it <-500*3
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov10_gpnn10_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov10_gpnn10_2_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- setdiff(1:20,18)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov10_gpnn10_3_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
# runs4 <- 1:10
# res.mat4 <- array(,dim=c(2,length(runs4),num.it))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov9_gpnn9_loss__jobid_",i,".csv")))
# }

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_1")
                             ,paste0("gpnn_2")
                             ,paste0("gpnn_3")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','magenta'))
```

#13 Nov
##Results of gpnn
```{r}
#GPNN
num.it <-400*3
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov11_gpnn10_4_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov11_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:20
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov11_gpnn10_6_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:20
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov11_gpnn10_7_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_7")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```
##Get results of lasso
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')

hs.int<-matrix(,nrow=20,ncol=13)
for(i in 1:20){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov11_lasso_noscale_",i,".csv"))))
}
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE",'No. Var'))
signif(colMeans(hs.int[,c(1:6,13)],3))
 library(matrixStats)
signif(sqrt(colVars(hs.int[,c(1:6,13)])),3)
```

#14 Nov
##Results of gpnn
```{r}
#GPNN
num.it <-400*3
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov14_gpnn10_4_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov14_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:20
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov14_gpnn10_6_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:19
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov14_gpnn10_7_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_7")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```




#15 nov 

##Plot FI
With bias initialise around mean
```{r}
#GPNN
num.it <-250*3
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov11_gpnn10_4_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov11_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:20
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov11_gpnn10_6_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- c(1:7,10:11)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov15_gpnn10_6_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```


##LASSO with AGE
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

hs.int<-matrix(,nrow=20,ncol=13)
failed.run <- c(3)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov14_lasso_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE",'No. Var'))
signif(colMeans(hs.int[,c(1:6,13)],3))
 library(matrixStats)
signif(sqrt(colVars(hs.int[,c(1:6,13)])),3)
```
##GPR with AGE 
Previous result
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

hs.int<-matrix(,nrow=20,ncol=13)
failed.run <- c(3)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE",'No. Var'))
signif(colMeans(hs.int[,c(1:6,13)],3))
 library(matrixStats)
signif(sqrt(colVars(hs.int[,c(1:6,13)])),3)
```


##Plot Age

```{r}
#GPNN
num.it <-110*3
runs <- c(1,10,11,18,2,3,4,5,7,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov14_gpnn_4_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1,10,11,14,15,2,20,3,4,6,7:9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov14_gpnn_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:20
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov14_gpnn_6_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:13
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov14_gpnn_7_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,100))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,100))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```


#16 Nov
##Plot age
```{r}
#GPNN
num.it <-110*3
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_4_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:20
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_6_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:16
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_7_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```

#17 Nov

##Simulation
###Plot
```{r}
#GPNN
num.it <-250*3
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov16_gpnn10_4_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov16_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:20
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov16_gpnn10_6_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
# runs4 <- 1:16
# res.mat4 <- array(,dim=c(2,length(runs4),num.it))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_7_loss__jobid_",i,".csv")))[,1:num.it]
# }

failed.run <- c()
hs.int<-matrix(,nrow=20,ncol=13)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov16_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```

##Simulation plot
Based on var 6, seed 4
This is plotting with minimum

```{r}
#GPNN
num.it <-250*3
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpnn10_4_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:20
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpnn10_6_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
# runs4 <- 1:16
# res.mat4 <- array(,dim=c(2,length(runs4),num.it))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_7_loss__jobid_",i,".csv")))[,1:num.it]
# }

failed.run <- c()
hs.int<-matrix(,nrow=20,ncol=13)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```

#18 Nov

##Assess simulation same SEED
```{r}
#GPNN
num.it <-250*3
runs <- c(1,1)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov17_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2,2)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov17_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- c(3,3)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov17_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
# runs4 <- 1:16
# res.mat4 <- array(,dim=c(2,length(runs4),num.it))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_7_loss__jobid_",i,".csv")))[,1:num.it]
# }

failed.run <- c()
hs.int<-matrix(,nrow=20,ncol=13)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```
There is a repetition that i cannot explain

##See simulation
```{r}
#GPNN
num.it <-250*3
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_4_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:20
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_6_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
# runs4 <- 1:16
# res.mat4 <- array(,dim=c(2,length(runs4),num.it))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_7_loss__jobid_",i,".csv")))[,1:num.it]
# }

failed.run <- c()
hs.int<-matrix(,nrow=20,ncol=13)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             # ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','magenta'))
```
GPR
```{r}
hs.int<-matrix(,nrow=20,ncol=13)
failed.run <- c()
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE",'No. Var'))
signif(colMeans(hs.int[,c(1:6,13)],3))
 library(matrixStats)
signif(sqrt(colVars(hs.int[,c(1:6,13)])),3)
```


#20 Nov

##Assess calculate
mean absolute percentage error (MAPE)

```{r}
mape <- function(true_vec, obs_vec){(mean(abs(true_vec-obs_vec)*100/true_vec))}
```

Load true
```{r}
true.the <- c(unlist(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov17_gpnn10_5_theta__jobid_1.feather')))
true.wei <- c(unlist(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov17_gpnn10_5_weights__jobid_1.feather')))
true.bias <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov17_gpnn10_5_bias__jobid_1.csv')$x)
```

```{r}
runs <- 1:20
res.mat <- matrix(,nrow=length(runs),ncol = 3)
for(i in runs){
  res.mat[which(i==runs),1] <- mape(true.the, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_4_theta__jobid_',i,'.feather')))))
  res.mat[which(i==runs),2] <- mape(true.wei, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_4_weights__jobid_',i,'.feather')))))
  res.mat[which(i==runs),3] <- mape(true.bias, c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_4_bias__jobid_',i,'.csv'))$x))
}
plot(x= runs,y=res.mat[,1],col='red',lwd=2, type = 'l',main = "Mean Absolute % Error", ylab="MAPE", xlab="runs",ylim=c(-800,140))
lines(x= runs,y=res.mat[,2],col='blue',lwd=2)
lines(x= runs,y= res.mat[,3],col='green',lwd=2)
legend('bottomright',legend = c('theta','weights','bias'),lty=c(1),col=c("red",'blue','green'))

```

```{r}
runs <- 1:20
res.mat <- matrix(,nrow=length(runs),ncol = 3)
for(i in runs){
  res.mat[which(i==runs),1] <- mape(true.the, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_5_theta__jobid_',i,'.feather')))))
  res.mat[which(i==runs),2] <- mape(true.wei, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_5_weights__jobid_',i,'.feather')))))
  res.mat[which(i==runs),3] <- mape(true.bias, c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_5_bias__jobid_',i,'.csv'))$x))
}
plot(x= runs,y=res.mat[,1],col='red',lwd=2, type = 'l',main = "Mean Absolute % Error", ylab="MAPE", xlab="runs",ylim=c(-800,140))
lines(x= runs,y=res.mat[,2],col='blue',lwd=2)
lines(x= runs,y= res.mat[,3],col='green',lwd=2)
legend('bottomright',legend = c('theta','weights','bias'),lty=c(1),col=c("red",'blue','green'))
```
Get in-sample predictions, say 1st jobid
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/sim/simfi3.csv')
wb2.pred.train <- age_tab$pred[ind.to.use$train]
gpr.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpr_inpred_noscale_",1,".csv")))
pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_5_inpred__jobid_1.feather')))
gpnn.pred.train <- tail(pred.test,1611)
colnames(gpnn.pred.train) <- c('id','pred')
gpnn.pred.train <- gpnn.pred.train[order(gpnn.pred.train$id),]
plot(y=gpnn.pred.train[,2], x = wb2.pred.train, ylab="FI Prediction", xlab = "True FI", main = "In-sample Predictions against Simulated Truth",lwd=0.5, ylim=c(0,13),xlim=c(0,13))
lines(x=wb2.pred.train, y=gpr.pred.train, type = "p", col='blue',pch=2,lwd=0.5)

abline(a=0,b=1,lwd=2,col="red")
abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="orange")

# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("GPNN","GPR","y=x, m=1"),col=c("black","blue","red"), pch = c(1,2,15))
```




```{r}
runs <- 1:20
res.mat <- matrix(,nrow=length(runs),ncol = 3)
for(i in runs){
  res.mat[which(i==runs),1] <- mape(true.the, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_6_theta__jobid_',i,'.feather')))))
  res.mat[which(i==runs),2] <- mape(true.wei, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_6_weights__jobid_',i,'.feather')))))
  res.mat[which(i==runs),3] <- mape(true.bias, c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_6_bias__jobid_',i,'.csv'))$x))
}
plot(x= runs,y=res.mat[,1],col='red',lwd=2, type = 'l',main = "Mean Absolute % Error", ylab="MAPE", xlab="runs",ylim=c(-800,140))
lines(x= runs,y=res.mat[,2],col='blue',lwd=2)
lines(x= runs,y= res.mat[,3],col='green',lwd=2)
legend('bottomright',legend = c('theta','weights','bias'),lty=c(1),col=c("red",'blue','green'))
```


#21 Nov

##Results from gen_pred_small
```{r}
#GPNN
num.it <-250*1
runs <- c(1,1)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov21_small_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2,2)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov21_small_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- c(3,3)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov21_small_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
# runs4 <- 1:16
# res.mat4 <- array(,dim=c(2,length(runs4),num.it))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_7_loss__jobid_",i,".csv")))[,1:num.it]
# }

failed.run <- c()
hs.int<-matrix(,nrow=20,ncol=13)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,50))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,50))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```

##Plot 
```{r}
#GPNN
num.it <-2000
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov21_small_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov21_small_6_loss__jobid_",i,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("gpnn_5")
                             ,paste0("gpnn_6"))
                             # ,paste0("gpnn_6")
                             # ,paste0("gpnn_6_bias~mean")
                             # , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,60))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)


legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,60))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
```
##MAPE
```{r}
true.the <- c(unlist(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov21_small_theta__jobid_1.feather')))
true.wei <- c(unlist(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov21_small_weights__jobid_1.feather')))
true.bias <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov21_small_bias__jobid_1.csv')$x)

runs <- 1:20
res.mat <- matrix(,nrow=length(runs),ncol = 3)
for(i in runs){
  res.mat[which(i==runs),1] <- mape(true.the, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov21_small_5_theta__jobid_',i,'.feather')))))
  res.mat[which(i==runs),2] <- mape(true.wei, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov21_small_5_weights__jobid_',i,'.feather')))))
  res.mat[which(i==runs),3] <- mape(true.bias, c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov21_small_5_bias__jobid_',i,'.csv'))$x))
}
plot(x= runs,y=res.mat[,1],col='red',lwd=2, type = 'l',main = "Mean Absolute % Error", ylab="MAPE", xlab="runs",ylim=c(-2000,5000))
lines(x= runs,y=res.mat[,2],col='blue',lwd=2)
lines(x= runs,y= res.mat[,3],col='green',lwd=2)
legend('bottomright',legend = c('theta','weights','bias'),lty=c(1),col=c("red",'blue','green'))
```
##Predicgtiond

```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x[1:30]
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x[1:30]
age_tab<-read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/sim/simfi_small.csv')
wb2.pred.train <- age_tab$pred[ind.to.use$train]
# gpr.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpr_inpred_noscale_",1,".csv")))
pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov21_small_5_inpred__jobid_1.feather')))
gpnn.pred.train <- tail(pred.test,30)
colnames(gpnn.pred.train) <- c('id','pred')
gpnn.pred.train <- gpnn.pred.train[order(gpnn.pred.train$id),]
plot(y=gpnn.pred.train[,2], x = wb2.pred.train, ylab="FI Prediction", xlab = "True FI", main = "In-sample Predictions against Simulated Truth",lwd=0.5, ylim=c(-15,15),xlim=c(-15,15))
# lines(x=wb2.pred.train, y=gpr.pred.train, type = "p", col='blue',pch=2,lwd=0.5)

abline(a=0,b=1,lwd=2,col="red")
abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="orange")

# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("GPNN","y=x, m=1"),col=c("black","red"), pch = c(1,2,15))
```

##Assess simulation same SEED
```{r}
#GPNN
num.it <-750*3
runs <- c(1)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov24_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov24_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- c(3)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov24_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
# runs4 <- 1:16
# res.mat4 <- array(,dim=c(2,length(runs4),num.it))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_7_loss__jobid_",i,".csv")))[,1:num.it]
# }

failed.run <- c()
hs.int<-matrix(,nrow=20,ncol=13)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
plot(x=1:num.it,y=sqrt(res.mat[2,,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x = 1:num.it,y=sqrt(res.mat[2,,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.mat[2,,]),col='darkgreen',lwd=2, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=sqrt(res.mat[2,,1200]), col='black',lwd=1)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
plot(x =1:num.it,y=sqrt(res.mat[1,,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x = 1:num.it,y=sqrt(res.mat2[1,,]),col='blue',lwd=2, type = 'l')
lines(x = 1:num.it,y=sqrt(res.mat3[1,,]),col='darkgreen',lwd=2, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```
Wrong plot below
```{r}
#GPNN
num.it <-250*3
runs <- c(1,1)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov24_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2,2)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov24_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- c(3,3)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov24_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
# runs4 <- 1:16
# res.mat4 <- array(,dim=c(2,length(runs4),num.it))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_7_loss__jobid_",i,".csv")))[,1:num.it]
# }

failed.run <- c()
hs.int<-matrix(,nrow=20,ncol=13)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
# res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```

#25 Nov
```{r}
#GPNN
num.it <-400*3
runs <- c(1)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov25_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov25_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- c(3)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov25_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
# runs4 <- 1:16
# res.mat4 <- array(,dim=c(2,length(runs4),num.it))
# for(i in runs4){
#   res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov15_gpnn_7_loss__jobid_",i,".csv")))[,1:num.it]
# }

failed.run <- c()
hs.int<-matrix(,nrow=20,ncol=13)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
plot(x=1:num.it,y=sqrt(res.mat[2,,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x = 1:num.it,y=sqrt(res.mat[2,,]),col='blue',lwd=1, type = 'l')
lines(x = 1:num.it,y=sqrt(res.mat[2,,]),col='darkgreen',lwd=2, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=sqrt(res.mat[2,,1200]), col='black',lwd=1)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
plot(x =1:num.it,y=sqrt(res.mat[1,,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x = 1:num.it,y=sqrt(res.mat2[1,,]),col='blue',lwd=2, type = 'l')
lines(x = 1:num.it,y=sqrt(res.mat3[1,,]),col='darkgreen',lwd=2, type = 'l')
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```

#26 Nov

##Plot results from beginning
```{r}
#GPNN
num.it <-400*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov25_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }


failed.run <- c()
hs.int<-matrix(,nrow=20,ncol=13)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             # ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','magenta'))
```
We can see that at iteration 750, it stops updating, potentially from the decrease in learning rate, perhaps remove that.

###Plot MAP
```{r}
#GPNN
num.it <-400*3
runs <- 1:10
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov25_gpnn10_5_map__jobid_",i,".csv")))[1:num.it]
 }

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             # ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','magenta'))
```



##Plot results from same parameters
```{r}
#GPNN
num.it <-100*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov25_gpnn10_ext_loss__jobid_",i,".csv")))[,1:num.it]
 }


failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta'))
```
It is 0 and stays at 0 ===> good
### Plot MAP
```{r}
#GPNN
num.it <-100*3
runs <- 1:10
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov25_gpnn10_ext_map__jobid_",i,".csv")))[1:num.it]
 }

#define legends
leglab <- c(paste0("gpnn"))

#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train Loss", ylab="Loss", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red"))
```

##Note

`nov25_gpnn_5` has decayed learning rate
Try `nov26` without the decay learning rate

##27 Nov
##Plot results from beginning
```{r}
#GPNN
num.it <-400*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov26_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }


failed.run <- c()
hs.int<-matrix(,nrow=20,ncol=13)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov17_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             # ,paste0("gpnn_6_bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','magenta'))
```

#28 Nov
##Plot results from beginning
```{r}
#GPNN
num.it <-400*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov26_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

leglab <- c(paste0("gpnn_fixed_seed")
                             ,paste0("gpnn_random_seed")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```
I accidentally overwrote the results of gpnn_5 and gpnn_5_noseed :(

###Observe loss
```{r}
#GPNN
num.it <-400*3
runs <- 1:10
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov26_gpnn10_5_map__jobid_",i,".csv")))[1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(length(runs2),num.it))
for(i in runs2){
  res.mat2[which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpnn10_5_map__jobid_",i,".csv")))[1:num.it]
}


leglab <- c(paste0("gpnn_fixed_seed"),paste0("gpnn_random_seed"))

#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train Loss", ylab="Loss", xlab="iteration",ylim=c(48,100))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2, MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
 

```


##Plot Real data
```{r}
#GPNN
num.it <-1000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov27_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
# runs2 <- 1:20
# res.mat2 <- array(,dim=c(2,length(runs2),num.it))
# for(i in runs2){
#   res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov15_gpnn10_6_loss__jobid_",i,".csv")))[,1:num.it]
# }

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
# res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
# res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
# lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
# lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
# lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta'))
```

Loss
```{r}
#GPNN
num.it <-1000*3
runs <- 1:10
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov27_gpnn10_5_map__jobid_",i,".csv")))[1:num.it]
 }

leglab <- c(paste0("gpnn"))

#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train Loss", ylab="Loss", xlab="iteration",ylim=c(59,80))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)


grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
 

```

#29 Nov

Replot
```{r}
#GPNN
num.it <-700*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_nonseed_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

leglab <- c(paste0("gpnn_fixed_seed")
                             ,paste0("gpnn_random_seed")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```
Loss
```{r}
#GPNN
num.it <-700*3
runs <- 1:10
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_5_map__jobid_",i,".csv")))[1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(length(runs2),num.it))
for(i in runs2){
  res.mat2[which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_nonseed_map__jobid_",i,".csv")))[1:num.it]
}
leglab <- c(paste0("gpnn_fixed_seed"),paste0("gpnn_random_seed"))
#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train Loss", ylab="Loss", xlab="iteration",ylim=c(48,100))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
```
##Real
```{r}
#GPNN
num.it <-900*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov28_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov28_gpnn10_5_bias_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

leglab <- c(paste0("gpnn")
                             ,paste0("gpnn_with_bias")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```
Loss
```{r}
#GPNN
num.it <-700*3
runs <- 1:10
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov28_gpnn10_5_map__jobid_",i,".csv")))[1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(length(runs2),num.it))
for(i in runs2){
  res.mat2[which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov28_gpnn10_5_bias_map__jobid_",i,".csv")))[1:num.it]
}
leglab <- c(paste0("gpnn_fixed_seed"),paste0("gpnn_random_seed"))
#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train Loss", ylab="Loss", xlab="iteration",ylim=c(48,100))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
```

##Assessing the parameters in simulation study

###True
####Load
```{r}
#First layer
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov25_gpnn10_5_theta_',"_jobid_",1,'.feather')))
bias<- as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov25_gpnn10_5_bias__jobid_1.csv')))
#Last layer
l.bias <- as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov25_gpnn10_5_lbias__jobid_1.csv')))
l.theta <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov25_gpnn10_5_ltheta_',"_jobid_",1,'.feather')))
#sigma
y.sigma <- tail(as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov25_gpnn10_5_sigma__jobid_1.csv'))),1)

#####Analysis


#First-layer theta
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = paste0('Region',1:8)
            )

# First-layer bias
data.frame( Value = bias,row.names = paste0('Region',1:8))

# Hidden-layaer theta
data.frame( Mean =mean(l.theta), 
            Var = var(l.theta),
            Min = min(l.theta),
            Max = max(l.theta))
# Hidden-layer bias
data.frame( Value = l.bias)
# sigma
data.frame( Value = y.sigma)
```
###Fixed seed
```{r}
#First layer
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_5_theta_',"_jobid_",1,'.feather')))
bias<- as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_5_bias__jobid_1.csv')))
#Last layer
# l.bias <- as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_5_lbias__jobid_1.csv')))
# l.theta <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_5_ltheta_',"_jobid_",1,'.feather')))
#sigma
y.sigma <- tail(as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_5_sigma__jobid_1.csv'))),1)

#####Analysis


#First-layer theta
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = paste0('Region',1:8)
            )

# First-layer bias
data.frame( Value = bias,row.names = paste0('Region',1:8))

# Hidden-layaer theta
# data.frame( Mean =mean(l.theta), 
#             Var = var(l.theta),
#             Min = min(l.theta),
#             Max = max(l.theta))
# # Hidden-layer bias
# data.frame( Value = l.bias)
# sigma
data.frame( Value = y.sigma)
```

###Random seed
```{r}
#First layer
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_nonseed_theta_',"_jobid_",3,'.feather')))
bias<- as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_nonseed_bias__jobid_3.csv')))
#Last layer
# l.bias <- as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_nonseed_lbias__jobid_1.csv')))
# l.theta <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_nonseed_ltheta_',"_jobid_",1,'.feather')))
#sigma
y.sigma <- tail(as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_nonseed_sigma__jobid_3.csv'))),1)

#####Analysis


#First-layer theta
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = paste0('Region',1:8)
            )

# First-layer bias
data.frame( Value = bias,row.names = paste0('Region',1:8))

# Hidden-layaer theta
# data.frame( Mean =mean(l.theta), 
#             Var = var(l.theta),
#             Min = min(l.theta),
#             Max = max(l.theta))
# # Hidden-layer bias
# data.frame( Value = l.bias)
# sigma
data.frame( Value = y.sigma)
```

Find the lowest 
```{r}
#GPNN
num.it <-700*3
runs <- 1
res.mat <- array(,dim=c(2,num.it))
for(i in runs){
  res.mat <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
runs2 <- 3
res.mat2 <- array(,dim=c(2,num.it))
for(i in runs2){
  res.mat2 <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_nonseed_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

leglab <- c(paste0("gpnn_fixed_seed")
                             ,paste0("gpnn_random_seed")
                             , "GPR")

#Test
plot(x=1:num.it,y=sqrt(res.mat[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x = 1:num.it,y=sqrt(res.mat2[2,]),col='blue',lwd=1, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
plot(x =1:num.it,y=sqrt(res.mat[1,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x = 1:num.it,y=sqrt(res.mat2[1,]),col='blue',lwd=2, type = 'l')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```
Look at predictions
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/sim/simfi5.csv')
wb2.pred.train <- age_tab$pred[ind.to.use$train]

pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_5_inpred__jobid_1.feather')))
gpr.pred.train <- tail(pred.test,1611)
colnames(gpr.pred.train) <- c('id','pred')
gpr.pred.train <- gpr.pred.train[order(gpr.pred.train$id),]


pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_nonseed_inpred__jobid_3.feather')))
gpnn.pred.train <- tail(pred.test,1611)
colnames(gpnn.pred.train) <- c('id','pred')
gpnn.pred.train <- gpnn.pred.train[order(gpnn.pred.train$id),]

plot(y=gpnn.pred.train[,2], x = wb2.pred.train, ylab="FI Prediction", xlab = "True FI", main = "In-sample Predictions against Simulated Truth",lwd=0.5, ylim=c(0,13),xlim=c(0,13), col = 'blue')
lines(x=wb2.pred.train, y=gpr.pred.train[,2], type = "p", col='red',pch=2,lwd=0.5)
abline(a=0,b=1,lwd=2,col="black")
# abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="b")
# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("GPNN-fixedSeed","GPNN-randomSeed","y=x, m=1"),col=c("red","blue","black"), pch = c(2,1,15))
```

Look at MAPE
```{r}
mape <- function(true_vec, obs_vec){(mean(abs(true_vec-obs_vec)*100/true_vec))}
```
Load true
```{r}
true.the <- c(unlist(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov25_gpnn10_5_theta__jobid_1.feather')))
# true.wei <- c(unlist(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov25_gpnn10_5_weights__jobid_1.feather')))
true.bias <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov25_gpnn10_5_bias__jobid_1.csv')$x)
```
```{r}
runs <- 1:10
res.mat <- matrix(,nrow=length(runs),ncol = 2)
for(i in runs){
  res.mat[which(i==runs),1] <- mape(true.the, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_5_theta__jobid_',i,'.feather')))))
  # res.mat[which(i==runs),2] <- mape(true.wei, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_4_weights__jobid_',i,'.feather')))))
  res.mat[which(i==runs),2] <- mape(true.bias, c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_5_bias__jobid_',i,'.csv'))$x))
}
plot(x= runs,y=res.mat[,1],col='red',lwd=2, type = 'l',main = "Mean Absolute % Error", ylab="MAPE", xlab="runs")
# lines(x= runs,y=res.mat[,2],col='blue',lwd=2)
lines(x= runs,y= res.mat[,2],col='green',lwd=2)
legend('bottomright',legend = c('theta','weights','bias'),lty=c(1),col=c("red",'blue','green'))

```
```{r}
runs <- 1:10
res.mat <- matrix(,nrow=length(runs),ncol = 2)
for(i in runs){
  res.mat[which(i==runs),1] <- mape(true.the, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_nonseed_theta__jobid_',i,'.feather')))))
  # res.mat[which(i==runs),2] <- mape(true.wei, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov18_gpnn10_4_weights__jobid_',i,'.feather')))))
  res.mat[which(i==runs),2] <- mape(true.bias, c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov28_gpnn10_nonseed_bias__jobid_',i,'.csv'))$x))
}
plot(x= runs,y=res.mat[,1],col='red',lwd=2, type = 'l',main = "Mean Absolute % Error", ylab="MAPE", xlab="runs", ylim = c(-800,200))
# lines(x= runs,y=res.mat[,2],col='blue',lwd=2)
lines(x= runs,y= res.mat[,2],col='green',lwd=2)
legend('bottomright',legend = c('theta','weights','bias'),lty=c(1),col=c("red",'blue','green'))

```

#30 Nov

##Plot simulation with increased lr
```{r}
#GPNN
num.it <-700*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov29_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov29_gpnn10_nonseed_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

leglab <- c(paste0("gpnn_fixed_seed")
                             ,paste0("gpnn_random_seed")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```
Very odd behaviour

#Real data
```{r}
#GPNN
num.it <-900*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov29_gpnn10_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov29_gpnn10_5_bias_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

leglab <- c(paste0("gpnn")
                             ,paste0("gpnn_with_bias")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```
Again odd behaviour and does not generalise well





#1 Dec

Observe gen_pred2

```{r}
#GPNN
num.it <-500*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov30_gpnnlin_lr7_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov30_gpnnlin_lr9_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov30_gpnnlin_lr11_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov30_gpnnlin_lr11_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_7")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```

Assess long
```{r}
#GPNN
num.it <-700*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov30_gpnnlin_lr11_long_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj


failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_7")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```

# 1 dec
```{r}
#GPNN
num.it <-1000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec1_gpnnlin_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec1_gpnnlin_lr12_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_7")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```

#3 Dec

##Observe gen_pred2 

```{r}
#GPNN
num.it <-1000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec1_gpnnlin_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec1_gpnnlin_lr12_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_4_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_BaseModel")
                             ,paste0("gpnn_LowLR")
                             ,paste0("gpnn_HighPriorVar")
                             ,paste0("gpnn_LowPriorVar")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
```

##Look at real data
```{r}
#GPNN
num.it <-900*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec1_gpnnlin_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_BaseModel")
                             ,paste0("gpnn_withBias"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```

##Plot simulation fixed seed and random seed
```{r}
#GPNN
num.it <-700*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec2_gpnnlin_loss__jobid_",i,".csv")))[,1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec2_gpnnlin_nonseed_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

leglab <- c(paste0("gpnn_fixed_seed")
                             ,paste0("gpnn_random_seed")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```


#4 Dec
##Plot results from same parameters
```{r}
#GPNN
num.it <-100*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec3_gpnnlin_ext_loss__jobid_",i,".csv")))[,1:num.it]
 }


failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta'))
```

##Plot simulation fixed seed and random seed
```{r}
#GPNN
num.it <-900*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec3_gpnnlin_loss__jobid_",i,".csv")))[,1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec3_gpnnlin_nonseed_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

leglab <- c(paste0("gpnn_fixed_seed")
                             ,paste0("gpnn_random_seed")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```

```{r}
#GPNN
num.it <-900*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec3_gpnnlin_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("gpnn_4")
                             ,paste0("gpnn_5")
                             ,paste0("gpnn_6")
                             ,paste0("gpnn_7")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','green','orange','magenta'))
```

#5 Dec

##Plot results from same parameters
```{r}
#GPNN
num.it <-100*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec4_gpnnlin_ext_loss__jobid_",i,".csv")))[,1:num.it]
 }


failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)


legend('topright',legend = leglab,lty=c(1),col=c("red"))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = leglab,lty=c(1),col=c("red"))
```

##Plot results from same parameters
```{r}
#GPNN
num.it <-100*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec4_gpnnlin_ext6_loss__jobid_",i,".csv")))[,1:num.it]
 }


failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)


legend('topright',legend = leglab,lty=c(1),col=c("red"))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
legend('topright',legend = leglab,lty=c(1),col=c("red"))
```

##Plot simulation fixed seed and random seed
```{r}
#GPNN
num.it <-900*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec4_gpnnlin_loss__jobid_",i,".csv")))[,1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec4_gpnnlin_nonseed_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

leglab <- c(paste0("gpnn_fixed_seed")
                             ,paste0("gpnn_random_seed"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
```


#6 Dec

#Plot ext
```{r}
#GPNN
num.it <-100*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec4_gpnnlin_ext_v5lr10_loss__jobid_",i,".csv")))[,1:num.it]
 }


failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)


legend('topright',legend = leglab,lty=c(1),col=c("red"))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = leglab,lty=c(1),col=c("red"))
```
Look in the log files `79884144`


##Look at real data
Assessing `dec2_gpnnlin`This is with var 5
```{r}
#GPNN
num.it <-200*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec1_gpnnlin_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("omega^2~5e-5, bias~1")
                             ,paste0("omega^2~5e-5, bias~mean"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='blue',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```
Look at log `79884148` everything seems fine

##Plot simulation fixed seed and random seed
This is with var 6
```{r}
#GPNN
num.it <-400*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec5_gpnnlin_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec4_gpnnlin_nonseed_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c()
hs.int<-matrix(,nrow=10,ncol=13)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_nov27_gpr_noscale_",i,".csv"))))
}
# hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

leglab <- c(paste0("gpnn_fixed_seed")
                             ,paste0("gpnn_random_seed"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,20))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
```

##I should do new version vs old version
But then set up is not so comparable tho 
```{r}
#GPNN
num.it <-200*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec1_gpnnlin_5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v5lr8_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}

failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("omega^2~5e-5, bias~1")
                             ,paste0("omega^2~5e-6, bias~1")
                             ,paste0("omega^2~5e-5, bias~mean")
                             ,paste0("omega^2~5e-6, bias~mean")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
```
We can see that with var ~ 6, bias doesn't have a large impact let's see
```{r}
runs <- 1:10
l.bias<- vector(mode="numeric")
for(i in runs){
  l.bias <- c(l.bias,as.vector(unlist(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_lbias__jobid_',i,'.csv')))))
}
mean(l.bias)
```
With bias
```{r}
runs <- 1:10
l.bias<- vector(mode="numeric")
for(i in runs){
  l.bias <- c(l.bias,as.vector(unlist(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_lbias__jobid_',i,'.csv')))))
}
mean(l.bias)
```

```{r}
runs <- 1:10
l.bias<- vector(mode="numeric")
for(i in runs){
  l.bias <- c(l.bias,as.vector(unlist(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec1_gpnnlin_5_lbias__jobid_',i,'.csv')))))
}
mean(l.bias)

runs <- 1:10
l.bias<- vector(mode="numeric")
for(i in runs){
  l.bias <- c(l.bias,as.vector(unlist(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v5lr8_lbias__jobid_',i,'.csv')))))
}
mean(l.bias)
```


##Observe gen_pred 
```{r}
#GPNN
num.it <-1000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_4_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec1_gpnnlin_5_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_loss__jobid_",i,".csv")))[,1:num.it]
}
# stgp


failed.run <- c(2,17,29)
hs.int<-matrix(,nrow=30,ncol=13)
for(i in setdiff(1:30,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_nov2__gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("omega^2~5e-4")
                             ,paste0("omega^2~5e-5")
                             ,paste0("omega^2~5e-6")
                             , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
```

#7 Dec

##Update from Jian's meeting from 6 dec

o 1. Add noise to simulation to see if it converges, e.g. noise = 5
/ 2. Check if mask is unilateral or bilateral => some parts are uni and some are bi
3. Build a generative model with only 1 GP in the first layer.   ====> isn't this simply GPR?
/ 4. Always check objecive function when it doesn't work, e.g. when rmse is diverging
/ 5. Check if lr is too large which may cause RMSE to diverge in the wrong way
o 6. Try flat prior on omega^2
7. For simulation, check MSE of alpha(v)


## Check number 4 objecive function when it doesn't work
```{r}
#GPNN
num.it <-100*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec4_gpnnlin_ext_v5lr10_loss__jobid_",i,".csv")))[,1:num.it]
 }
#define legends
leglab <- c(paste0("GPNN"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)


legend('topright',legend = leglab,lty=c(1),col=c("red"))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = leglab,lty=c(1),col=c("red"))

res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec4_gpnnlin_ext_v5lr10_map__jobid_",i,".csv")))[1:num.it]
 }

leglab <- c("GPNN")
#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train Loss", ylab="Loss", xlab="iteration",ylim=c(44,48))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red"))
```
We can see that Loss is similar to MSE, indicating too large step size?
Check if it has lower stepsize, waiting for `dec7_gpnnlin_ext_v5lr12`

##Check 5, lower lr
```{r}
#GPNN
num.it <-100*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec7_gpnnlin_ext_v5lr12_loss__jobid_",i,".csv")))[,1:num.it]
 }
#define legends
leglab <- c(paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)


legend('topright',legend = leglab,lty=c(1),col=c("red"))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = leglab,lty=c(1),col=c("red"))

res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec7_gpnnlin_ext_v5lr12_map__jobid_",i,".csv")))[1:num.it]
 }

leglab <- c("GPNN")
#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train Loss", ylab="Loss", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red"))
```
Note we that we only want to look at held out, held in is not exactly zero since the parameters rely on the last mini batch only.
It is now resolved


##1 Adding noise
Use `simfi8.csv`, added seed 1 N(0,3)
Assess `dec7_gpnnlin_8_v6lr11`

Currently running
//1. `dec6_gpnnlin_v6lr11_long` Real data long run
//2. `dec7_gpnnlin_ext_v5lr12`Test low lr
//3. `dec7_gpnnlin_7_v6lr11` against sim_dec5_gpnnlin_v6lr11?, PREVIOUSLY dec5 was fitted against simfi6 which isn't correct? perhaps it can estimate something with lower degree, try!!!
//4. `dec7_gpnnlin_nonseed_7_v6lr11`
//5. `dec7_gpnnlin_8_v6lr11` With noise
//6. `dec7_gpnnlin_nonseed_8_v6lr11` With noise
//7. sim`dec7_gpnnlin_nhp_8_v6lr11`no hidden prior
//8. re`dec7_gpnnlin_nhp_v6lr11`no hidden prior but init bias




#8 Dec

Currently running
1. `dec8_gpnnlin_v6lr11_long` Real data long run (2000)
2. `gen_pred_gpr_ldorsal`
3.`dec8_gpnnlin_nhp_v6lr11` Real data long

##Real data
dec6_gpnnlin_v6lr11_long
and
dec7_gpnnlin_nhp_v6lr11
```{r}
#GPNN
num.it <-1000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_long_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:5,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec7_gpnnlin_nhp_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("with priors")
                             ,paste0("without priors"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```

##Simulation without noise
```{r}
#GPNN
num.it <-400*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec7_gpnnlin_7_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:5,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec7_gpnnlin_nonseed_7_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}


#define legends
leglab <- c(paste0("with priors")
                             ,paste0("without priors"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)


legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```
It gets stuck in a local optimum!!!, actually don't, eed a longer run
From this result, try fitting v7lr11 against simfi7? HAVE NOT DONE

##Simulation With noise
Noise N(0,3)
With prior and no hiden layer priors
```{r}
#GPNN
num.it <-400*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec7_gpnnlin_8_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec7_gpnnlin_nonseed_8_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec7_gpnnlin_nhp_8_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))


#define legends
leglab <- c(paste0("GPNN_FixedSeed")
                             ,paste0("GPNN_RandomSeed")
                             ,paste0("GPNN_NHP")
            , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
```
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))




RMSE should converge to 3 but this is 4, perhaps try longer?
//1. dec9_gpnnlin_7_v6lr11
//2. dec9_gpnnlin_nonseed_7_v6lr11
//3. dec9_gpnnlin_nhp_8_v6lr11





#9 Dec
##Look at Gen GPR LDorsal


```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi
hs.pred.train <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec7_gpr_LDor_inpred_noscale_4.csv')$x,read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec7_gpr_LDor_outpred_noscale_4.csv')$x)
plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "GPR against Truth", ylim=c(0,13))
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```
This isn't good, it's just predicting the mean.
Let's look at the visualisation

I am producing 
//1. `dfn/viz/gpr_LDor_`
//2. `dec9_gpr_VenCer_`

```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi
hs.pred.train <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec9_gpr_VenCer_inpred_noscale_4.csv')$x,read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec9_gpr_VenCer_outpred_noscale_4.csv')$x)
plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "GPR against Truth", ylim=c(0,13))
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi
hs.pred.train <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec9_gpr_LDor_inpred_noscale_4.csv')$x,read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec9_gpr_LDor_outpred_noscale_4.csv')$x)
plot(y=hs.pred.train, x = wb2.pred.train, ylab="GPR Prediction", xlab = "Truth", main = "GPR against Truth", ylim=c(0,13))
abline(a=0,b=1,lwd=2,col="red")
abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("y=x, m=1", paste0("fitted, m=", round(coef(lm(hs.pred.train ~ wb2.pred.train))[2],2))),col=c("red","blue"), lty = 1)
```

##GPR
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi
hs.pred.train <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_inpred_noscale_4.csv')$x,read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_outpred_noscale_4.csv')$x)
plot(y=hs.pred.train[ind.to.use$train], x = wb2.pred.train[ind.to.use$train], ylab="GPR Prediction", xlab = "Truth", main = "GPR against Truth", ylim=c(0,13), col = 'blue',lwd=0.5)
lines(y=hs.pred.train[ind.to.use$test], x = wb2.pred.train[ind.to.use$test], type = "p", col='red',pch=2,lwd=0.5)
abline(lm(hs.pred.train[ind.to.use$train] ~ wb2.pred.train[ind.to.use$train]), col = "purple")
abline(lm(hs.pred.train[ind.to.use$test] ~ wb2.pred.train[ind.to.use$test]), col = "orange")
abline(a=0,b=1,lwd=2,col="black")
# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("Held-in","Held-out","y=x, m=1","Held-in fitted linear","Held-out fitted linear"),col=c("blue","red","black",'purple','orange'), pch = c(2,1,15,15,15))
```


##Plot real
dec6_gpnnlin_v6lr11
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi

pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_inpred__jobid_1.feather')))
gpr.pred.train <- tail(pred.test,1611)
colnames(gpr.pred.train) <- c('id','pred')
gpr.pred.train <- gpr.pred.train[order(gpr.pred.train$id),]

pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_outpred__jobid_1.feather')))
gpnn.pred.train <- tail(pred.test,1642)
colnames(gpnn.pred.train) <- c('id','pred')
gpnn.pred.train <- gpnn.pred.train[order(gpnn.pred.train$id),]

plot(y=round(gpr.pred.train[,2]), x = wb2.pred.train[ind.to.use$train], ylab="FI Prediction", xlab = "True FI", main = "GPNN Predictions against Simulated Truth",lwd=0.5, ylim=c(-10,20),xlim=c(0,13), col = 'blue')
lines(x=round(wb2.pred.train[ind.to.use$test]), y=gpnn.pred.train[,2], type = "p", col='red',pch=2,lwd=0.5)
abline(a=0,b=1,lwd=2,col="black")
# abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="b")
abline(lm(gpr.pred.train[,2] ~ wb2.pred.train[ind.to.use$train]), col = "purple")
abline(lm(gpnn.pred.train[,2] ~ wb2.pred.train[ind.to.use$test]), col = "orange")

grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("Held-in","Held-out","y=x, m=1","Held-in fitted linear","Held-out fitted linear"),col=c("blue","red","black",'purple','orange'), pch = c(2,1,15,15,15))
```

dec7_gpnnlin_nhp_v6lr11
```{r}
runnum <- 4
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi

pred.test <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec7_gpnnlin_nhp_v6lr11_inpred__jobid_',runnum,'.feather'))))
gpr.pred.train <- tail(pred.test,1611)
colnames(gpr.pred.train) <- c('id','pred')
gpr.pred.train <- gpr.pred.train[order(gpr.pred.train$id),]

pred.test <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec7_gpnnlin_nhp_v6lr11_outpred__jobid_',runnum,'.feather'))))
gpnn.pred.train <- tail(pred.test,1642)
colnames(gpnn.pred.train) <- c('id','pred')
gpnn.pred.train <- gpnn.pred.train[order(gpnn.pred.train$id),]

plot(y=round(gpr.pred.train[,2]), x = wb2.pred.train[ind.to.use$train], ylab="FI Prediction", xlab = "True FI", main = "GPNN Predictions against Simulated Truth",lwd=0.5, ylim=c(-10,20),xlim=c(0,13), col = 'blue')
lines(x=round(wb2.pred.train[ind.to.use$test]), y=gpnn.pred.train[,2], type = "p", col='red',pch=2,lwd=0.5)
abline(a=0,b=1,lwd=2,col="black")
# abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="b")
abline(lm(gpr.pred.train[,2] ~ wb2.pred.train[ind.to.use$train]), col = "purple")
abline(lm(gpnn.pred.train[,2] ~ wb2.pred.train[ind.to.use$test]), col = "orange")

grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("Held-in","Held-out","y=x, m=1","Held-in fitted linear","Held-out fitted linear"),col=c("blue","red","black",'purple','orange'), pch = c(2,1,15,15,15))
```
This is extremely weird, run 4 never gets below 5, run 1 seems okay 

Perhaps look at the distribution shift between runs
###Look at distribution

####for gpr ldr
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$fi
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
c1 <- rgb(173,216,230,max = 255, alpha = 80, names = "lt.blue")
c2 <- rgb(255,192,203, max = 255, alpha = 80, names = "lt.pink")
hist.true <- hist(age, breaks = seq(from=-5, to=20, by=1), plot = FALSE)


hs.pred.train <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec9_gpr_LDor_inpred_noscale_4.csv')$x,read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec9_gpr_LDor_outpred_noscale_4.csv')$x)

for(i in c(1:6,8:10)){
  hs.pred.train <- c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec9_gpr_LDor_inpred_noscale_',i,'.csv'))$x,read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec9_gpr_LDor_outpred_noscale_',i,'.csv'))$x)
  hist.pred <- hist(hs.pred.train, breaks = seq(from=-15, to=30, by=1), plot = FALSE)
  plot(hist.true,col=c1,ylim=c(0,1500), main = "Histogram of Fluid Intelligence score in the datasets", xlab = "Fluid Intelligence score")
plot(hist.pred, add = TRUE, col = c2)
legend("topright", pch=15, legend = c("True", "Predictions"), col = c("lightblue","pink"))
}
```

####for gpr
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$fi
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
c1 <- rgb(173,216,230,max = 255, alpha = 80, names = "lt.blue")
c2 <- rgb(255,192,203, max = 255, alpha = 80, names = "lt.pink")
hist.true <- hist(age, breaks = seq(from=-5, to=20, by=1), plot = FALSE)


hs.pred.train <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_inpred_noscale_4.csv')$x,read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec9_gpr_LDor_outpred_noscale_4.csv')$x)

for(i in c(1:6,8:10)){
  hs.pred.train <- c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_inpred_noscale_',i,'.csv'))$x,read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec9_gpr_LDor_outpred_noscale_',i,'.csv'))$x)
  hist.pred <- hist(hs.pred.train, breaks = seq(from=-15, to=30, by=1), plot = FALSE)
  plot(hist.true,col=c1,ylim=c(0,1500), main = "Histogram of Fluid Intelligence score in the datasets", xlab = "Fluid Intelligence score")
plot(hist.pred, add = TRUE, col = c2)
legend("topright", pch=15, legend = c("True", "Predictions"), col = c("lightblue","pink"))
}
```

####for v6lr11
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$fi
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
c1 <- rgb(173,216,230,max = 255, alpha = 80, names = "lt.blue")
c2 <- rgb(255,192,203, max = 255, alpha = 80, names = "lt.pink")
hist.true <- hist(age, breaks = seq(from=-5, to=20, by=1), plot = FALSE)

for(i in c(1:10)){
  pred.test <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_inpred__jobid_',i,'.feather'))))
  gpr.pred.train <- tail(pred.test,1611)
  colnames(gpr.pred.train) <- c('id','pred')
  gpr.pred.train <- gpr.pred.train[order(gpr.pred.train$id),]
  pred.test <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_outpred__jobid_',i,'.feather'))))
  gpnn.pred.train <- tail(pred.test,1642)
  colnames(gpnn.pred.train) <- c('id','pred')
  gpnn.pred.train <- gpnn.pred.train[order(gpnn.pred.train$id),]

  hist.pred <- hist(c(gpr.pred.train$pred,gpnn.pred.train$pred), breaks = seq(from=-15, to=30, by=1), plot = FALSE)
  plot(hist.true,col=c1,ylim=c(0,1500), main = "Histogram of Fluid Intelligence score in the datasets", xlab = "Fluid Intelligence score")
plot(hist.pred, add = TRUE, col = c2)
legend("topright", pch=15, legend = c("True", "Predictions"), col = c("lightblue","pink"))
}
```

####for nhp
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$fi
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
c1 <- rgb(173,216,230,max = 255, alpha = 80, names = "lt.blue")
c2 <- rgb(255,192,203, max = 255, alpha = 80, names = "lt.pink")
hist.true <- hist(age, breaks = seq(from=-5, to=20, by=1), plot = FALSE)

for(i in c(1:5,7:10)){
  pred.test <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec7_gpnnlin_nhp_v6lr11_inpred__jobid_',i,'.feather'))))
  gpr.pred.train <- tail(pred.test,1611)
  colnames(gpr.pred.train) <- c('id','pred')
  gpr.pred.train <- gpr.pred.train[order(gpr.pred.train$id),]
  pred.test <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec7_gpnnlin_nhp_v6lr11_outpred__jobid_',i,'.feather'))))
  gpnn.pred.train <- tail(pred.test,1642)
  colnames(gpnn.pred.train) <- c('id','pred')
  gpnn.pred.train <- gpnn.pred.train[order(gpnn.pred.train$id),]

  hist.pred <- hist(c(gpr.pred.train$pred,gpnn.pred.train$pred), breaks = seq(from=-15, to=20, by=1), plot = FALSE)
  plot(hist.true,col=c1,ylim=c(0,1500), main = "Histogram of Fluid Intelligence score in the datasets", xlab = "Fluid Intelligence score")
plot(hist.pred, add = TRUE, col = c2)
legend("topright", pch=15, legend = c("True", "Predictions"), col = c("lightblue","pink"))
}
```

#12 Dec

Prev Comments from simulation with Noise not converging to 3
##Simulation With noise
Noise N(0,3)

But two of these aren't fitted against with noise tho, only use `nhp`

```{r}
#GPNN
num.it <-1500*3
runs <- c(1,3,4,6,8)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_nhp_8_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN-NHP"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta'))
```
See that it still diesn't converge to 4

##Let's look at the case of no noise
```{r}
#GPNN
num.it <-1500*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_7_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:3,6:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_nonseed_7_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec12_gpr7_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN_FixedSeed")
                             ,paste0("GPNN_RandomSeed"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```

##Look at fitting against gpr ldor
```{r}
#GPNN
num.it <-1500*3
runs <- c(2:5,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_ldor_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj

#define legends
leglab <- c(paste0("GPNN"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
```
Not 0 yet, but I think it converges very slowly

##Calculating MAPE
```{r}
mape <- function(true_vec, obs_vec){(mean(abs(true_vec-obs_vec)*100/true_vec))}

true.the <- c(unlist(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_theta__jobid_4.feather')))
true.bias <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_bias__jobid_4.csv')$x)
true.lthe <- c(unlist(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_lweights__jobid_4.feather')))
true.lbias <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_lbias__jobid_4.csv')$x)

runs <- 1:10
res.mat <- matrix(,nrow=length(runs),ncol = 4)
for(i in runs){
  res.mat[which(i==runs),1] <- mape(true.the, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_7_v6lr11_theta__jobid_',i,'.feather')))))
  res.mat[which(i==runs),2] <- mape(true.bias, c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_7_v6lr11_bias__jobid_',i,'.csv'))$x))
  res.mat[which(i==runs),3] <- mape(true.lthe, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_7_v6lr11_lweights__jobid_',i,'.feather')))))
  res.mat[which(i==runs),4] <- mape(true.lbias, c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_7_v6lr11_lbias__jobid_',i,'.csv'))$x))
  
}
plot(x= runs,y=res.mat[,1],col='red',lwd=2, type = 'l',main = "Mean Absolute % Error", ylab="MAPE (%)", xlab="runs",ylim=c(-0.2,0.01))
lines(x= runs,y=res.mat[,2],col='blue',lwd=2)
lines(x= runs,y= res.mat[,3],col='orange',lwd=2)
lines(x= runs,y= res.mat[,4],col='purple',lwd=2)
legend('bottomright',legend = c('theta','bias','lweights','lbias'),lty=c(1),col=c("red",'blue','orange','purple'))

```
```{r}
mape <- function(true_vec, obs_vec){(mean(abs(true_vec-obs_vec)*100/true_vec))}

true.the <- c(unlist(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_theta__jobid_4.feather')))
true.bias <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_bias__jobid_4.csv')$x)
true.lthe <- c(unlist(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_lweights__jobid_4.feather')))
true.lbias <- c(read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_lbias__jobid_4.csv')$x)

runs <- c(1:3,6:10)
res.mat <- matrix(,nrow=length(runs),ncol = 4)
for(i in runs){
  res.mat[which(i==runs),1] <- mape(true.the, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_nonseed_7_v6lr11_theta__jobid_',i,'.feather')))))
  res.mat[which(i==runs),2] <- mape(true.bias, c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_nonseed_7_v6lr11_bias__jobid_',i,'.csv'))$x))
  res.mat[which(i==runs),3] <- mape(true.lthe, c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_nonseed_7_v6lr11_lweights__jobid_',i,'.feather')))))
  res.mat[which(i==runs),4] <- mape(true.lbias, c(read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_nonseed_7_v6lr11_lbias__jobid_',i,'.csv'))$x))
  
}
plot(x= runs,y=res.mat[,1],col='red',lwd=2, type = 'l',main = "Mean Absolute % Error", ylab="MAPE (%)", xlab="runs",ylim=c(-1000,700))
lines(x= runs,y=res.mat[,2],col='blue',lwd=2)
lines(x= runs,y= res.mat[,3],col='orange',lwd=2)
lines(x= runs,y= res.mat[,4],col='purple',lwd=2)
legend('bottomright',legend = c('theta','bias','lweights','lbias'),lty=c(1),col=c("red",'blue','orange','purple'))

```



#Look at Real data long run from 9 dec
```{r}
#GPNN
num.it <-2000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec8_gpnnlin_v6lr11_long_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:5,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec8_gpnnlin_nhp_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("with priors")
                             ,paste0("without priors"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```

#13 Dec

##Plot long simulation run 

###No noise

```{r}
#GPNN
num.it <-1500*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_7_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:3,6:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_nonseed_7_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}

runs3 <- c(2:4,6,8:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec12_gpnnlin_nhp_7_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec12_gpr7_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))


#define legends
leglab <- c(paste0("GPNN_FixedSeed")
                             ,paste0("GPNN_RandomSeed")
                             ,paste0("GPNN_NHP")
            , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
```


###With noise

```{r}
#GPNN
num.it <-1500*3
runs <- c(2:5,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec12_gpnnlin_8_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1,3,4,6,8)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec9_gpnnlin_nhp_8_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}


runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))


#define legends
leglab <- c(paste0("GPNN"),paste0("GPNN_NHP")
            , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```


#14 Dec

#Use the 2 plots above as they are not yet fully used

#15 Dec

##Plot 1000 runs of real data
```{r}
#GPNN
num.it <-1000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec14_gpnn_ols_gen_loss__jobid_",i,".csv")))[,1:num.it]
 }

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("with priors")
                             ,paste0("without priors"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```
Let's look at predictions
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi

pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec14_gpnn_ols_gen_inpred__jobid_1.feather')))
gpr.pred.train <- tail(pred.test,1611)
colnames(gpr.pred.train) <- c('id','pred')
gpr.pred.train <- gpr.pred.train[order(gpr.pred.train$id),]

pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec14_gpnn_ols_gen_outpred__jobid_1.feather')))
gpnn.pred.train <- tail(pred.test,1642)
colnames(gpnn.pred.train) <- c('id','pred')
gpnn.pred.train <- gpnn.pred.train[order(gpnn.pred.train$id),]

plot(y=round(gpr.pred.train[,2]), x = wb2.pred.train[ind.to.use$train], ylab="FI Prediction", xlab = "True FI", main = "GPNN Predictions against Simulated Truth",lwd=0.5, ylim=c(-10,20),xlim=c(0,13), col = 'blue')
lines(x=round(wb2.pred.train[ind.to.use$test]), y=gpnn.pred.train[,2], type = "p", col='red',pch=2,lwd=0.5)
abline(a=0,b=1,lwd=2,col="black")
# abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="b")
abline(lm(gpr.pred.train[,2] ~ wb2.pred.train[ind.to.use$train]), col = "purple")
abline(lm(gpnn.pred.train[,2] ~ wb2.pred.train[ind.to.use$test]), col = "orange")

grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("Held-in","Held-out","y=x, m=1","Held-in fitted linear","Held-out fitted linear"),col=c("blue","red","black",'purple','orange'), pch = c(2,1,15,15,15))
```

We can see 0 updates from here, will use this and add noise

#16 Dec

##Plot simulation against noise 1
```{r}
#GPNN
num.it <-100*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec15_gpnn_ols_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj

#define legends
leglab <- c(paste0("GPNN"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=sqrt(1.214252 + 1^2))
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
abline(h=sqrt(1.214252 + 1^2))

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
```
wrong training *

##Observe large theta
```{r}
#GPNN
num.it <-1000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec15_gpnn_ols_gen_largetheta_loss__jobid_",i,".csv")))[,1:num.it]
 }

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN large thetas"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,2.3))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,2.3))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta'))
```
Let's look at predictions
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi

pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec15_gpnn_ols_gen_largetheta_inpred__jobid_1.feather')))
gpr.pred.train <- tail(pred.test,1611)
colnames(gpr.pred.train) <- c('id','pred')
gpr.pred.train <- gpr.pred.train[order(gpr.pred.train$id),]

pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec15_gpnn_ols_gen_largetheta_outpred__jobid_1.feather')))
gpnn.pred.train <- tail(pred.test,1642)
colnames(gpnn.pred.train) <- c('id','pred')
gpnn.pred.train <- gpnn.pred.train[order(gpnn.pred.train$id),]

plot(y=round(gpr.pred.train[,2]), x = wb2.pred.train[ind.to.use$train], ylab="FI Prediction", xlab = "True FI", main = "GPNN Predictions against Simulated Truth",lwd=0.5, ylim=c(-10,20),xlim=c(0,13), col = 'blue')
lines(x=round(wb2.pred.train[ind.to.use$test]), y=gpnn.pred.train[,2], type = "p", col='red',pch=2,lwd=0.5)
abline(a=0,b=1,lwd=2,col="black")
# abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="b")
abline(lm(gpr.pred.train[,2] ~ wb2.pred.train[ind.to.use$train]), col = "purple")
abline(lm(gpnn.pred.train[,2] ~ wb2.pred.train[ind.to.use$test]), col = "orange")

grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("Held-in","Held-out","y=x, m=1","Held-in fitted linear","Held-out fitted linear"),col=c("blue","red","black",'purple','orange'), pch = c(2,1,15,15,15))
```
Look at size of theta
```{r}
for(i in 1:10){
print(summary(c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec15_gpnn_ols_gen_largetheta_theta__jobid_',i,'.feather'))))))
}
```


##Currently running
1. gen_pred2_largetheta.R
//2. gpnn_ols SIM => gone back and fixed above


#18 Dec
## Look at gen_pred2_largetheta
```{r}
#GPNN
num.it <-1000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_loss__jobid_",i,".csv")))[,1:num.it]
 }

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN large thetas"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,700))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=1)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,700))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=1)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=1)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta'))
```

```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi

pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_inpred__jobid_1.feather')))
gpr.pred.train <- tail(pred.test,1611)
colnames(gpr.pred.train) <- c('id','pred')
gpr.pred.train <- gpr.pred.train[order(gpr.pred.train$id),]

pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_outpred__jobid_1.feather')))
gpnn.pred.train <- tail(pred.test,1642)
colnames(gpnn.pred.train) <- c('id','pred')
gpnn.pred.train <- gpnn.pred.train[order(gpnn.pred.train$id),]

plot(y=round(gpr.pred.train[,2]), x = wb2.pred.train[ind.to.use$train], ylab="FI Prediction", xlab = "True FI", main = "GPNN Predictions against Simulated Truth",lwd=0.5,xlim=c(0,13), col = 'blue',ylim=c(168.5,169.5))
lines(x=round(wb2.pred.train[ind.to.use$test]), y=round(gpnn.pred.train[,2]), type = "p", col='red',pch=2,lwd=0.5)
abline(a=0,b=1,lwd=2,col="black")
# abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="b")
abline(lm(gpr.pred.train[,2] ~ wb2.pred.train[ind.to.use$train]), col = "purple")
abline(lm(gpnn.pred.train[,2] ~ wb2.pred.train[ind.to.use$test]), col = "orange")

grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c("Held-in","Held-out","y=x, m=1","Held-in fitted linear","Held-out fitted linear"),col=c("blue","red","black",'purple','orange'), pch = c(2,1,15,15,15))
```
Look at size of theta
```{r}
for(i in 1:10){
print(summary(c(unlist(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec2_gpnnlin_6_theta__jobid_',i,'.feather'))))))
}
```
Initialising with large theta leads to unstability


gpr ols


#19 dec

##Plot simulation with noise 1

```{r}
#GPNN
num.it <-100*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec15_gpnn_ols_loss__jobid_",i,".csv")))[,1:num.it]
 }


runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec18_gprols_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))


#define legends
leglab <- c(paste0("GPNN"), "GPR","response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1,1.2))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h= 1.101931,lwd=2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1,1.2))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h= 1.101931,lwd=2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta','black'))
```

##Compare real-data between ols and not ols 
```{r}
#GPNN
num.it <-1000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_long_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec14_gpnn_ols_gen_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN with hidden-layer gradient updates")
                             ,paste0("GPNN with hidden-layer OLS"), "GPR", "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=2.084393, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=2.049224, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```
##Look at prediction scatter plot
###In-sample
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$train]
gpr.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_inpred_noscale_",1,".csv")))
pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec14_gpnn_ols_gen_inpred__jobid_1.feather')))
stgp.pred.train <- tail(pred.test,1611)
colnames(stgp.pred.train) <- c('id','pred')
stgp.pred.train <- stgp.pred.train[order(stgp.pred.train$id),]
pred.test <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_inpred__jobid_1.feather')))
gpnn.pred.train <- tail(pred.test,1611)
colnames(gpnn.pred.train) <- c('id','pred')
gpnn.pred.train <- gpnn.pred.train[order(gpnn.pred.train$id),]

plot(y=gpr.pred.train, x = wb2.pred.train, ylab="FI Prediction", xlab = "True FI", main = "In-sample Predictions against Truth",lwd=0.5, ylim=c(-5,18),xlim=c(0,13), col = "magenta")
lines(x=wb2.pred.train, y=stgp.pred.train[,2], type = "p", col='blue',pch=3,lwd=0.1)
lines(x=wb2.pred.train, y=gpnn.pred.train[,2], type = "p", col='red',pch=4,lwd=0.1)

abline(a=0,b=1,lwd=2,col="black")
abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="orange")

# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c(paste0("GPNN with hidden-layer gradient updates")
                             ,paste0("GPNN with hidden-layer OLS"), "GPR","y=x, m=1"),col=c("red","blue",'magenta','black'), pch = c(4,3,1,15))
```
###Out-of-sample
```{r}
ind.to.use<- list()
ind.to.use$train <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/train_index.csv')$x
ind.to.use$test <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/test_index.csv')$x
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/fi.feather')
wb2.pred.train <- age_tab$fi[ind.to.use$test]
gpr.pred.train <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_outpred_noscale_",1,".csv")))
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec14_gpnn_ols_gen_outpred__jobid_1.feather'))
stgp.pred.train <- tail(pred.test[2,],1642)
pred.test <- as.matrix(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_outpred__jobid_1.feather'))
gpnn.pred.train <- tail(pred.test[2,],1642)

plot(y=gpr.pred.train, x = wb2.pred.train, ylab="FI Prediction", xlab = "True FI", main = "Out-of-sample Predictions against Truth",lwd=0.5, ylim=c(-5,18),xlim=c(0,13), col = "magenta")
lines(x=wb2.pred.train, y=stgp.pred.train, type = "p", col='blue',pch=3,lwd=0.1)
lines(x=wb2.pred.train, y=gpnn.pred.train, type = "p", col='red',pch=4,lwd=0.1)

abline(a=0,b=1,lwd=2,col="black")
abline(h=mean(age_tab$fi[ind.to.use$train]),lwd=1,col="orange")

# abline(lm(hs.pred.train ~ wb2.pred.train), col = "blue")
grid(nx = NULL, ny = NULL,
     lty = 2,      # Grid line type
     col = "gray", # Grid line color
     lwd = 2)      # Grid line width
legend("bottomright", legend = c(paste0("GPNN with hidden-layer gradient updates")
                             ,paste0("GPNN with hidden-layer OLS"), "GPR","y=x, m=1"),col=c("red","blue",'magenta','black'), pch = c(4,3,1,15))
```



Currently running
AGE
1. gpnn_ols
2. gpnn_opt


#6 Jan

Look at REAL DATA age
ols vs fully gradient

```{r}
#GPNN
num.it <-750*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan4_gpnn_ols_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_jan5_gpnn_1_4_5_loss__jobid_",i,".csv")))[,1:num.it]
}

runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_jan5_gpnn_2_4_5_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec12_gpr7_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))


#define legends
leglab <- c(paste0("GPNN_FixedSeed")
                             ,paste0("GPNN_RandomSeed")
                             ,paste0("GPNN_NHP")
            , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
```

Fully gradient update is off the chart 

##Task fmri
Look at the distribution of Mask
```{r}
t.mask <-oro.nifti::readNIfTI('/well/nichols/users/qcv214/bnn2/task/mean_mask.nii.gz')
```
```{r}
summary(t.mask[t.mask>0])
```
```{r}
print(paste0("Union mask: ",sum(t.mask>0) , " voxels"))
print(paste0("Intersection mask: ",sum(t.mask==1) , " voxels"))
print(paste0("99% mask: ",sum(t.mask>0.99) , " voxels"))
```

Look at intersection of mask, and CIC_res3, seems like they are similar, so use CIC_res3 to generate it.
=> Take code from res3/fi/dfn/dfn_get_mask.R
=> Generate a script for mask on task/get_mask.R

But first, gotta
1. Generate a list of participant id
2. Check if they actually have Age or Fluid Intelligence



#8 Jan

Check learning rate of gradient updates for age
```{r}
#GPNN
num.it <-750*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan6_gpnn_2_4_8_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan6_gpnn_2_4_10_loss__jobid_",i,".csv")))[,1:num.it]
}

runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan6_gpnn_2_4_13_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec12_gpr7_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))


#define legends
leglab <- c(paste0("GPNN_FixedSeed")
                             ,paste0("GPNN_RandomSeed")
                             ,paste0("GPNN_NHP")
            , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
```
Very low learning rate is working!!

#8 Jan

Check varying learning rate
```{r}
#GPNN
num.it <-500*4
runs <- c(1,3:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan8_gpnn_2_4_12_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:4,6:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan8_gpnn_2_4_15_loss__jobid_",i,".csv")))[,1:num.it]
}

runs3 <- c(1:4,6:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan8_gpnn_2_4_16_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_dec12_gpr7_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))


#define legends
leglab <- c(paste0("GPNN_FixedSeed")
                             ,paste0("GPNN_RandomSeed")
                             ,paste0("GPNN_NHP")
            , "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(5,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta'))
```

#9 Jan

how about look at all participants with tasks `/well/nichols/users/qcv214/bnn2/task/full_part_id.csv`, and participants in age, find intercept
Check overlapping
```{r}
agetab<-read.table(file = '/well/nichols/projects/UKB/SMS/ukb_latest-Age.tsv', sep = '\t', header = TRUE)
part_list<-read.csv('/well/nichols/users/qcv214/bnn2/task/full_part_id.csv', header = FALSE, sep = "", dec = ".") #4529 participants
length(intersect(part_list$V1,paste0(2,agetab$eid))) #I think it should match with eid but intersection is 0
length(intersect(part_list$V1,paste0(agetab$eid))) #I think it should match with eid but intersection is 0
length(intersect(part_list$V1,paste0(2,agetab$eid_8107))) #I think it should match with eid but intersection is 0
length(intersect(part_list$V1,paste0(agetab$eid_8107))) #I think it should match with eid but intersection is 0
```
It actually intercept with `agetab$eid_8107`, (without "2" in front unlike r-fmri)

Check intersection of t-fmri and the used r-fmri data
```{r}
part_use<- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/dfn/part_id.csv')$x
part_list<-read.csv('/well/nichols/users/qcv214/bnn2/task/full_varcope_part_id.csv', header = FALSE, sep = "", dec = ".") #4529 participants
length(intersect(part_use,paste0(2,part_list$V1))) #I think it should match with eid but intersection is 0

```
only 792 joint participants

##Compile age results
```{r}
#GPNN
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan6_gpnn_2_4_13_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan4_gpnn_ols_1_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN with hidden-layer gradient updates")
                             ,paste0("GPNN with hidden-layer OLS"), "GPR", "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=5.904118, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```
Let's fit another gpr and see

Compared to back in September, with GP in the last layer
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 80*4
runs <- setdiff(1:20,c(1,6,18))
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_oct6_stgpols_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- setdiff(1:20,c(8,14,19))
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_oct6_stgpols4_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- setdiff(1:20,c(3))
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_oct6_stgpols5_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- c(12,17,18,24,25,27,28,29,8,9)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_sep7_nnvwb2_loss__jobid_",i,".csv")))
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("STGP,0.25")
                             ,paste0("STGP,0.35")
                             ,paste0("STGP,0.40")
                             ,paste0("GPNN"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 

#10 Jan

##Look at Age, ols varying learning rates

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan4_gpnn_ols_1_loss__jobid_",i,".csv")))[,1:num.it]
}
#Empirical bayes with 0.1 init var
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan9_gpnn_ols_2_2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan9_gpnn_ols_2_4_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan9_gpnn_ols_2_6_loss__jobid_",i,".csv")))
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr ~ 5e-8")
                             ,paste0("lr ~ 5e-2")
                             ,paste0("lr ~ 5e-4")
                             ,paste0("lr ~ 5e-6"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 
Loss
```{r}
#GPNN
num.it <- 500*4
runs <- 1:10
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan4_gpnn_ols_1_map__jobid_",i,".csv")))[1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(length(runs2),num.it))
for(i in runs2){
  res.mat2[which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan9_gpnn_ols_2_2_map__jobid_",i,".csv")))[1:num.it]
}
leglab <- c(paste0("gpnn ols 1"),paste0("gpnn ols 2"))
#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train Loss", ylab="sqrt(Loss)", xlab="iteration",ylim=c(0,2000))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
```

See no updates

##Task fmri modelling FI
```{r}
#GPNN
num.it <-267*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/task/pile/re_jan9_gpnn_ols_2_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/task/pile/re_jan9_gpnn_ols_2_2_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN with hidden-layer gradient updates")
                             ,paste0("GPNN with hidden-layer OLS"), "GPR", "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=2.084393, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=2.049224, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```
###With all r-fmri andt-fmri
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 267*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_long_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec14_gpnn_ols_gen_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/task/pile/re_jan9_gpnn_ols_2_1_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/task/pile/re_jan9_gpnn_ols_2_2_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("DMN with full gradient updates")
                             ,paste0("DMN with OLS")
                             ,paste0("Task with OLS 1")
                             ,paste0("Task with OLS 2"),
            "GPR (DMN)")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.8,4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=2.084393, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.8,4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=2.049224, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
``` 
Loss
```{r}
#GPNN
num.it <-267*3
runs <- 1:10
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/task/pile/re_jan9_gpnn_ols_2_1_map__jobid_",i,".csv")))[1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(length(runs2),num.it))
for(i in runs2){
  res.mat2[which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/task/pile/re_jan9_gpnn_ols_2_2_map__jobid_",i,".csv")))[1:num.it]
}
leglab <- c(paste0("gpnn ols 1"),paste0("gpnn ols 2"))
#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='green',lwd=2, type = 'l',main = "Train Loss", ylab="sqrt(Loss)", xlab="iteration",ylim=c(40,90))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='orange',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("green",'orange'))
```


#11 Jan

running

1. new nnbwb2 AGE
2. gpnn_gp AGE
3. gen_gpnn FI SIM //

##Look at gen_gpnn
```{r}
# gen.pred <- as.data.frame(t(read_feather('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan11_gen_gpnn_pred__jobid_1.feather')))
gen.pred <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan11_gen_gpnn_pred__jobid_1.csv')$V1
```
```{r}
hist(gen.pred, xlab = 'Simulated response', main = 'Histogram of Simulated response')
```

#12 Jan
##Plot result of Simulated FI
Starting with no info, vs starting with actual first layer
```{r}
#GPNN
num.it <-500*3
runs <- c(1:7,9,13,17)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan11_gpnn_ols_2_4_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:7
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan11_gpnn_ols_2_4_ext_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN with hidden-layer gradient updates")
                             ,paste0("GPNN with hidden-layer OLS"), "GPR", "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.1))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.1))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=5.904118, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```
Loss
```{r}
#GPNN
num.it <-500*3
runs <- c(1:7,9,13,17)
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan11_gpnn_ols_2_4_map__jobid_",i,".csv")))[1:num.it]
 }
runs2 <- 1:7
res.mat2 <- array(,dim=c(length(runs2),num.it))
for(i in runs2){
  res.mat2[which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan11_gpnn_ols_2_4_ext_map__jobid_",i,".csv")))[1:num.it]
}
leglab <- c(paste0("gpnn ols 1"),paste0("gpnn ols 2"))
#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='green',lwd=2, type = 'l',main = "Train Loss", ylab="sqrt(Loss)", xlab="iteration",ylim=c(0,200))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='orange',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("green",'orange'))

```

#13 Jan
Look at FI sim ext
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 500*3
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan12_gpnn_ols_2_4_extc8_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan11_gpnn_ols_2_4_ext_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- 1:20
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan12_gpnn_ols_2_4_extc12_loss__jobid_",i,".csv")))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("init param 0.8")
                             ,paste0("init param 1 (true)")
                             ,paste0("init param 1.2"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.05))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.05))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 
With grad
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 200*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_jan13_gpnn_grad_2_4_extc8_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_jan13_gpnn_grad_2_4_ext_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_jan13_gpnn_grad_2_4_extc12_loss__jobid_",i,".csv")))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("init param 0.8")
                             ,paste0("init param 1 (true)")
                             ,paste0("init param 1.2"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 


No info, vary lr
```{r}
#GPNN
num.it <-500*3
runs <- 1:20
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan12_gpnn_ols_2_2_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan11_gpnn_ols_2_4_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = 5e-2")
                             ,paste0("lr = 5e-4"), "GPR", "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=5.904118, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```

## Age
Look at the old GPNN with 2 GP, old vs new
```{r}
#GPNN
num.it <-100*4
runs <- c(1:5,12:14)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan12_gpnn_gp_2_2_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2,2)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in 1:2){
  res.mat2[,i,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan12_nnvwb2_loss__jobid_",8,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN with hidden-layer gradient updates")
                             ,paste0("GPNN with hidden-layer OLS"), "GPR", "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=5.904118, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```
This shows that it's entirely different


#14 Jan
Look at FI sim ext for long runs
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_jan14_gpnn_grad_2_4_extc8_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_jan14_gpnn_grad_2_4_ext_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_jan14_gpnn_grad_2_4_extc12_loss__jobid_",i,".csv")))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("init param 0.8")
                             ,paste0("init param 1 (true)")
                             ,paste0("init param 1.2"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.05))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.05))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 


#16 Jan

##Look at GPNN OLS in long run, no info
```{r}
#GPNN
num.it <-1500*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_2_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = 5e-1")
                             ,paste0("lr = 5e-2"), "GPR", "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=5.904118, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```
Look at r-squared
```{r}
#GPNN
num.it <-1500*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_1_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_2_rsq__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = 5e-1")
                             ,paste0("lr = 5e-2"), "GPR", "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=5.904118, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```

##knowing truth
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1500*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_4_extc8_loss__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_4_ext_loss__jobid_",i,".csv")))
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_4_extc12_loss__jobid_",i,".csv")))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("init param 0.8")
                             ,paste0("init param 1 (true)")
                             ,paste0("init param 1.2"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.1))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.1))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 
RSQ
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1500*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_4_extc8_rsq__jobid_",i,".csv")))
}
#Empirical bayes with 0.1 init var
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_4_ext_rsq__jobid_",i,".csv")))
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_4_extc12_rsq__jobid_",i,".csv")))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("init param 0.8")
                             ,paste0("init param 1 (true)")
                             ,paste0("init param 1.2"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(99.9,100))
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr3[2,],col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=res.iqr3[1,],col='green',lwd=0.5)
lines(x=1:num.it,y=res.iqr3[3,],col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(99.999,100))
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=res.iqr3[2,],col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr3[1,],col='green',lwd=0.5)
lines(x=1:num.it,y=res.iqr3[3,],col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange'))
``` 


##Simulated Response 
Look at mean and sd
```{r}
age <- read.csv('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan11_gen_gpnn_pred__jobid_1.csv')$V1
mean(age)
sd(age)
```

Look at the intercept of the gpnn ols model
```{r}
t.vec<- vector(mode='numeric')
for(i in 1:10){
  t.vec<- c(t.vec,read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_1_lbias__jobid_',i,'.csv'))$x)
}
summary(t.vec)
```
Intercept of guided
```{r}
t.vec<- vector(mode='numeric')
for(i in 1:10){
  t.vec<- c(t.vec,read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan14_gpnn_ols_2_4_extc8_lbias__jobid_',i,'.csv'))$x)
}
summary(t.vec)
```

#17 Jan

##Look at GPNN OLS in long run, no info
```{r}
#GPNN
num.it <-4000*3
runs <- 2:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan16_gpnn_ols_2_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:5,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan16_gpnn_ols_2_2_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = 5e-1")
                             ,paste0("lr = 5e-2"), "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=4535, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=4535, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','black'))
```
Look at r-squared
```{r}
#GPNN
num.it <-4000*3
runs <- 2:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan16_gpnn_ols_2_1_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:5,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan16_gpnn_ols_2_2_rsq__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = 5e-1")
                             ,paste0("lr = 5e-2"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=5.904118, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
```


##Age data and ridge
```{r}
#GPNN
num.it <-100*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan16_gpnn_ridge_2_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan16_gpnn_ridge_2_2_loss__jobid_",8,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN with hidden-layer gradient updates")
                             ,paste0("GPNN with hidden-layer OLS"), "GPR", "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=5.904118, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```


Plot altogether
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-100*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan10_gpnn_ols_2_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2,2)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in 1:2){
  res.mat2[,i,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan12_nnvwb2_loss__jobid_",8,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan16_gpnn_ridge_2_2_loss__jobid_",i,".csv")))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GP+OLS")
                             ,paste0("GP+GP")
                             ,paste0("GP+Ridge"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 

Look at the intercept of the gpnn ols model
```{r}
t.vec<- vector(mode='numeric')
for(i in 2:10){
  t.vec<- c(t.vec,read.csv(paste0('/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan16_gpnn_ols_2_1_lbias__jobid_',i,'.csv'))$x)
}
summary(t.vec)
```


#20 Jan

##Plot GPNN OLS extended
I think the job ran for too long and got killed

```{r}
#GPNN
num.it <-4000*3
runs <- 2:6
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan19_gpnn_ols_2_1_extendedJan16_loss__jobid_",i,".csv")))[,1:num.it]
 }

#define legends
leglab <- c(paste0("lr = 5e-1")
                             , "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=4535, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=4535, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'black'))
```



#21 Jan


##Assessing decreasing lr (backtracking)
Currently rerunning 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-100*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan10_gpnn_ols_2_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2,2)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in 1:2){
  res.mat2[,i,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan12_nnvwb2_loss__jobid_",8,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan16_gpnn_ridge_2_2_loss__jobid_",i,".csv")))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GP+OLS")
                             ,paste0("GP+GP")
                             ,paste0("GP+Ridge"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 


##Look at gpnn_ols+ridge
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-100*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan20_gpnn_ridgp_2_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan20_gpnn_ridgp_2_2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan20_gpnn_ridgp_2_3_loss__jobid_",i,".csv")))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GP+OLS")
                             ,paste0("GP+GP")
                             ,paste0("GP+Ridge"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 
It seems like high lr is doing well, investigate further

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-100*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan20_gpnn_ridgp_2_4_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2,2)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in 1:2){
  res.mat2[,i,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan12_nnvwb2_loss__jobid_",8,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan16_gpnn_ridge_2_2_loss__jobid_",i,".csv")))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GP+OLS")
                             ,paste0("GP+GP")
                             ,paste0("GP+Ridge"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 

Currently running
1. / age  jan21_gpnn_ridgp_2_08
2. / age jan21_gpnn_ridgp_2_04
3. // age jan20_gpnn_olslr_2_1 ran forever and got terminated FAILED
4. / sim fi jan21_gpnn_ols_2_1_extendedJan19
5. // gpnn_ridgphs FAILED 2 



#23 Jan

##Look at gpnn_ols+ridge
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-100*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan20_gpnn_ridgp_2_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(3:5,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan21_gpnn_ridgp_2_04_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1:7,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan21_gpnn_ridgp_2_08_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr=0.5")
                             ,paste0("lr=0.4")
                             ,paste0("lr=0.8"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- c(3:5,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan21_gpnn_ridgp_2_04_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1:7,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan21_gpnn_ridgp_2_08_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr=0.4")
                             ,paste0("lr=0.8"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
abline(v=400)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)
abline(v=400)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 
We can see that it's decreasing



##Sim fi age
```{r}
#GPNN
num.it <-4000*3
runs <- 9
res.mat <- array(,dim=c(2,2,num.it))
for(i in 1:2){
  res.mat[,i,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan21_gpnn_ols_2_1_extendedJan19_loss__jobid_",9,".csv")))[,1:num.it]
 }

#define legends
leglab <- c(paste0("lr = 5e-1")
                             , "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=4535, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=4535, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'black'))
```


#24 Jan

##Plot very long sim fi
Too difficult
```{r}
#GPNN
num.it <-4000*3*3
runs <- 2:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan16_gpnn_ols_2_1_loss__jobid_",i,".csv")))
    # as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan21_gpnn_ols_2_1_extendedJan19_loss__jobid_",9,".csv")))[,1:num.it]
}

#define legends
leglab <- c(paste0("lr = 5e-1")
                             , "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75),na.rm=TRUE)
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=4535, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75),na.rm=TRUE)
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=4535, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'black'))
```

Let's try just one successful run
```{r}
#GPNN
num.it <-4000*3*3
runs <- 9
res.mat <- array(,dim=c(2,2,num.it))
for(i in 1:2){
  res.mat[,i,] <- cbind(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan16_gpnn_ols_2_1_loss__jobid_",9,".csv"))),as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan19_gpnn_ols_2_1_extendedJan16_loss__jobid_",9,".csv"))),as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan21_gpnn_ols_2_1_extendedJan19_loss__jobid_",9,".csv"))))
 }

#define legends
leglab <- c(paste0("lr = 5e-1")
                             , "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim = c(1950,4535))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='red',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='red',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=4535, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim = c(1950,4535))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='red',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='red',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=4535, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'black'))
```


##Age

###Compare gpnn gp + ridge and gpnn ridge + gp
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-100*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan16_gpnn_ridge_2_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2,2)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in 1:2){
  res.mat2[,i,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan12_nnvwb2_loss__jobid_",8,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1:7,9)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan21_gpnn_ridgp_2_08_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN: GP+Ridge")
                             ,paste0("GPNN: GPs+GP")
                             ,paste0("GPNN: Ridge+GP"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```  
###Long run Age

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-(500+400)*4
runs <- c(3:5,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- cbind(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan21_gpnn_ridgp_2_04_loss__jobid_",i,".csv"))),as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan23_gpnn_ridgp_2_04_ext_loss__jobid_",9,".csv"))))
 }
#GPNN adj
runs2 <-c(1,3,6,7)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- cbind(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan21_gpnn_ridgp_2_08_loss__jobid_",i,".csv"))),as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan23_gpnn_ridgp_2_08_ext_loss__jobid_",i,".csv"))))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr=0.4")
                             ,paste0("lr=0.8"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
abline(v=400)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)
abline(v=400)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-(500+400)*4
runs <- c(3:5,8,9)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- cbind(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan21_gpnn_ridgp_2_04_rsq__jobid_",i,".csv"))),as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan23_gpnn_ridgp_2_04_ext_rsq__jobid_",9,".csv"))))
 }
#GPNN adj
runs2 <-c(1,3,6,7)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- cbind(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan21_gpnn_ridgp_2_08_rsq__jobid_",i,".csv"))),as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan23_gpnn_ridgp_2_08_ext_rsq__jobid_",i,".csv"))))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr=0.4")
                             ,paste0("lr=0.8"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
abline(v=400)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)
abline(v=400)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 


#26 Jan

Currently running
1.gpnn ols backtrack [FAILED] ran for TOO long, endless loop
2.neural net [not run...]
3. gpnn ridge lr5 [FAILED, always smthng wrong in fast_normal_lm]
4. gpnn ridge backtrack [running, failed]
5. //gpnn ridge 15 [80177350]
6. //gpnn ridge 099 [80178539]



#27 Jan
Running 
1. gpnn ridge backtrack (improved) 80220893 


#29 Jan
##Age Ridge different lr
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-2:6
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr15_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr=0.99")
                             ,paste0("lr=1.5"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
abline(v=400)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)
abline(v=400)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 
##Backtrack
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 500
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- t(tail(t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))),num.it))
 }
#GPNN adj
runs2 <- c(1:6,8:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- t(tail(t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_backtrack_loss__jobid_",i,".csv")))),num.it
                                        ))
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr=0.99")
                             ,paste0("lr=1.5"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
abline(v=400)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)
abline(v=400)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 
There is some error

#30 Jan
##Plotting BB learning rate
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan29_gpnn_bb_2_beta5_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr=0.99")
                             ,paste0("lr=BB"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 

##BB to see learning rate
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-100*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:9
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan30_gpnn_bb_2_beta5_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr=0.99")
                             ,paste0("lr=BB"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
abline(v=400)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)
abline(v=400)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 
Look at learning rate
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-100
runs <- 1:4
res.mat <- matrix(,nrow=length(runs),ncol= num.it)
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan30_gpnn_bb_2_beta5_lr__jobid_",i,".csv")))[1:num.it]
 }
plot(x=1:num.it,y=res.mat[1,],ylim=c(0,2),type='l',main = "BB Learning Rate", ylab="Learning Rate", xlab="epoch")
for(i in 2:(nrow(res.mat))){
  lines(x=1:num.it,y=res.mat[i,],col=i)
}
```

#31 Jan

##For BB plot 2 Y-axes
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-100*4
runs <- c(2,2)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in 1:2){
  res.mat[,i,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan30_gpnn_bb_2_beta5_loss__jobid_",runs[1],".csv")))[,1:num.it]
 }

#define legends
leglab <- c(paste0("GPNN lr=BB"),'Learning rate')
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
par(mar = c(5, 4, 4, 4) + 0.3) 
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,9))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)
abline(v=400)
par(new = TRUE)                             # Add new plot
lrvec <- rep(c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan30_gpnn_bb_2_beta5_lr__jobid_",runs[1],".csv")))$x,each = 4)
plot(x=1:num.it,y=lrvec,ylim=c(0,2),type='l',main = "", ylab="", xlab="",axes = FALSE,col='darkgreen')
axis(side = 4, at = pretty(range(0:2)))      # Add second axis
mtext("Learning Rate", side = 4, line = 3)             # Add second axis label
legend('topright',legend = leglab,lty=c(1),col=c("red",'darkgreen'))

``` 

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-100*4
runs <- c(2,2)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in 1:2){
  res.mat[,i,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan30_gpnn_bb_2_beta5_rsq__jobid_",runs[1],".csv")))[,1:num.it]
 }

#define legends
leglab <- c(paste0("GPNN lr=BB"),'Learning rate')
#Train
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
par(mar = c(5, 4, 4, 4) + 0.3) 
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R-Squared %", ylab="R-Squared %", xlab="iteration",ylim=c(0,90))
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(h=5.904118, lwd = 2)
# abline(v=400)
par(new = TRUE)                             # Add new plot
lrvec <- rep(c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan30_gpnn_bb_2_beta5_lr__jobid_",runs[1],".csv")))$x,each = 4)
plot(x=1:num.it,y=lrvec,ylim=c(0,2),type='l',main = "", ylab="", xlab="",axes = FALSE,col='darkgreen')
axis(side = 4, at = pretty(range(0:2)))      # Add second axis
mtext("Learning Rate", side = 4, line = 3)             # Add second axis label
legend('topright',legend = leglab,lty=c(1),col=c("red",'darkgreen'))

``` 




#1 Feb
##Backtracking
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-100*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan31_gpnn_ridgp_2_backtrack_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr=0.99")
                             ,paste0("lr=Backtrack"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
abline(v=400)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)
abline(v=400)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 


Currently running:
1. // Backtrack 500 80361577
2. // `feb1_gpnn_ols_2_lr5` 80362802
3. // `gpnn_bbs` 80362786 [failed, error exploded]
4. // `gpnn_bb` 80362798
5. // `gpnn_bb_cap` 80362884
6. / `gpnn_bbs` 80362897 
7. //`gpnn_ridgp_ridge` 80362923, only 099 was made feb2_gpnn_ridgpridge_2_lr099.... need lr5 too
8. // gpnngen_gpnn_ols_bb 80363448 [done]
9. // gpnn_bb_hs 80363580

#2 Feb
`BB smoothing` failed, look at the
```{r}
lrvec<- c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan30_gpnn_bb_2_beta5_lr__jobid_",2,".csv")))$x
```
phi
```{r}
phi <- function(k){(k+1)}
```
bb smoothing
```{r}
lr.vec <- vector(mode='numeric')
for(e in 2:99){
  lr.vec <- c(lr.vec,prod(lrvec[3:(e+1)]*phi(2:e))^(1/(e-1))/phi(e))
}
```

#3 Feb
##SIM GPNN
gpnngen_gpnn_ols_bb

```{r}
#GPNN
num.it <-1000*3
runs <- 2:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_jan16_gpnn_ols_2_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/sim_feb2_gpnn_ols_2_bb_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = 5e-1")
                             ,paste0("lr = bb"), "Response sd")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(1000,3900))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=4535, lwd = 2)

legend('right',legend = leglab,lty=c(1),col=c("red",'blue','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1000,3900))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
abline(h=4535, lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','black'))
```

##Look at high learning rate of gpnn_ols
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan10_gpnn_ols_2_1_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2,2)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in 1:2){
  res.mat2[,i,] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb1_gpnn_ols_2_lr5_loss__jobid_",8,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GP+OLS_lr=0.5")
                             ,paste0("GP+OLS_lr=5"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','black'))
``` 
No differences whatsoever


##Backtracking
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb1_gpnn_ridgp_2_backtrack_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr=0.99")
                             ,paste0("lr=Backtrack"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(3,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 
We can see that backtracking works, but very slow.


##BB and BB cap

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb1_gpnn_bb_2_beta5_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2:8,10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb2_gpnn_bb_2_beta5_cap_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = 0.99")
                             ,paste0("lr = BB")
                             ,paste0("lr = BB Cap"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,11))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```  
We can see that CAP slows BB down by a lot, but way more stable and is faster than fixing lr

###Observe lr of cap
Cap at 10
Look at learning rate
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-400
runs <- c(2:8,10)
res.mat <- matrix(,nrow=length(runs),ncol= num.it)
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb2_gpnn_bb_2_beta5_cap_lr__jobid_",i,".csv")))[1:num.it]
 }

summary(c(res.mat[1,]))
```

##BB and BB with HS weight variance
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb1_gpnn_bb_2_beta5_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1:2,8:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb2_gpnn_bb_hs_beta5_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = 0.99")
                             ,paste0("lr = BB")
                             ,paste0("lr = BB, Horseshoe hypervar"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,15))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,15))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```  
Somehow HS isn't working.... gotta look at the distribution of weights
###Weights
BB
```{r}
#First layer
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_feb1_gpnn_bb_2_beta5_weights_',"_jobid_",8,'.feather')))
bias<- as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/pile/re_feb1_gpnn_bb_2_beta5_bias__jobid_8.csv')))
#First-layer theta
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = paste0('Region',1:12)
            )
# First-layer bias
data.frame( Value = bias,row.names = paste0('Region',1:12))
```
Exploded

BB HS
```{r}
#First layer
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_feb2_gpnn_bb_hs_beta5_weights_',"_jobid_",8,'.feather')))
bias<- as.vector(unlist(read.csv( '/well/nichols/users/qcv214/bnn2/res3/pile/re_feb2_gpnn_bb_hs_beta5_bias__jobid_8.csv')))
#First-layer theta
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = paste0('Region',1:12)
            )
# First-layer bias
data.frame( Value = bias,row.names = paste0('Region',1:12))
```
The two methods have complete opposite behaviours
BB: Huge biases, medium weights
BB HS: tiny biases, huge weights


##GPNN Ridge+GP using Ridge with High lr
lr0.99
Not so different between ridge and normal prior
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(2:8,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb2_gpnn_ridgpridge_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr=0.99")
                             ,paste0("lr=Backtrack"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
abline(v=400)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)
abline(v=400)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 


Currently running 
1. // gpnn ridge+gp_ridge lr 5 `80378495` [Failed]
2. bbs 80378598



#6 Feb
##BB with smoothing
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-400*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb1_gpnn_bb_2_beta5_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:7
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb5_gpnn_bbs_2_beta5_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = 0.99")
                             ,paste0("lr = BB")
                             ,paste0("lr = BB, Horseshoe hypervar"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```  

Look at lr and pre lr
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-400
lrvec <- c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb5_gpnn_bbs_2_beta5_lr__jobid_",runs[1],".csv")))$x
#define legends
leglab <- c(paste0("Smoothed learning rate"),'Pre-Smoothing learning rate')
#Train
par(mar = c(5, 4, 4, 4) + 0.3) 
plot(x =1:num.it,y=lrvec,col='red',lwd=2, type = 'l',main = "Smoothed vs Pre-smoothing LR", ylab="Smoothed LR", xlab="Epoch",ylim=c(0,1.1))

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
par(new = TRUE)                             # Add new plot
prelrvec <- c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb5_gpnn_bbs_2_beta5_prelr__jobid_",runs[1],".csv")))$x
plot(x=1:num.it,y=prelrvec,ylim=c(0,10),type='l',main = "", ylab="", xlab="",axes = FALSE,col='darkgreen')
axis(side = 4, at = pretty(range(0:10)))      # Add second axis
mtext("Pre-Smoothing LR", side = 4, line = 3)             # Add second axis label
legend('topright',legend = leglab,lty=c(1),col=c("red",'darkgreen'))

``` 




#7 Feb

##Look at the error in high lr
Run 1: Error: from glmnet Fortran code (error code 7777); All used predictors have zero variance
Run 2: need at least two non-NA values to interpolate
Run 10: Error in intI(j, n = x@Dim[2], dn[[2]], give.dn = FALSE) :'NA' indices are not (yet?) supported for sparse Matrices Calls: cv.glmnet ... NextMethod -> predict.glmnet -> [ -> [ -> subCsp_cols -> intI

Run 1
```{r}
#First layer
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_feb6_gpnn_ridgpridge_2_lr5_weights_',"_jobid_",1,'.feather')))
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = paste0('Region',1:12)
            )
```
It's not the weight that is crashing, it's the ReLU.

Look at ReLU
```{r}
#First layer
theta.matrix <- t(as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_feb6_gpnn_ridgpridge_2_lr5_hneurons_',"_jobid_",2,'.feather'))))
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = paste0('Region',1:12)
            )
```


##Short run BB IG
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-200*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb1_gpnn_bb_2_beta5_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb6_gpnn_bb_ig_beta5_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = 0.99")
                             ,paste0("lr = BB")
                             ,paste0("lr = BB IG"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```  

Running
1. // 80422138 BBIG
2. // 80422183 BBIG INIT
3. //80422184 BB INIT



#9 Feb
##BB IG
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_jan26_gpnn_ridgp_2_lr099_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:20
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_2_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:20
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = 0.99")
                             ,paste0("lr = BB")
                             ,paste0("lr = BB IG"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```  


##Plot minimum rmse across runs
```{r}
runs <- 1:20
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_2_beta5_init_minloss__jobid_",i,".csv"))$x)
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_minloss__jobid_",i,".csv"))$x)
}
runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

plot(x=runs, y= sqrt(res1), col='blue',lwd=2, type = 'b',main = "Minimum Test RMSE across 2,000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
lines(x = runs,y=sqrt(res2),col='darkgreen',lwd=2, type = 'b')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('BB','BB IG','GPR', 'response sd'),lty=c(1),col=c('blue','darkgreen','magenta','black'))
```
Virtually, they are all same
I will arbitrarily pick run 2 for both methods, then they'd have the same initialisation



Currently running
1 feb9_gpnn_bb_init_ext_bbs 80423519
2 feb9_gpnn_bb_init_ext_cap 80423520
3 / feb9_gpnn_bb_ig_init_ext_bbs 80423533
4 / feb9_gpnn_bb_ig_init_ext_cap 80423534
5 feb9_gpnn_bb_ig_beta5_init 80423725


#10 feb

##For Extended bbs and bb cap

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_2_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10 #c(1:3,5:9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_init_ext_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1:5,7:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_init_ext_cap_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB")
                             ,paste0("minBB+ BBS")
                             ,paste0("minBB+ BB Cap"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,11))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```  

##Plot minimum rmse across runs
New IG, everything same apart from param saving   
```{r}
runs <- c(2,4,7,8,9,10,11)
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_2_beta5_init_minloss__jobid_",i,".csv"))$x)
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_minloss__jobid_",i,".csv"))$x)
}
runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

plot(x=runs, y= sqrt(res1), col='red',lwd=2, type = 'b',main = "Min Test RMSE", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
lines(x = runs,y=sqrt(res2),col='blue',lwd=2, type = 'b')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   

```
Currently running
1 //feb10_gpnn_bb_ig_init_ext_bbs 80426633
2 //feb10_gpnn_bb_ig_init_ext_cap 80426632
3 // feb10_gpnn_bb_ext_backtrack 80426915

#12 Feb
##BB IG Ext
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb10_gpnn_bb_ig_init_ext_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb10_gpnn_bb_ig_init_ext_cap_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("BB IG+BBS")
                             ,paste0("BB IG+Cap"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,12))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```  
Blue actually works

plot just blue 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb10_gpnn_bb_ig_init_ext_bbs_loss__jobid_",i,".csv")))[,1:num.it]
 }

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = IG+BBS"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta','black'))
```  

##BBB Backtrack
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_2_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb10_gpnn_bb_ext_backtrack_loss__jobid_",i,".csv")))[,1:num.it]
}


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = BB"),paste0("lr = BB+Backtrack"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```  

Plot
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb10_gpnn_bb_ext_backtrack_loss__jobid_",i,".csv")))[,1:num.it]
}


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = BB+Backtrack"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='blue',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='blue',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'magenta','black'))
```  
Plot loss
```{r}
#GPNN
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb10_gpnn_bb_ext_backtrack_map__jobid_",i,".csv")))
 }
leglab <- c(paste0("BB+Backtrack"))
#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='blue',lwd=2, type = 'l',main = "Training Loss", ylab="Loss", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("blue",'orange'))

```

##Finding proportions of rmse below gpr

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_2_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
}
runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))


#Count how many held-out rmse is better 
##Check at 1500-2000 iteration
sum(sqrt(apply(res.mat[2,,1500:2000], 1, FUN = min))<hs.test[2])*100/length(runs)
```
This shows that 7 out of 10 runs of bb get held-out rmse lower than horseshoe


##FI
###Old code
dec6_gpnnlin_v6lr11_long
and
dec7_gpnnlin_nhp_v6lr11
```{r}
#GPNN
num.it <-1000*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_long_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:5,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec7_gpnnlin_nhp_v6lr11_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("with priors")
                             ,paste0("without priors"), "GPR")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2.07,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(1.95,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta'))
```



Currently running
FI bb 80452505
FI bb IG 80452506

FI bb 600 80461709
FI bb IG 600 80461710

#13 FEb

##FI
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-600*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec6_gpnnlin_v6lr11_long_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_feb12_gpnn_bb_2_beta5_init_600_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_feb9_gpnn_bb_ig_beta5_init_600_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("fixed lr, GP + OLS")
                             ,paste0("lr = BB")
                             ,paste0("lr = BB IG"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(2,4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=2.084393, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,4))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=2.049224, lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```  

Loss
```{r}
#GPNN
num.it <-600*3
runs <- 1:10
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_feb12_gpnn_bb_2_beta5_init_600_map__jobid_",i,".csv")))[1:num.it]
 }
runs2 <- 1:10
res.mat2 <- array(,dim=c(length(runs2),num.it))
for(i in runs2){
  res.mat2[which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_feb9_gpnn_bb_ig_beta5_init_600_map__jobid_",i,".csv")))[1:num.it]
}
leglab <- c(paste0("lr = BB"),paste0("lr = BB IG"))
#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Training Loss", ylab="sqrt(Loss)", xlab="iteration",ylim=c(2600,2800))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
```

R^2
```{r}
#GPNN
num.it <-600*3
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_feb12_gpnn_bb_2_beta5_init_600_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_feb9_gpnn_bb_ig_beta5_init_600_rsq__jobid_",i,".csv")))[,1:num.it]
}

# runs.hs <- c(1,2,4:10)
# hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
# for(i in runs.hs){
#   hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
# }
# hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
# hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("lr = BB")
                             ,paste0("lr = BB IG"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Test R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=1, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
# abline(v=3*1:100,lwd=0.2)
# abline(h=hs.test[2], col='magenta',lwd=2)
# abline(h=hs.test[1], col='magenta',lwd=0.5)
# abline(h=hs.test[3], col='magenta',lwd=0.5)
# abline(h=6.035854, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R^2", ylab="R^2", xlab="iteration")
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=res.iqr[3,],col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=res.iqr2[2,],col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=res.iqr2[1,],col='lightblue',lwd=0.5)
lines(x=1:num.it,y=res.iqr2[3,],col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# abline(v=3*1:100,lwd=0.2)
# abline(h=hs.train[2], col='magenta',lwd=2)
# abline(h=hs.train[1], col='magenta',lwd=0.5)
# abline(h=hs.train[3], col='magenta',lwd=0.5)
# abline(h=5.904118, lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue'))
```

##Plot minimum rmse across runs
```{r}
runs <- 1:10
res1 <- vector(mode = 'numeric')
res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_feb12_gpnn_bb_2_beta5_init_600_minloss__jobid_",i,".csv"))$x)
  res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_feb9_gpnn_bb_ig_beta5_init_600_minloss__jobid_",i,".csv"))$x)
}
runs.hs <- 1:10
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/fi/pile/re_dec12_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

plot(x=runs, y= sqrt(res1), col='blue',lwd=2, type = 'b',main = "Minimum Test RMSE across 2,000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(1,3))
lines(x = runs,y=sqrt(res2),col='darkgreen',lwd=2, type = 'b')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=2.084393, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('BB','BB IG','GPR', 'response sd'),lty=c(1),col=c('blue','darkgreen','magenta','black'))
```


#15 Feb

Currently running
//feb15_sgld_bb_ig_bbs `80543987`
- will save predictions of last 100 epochs. Will save mean parameters of last 100 epochs. Will save the trajectories of alphas and betas.
//feb15_sgld_bb_ig_bbs_burnin `80544051`
- seems like need burnin because the first few iterations, bb lr is too high


#16 Feb

##Plot SGLD
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-250*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb15_sgld_bb_ig_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb15_sgld_bb_ig_bbs_burnin_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:BB IG+BBS")
                             ,paste0("SGLDLBB IG+BBS Burnin"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,12))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 





Running
//feb16_sgld_bb_ig_bbs_burnin_test => I think from inspection, burn in is too early, even at 250 epoch, smoothed lr is still 0.004
In fact, even at 500 epoch, smoothed lr is 0.002 which is too high
//feb10_gpnn_bb_ig_init_ext_bbs_test 80545671

SCARPPED everything, spotted a mistake of mistakening assigning initial Noise to non zero

//feb16_sgld_bb_ig_bbs_burnin 80545693

#17 Feb

Running 
// feb17_sgld_bb_ig_bbs_burnin 80547087

#18 Feb
##Plot SGLD
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-250*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb15_sgld_bb_ig_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb17_sgld_bb_ig_bbs_burnin_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:BB IG+BBS")
                             ,paste0("SGLDLBB IG+BBS Burnin"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,12))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 


Currently running

// feb18_sgld_bb_ig_bbs_cap_burnin 80547389

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-250*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb15_sgld_bb_ig_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb18_sgld_bb_ig_bbs_cap_burnin_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:BB IG+BBS")
                             ,paste0("SGLDLBB IG+BBS Burnin"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,12))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 


Currently running
feb19_sgld_bb_ig_bbs_cap_burnin_1e-7 80547450
feb19_sgld_bb_ig_bbs_cap_burnin_1e-9 80547451
feb19_sgld_bb_ig_bbs_cap_burnin_1e-11 80547434
feb19_sgld_bb_ig_bbs_cap_burnin_1e-13 80547435

#20 Feb

##Plot SGLD
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-250*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb15_sgld_bb_ig_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb19_sgld_bb_ig_bbs_cap_burnin_1e-13_loss__jobid_",i,".csv")))[,1:num.it]
}
# HSP


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:BB IG+BBS")
                             ,paste0("SGLDLBB IG+BBS Burnin"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,12))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 

Plotting 4 things
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-250*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb15_sgld_bb_ig_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb19_sgld_bb_ig_bbs_cap_burnin_1e-9_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb19_sgld_bb_ig_bbs_cap_burnin_1e-11_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:BB IG+BBS")
                             ,paste0("SGLD:BB IG+capBBS Burnin lr1e-9"), 'SGLD:BB IG+capBBS Burnin lr1e-11','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,11))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,14))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
``` 

Look at the learning rate
BBS never kicked in

###Load summary of the parameters

####bb
```{r}
#First layer
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_weights_',"_jobid_",1,'.feather')))
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = paste0('Region',1:12)
            )
```

####lr1e-9
```{r}
#First layer
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_feb19_sgld_bb_ig_bbs_cap_burnin_1e-9_meanweights_',"_jobid_",1,'.feather')))
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = paste0('Region',1:12)
            )
```
####lr1e-9

```{r}
#First layer
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_feb19_sgld_bb_ig_bbs_cap_burnin_1e-11_meanweights_',"_jobid_",1,'.feather')))
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = paste0('Region',1:12)
            )
```




#22 Feb
From 12 Feb `re_feb10_gpnn_bb_ig_init_ext_bbs` did its best 
Maybe I should run from that, but held-in rmse is already 0

From the YW paper, maybe I should plot the trajectory of my variances of my theta gradients. Perhaps mean of regional variances. CAN'T DO THAT YET..




Currently running
feb22_sgld_bb_ig 80620076 => 1e9

feb22_sgld_bb_ig_e7 80620350
feb22_sgld_bb_ig_e8 80620931

feb22_sgld_bb_ig_e10
feb22_sgld_bb_ig_e11


#23 Feb
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-150*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb22_sgld_bb_ig_e7_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb22_sgld_bb_ig_e8_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb22_sgld_bb_ig_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:BB IG+BBS")
                             ,paste0("SGLD:BB IG+capBBS Burnin lr1e-9"), 'SGLD:BB IG+capBBS Burnin lr1e-11','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,11))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,14))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
``` 

#23 Feb
e8,e10,e11
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-150*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb22_sgld_bb_ig_e8_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,4:6,8:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb22_sgld_bb_ig_e10_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1,3,9,10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb22_sgld_bb_ig_e11_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:b=1e8")
                             ,paste0("SGLD:b=1e10"), 'SGLD:b=1e11','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,11))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
``` 
Running feb22_sgld_bb_ig_e13 and feb22_sgld_bb_ig_e12

#26 Feb
e11,e12,e13 =>no difference at all
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-150*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1,3,9,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb22_sgld_bb_ig_e11_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb22_sgld_bb_ig_e12_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb22_sgld_bb_ig_e13_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:BB IG+BBS")
                             ,paste0("SGLD:BB IG+capBBS Burnin lr1e-9"), 'SGLD:BB IG+capBBS Burnin lr1e-11','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,11))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,14))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
``` 

Wanna do declr SGLD on bb+bbs but that one doesn't have alphas and betas

#27 Feb
Currently running
//feb27_sgld_bb_ig_e11 80812062
feb27_gpnn_bb_ig_init_ext_bbs_test 80812063



#28 Feb
##Grad noise of feb27_sgld_bb_ig_e11
```{r}
#First layer
theta.matrix <- as.matrix(read.csv(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_sgld_bb_ig_e11_gradnoise_',"_jobid_",1,'.csv')))
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = c(paste0('Region',1:12),paste0('bias',1:12))
            )
```
Plot trajectory of these
```{r}
plot(x=1:150,y = theta.matrix[1,],col = 1,type='b')
lines(x=1:150,y = theta.matrix[2,],col = 2)
lines(x=1:150,y = theta.matrix[6,],col = 3)
lines(x=1:150,y = theta.matrix[7,],col = 4)
abline(h=1e-11,col='grey')

```
```{r}
plot(x=1:150,y = theta.matrix[1,],col = 1,type='l',ylab='Noise magnitude', xlab = 'iterations',main = 'Gradient noise vs Injected noise')
lines(x=1:150,y = theta.matrix[2,],col = 2)
lines(x=1:150,y = theta.matrix[6,],col = 3)
# lines(x=1:150,y = theta.matrix[7,],col = 4)
abline(h=1e-11,col='grey')
legend('topright',legend = c('Region 1','Region 2', 'Region 9','Injected noise'),lty=c(1),col=c("black",'red','green','grey'))
```

#2 Mar
##Plot bbs ext
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:4,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("BB IG + BBS IG"),'GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,10))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,12))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 
We can see that rmse has converged, perhaps look at loss too
Loss
```{r}
#GPNN
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb7_gpnn_bb_ig_beta5_init_map__jobid_",i,".csv")))[1:num.it]
 }
runs2 <- c(1:4,7:10)
res.mat2 <- array(,dim=c(length(runs2),num.it))
for(i in runs2){
  res.mat2[which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_map__jobid_",i,".csv")))[1:num.it]
}
leglab <- c(paste0("BB IG"),paste0("BB IG + BBS IG"))
#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Training Loss", ylab="sqrt(Loss)", xlab="iteration",ylim=c(3500,4000))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
```
```{r}
#GPNN
num.it <-500*3
runs <-  c(1:4,7:10)
res.mat <- array(,dim=c(length(runs),num.it))
for(i in runs){
  res.mat[which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_map__jobid_",i,".csv")))[1:num.it]
 }
leglab <- c(paste0("lr = BB"),paste0("lr = BB IG"))
#Test
res.iqr <- apply(res.mat, MARGIN = 2, FUN = quantile, probs= c(0,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Training Loss", ylab="sqrt(Loss)", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
```

loss has also converged

Currently running
//mar2_sgld_bbs_ig_e8  80923826
//mar2_sgld_bbs_ig_e10  80923825
//mar2_sgld_bbs_ig_e11  80923824
//mar2_sgld_bbs_ig_e12 80925614




#6 Mar
##BBS SGLD Dec lr
e8,e10,e11
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e8_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e10_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e11_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:b=1e8")
                             ,paste0("SGLD:b=1e10"), 'SGLD:b=1e11','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,11))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta'))
``` 

e10,e11,e12
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e10_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e11_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e12_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:b=1e10")
                             ,paste0("SGLD:b=1e11"), 'SGLD:b=1e12','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 
##Grad noise of re_mar2_sgld_bbs_ig_e12
```{r}
#First layer
theta.matrix <- as.matrix(read.csv(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e12_gradnoise_',"_jobid_",1,'.csv')))
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = c(paste0('Region',1:12),paste0('bias',1:12))
            )
```
Plot trajectory of these
```{r}
plot(x=1:300,y = theta.matrix[1,],col = 1,type='l',ylim=c(0,1e-11),ylab='Noise magnitude', xlab = 'iterations',main = 'Gradient noise vs Injected noise')
lines(x=1:300,y = theta.matrix[2,],col = 2)
lines(x=1:300,y = theta.matrix[9,],col = 3)
# lines(x=1:150,y = theta.matrix[7,],col = 4)
abline(h=1e-12,col='grey')
legend('right',legend = c('Region 1','Region 2', 'Region 9','Injected noise'),lty=c(1),col=c("black",'red','green','grey'))

```

##Grad noise of re_mar2_sgld_bbs_ig_e11
```{r}
#First layer
theta.matrix <- as.matrix(read.csv(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e11_gradnoise_',"_jobid_",1,'.csv')))
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = c(paste0('Region',1:12),paste0('bias',1:12))
            )
```
##Grad noise of re_mar2_sgld_bbs_ig_e10
```{r}
#First layer
theta.matrix <- as.matrix(read.csv(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e10_gradnoise_',"_jobid_",1,'.csv')))
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = c(paste0('Region',1:12),paste0('bias',1:12))
            )
```
Plot trajectory of these
```{r}
plot(x=1:300,y = theta.matrix[1,],col = 1,type='l',ylim=c(0,1e-9),ylab='Noise magnitude', xlab = 'iterations',main = 'Gradient noise vs Injected noise')
lines(x=1:300,y = theta.matrix[2,],col = 2)
lines(x=1:300,y = theta.matrix[9,],col = 3)
# lines(x=1:150,y = theta.matrix[7,],col = 4)
abline(h=1e-10,col='grey')
legend('right',legend = c('Region 1','Region 2', 'Region 9','Injected noise'),lty=c(1),col=c("black",'red','green','grey'))

```



Currently running
1. //mar2_sgld_bbs_ig_e13  80934881
2. //mar2_sgld_bbs_ig_e14  80934883
3. //mar2_sgld_bbs_ig_e15  80934885


#7 Mar
e13,e14,e15
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e13_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e14_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 2:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e15_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:b=1e13")
                             ,paste0("SGLD:b=1e14"), 'SGLD:b=1e15','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 

##Grad noise of re_mar2_sgld_bbs_ig_e14
```{r}
#First layer
theta.matrix <- as.matrix(read.csv(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e14_gradnoise_',"_jobid_",1,'.csv')))
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = c(paste0('Region',1:12),paste0('bias',1:12))
            )
```
Plot trajectory of these
```{r}
plot(x=1:300,y = theta.matrix[1,],col = 1,type='l',ylim=c(0,1e-13),ylab='Noise magnitude', xlab = 'iterations',main = 'Gradient noise vs Injected noise')
lines(x=1:300,y = theta.matrix[2,],col = 2)
lines(x=1:300,y = theta.matrix[9,],col = 3)
# lines(x=1:150,y = theta.matrix[7,],col = 4)
abline(h=1e-14,col='grey')
legend('right',legend = c('Region 1','Region 2', 'Region 9','Injected noise'),lty=c(1),col=c("black",'red','green','grey'))

```


##Grad noise of re_mar2_sgld_bbs_ig_e15
```{r}
#First layer
theta.matrix <- as.matrix(read.csv(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e15_gradnoise_',"_jobid_",2,'.csv')))
data.frame( Mean =rowMeans(theta.matrix), 
            Var = apply(theta.matrix,1,var),
            Min = apply(theta.matrix,1,min),
            Max = apply(theta.matrix,1,max),
            row.names = c(paste0('Region',1:12),paste0('bias',1:12))
            )
```
Plot trajectory of these
```{r}
plot(x=1:300,y = theta.matrix[1,],col = 1,type='l',ylim=c(0,1e-13),ylab='Noise magnitude', xlab = 'iterations',main = 'Gradient noise vs Injected noise')
lines(x=1:300,y = theta.matrix[2,],col = 2)
lines(x=1:300,y = theta.matrix[9,],col = 3)
# lines(x=1:150,y = theta.matrix[7,],col = 4)
abline(h=1e-14,col='grey')
legend('right',legend = c('Region 1','Region 2', 'Region 9','Injected noise'),lty=c(1),col=c("black",'red','green','grey'))

```

##Use this
e10,e12,e15
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e10_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e12_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 2:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e15_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:b=1e10")
                             ,paste0("SGLD:b=1e12"), 'SGLD:b=1e15','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e13_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e12_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 2:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e11_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=1e13")
                             ,paste0("SGLD:b=1e12"), 'SGLD:b=1e11','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.6))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
```


Currently running
mar7_sgld_bbs_ig_a12_b2 81054356
mar7_sgld_bbs_ig_a13_b2 81054355
mar7_sgld_bbs_ig_a14_b2 81054354
mar7_sgld_bbs_ig_a14_b1 81054353
mar7_sgld_bbs_ig_a15_b1 81054352
mar7_sgld_bbs_ig_a16_b1 81054351



#8 Mar

##Define lr function
```{r}
lrdec <- function(start.a,start.b,start.gamma,x){start.a*(start.b+x)^(-start.gamma)}
```

## for b = 1e1
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1:7,9:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a14_b1_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1:2,4:8,10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a15_b1_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a16_b1_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=10, a=1e-14")
                             ,paste0("SGLD:b=10, a=1e-15"), 'SGLD:b=10, a=1e-16','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.58))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.05))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 
Plot
```{r}
plot(x=1:500, lrdec(1e-14,10,.55,1:500),type='l',ylim=c(1e-18,1e-15))
lines(x=1:500, lrdec(1e-15,10,.55,1:500),col = 'red')
lines(x=1:500, lrdec(1e-16,10,.55,1:500),col = 'blue')
```


## for b = 1e2
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(1:3,5:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a12_b2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1:4,6:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a13_b2_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1,3:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a14_b2_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=100, a=1e-12")
                             ,paste0("SGLD:b=100, a=1e-13"), 'SGLD:b=100, a=1e-14','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.58))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.05))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 

Plot
```{r}
plot(x=1:500, lrdec(1e-12,100,.55,1:500),type='l',ylim=c(1e-18,1e-13))
lines(x=1:500, lrdec(1e-13,100,.55,1:500),col = 'red')
lines(x=1:500, lrdec(1e-14,100,.55,1:500),col = 'blue')
```
Plot
```{r}
plot(x=1:500, log(lrdec(1e-12,100,.55,1:500)),type='l', ylim = c(-36,-30))
lines(x=1:500, log(lrdec(1e-13,100,.55,1:500)),col = 'red')
lines(x=1:500, log(lrdec(1e-14,100,.55,1:500)),col = 'blue')
```


Plot the orioginal decreasing lr
```{r}
plot(x=1:500, lrdec(1,1e13,1,1:500),type='l',ylim=c(1e-15,1e-13))
lines(x=1:500, lrdec(1,1e14,1,1:500),col = 'red')
lines(x=1:500, lrdec(1,1e15,1,1:500),col = 'blue')
```



#13 mar
Re-plotting the old dec lr function with e13,e14,e15
e10,e12,e15
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e13_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e14_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 2:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e15_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=1e13")
                             ,paste0("SGLD:b=1e14"), 'SGLD:b=1e15','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.5,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,6.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e13_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e14_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 2:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e15_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=1e13")
                             ,paste0("SGLD:b=1e14"), 'SGLD:b=1e15','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.58))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.05))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 

##Plot all lr
on log10 scale

'blue','darkgreen','orange'

```{r}
plot(x=1:500, log10(lrdec(1,1e13,1,1:500)),type='l',ylim=c(-17.5,-13),col = 'blue',ylab = 'log10',xlab='epochs')
lines(x=1:500, log10(lrdec(1,1e14,1,1:500)),col = 'blue')
lines(x=1:500, log10(lrdec(1,1e15,1,1:500)),col = 'blue')
lines(x=1:500, log10(lrdec(1e-14,10,.55,1:500)),col='orange')
lines(x=1:500, log10(lrdec(1e-15,10,.55,1:500)),col = 'orange')
lines(x=1:500, log10(lrdec(1e-16,10,.55,1:500)),col = 'orange')
lines(x=1:500, log10(lrdec(1e-12,100,.55,1:500)),col='darkgreen')
lines(x=1:500, log10(lrdec(1e-13,100,.55,1:500)),col = 'darkgreen')
lines(x=1:500, log10(lrdec(1e-14,100,.55,1:500)),col = 'darkgreen')
legend('bottomright',legend = c("SGLD:b=variable, a=1, gamma=1","SGLD:b=100, a=variable, gamma=0.55", 'SGLD:b=10, a=variable, gamma=0.55'),lty=c(1),col=c('blue','darkgreen','orange'))
```


##Let's look at top two pair
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e13_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a12_b2_loss__jobid_",i,".csv")))[,1:num.it]
} 


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=1e13, a=1, gamma=1")
                             ,paste0("SGLD:b=100, a=1e-12, gamma=0.55"))

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.58))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.05))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('right',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 



##Let's look at bottom pair
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-2:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e15_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,3:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a14_b2_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1:7,9:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a14_b1_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:b=1e15, a=1, gamma=1")
                             ,paste0("SGLD:b=100, a=1e-14, gamma=0.55"), 'SGLD:b=10, a=1e-14, gamma=0.55')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.58))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.05))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 



##Look at more lr to use
###b=13
```{r}
plot(x=1:1200, log10(lrdec(1,1e11,1,1:1200)),type='l',ylim=c(-17.5,-10),col = 'blue',ylab = 'log10',xlab='epochs')
lines(x=1:1200, log10(lrdec(1,1e12,1,1:1200)),col = 'blue')
lines(x=1:1200, log10(lrdec(1,1e13,1,1:1200)),col = 'blue')
lines(x=1:1200, log10(lrdec(1e-9,10,.55,1:1200)),col='orange')
lines(x=1:1200, log10(lrdec(1e-10,10,.55,1:1200)),col = 'orange')
lines(x=1:1200, log10(lrdec(1e-11,10,.55,1:1200)),col = 'orange')
lines(x=1:1200, log10(lrdec(1e-12,10,.55,1:1200)),col = 'orange')
lines(x=1:1200, log10(lrdec(1e-9,100,.55,1:1200)),col='darkgreen')
lines(x=1:1200, log10(lrdec(1e-10,100,.55,1:1200)),col = 'darkgreen')
lines(x=1:1200, log10(lrdec(1e-11,100,.55,1:1200)),col = 'darkgreen')
lines(x=1:1200, log10(lrdec(1e-12,100,.55,1:1200)),col = 'darkgreen')
legend('bottomright',legend = c("SGLD:b=variable, a=1, gamma=1","SGLD:b=100, a=variable, gamma=0.55", 'SGLD:b=10, a=variable, gamma=0.55'),lty=c(1),col=c('blue','darkgreen','orange'))
```


mar13_sgld_bbs_ig_a9_b2 81162992
mar13_sgld_bbs_ig_a10_b2 81162993
mar13_sgld_bbs_ig_a11_b2 81162994
mar13_sgld_bbs_ig_a9_b1 81162995
mar13_sgld_bbs_ig_a10_b1 81162997 
mar13_sgld_bbs_ig_a11_b1 81162998
mar13_sgld_bbs_ig_a12_b1 81168462

#Mar 14
Plot b = 2, a = 1e9,1e10,1e11
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a9_b2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a10_b2_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a11_b2_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=100, a=1e-12")
                             ,paste0("SGLD:b=100, a=1e-13"), 'SGLD:b=100, a=1e-14','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.58))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.05))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a10_b2_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a11_b2_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a12_b2_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=100, a=1e-9")
                             ,paste0("SGLD:b=100, a=1e-10"), 'SGLD:b=100, a=1e-11','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.6))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 

#Plotting b=10,
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:5,7:10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a9_b1_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a10_b1_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1:6,8:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a11_b1_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=100, a=1e-9")
                             ,paste0("SGLD:b=100, a=1e-10"), 'SGLD:b=100, a=1e-11','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.56,4.7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,1))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 
Plot with e12
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a10_b1_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a11_b1_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1:4,6:7,9:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a12_b1_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=10, a=1e-10")
                             ,paste0("SGLD:b=10, a=1e-11"), 'SGLD:b=10, a=1e-12','GPR','Response sd')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.6))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 

##Only care about a = 1e10 onwards,
compare 

##Learning rate used
```{r}
plot(x=1:1200, log10(lrdec(1,1e11,1,1:1200)),type='l',ylim=c(-17.5,-10),col = 'blue',ylab = 'Learning rate (log10)',xlab='epochs')
lines(x=1:1200, log10(lrdec(1,1e12,1,1:1200)),col = 'blue')
lines(x=1:1200, log10(lrdec(1,1e13,1,1:1200)),col = 'blue')
lines(x=1:1200, log10(lrdec(1,1e15,1,1:1200)),col = 'blue')
lines(x=1:1200, log10(lrdec(1e-10,10,.55,1:1200)),col = 'orange')
lines(x=1:1200, log10(lrdec(1e-11,10,.55,1:1200)),col = 'orange')
lines(x=1:1200, log10(lrdec(1e-12,10,.55,1:1200)),col = 'orange')
lines(x=1:1200, log10(lrdec(1e-14,10,.55,1:1200)),col = 'orange')
lines(x=1:1200, log10(lrdec(1e-10,100,.55,1:1200)),col = 'darkgreen')
lines(x=1:1200, log10(lrdec(1e-11,100,.55,1:1200)),col = 'darkgreen')
lines(x=1:1200, log10(lrdec(1e-12,100,.55,1:1200)),col = 'darkgreen')
lines(x=1:1200, log10(lrdec(1e-14,100,.55,1:1200)),col = 'darkgreen')
legend('bottomleft',legend = c("SGLD:b=variable, a=1, gamma=1","SGLD:b=100, a=variable, gamma=0.55", 'SGLD:b=10, a=variable, gamma=0.55'),lty=c(1),col=c('blue','darkgreen','orange'))
```

##Case Too misleading
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-2:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e11_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a10_b2_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a10_b1_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=1e11, a=1, gamma=1")
                             ,paste0("SGLD:b=100, a=1e-9, gamma=0.55"), 'SGLD:b=10, a=1e-9, gamma=0.55')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.68))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,1))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 

##Case just right
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e12_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a11_b2_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:10
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar13_sgld_bbs_ig_a11_b1_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=1e12, a=1, gamma=1")
                             ,paste0("SGLD:b=100, a=1e-11, gamma=0.55"), 'SGLD:b=10, a=1e-11, gamma=0.55')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.585))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.5))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 
##Case Too weak
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-300*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-2:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar2_sgld_bbs_ig_e15_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(1,3:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a14_b2_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- c(1:7,9:10)
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar7_sgld_bbs_ig_a14_b1_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("BB IG")
                             ,paste0("SGLD:b=1e15, a=1, gamma=1")
                             ,paste0("SGLD:b=100, a=1e-14, gamma=0.55"), 'SGLD:b=10, a=1e-14, gamma=0.55')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,4.58))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,0.05))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 



##b = 100
Not work, fine work

#16 Mar
Currently running
//mar17_mala_weights_lr5  81213552
//mar17_mala_weights_lr0005 81213690
//mar17_mala_weights_lr0000005 81213691

#18 Mar
Observation: lr5 and 5e-4 have accept rate = 0 due to difference in posterior (ratio = 0)
lr5e-7 have 97% acceptance ratio
What is the correct way tho?

I will try amending the transition probaiblity part, currently ratio is always 1 ====> I don't think using the new q is right, scaling term shouldn't be the same

Re-scaling gradient by factor of n
mar18_mala_weights_n_lr5e1 81217575
mar18_mala_weights_n_lr5e4 81217573
mar18_mala_weights_n_lr5e7 81217572

Changing q
mar18_mala_weights_q_lr5e1 81217717
mar18_mala_weights_q_lr5e4 81217715
mar18_mala_weights_q_lr5e7 81217716


#20 Mar

Let's look at the acceptance rate,

## the base mala weights
###lr = 5e-7
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar17_mala_weights_lr0000005_acceptedweights__jobid_',2,'.feather'))[,1])
sum(unique(theta.matrix)!=100)
```
This means 97% accepted


Fixed posterior and gradients
Currently running 
// mar20_mala_weights_q_lr5e2 81290583 ==> lr too high, accpet rate ~ 0.001
// mar20_mala_weights_q_lr5e3 81290600 => accept rate ~0.999, rmse ~ 7
// mar20_mala_weights_q_lr5e4 81290585 => accept rate ~0.999, rmse go to 7 in 1 iteration, 
// mar20_mala_weights_q_lr5e5 81290601
// mar20_mala_weights_q_lr5e6 81290596
// mar20_mala_weights_q_lr5e8 81290597
// mar20_mala_weights_q_lr5e10 81290599 Lets focus on this 

// mar20_mala_weights_q_lr8e3 81292352 
// mar20_mala_weights_q_lr9e3 81292736 
// mar20_mala_weights_q_lr1e2 81292737
// mar20_mala_weights_q_lr2e2 81292355 

All of these updates seem to be updating the other way...

ACTUALLY MALA AND SGLD are principally the same


// mar20_mala_weights_q_fixed_lr5e10 81292752 changing sign of prior gradient ==> 0.9999, rmse slowly goes from 0 to 1.25
// mar20_mala_weights_q_neg_lr5e10 81292754 changing sign of gradient update (shouldn't work tho)

Now let's compare learning rate of MALA to SGLD
In Mar 13 presentation, let's try using 1e-12 learning rate
//mar20_mala_weights_q_neg_lr1e12 81292755
//mar20_mala_weights_q_lr1e12 81292758  
//mar20_mala_weights_q_fixed_lr1e12 81292756 => accept rate ~  0.999999, rmse slowly goes from 0 to 0.05


Imma needa do the fixed version of 1e2
//mar20_mala_weights_q_fixed_lr2e2 81292761 => moves too far
//mar20_mala_weights_q_fixed_lr1e2 81292762 => moves too far
//mar20_mala_weights_q_fixed_lr8e3 81292765 => moves too far
//mar20_mala_weights_q_fixed_lr9e3 81292766 => moves too far


#21 March

Calculate effective sample size
```{r}
library(coda)
```
Load data from mar20_mala_weights_q_fixed_lr1e12
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar20_mala_weights_q_fixed_lr1e12_acceptedweights__jobid_',4,'.feather')))

mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```

Load data from mar20_mala_weights_q_fixed_lr5e10
```{r}
theta.matrix2 <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar20_mala_weights_q_fixed_lr5e10_acceptedweights__jobid_',4,'.feather')))
mcmc_object2 <- as.mcmc(theta.matrix2)
ess_values2 <- effectiveSize(mcmc_object2)
summary(ess_values2)
```


Currently running
mar20_mala_weights_q_fixed_lr1e8 81299569
mar20_mala_weights_q_fixed_lr1e9 81299570
mar20_mala_weights_q_fixed_lr1e7 81299571
mar20_mala_weights_q_fixed_lr1e4 81299572 ===> acceptance 0.8
mar20_mala_weights_q_fixed_lr1e5 81299573
mar20_mala_weights_q_fixed_lr1e6 81299574 
mar20_mala_weights_q_fixed_lr1e3 81299634 ==> rate 0 
mar20_mala_weights_q_fixed_lr1e2 81299636 ==> rate 0 



Let's look at ess when there is no acceptance
mar20_mala_weights_q_fixed_lr8e3
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar20_mala_weights_q_fixed_lr8e3_acceptedweights__jobid_',2,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```


Currently running
MALA with 200 training samples
[termniated]mar21_mala_weights_sub_lr2e4 81335016
[termniated] mar21_mala_weights_sub_lr4e4 81335033
[termniated] mar21_mala_weights_sub_lr6e4 81335034
[termniated] mar21_mala_weights_sub_lr8e4 81335035

Seems like these parameters don't work, try 8e5?
//mar21_mala_weights_sub_lr8e5 81335036 => accept 0.0003
//mar21_mala_weights_sub_lr8e6 81335037 => accept 0.2         #0.192~0.216 rate 
//mar21_mala_weights_sub_lr8e7 81335052 => accept 0.852 **    #0.837~0.86 rate
//mar21_mala_weights_sub_lr8e8 81335053 => accept 0.992
//mar21_mala_weights_sub_lr3e6 81335090 => accept 0.742 *
//mar21_mala_weights_sub_lr4e6 81335099 => accept 0.45 *
//mar21_mala_weights_sub_lr2e6 81335100 => accept 0.819
//mar21_mala_weights_sub_lr35e7 81335145 => accept 0.498
[termniated] mar21_mala_weights_sub_lr33e7 81335158
[termniated] mar21_mala_weights_sub_lr34e7 81335160
[termniated] mar21_mala_weights_sub_lr32e7 81335170
//mar21_mala_weights_sub_lr31e7 81335179 => accept 0.539**    #0.512~0.55 rate

Plot the graph of lr and acceptance ration to show sensitivity
```{r}
acc.vec <- c(0.0003,0.2,.852,.992,.742,.45,.819,.498,.539)
lr.vec <- c(8e-5,8e-6,8e-7,8e-8,3e-6,4e-6,2e-6,35e-7,31e-7)

plot(x=log10(lr.vec[order(lr.vec)]),y=acc.vec[order(lr.vec)],type='b',xlab = "Learning rate (log10)", ylab="Acceptance Rate",main = "Acceptance vs Learning rate")

# scatter.smooth(x=log10(lr.vec),y=acc.vec)
```


#23 Mar
Putting in adaptive learning rate

currently running
//mar23_mala_weights_sub_adapt1 81347737
//mar23_mala_weights_sub_adapt75 81347738
//mar23_mala_weights_sub_adapt50 81347739
//mar23_mala_weights_sub_adapt25 81347740

##Look at the case with fixed lr
let's look at 
###mar21_mala_weights_sub_lr8e6 (accept 0.2)
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar21_mala_weights_sub_lr8e6_acceptedweights__jobid_',5,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```
###mar21_mala_weights_sub_lr8e7 (0.852)
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar21_mala_weights_sub_lr8e7_acceptedweights__jobid_',5,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```

###mar21_mala_weights_sub_lr35e7 (0.539)
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar21_mala_weights_sub_lr35e7_acceptedweights__jobid_',5,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```

Plotting held-in and held-out for these
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1000
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:5
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar21_mala_weights_sub_lr8e6_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:5
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar21_mala_weights_sub_lr31e7_loss__jobid_",i,".csv")))[,1:num.it]
} 
# HSP
runs4 <- 1:5
res.mat4 <- array(,dim=c(2,length(runs4),num.it))
for(i in runs4){
  res.mat4[,which(i==runs4),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar21_mala_weights_sub_lr8e7_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("MALA: lr=80e-7")
                             ,paste0("MALA: lr=31e-7"), 'MALA: lr=8e-7')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
res.iqr4 <- apply(res.mat4[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr4[2,]),col='orange',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr4[1,]),col='yellow',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr4[3,]),col='yellow',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
``` 
###Check the overall acceptance RATE in the log files. We should expect blue to be flat... tho we can kinda see that in train plot
//mar21_mala_weights_sub_lr8e6 81335037 => accept 0.2         #0.192~0.216 rate 
//mar21_mala_weights_sub_lr8e7 81335052 => accept 0.852 **    #0.837~0.86 rate 
//mar21_mala_weights_sub_lr31e7 81335179 => accept 0.539**    #0.512~0.55 rate 



#24 Mar
Check the adaptive lr
//mar23_mala_weights_sub_adapt1 81347737
//mar23_mala_weights_sub_adapt75 81347738
//mar23_mala_weights_sub_adapt50 81347739
//mar23_mala_weights_sub_adapt25 81347740
###adapt 1 
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar23_mala_weights_sub_adapt1_acceptedweights__jobid_',5,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```
###adapt 0.75
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar23_mala_weights_sub_adapt75_acceptedweights__jobid_',5,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```

###adapt 0.5
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar23_mala_weights_sub_adapt5_acceptedweights__jobid_',5,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```

###adapt 0.25 
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar23_mala_weights_sub_adapt25_acceptedweights__jobid_',5,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```




 



Theses absolutely make no differences to one another

##Let's look at how the lr is adjusting to see the effect of adaptive coef, and also look at the acceptance trajectory
I forgot to record `step.size.vec`!!!!

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1000
run.num <- 5
accvec1 <- c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar23_mala_weights_sub_adapt1_acceptedratio__jobid_",run.num,".csv")))$x
accvec2 <- c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar23_mala_weights_sub_adapt75_acceptedratio__jobid_",run.num,".csv")))$x
accvec3 <- c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar23_mala_weights_sub_adapt5_acceptedratio__jobid_",run.num,".csv")))$x
accvec4 <- c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar23_mala_weights_sub_adapt25_acceptedratio__jobid_",run.num,".csv")))$x

#define legends
leglab <- c(paste0("Smoothed learning rate"),'Pre-Smoothing learning rate')
#Train
# par(mar = c(5, 4, 4, 4) + 0.3) 
plot(x =1:num.it,y=accvec1,col='red',lwd=2, type = 'l',main = "Smoothed vs Pre-smoothing LR", ylab="Smoothed LR", xlab="Epoch")
lines(x =1:num.it,y=accvec2,col='blue')
lines(x =1:num.it,y=accvec3,col='darkgreen')
lines(x =1:num.it,y=accvec4,col='orange')


grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
# par(new = TRUE)                             # Add new plot
# prelrvec <- c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb5_gpnn_bbs_2_beta5_prelr__jobid_",runs[1],".csv")))$x
# plot(x=1:num.it,y=prelrvec,ylim=c(0,10),type='l',main = "", ylab="", xlab="",axes = FALSE,col='darkgreen')
# axis(side = 4, at = pretty(range(0:10)))      # Add second axis
# mtext("Pre-Smoothing LR", side = 4, line = 3)             # Add second axis label
legend('topright',legend = leglab,lty=c(1),col=c("red",'darkgreen'))

``` 


Currently running.... same as before, but added learning rate
mar24_mala_weights_sub_adapt1  81375697
mar24_mala_weights_sub_adapt25 81383712



Perhaps try MALA from different initial points?

#25 Mar
##Look at lr of adaptive
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1000
run.num <- 5
accvec1 <- c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar24_mala_weights_sub_adapt1_acceptedratio__jobid_",run.num,".csv")))$x
accvec2 <- c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar24_mala_weights_sub_adapt25_acceptedratio__jobid_",run.num,".csv")))$x

#define legends
leglab <- c(paste0("gamma = 1"),'gamma = 0.25')
#Train
# par(mar = c(5, 4, 4, 4) + 0.3) 
plot(x =1:num.it,y=accvec1,col='red',lwd=2, type = 'l',main = "Effect of gamma on Acceptance ratio", ylab="Acceptance Ratio", xlab="Iterations")
lines(x =1:num.it,y=accvec2,col='blue')

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
``` 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1000
run.num <- 1
accvec1 <- (c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar24_mala_weights_sub_adapt1_lr__jobid_",run.num,".csv")))$x)[1:num.it]
accvec2 <- (c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar24_mala_weights_sub_adapt25_lr__jobid_",run.num,".csv")))$x)[1:num.it]

#define legends
leglab <-c(paste0("gamma = 1"),'gamma = 0.25')
#Train
# par(mar = c(5, 4, 4, 4) + 0.3) 
plot(x =1:num.it,y=accvec1,col='red',lwd=2, type = 'l',main = "Effect of gamma on learning rate", ylab="Learning rate", xlab="Iterations")
lines(x =1:num.it,y=accvec2,col='blue')


grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2) 
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue'))
``` 

##Let's look at the final distribution of weights in adaptive 1
```{r}
for(i in 1:5){
  theta.matrix <- c(as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar24_mala_weights_sub_adapt1_acceptedweights__jobid_',i,'.feather')))[,1])
  plot(density(theta.matrix),main="Posterior density plot of theta1,1",xlim=c(-0.05,0.05))
}
```
They do not have the same dist. Potentially due to having only 1000 iterations.



Currently running
//mar29_mala_weights_sub_adapt25_V 81497786 ==> has 1mcmc sample in fast_lm
//mar29_sgld_bbs_ig_a10_b1_V 81483463 ==> SGLD with a=1e-10 and b=10 and gamma = 1,has 1mcmc sample in fast_lm =======> ACTUALLY the MAP is wrong, missing l.expan terms

//mar30_gpnnols_bb_ig_beta5_init 81518133
//mar30_gpnngpgp_bb_ig_beta5_init 81518136

#31 Mar

##Compare 2 Bayesian inference

### Within method
#### MALA
##### Looking at 1 run first

First of all, check ESS
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar29_mala_weights_sub_adapt25_V_acceptedweights__jobid_',5,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```
Seems like the ess hasn't really changed.... maybe set burnin to 1????, No but then I am not even taking the posterior mean parameters, I am only taking 1 sample
***Perhaps try adapt = 1


```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])

dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','mar29_mala_weights_sub_adapt25_V','_outpred__jobid_',5,'.feather'))))
colnames(dat.out) <- c('id','pred')
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
```
Maybe look at the min, max and see if it covers the truth
```{r}
#from chatgpt
library(dplyr)

# Group dat.out by subject_id and get the minimum and maximum of predictions
dat.out.grouped <- dat.out %>%
  group_by(id) %>%
  summarize(min_pred = min(pred), max_pred = max(pred))

# Join true.test with dat.out.grouped on subject_id
joined_data <- left_join(true.test, dat.out.grouped, by = "id")

# Add a column to specify whether the truth is within the min-max interval
joined_data <- joined_data %>%
  mutate(within_interval = ifelse(true>= min_pred & true <= max_pred, TRUE, FALSE))

# Rename columns
colnames(joined_data) <- c("subject_id", "truth", "min_pred", "max_pred", "within_interval")

# View the final table
joined_data
# sum(joined_data$within_interval)/length(joined_data$subject_id)
```
Only 65%??
Get quantile

```{r}
# Define a function to calculate percentiles
calc_percentile <- function(x, y) {
  round(sum(x <= y) / length(x) * 100)
}

# Split "predictions" column in "dat.out" by "subject_id"
pred_list <- split(dat.out$pred, dat.out$id)

# Use "sapply()" to apply the "calc_percentile()" function to each element of "pred_list"
percentiles <- sapply(names(pred_list), function(i) calc_percentile(pred_list[[i]], joined_data$truth[joined_data$subject_id==i]))

# Combine the results into a data frame
result <- data.frame(subject_id = names(percentiles), percentile = percentiles)
result$subject_id <- as.numeric(result$subject_id)

joined_data <- left_join(joined_data, result, by = "subject_id")
joined_data
```



Let's observe this for other runs
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
for(i in c(1:2,4:5)){
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','mar29_mala_weights_sub_adapt25_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  dat.out.grouped <- dat.out %>%
  group_by(id) %>%
  summarize(min_pred = min(pred), max_pred = max(pred))

  joined_data <- left_join(true.test, dat.out.grouped, by = "id")
  joined_data <- joined_data %>%
    mutate(within_interval = ifelse(true>= min_pred & true <= max_pred, TRUE, FALSE))
  colnames(joined_data) <- c("subject_id", "truth", "min_pred", "max_pred", "within_interval")
  print(paste0(" %Correct interval: ", sum(joined_data$within_interval)*100/length(joined_data$subject_id), " of Run ",i))
}
```
60-67%

We can also look at how many percentiles it takes for the truth [done]

Let's dig into subject 1676 with prediction percentile 72 on run number 5
```{r}
for(i in c(1:2,4:5)){
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','mar29_mala_weights_sub_adapt25_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  x.val <- round(dat.out$pred[dat.out$id==1676])
  breaks <- seq(min(x.val) - 0.5, max(x.val) + 0.5, by = 1)
  
  plot(hist(x.val,breaks = breaks),xlab='Outcome (Age)', main = 'Histogram of Prediction of unseen Subject #1')
  abline(v=joined_data$truth[joined_data$subject_id==1676],col='red')
}
```
Now I will try the same for sgld
####SGLD
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
for(i in c(1:2,4:5)){
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','mar29_sgld_bbs_ig_a10_b1_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  dat.out.grouped <- dat.out %>%
  group_by(id) %>%
  summarize(min_pred = min(pred), max_pred = max(pred))

  joined_data <- left_join(true.test, dat.out.grouped, by = "id")
  joined_data <- joined_data %>%
    mutate(within_interval = ifelse(true>= min_pred & true <= max_pred, TRUE, FALSE))
  colnames(joined_data) <- c("subject_id", "truth", "min_pred", "max_pred", "within_interval")
  print(paste0(" %Correct interval: ", sum(joined_data$within_interval)*100/length(joined_data$subject_id), " of Run ",i))
}
```
It's about 1.5% but this is because SGLD is very resticted, looking at it's closely, the predictions are actually supoer close to truth...

Let's dig into subject 1676 with prediction percentile 72 on run number 5
```{r}
for(i in c(1:2,4:5)){
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','mar29_sgld_bbs_ig_a10_b1_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  x.val <- round(dat.out$pred[dat.out$id==1676])
  breaks <- seq(min(x.val) - 0.5, max(x.val) + 0.5, by = 1)
  
  plot(hist(x.val,breaks = breaks))
  abline(v=joined_data$truth[joined_data$subject_id==1676],col='red')
}
```

###Compare MALA rmse and SGLD
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <- 1000
runs <- 1:5
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar29_mala_weights_sub_adapt25_V_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar29_sgld_bbs_ig_a10_b1_V_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c("MALA","SGLD")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('right',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
``` 


##Testing old code for GPNNs
Currently running
[FAILED] mar31_gpnn_4 81522309 (GPGP) TERMINATED, took too long
//mar31_gpnn_ols_2_lr5 81522311 (GP+OLS)
//mar30_gpnnols_bb_ig_beta5_init 81518133
//mar30_gpnngpgp_bb_ig_beta5_init 81518136

#1 April

Test old code vs new code
Since old GPGP took too long and was performing badly with 0 coef, let's look at gpols
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar31_gpnn_ols_2_lr5_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar30_gpnnols_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Optimisation")
                             ,paste0("SGLD:b=1e12, a=1, gamma=1")
                             ,paste0("SGLD:b=100, a=1e-11, gamma=0.55"), 'SGLD:b=10, a=1e-11, gamma=0.55')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration")
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
```
These are completely noisy....

Plot results of GPGP and GPOLS
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar30_gpnnols_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar30_gpnngpgp_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
} 

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c("Ridge+GP", "GP+OLS","GP+GP","GPR","Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```
This is not coherent to old studies...
GPGP: 4.89 (training), 5.21 (held-out) ==> Perhaps it used the wrong derivation, let's check
I am checking sigma/nnig2 and sigma/gpnnig ===> gpnngpgp but [sigma/nnig2] doesn't update sigma^2
Also gpnnig uses fast_horseshoe instead of normal AND the update of sigma is very different

Let's try gpgp with horseshoe instead
[FAILED] Currently running 13169438 in SLURM... not sure how it works... to check squeue -u qcv214

#3 April
Plot learning rate of the one that didn't work?
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-75
run.num <- 1
accvec2 <- (c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar30_gpnnols_bb_ig_beta5_init_lr__jobid_",run.num,".csv")))$x)[1:num.it]
accvec3<- (c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar30_gpnngpgp_bb_ig_beta5_init_lr__jobid_",run.num,".csv")))$x)[1:num.it]
accvec1 <- (c(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_lr__jobid_",run.num,".csv")))$x)[1:num.it]
#define legends
leglab <-c("Ridge+GP",paste0("GP+OLS"),'GP+GP')
#Train
# par(mar = c(5, 4, 4, 4) + 0.3) 
plot(x =1:num.it,y=accvec1,col='red', type = 'l',main = "BB learning rate", ylab="Learning rate", xlab="Iterations",ylim=c(0,1),lwd=1)
lines(x =1:num.it,y=accvec2,col='blue',lwd=1)
lines(x =1:num.it,y=accvec3,col='darkgreen',lwd=1)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2) 
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen'))
``` 




#3 April
After meeting with Tom
##Look at 3 ranges of theta and observe trajectory
```{r}
library(coda)
```
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar29_mala_weights_sub_adapt25_V_acceptedweights__jobid_',4,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```
with adaptive lr, accept rate = 0.574 and 1 mcmc sample from fast_normal
This gives min ess 0.452 and max 24.54, very low

Look at one with posterior mean
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar24_mala_weights_sub_adapt25_acceptedweights__jobid_',4,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```
ess 0.6885 - 21.5751
Let's look at the one with acceptance 0.2
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar21_mala_weights_sub_lr8e6_acceptedweights__jobid_',4,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```
0.8226-16.5796 ==>not any better if not worse/


Let's just focus on `mar29_mala_weights_sub_adapt25_V`
```{r}
print(paste0("Position Min: ", which.min(ess_values), "with ESS = ",ess_values[which.min(ess_values)]))
print(paste0("Position Max: ", which.max(ess_values), "with ESS = ",ess_values[which.max(ess_values)]))
print(paste0("Position Median: ", which(order(ess_values)==500), "with ESS = ",sort(ess_values)[500]))
```
Plot trajectory of min
```{r}
plot(x=1:1000,y=theta.matrix[,271],type='b',ylab= 'Theta value', xlab = 'Iteration',main = 'Tracjectory of theta 271')
```
Max
```{r}
plot(x=1:1000,y=theta.matrix[,13],type='b',ylab= 'Theta value', xlab = 'Iteration',main = 'Tracjectory of theta 13')
```
Mid
```{r}
plot(x=1:1000,y=theta.matrix[,639],type='b',ylab= 'Theta value', xlab = 'Iteration',main = 'Tracjectory of theta 639')
```

Look at the one with posterior mean
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar24_mala_weights_sub_adapt25_acceptedweights__jobid_',4,'.feather')))
mcmc_object <- as.mcmc(theta.matrix)
ess_values <- effectiveSize(mcmc_object)
print(paste0("Position Min: ", which.min(ess_values), "with ESS = ",ess_values[which.min(ess_values)]))
print(paste0("Position Max: ", which.max(ess_values), "with ESS = ",ess_values[which.max(ess_values)]))
print(paste0("Position Median: ", which(order(ess_values)==500), "with ESS = ",sort(ess_values)[500]))
```
Different position from the one without posterior mean


##Look at PPI for inclusion
First, define a MSE... should be the held-in MSE. But then held-in RMSE for MALA is large....
Let's define PPI with only held-out variance

```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
for(i in c(1:2,4:5)){
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','mar29_mala_weights_sub_adapt25_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  dat.out.grouped <- dat.out %>%
  group_by(id) %>%
  summarize(lwr_ppi = mean(pred)-1.96*sd(pred), upr_ppi = mean(pred)+1.96*sd(pred))

  joined_data <- left_join(true.test, dat.out.grouped, by = "id")
  joined_data <- joined_data %>%
    mutate(within_interval = ifelse(true>= lwr_ppi & true <= upr_ppi, TRUE, FALSE))
  colnames(joined_data) <- c("subject_id", "truth", "lwr_ppi", "upr_ppi", "within_interval")
  print(paste0(" %Correct interval: ", sum(joined_data$within_interval)*100/length(joined_data$subject_id), " of Run ",i,", Mean PPI width: ",mean(joined_data$upr_ppi - joined_data$lwr_ppi)))
}
```
If I tried inputting (approx) held-in rmse of 6.5
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
for(i in c(1:2,4:5)){
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','mar29_mala_weights_sub_adapt25_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  dat.out.grouped <- dat.out %>%
  group_by(id) %>%
  summarize(lwr_ppi = mean(pred)-1.96*sqrt(6.5^2+var(pred)), upr_ppi = mean(pred)+1.96*sqrt(6.5^2+var(pred)))

  joined_data <- left_join(true.test, dat.out.grouped, by = "id")
  joined_data <- joined_data %>%
    mutate(within_interval = ifelse(true>= lwr_ppi & true <= upr_ppi, TRUE, FALSE))
  colnames(joined_data) <- c("subject_id", "truth", "lwr_ppi", "upr_ppi", "within_interval")
  print(paste0(" %Correct interval: ", sum(joined_data$within_interval)*100/length(joined_data$subject_id), " of Run ",i,", Mean PPI width: ",mean(joined_data$upr_ppi - joined_data$lwr_ppi)))
}
```
Theoretically it makes sense???
```{r}
# Define a function to calculate percentiles
calc_percentile <- function(x, y) {
  round(sum(x <= y) / length(x) * 100)
}

# Split "predictions" column in "dat.out" by "subject_id"
pred_list <- split(dat.out$pred, dat.out$id)

# Use "sapply()" to apply the "calc_percentile()" function to each element of "pred_list"
percentiles <- sapply(names(pred_list), function(i) calc_percentile(pred_list[[i]], joined_data$truth[joined_data$subject_id==i]))

# Combine the results into a data frame
result <- data.frame(subject_id = names(percentiles), percentile = percentiles)
result$subject_id <- as.numeric(result$subject_id)

joined_data <- left_join(joined_data, result, by = "subject_id")
joined_data
```

Let's look at SGLD
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
for(i in c(1:2,4:5)){
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','mar29_sgld_bbs_ig_a10_b1_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  dat.out.grouped <- dat.out %>%
  group_by(id) %>%
  summarize(lwr_ppi = mean(pred)-1.96*sqrt(0.25^2+var(pred)), upr_ppi = mean(pred)+1.96*sqrt(0.25^2+var(pred)))

  joined_data <- left_join(true.test, dat.out.grouped, by = "id")
  joined_data <- joined_data %>%
    mutate(within_interval = ifelse(true>= lwr_ppi & true <= upr_ppi, TRUE, FALSE))
  colnames(joined_data) <- c("subject_id", "truth", "lwr_ppi", "upr_ppi", "within_interval")
  print(paste0(" %Correct interval: ", sum(joined_data$within_interval)*100/length(joined_data$subject_id), " of Run ",i,", Mean PPI width: ",mean(joined_data$upr_ppi - joined_data$lwr_ppi)))
}

# Define a function to calculate percentiles
calc_percentile <- function(x, y) {
  round(sum(x <= y) / length(x) * 100)
}

# Split "predictions" column in "dat.out" by "subject_id"
pred_list <- split(dat.out$pred, dat.out$id)

# Use "sapply()" to apply the "calc_percentile()" function to each element of "pred_list"
percentiles <- sapply(names(pred_list), function(i) calc_percentile(pred_list[[i]], joined_data$truth[joined_data$subject_id==i]))

# Combine the results into a data frame
result <- data.frame(subject_id = names(percentiles), percentile = percentiles)
result$subject_id <- as.numeric(result$subject_id)

joined_data <- left_join(joined_data, result, by = "subject_id")
joined_data
```


#5 April
Running  
[FAILED] apr4_gpnngpgpFhs_bb_ig_beta5_init 13448637_23
[FAILED] apr5_gpnngpgpFhs_bb_ig_beta5_init 13515419

Also runninng
//apr5_mala_weights_sub_adapt1_opt_V 13517000
//apr5_sgld_bbs_ig_a8_b0_V 13517879
//apr5_sgld_bb_ig_a8_b0_V 13524572



##Look at ESS for predictions
```{r}
library(coda)
library(dplyr)
```
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_mar29_mala_weights_sub_adapt25_V_outpred__jobid_',4,'.feather')))
splt <- split(theta.matrix[2,],theta.matrix[1,]) #group 2nd row based on 1st row into a list
rs <- sapply(splt, c) #This gives time x subject matrix, with colnames of the subject1
mcmc_object <- as.mcmc(rs)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```
Let's just focus on `mar29_mala_weights_sub_adapt25_V`
```{r}
print(paste0("Position Min: ", which.min(ess_values), "with ESS = ",ess_values[which.min(ess_values)]))
print(paste0("Position Max: ", which.max(ess_values), "with ESS = ",ess_values[which.max(ess_values)]))
print(paste0("Position Median: ", which(order(ess_values)==1000), "with ESS = ",sort(ess_values)[1000]))
```
Load true
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
```
Plot trajectory of 
min
```{r}
ind <- 1896
plot(x=1:1000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', ind))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
```
Max
```{r}
ind <- 1377
plot(x=1:1000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', ind))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
```
Mid
```{r}
ind <- 1272
plot(x=1:1000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', ind))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2) 
```




##Try to tune learning_rate for sgld
```{r}
lrdec <- function(start.a,start.b,start.gamma,x){start.a*(start.b+x)^(-start.gamma)}
plot(x=1:2000, log10(lrdec(1e-10,1e1,1,1:2000)),type='l',ylim=c(-17.5,-7),col = 'red',ylab = 'Learning rate (log10)',xlab='epochs')
lines(x=1:2000, log10(lrdec(1e-8,1e1,1,1:2000)),col = 'blue')
lines(x=1:2000, log10(lrdec(1e-7,1,1,1:2000)),col = 'green')
lines(x=1:1200, log10(lrdec(1e-8,1,1,1:1200)),col = 'blue')
legend('bottomleft',legend = c("SGLD:b=variable, a=1, gamma=1","SGLD:b=100, a=variable, gamma=0.55", 'SGLD:b=10, a=variable, gamma=0.55'),lty=c(1),col=c('blue','darkgreen','orange'))
```

Actually let's tune SGLD according to what i found from MALA, looking at the corr acceptance rate
//mar21_mala_weights_sub_lr8e5 81335036 => accept 0.0003
//mar21_mala_weights_sub_lr8e6 81335037 => accept 0.2         #0.192~0.216 rate 
//mar21_mala_weights_sub_lr8e7 81335052 => accept 0.852 **    #0.837~0.86 rate
//mar21_mala_weights_sub_lr8e8 81335053 => accept 0.992
//mar21_mala_weights_sub_lr3e6 81335090 => accept 0.742 *
//mar21_mala_weights_sub_lr4e6 81335099 => accept 0.45 *
//mar21_mala_weights_sub_lr2e6 81335100 => accept 0.819
//mar21_mala_weights_sub_lr35e7 81335145 => accept 0.498
//mar21_mala_weights_sub_lr31e7 81335179 => accept 0.539**    #0.512~0.55 rate

Lets's use lre8 ====> use a = 1e-8,b = 1, gamma. = 1

#9 April
//apr5_gpnngpgpFhs_bb_ig_beta5_init failed too often, so I will reduce epoch to 120
//apr6_gpnngpgpFhs_bb_ig_beta5_init 13571315

##Plot MALA long run
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_mala_weights_sub_adapt1_opt_V_outpred__jobid_',4,'.feather')))
splt <- split(theta.matrix[2,],theta.matrix[1,]) #group 2nd row based on 1st row into a list
rs <- sapply(splt, c) #This gives time x subject matrix, with colnames of the subject1
mcmc_object <- as.mcmc(rs)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```
Let's just focus on `mar29_mala_weights_sub_adapt25_V`
```{r}
print(paste0("Position Min: ", which.min(ess_values), "with ESS = ",ess_values[which.min(ess_values)]))
print(paste0("Position Max: ", which.max(ess_values), "with ESS = ",ess_values[which.max(ess_values)]))
print(paste0("Position Median: ", which(order(ess_values)==1000), "with ESS = ",sort(ess_values)[1000]))
```
Load true
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
```
Plot trajectory of 
min
```{r}
ind <- 1638
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', ind))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
```
Max
```{r}
ind <- 1944
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', ind))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
```
Mid
```{r}
ind <- 836
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', ind))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2) 
```
//apr5_sgld_bbs_ig_a8_b0_V 13517879
//apr5_sgld_bb_ig_a8_b0_V 13524572
##SGLD with higher lr
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_sgld_bbs_ig_a8_b0_V_outpred__jobid_',4,'.feather')))
splt <- split(theta.matrix[2,],theta.matrix[1,]) #group 2nd row based on 1st row into a list
rs <- sapply(splt, c) #This gives time x subject matrix, with colnames of the subject1
mcmc_object <- as.mcmc(rs)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```
```{r}
print(paste0("Position Min: ", which.min(ess_values), "with ESS = ",ess_values[which.min(ess_values)]))
print(paste0("Position Max: ", which.max(ess_values), "with ESS = ",ess_values[which.max(ess_values)]))
print(paste0("Position Median: ", which(order(ess_values)==1000), "with ESS = ",sort(ess_values)[1000]))
```
Load true
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
```
Plot trajectory of 
min
```{r}
ind <- 956
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', ind),ylim=c(min(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],min(rs[,ind])),max(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],max(rs[,ind]))))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
```
Max
```{r}
ind <- 1800
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', as.numeric(colnames(rs)[ind])),ylim=c(min(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],min(rs[,ind])),max(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],max(rs[,ind]))))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
```
Mid
```{r}
ind <- 733
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', ind),ylim=c(min(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],min(rs[,ind])),max(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],max(rs[,ind]))))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2) 
```
##SGLD starting from near P*
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_sgld_bb_ig_a8_b0_V_outpred__jobid_',4,'.feather')))
splt <- split(theta.matrix[2,],theta.matrix[1,]) #group 2nd row based on 1st row into a list
rs <- sapply(splt, c) #This gives time x subject matrix, with colnames of the subject1
mcmc_object <- as.mcmc(rs)
ess_values <- effectiveSize(mcmc_object)
summary(ess_values)
```
```{r}
print(paste0("Position Min: ", which.min(ess_values), "with ESS = ",ess_values[which.min(ess_values)]))
print(paste0("Position Max: ", which.max(ess_values), "with ESS = ",ess_values[which.max(ess_values)]))
print(paste0("Position Median: ", which(order(ess_values)==1000), "with ESS = ",sort(ess_values)[1000]))
```
Load true
```{r}
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
```
Plot trajectory of 
min
```{r}
ind <-which.min(ess_values)
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', ind),ylim=c(min(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],min(rs[,ind])),max(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],max(rs[,ind]))))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
```
Max
```{r}
ind <- which.max(ess_values)
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', ind),ylim=c(min(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],min(rs[,ind])),max(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],max(rs[,ind]))))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
```
Mid
```{r}
ind <- which(order(ess_values)==1000)
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('Tracjectory of Predictions ', ind),ylim=c(min(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],min(rs[,ind])),max(true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],max(rs[,ind]))))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2) 
```

Plot to see overall rmse

##GPNN GPGP with fast_horseshoe
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-120*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_mar30_gpnngpgp_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:2
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr6_gpnngpgpFhs_bb_ig_beta5_init_loss__jobid_",5,".csv")))[,1:num.it]
}


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c("GP+GP", "GP+GP_HS","GPR","Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(4,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```
Looks like horseshoe makes it even more unstable. 


##Plot loss
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:5
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_sgld_bbs_ig_a8_b0_V_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-1:5
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_sgld_bb_ig_a8_b0_V_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:5
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_mala_weights_sub_adapt1_opt_V_loss__jobid_",i,".csv")))[,1:num.it]
} 

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c("SGLD", "SGLD: near Mode","MALA","GPR","Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('right',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('right',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```

##ALSO NEED TO RUN LASSO OR RIDGE
###LASSO with AGE
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

hs.int<-matrix(,nrow=20,ncol=13)
failed.run <- c(3)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov14_lasso_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE",'No. Var'))
signif(colMeans(hs.int[,c(1:6,13)],3))
 library(matrixStats)
signif(sqrt(colVars(hs.int[,c(1:6,13)])),3)
```
###GPR with AGE 
Previous result
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

hs.int<-matrix(,nrow=20,ncol=13)
failed.run <- c(3)
for(i in setdiff(1:20,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE",'No. Var'))
signif(colMeans(hs.int[,c(1:6,13)],3))
 library(matrixStats)
signif(sqrt(colVars(hs.int[,c(1:6,13)])),3)
```

##Ridge with AGE
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')

hs.int<-matrix(,nrow=10,ncol=13)
failed.run <- c(90)
for(i in setdiff(1:10,failed.run)){
  hs.int[i,] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr10_ridge_noscale_",i,".csv"))))
}
hs.int <- hs.int[-failed.run,]
print(c("inR2","inMAE","outR2","outMAE","inRMSE","outRMSE",'No. Var'))
signif(colMeans(hs.int[,c(1:6,13)],3))
 library(matrixStats)
signif(sqrt(colVars(hs.int[,c(1:6,13)])),3)
```

#Compare everything against optimisation
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1000
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#lasso
runs.hs <- 1:20
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov14_lasso_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))
#ridge
runs.hs2 <- 1:10
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr10_ridge_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.25,0.5,0.75))
hs.test2 <-quantile(hs.int2[,6],c(0.25,0.5,0.75))
#gpr
runs.hs3 <- c(1,2,4:10)
hs.int3<-matrix(,nrow=length(runs.hs3),ncol=13)
for(i in runs.hs3){
  hs.int3[which(i==runs.hs3),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train3 <- quantile(hs.int3[,5],c(0.25,0.5,0.75))
hs.test3 <-quantile(hs.int3[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN: Optimisation")
                             ,paste0("LASSO")
                             ,paste0("Ridge"), 'GPR',"Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.2,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

abline(h=hs.test[2], col='blue',lwd=2)
abline(h=hs.test[1], col='blue',lwd=0.5)
abline(h=hs.test[3], col='blue',lwd=0.5)

abline(h=hs.test2[2], col='darkgreen',lwd=2)
abline(h=hs.test2[1], col='darkgreen',lwd=0.5)
abline(h=hs.test2[3], col='darkgreen',lwd=0.5)

abline(h=hs.test3[2], col='magenta',lwd=2)
abline(h=hs.test3[1], col='magenta',lwd=0.5)
abline(h=hs.test3[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

abline(h=hs.train[2], col='blue',lwd=2)
abline(h=hs.train[1], col='blue',lwd=0.5)
abline(h=hs.train[3], col='blue',lwd=0.5)

abline(h=hs.train2[2], col='darkgreen',lwd=2)
abline(h=hs.train2[1], col='darkgreen',lwd=0.5)
abline(h=hs.train2[3], col='darkgreen',lwd=0.5)

abline(h=hs.train3[2], col='magenta',lwd=2)
abline(h=hs.train3[1], col='magenta',lwd=0.5)
abline(h=hs.train3[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 
###Look at R^2
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1000
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_rsq__jobid_",i,".csv")))[,1:num.it]
 }
#lasso
runs.hs <- 1:20
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov14_lasso_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,1],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,3],c(0.25,0.5,0.75))
#ridge
runs.hs2 <- 1:10
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr10_ridge_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,1],c(0.25,0.5,0.75))
hs.test2 <-quantile(hs.int2[,3],c(0.25,0.5,0.75))
#gpr
runs.hs3 <- c(1,2,4:10)
hs.int3<-matrix(,nrow=length(runs.hs3),ncol=13)
for(i in runs.hs3){
  hs.int3[which(i==runs.hs3),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train3 <- quantile(hs.int3[,1],c(0.25,0.5,0.75))
hs.test3 <-quantile(hs.int3[,3],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("GPNN: Optimisation")
                             ,paste0("LASSO")
                             ,paste0("Ridge"), 'GPR',"Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test R^2", ylab="R^2", xlab="iteration",ylim=c(50,100))
lines(x=1:num.it,y=(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=(res.iqr[3,]),col='pink',lwd=0.5)

abline(h=hs.test[2], col='blue',lwd=2)
abline(h=hs.test[1], col='blue',lwd=0.5)
abline(h=hs.test[3], col='blue',lwd=0.5)

abline(h=hs.test2[2], col='darkgreen',lwd=2)
abline(h=hs.test2[1], col='darkgreen',lwd=0.5)
abline(h=hs.test2[3], col='darkgreen',lwd=0.5)

abline(h=hs.test3[2], col='magenta',lwd=2)
abline(h=hs.test3[1], col='magenta',lwd=0.5)
abline(h=hs.test3[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=res.iqr[2,],col='red',lwd=2, type = 'l',main = "Train R^2", ylab="R^2", xlab="iteration",ylim=c(50,100))
lines(x=1:num.it,y=res.iqr[1,],col='pink',lwd=0.5)
lines(x=1:num.it,y=(res.iqr[3,]),col='pink',lwd=0.5)

abline(h=hs.train[2], col='blue',lwd=2)
abline(h=hs.train[1], col='blue',lwd=0.5)
abline(h=hs.train[3], col='blue',lwd=0.5)

abline(h=hs.train2[2], col='darkgreen',lwd=2)
abline(h=hs.train2[1], col='darkgreen',lwd=0.5)
abline(h=hs.train2[3], col='darkgreen',lwd=0.5)

abline(h=hs.train3[2], col='magenta',lwd=2)
abline(h=hs.train3[1], col='magenta',lwd=0.5)
abline(h=hs.train3[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 


#10 Apr
run gpgp and gpols with higher num of exp
apr10_gpnngpgp_bb_ig_beta5_init 13976512
apr10_gpnnols_bb_ig_beta5_init 13976657
//ridge.R 13975852

## Let's look at posterior distribution of predictions of mala and 2 sgld
Load data
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('subject_id','truth')

#Get index of actual subject id
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_mala_weights_sub_adapt1_opt_V_outpred__jobid_',4,'.feather')))
splt <- split(theta.matrix[2,],theta.matrix[1,]) #group 2nd row based on 1st row into a list
rs <- sapply(splt, c) #This gives time x subject matrix, with colnames of the subject1

as.numeric(colnames(rs)[1944])
```

```{r}
for(i in c(1:4)){
  id <- 4136
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','apr5_mala_weights_sub_adapt1_opt_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  x.val <- round(dat.out$pred[dat.out$id==id])
  breaks <- seq(min(x.val) - 0.5, max(x.val) + 0.5, by = 1)
  
  plot(hist(x.val,breaks = breaks),xlab='Outcome (Age)', main = 'Histogram of Prediction of unseen subject (MALA)')
  abline(v=true.test$truth[true.test$subject_id==id],col='red')
}
```

MALA from last time
```{r}
for(i in c(1:2,4:5)){
  id <- 1676
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','apr5_mala_weights_sub_adapt1_opt_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  x.val <- round(dat.out$pred[dat.out$id==id])
  breaks <- seq(min(x.val) - 0.5, max(x.val) + 0.5, by = 1)
  
  plot(hist(x.val,breaks = breaks),xlab='Outcome (Age)', main = 'Histogram of Prediction of unseen subject (MALA)')
  abline(v=true.test$truth[true.test$subject_id==id],col='red')
}
```


```{r}
for(i in c(1:4)){
  id <- 3790
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','apr5_sgld_bbs_ig_a8_b0_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  x.val <- round(dat.out$pred[dat.out$id==id])
  breaks <- seq(min(x.val) - 0.5, max(x.val) + 0.5, by = 1)
  
  plot(hist(x.val,breaks = breaks),xlab='Outcome (Age)', main = 'Histogram of Prediction of unseen subject (SGLD:Posterior Mode)')
  abline(v=true.test$truth[true.test$subject_id==id],col='red')
}
```

```{r}
for(i in c(1:4)){
  id <- 2429
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','apr5_sgld_bb_ig_a8_b0_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  x.val <- round(dat.out$pred[dat.out$id==id])
  breaks <- seq(min(x.val) - 0.5, max(x.val) + 0.5, by = 1)
  
  plot(hist(x.val,breaks = breaks),xlab='Outcome (Age)', main = 'Histogram of Prediction of unseen subject (SGLD:Near Mode)')
  abline(v=true.test$truth[true.test$subject_id==id],col='red')
}
```

#12 April

Currently running gpr
// re_apr12_gpr 14218172
[Failed, got cancelled] apr12_sgld_bb_ig_a8_b0_V 14272644 ==> various starting point

#13 April

##GPR 10 deg vs 40 deg
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1000
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#lasso
runs.hs <- 1:20
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov14_lasso_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))
#ridge
runs.hs2 <- 1:10
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr10_ridge_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.25,0.5,0.75))
hs.test2 <-quantile(hs.int2[,6],c(0.25,0.5,0.75))
#gpr
runs.hs3 <- c(1,2,4:10)
hs.int3<-matrix(,nrow=length(runs.hs3),ncol=13)
for(i in runs.hs3){
  hs.int3[which(i==runs.hs3),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train3 <- quantile(hs.int3[,5],c(0.25,0.5,0.75))
hs.test3 <-quantile(hs.int3[,6],c(0.25,0.5,0.75))

runs.hs4 <- c(1:10)
hs.int4<-matrix(,nrow=length(runs.hs4),ncol=13)
for(i in runs.hs4){
  hs.int4[which(i==runs.hs4),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr12_gpr_noscale_",i,".csv"))))
}
hs.train4 <- quantile(hs.int4[,5],c(0.25,0.5,0.75))
hs.test4 <-quantile(hs.int4[,6],c(0.25,0.5,0.75))


#define legends
leglab <- c(paste0("GPNN: Optimisation")
                             ,paste0("LASSO")
                             ,paste0("Ridge"), 'GPR_10','GPR_40',"Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.2,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

abline(h=hs.test[2], col='blue',lwd=2)
abline(h=hs.test[1], col='blue',lwd=0.5)
abline(h=hs.test[3], col='blue',lwd=0.5)

abline(h=hs.test2[2], col='darkgreen',lwd=2)
abline(h=hs.test2[1], col='darkgreen',lwd=0.5)
abline(h=hs.test2[3], col='darkgreen',lwd=0.5)

abline(h=hs.test3[2], col='magenta',lwd=2)
abline(h=hs.test3[1], col='magenta',lwd=0.5)
abline(h=hs.test3[3], col='magenta',lwd=0.5)

abline(h=hs.test4[2], col='orange',lwd=2)
abline(h=hs.test4[1], col='orange',lwd=0.5)
abline(h=hs.test4[3], col='orange',lwd=0.5)

abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','orange','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

abline(h=hs.train[2], col='blue',lwd=2)
abline(h=hs.train[1], col='blue',lwd=0.5)
abline(h=hs.train[3], col='blue',lwd=0.5)

abline(h=hs.train2[2], col='darkgreen',lwd=2)
abline(h=hs.train2[1], col='darkgreen',lwd=0.5)
abline(h=hs.train2[3], col='darkgreen',lwd=0.5)

abline(h=hs.train3[2], col='magenta',lwd=2)
abline(h=hs.train3[1], col='magenta',lwd=0.5)
abline(h=hs.train3[3], col='magenta',lwd=0.5)

abline(h=hs.train4[2], col='orange',lwd=2)
abline(h=hs.train4[1], col='orange',lwd=0.5)
abline(h=hs.train4[3], col='orange',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','orange','black'))
``` 
I see a decrease in train RMSE but increase in test rmse in gpr 10 and 40, 
I will try gpr 20 to see if it has similar effect

Currently running gpr
// re_apr13_gpr 14274810



##Look at ESS of 1177
Load true
```{r}
library(coda)
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
```
###Plot MALA long run
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_mala_weights_sub_adapt1_opt_V_outpred__jobid_',4,'.feather')))
splt <- split(theta.matrix[2,],theta.matrix[1,]) #group 2nd row based on 1st row into a list
rs <- sapply(splt, c) #This gives time x subject matrix, with colnames of the subject1
mcmc_object <- as.mcmc(rs)
ess_values <- effectiveSize(mcmc_object)
```
Plot trajectory of 
```{r}
ind <- 1177
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('MALA Tracjectory of Predictions ', ind, ", ESS = ",round(ess_values[ind])))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
```

###SGLD
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_sgld_bbs_ig_a8_b0_V_outpred__jobid_',4,'.feather')))
splt <- split(theta.matrix[2,],theta.matrix[1,]) #group 2nd row based on 1st row into a list
rs <- sapply(splt, c) #This gives time x subject matrix, with colnames of the subject1
mcmc_object <- as.mcmc(rs)
ess_values <- effectiveSize(mcmc_object)
```
Plot trajectory of 
```{r}
ind <- 1177
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('SGLD Tracjectory of Predictions ', ind, ", ESS = ",round(ess_values[ind])))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
```

###SGLD near
```{r}
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_sgld_bb_ig_a8_b0_V_outpred__jobid_',4,'.feather')))
splt <- split(theta.matrix[2,],theta.matrix[1,]) #group 2nd row based on 1st row into a list
rs <- sapply(splt, c) #This gives time x subject matrix, with colnames of the subject1
mcmc_object <- as.mcmc(rs)
ess_values <- effectiveSize(mcmc_object)
```
Plot trajectory of 
```{r}
ind <- 1177
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('SGLD_near mode Tracjectory of Predictions ', ind, ", ESS = ",round(ess_values[ind])))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
```


##Look at last 1000 preds for MALA to see convergent

Load data and MALA from last time
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('subject_id','truth')


for(i in c(1:2,4:5)){
  id <- 1676
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','apr5_mala_weights_sub_adapt1_opt_V','_outpred__jobid_',i,'.feather'))))
  dat.out <- tail(dat.out,nrow(dat.out)/2)
  colnames(dat.out) <- c('id','pred')
  x.val <- round(dat.out$pred[dat.out$id==id])
  breaks <- seq(min(x.val) - 0.5, max(x.val) + 0.5, by = 1)
  
  plot(hist(x.val,breaks = breaks),xlab='Outcome (Age)', main = 'Histogram of Prediction of unseen subject (MALA)')
  abline(v=true.test$truth[true.test$subject_id==id],col='red')
}
```

#14 April
Currently running
[wrong saliency] apr14_gpnn_bb_ig_init_ext_bbs_test  14423692 ==> to get saliency 
[no sal]//apr14_gpnngpgp_bb_ig_beta5_init 14447543 ===> fix initialisation of theta from 500 to 0, add saliency
[no sal and min]//apr14_gpnnols_bb_ig_beta5_init 14447565 ===> fix initialisation of theta from 500 to 0, add saliency
//apr14_gpnngpgp_bb_ig_beta5_init_c 14435839 ===> Testing combine gpgp ===> this gives dim (7549773x12)
//apr14_gpnngpgp_bb_ig_beta5_init_c 14459903 ==> FAILED but I fix it



#15 Apri
//apr15_gpnn_bb_ig_init_ext_bbs_test 14610296 ==> to get saliency 
//apr15_gpnngpgp_bb_ig_beta5_init 14610317 ===> fix saliency
//apr15_gpnnols_bb_ig_beta5_init  14610894 ===> fix saliency AND record minimum
//apr15_gpnngpgp_bb_ig_beta5_init_ext_bbs 14611316 ===> ext gpgp bb to bbs from apr14


##Plot rmse of GPGP and OLS
init at 0
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-150*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(4,5,7,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr14_gpnngpgp_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- c(2:4,6:10)
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr14_gpnnols_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
} 

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c("Ridge+GP", "GP+OLS","GP+GP","GPR","Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```

##look at the min of gpgp
```{r}
runs <- c(4,5,7,8,9)
res1 <- vector(mode = 'numeric')
# res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr14_gpnngpgp_bb_ig_beta5_init_minloss__jobid_",i,".csv"))$x)
  # res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_minloss__jobid_",i,".csv"))$x)
}
runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

plot(x=runs, y= sqrt(res1), col='blue',lwd=2, type = 'b',main = "Minimum Test RMSE across 2,000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
# lines(x = runs,y=sqrt(res2),col='darkgreen',lwd=2, type = 'b')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('BB','BB IG','GPR', 'response sd'),lty=c(1),col=c('blue','darkgreen','magenta','black'))
```
#20 April
//apr15_gpnn_bb_ig_init_ext_bbs_test 14610296 ==> to get saliency 
//apr15_gpnngpgp_bb_ig_beta5_init 14610317 ===> fix saliency
//apr15_gpnnols_bb_ig_beta5_init  14610894 ===> fix saliency AND record minimum
[FAILED] apr15_gpnngpgp_bb_ig_beta5_init_ext_bbs 14611316 ===> ext gpgp bb to bbs from apr14


##look at the min of gp ols
```{r}
runs <- 2:10
res1 <- vector(mode = 'numeric')
# res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr15_gpnnols_bb_ig_beta5_init_minloss__jobid_",i,".csv"))$x)
  # res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_minloss__jobid_",i,".csv"))$x)
}
runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

plot(x=runs, y= sqrt(res1), col='blue',lwd=2, type = 'b',main = "Minimum Test RMSE across 2,000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
# lines(x = runs,y=sqrt(res2),col='darkgreen',lwd=2, type = 'b')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('BB','BB IG','GPR', 'response sd'),lty=c(1),col=c('blue','darkgreen','magenta','black'))
```
Currently running 
//apr15_gpnngpgp_bb_ig_beta5_init_ext_bbs 15024277 ===> ext gpgp bb to bbs from apr14
//apr20_gpnnols_bb_ig_beta5_init_ext_bbs 15023315
//apr22_sgld_bb_ig_a8_b0_V 15160089 ==> sgld various initial points

#23 Apr
Plot bbs of gpgp, gpols
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-150
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(1:4,8,9)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr15_gpnngpgp_bb_ig_beta5_init_ext_bbs_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr20_gpnnols_bb_ig_beta5_init_ext_bbs_loss__jobid_",i,".csv")))[,1:num.it]
} 


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Ridge+GP")
                             ,paste0("GP+GP")
                             ,paste0("GP+OLS"), 'GPR','Noise')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 
It doesn't coverge to 0

##SGLD from different points
Load data
```{r}
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('subject_id','truth')

#Get index of actual subject id
theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_mala_weights_sub_adapt1_opt_V_outpred__jobid_',4,'.feather')))
splt <- split(theta.matrix[2,],theta.matrix[1,]) #group 2nd row based on 1st row into a list
rs <- sapply(splt, c) #This gives time x subject matrix, with colnames of the subject1

# as.numeric(colnames(rs)[1944])
```
SGLD near mode, varying initial points
```{r}
for(i in c(1,3,4,6)){
  id <- 1676 #Same as 
  dat.out <- as.data.frame(t(read_feather(paste0('/well/nichols/users/qcv214/bnn2/res3/pile/re_','apr22_sgld_bb_ig_a8_b0_V','_outpred__jobid_',i,'.feather'))))
  colnames(dat.out) <- c('id','pred')
  x.val <- round(dat.out$pred[dat.out$id==id])
  breaks <- seq(min(x.val) - 0.5, max(x.val) + 0.5, by = 1)
  
  plot(hist(x.val,breaks = breaks),xlab='Outcome (Age)', main = 'Histogram of Prediction of unseen subject (SGLD:Near Mode)')
  abline(v=true.test$truth[true.test$subject_id==id],col='red')
}
```
Look at ESS
##Look at ESS of 1177
Load true
```{r}
library(coda)
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')
```

###SGLD near
```{r}
for(i in c(1,3,4,6)){
  theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_apr22_sgld_bb_ig_a8_b0_V_outpred__jobid_',i,'.feather')))
  splt <- split(theta.matrix[2,],theta.matrix[1,]) #group 2nd row based on 1st row into a list
  rs <- sapply(splt, c) #This gives time x subject matrix, with colnames of the subject1
  mcmc_object <- as.mcmc(rs)
  ess_values <- effectiveSize(mcmc_object)
ind <- 1177
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('SGLD_near mode Tracjectory of Predictions ', ind, ", ESS = ",round(ess_values[ind])))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
}
plot(x=1:2000,y=rs[,ind],type='b',ylim=c(71,73.5),ylab= 'Predictions', xlab = 'Iteration',main = paste0('SGLD_near mode Tracjectory of Predictions ', ind, ", ESS = ",round(ess_values[ind])))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)

```

##Look at ESS of 1177, same init for sgld near
Load true
```{r}
library(coda)
age_tab<-read_feather('/well/nichols/users/qcv214/bnn2/res3/age.feather')
age_tab <- age_tab[order(age_tab$id),]
age <- age_tab$age
ind.temp <- read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/sim_wb2_index_",4,".csv"))
train.test.ind <- list()
train.test.ind$test <-  unlist(ind.temp[2,])
train.test.ind$train <-  unlist(ind.temp[1,])
test.true <- age[train.test.ind$test]
true.test<- data.frame(train.test.ind$test,test.true,row.names = NULL)
colnames(true.test) <- c('id','true')

for(i in c(1:4)){
  theta.matrix <- as.matrix(read_feather(paste0( '/well/nichols/users/qcv214/bnn2/res3/pile/re_apr5_sgld_bb_ig_a8_b0_V_outpred__jobid_',i,'.feather')))
  splt <- split(theta.matrix[2,],theta.matrix[1,]) #group 2nd row based on 1st row into a list
  rs <- sapply(splt, c) #This gives time x subject matrix, with colnames of the subject1
  mcmc_object <- as.mcmc(rs)
  ess_values <- effectiveSize(mcmc_object)
ind <- 1177
plot(x=1:2000,y=rs[,ind],type='b',ylab= 'Predictions', xlab = 'Iteration',main = paste0('SGLD_near mode Tracjectory of Predictions ', ind, ", ESS = ",round(ess_values[ind])))
abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)
}
# plot(x=1:2000,y=rs[,ind],type='b',ylim=c(71,73.5),ylab= 'Predictions', xlab = 'Iteration',main = paste0('SGLD_near mode Tracjectory of Predictions ', ind, ", ESS = ",round(ess_values[ind])))
# abline(h= true.test[true.test$id == as.numeric(colnames(rs)[ind]),2],col='red',lwd=2)

```

Currently running 
//apr23_gpnngpgp_bb_ig_beta5_init_c. 15230396 ====> optimised in terms of dat x expansion. ==> 500 epochs
Compare the output to normal gpgp, AND the improvement in computations
It takes 10 seconds to run each epoch.... for 7 out of 10 runs, other 3 took 1 min

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-150*4
runs <- 1:9
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr15_gpnngpgp_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr23_gpnngpgp_bb_ig_beta5_init_c_loss__jobid_",i,".csv")))[,1:num.it]
}

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c("GP+GP1", "GP+GP2","GPR","Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```
Compare the 500 epochs to ridge + gp
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr23_gpnngpgp_bb_ig_beta5_init_c_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c("Ridge+GP","GP+GP","GPR","Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```

Let's look at minimum
Do the same for GP + OLS then

Currently running
apr24_gpnngpgp_bb_ig_beta5_init_c 15236197  ==> 1,000 epochs
apr24_gpnnols_bb_ig_beta5_init_com  15236208 ==> 1,000 epochs


##look at the min of gpgp
```{r}
runs <- c(4,5,6,7,8)
res1 <- vector(mode = 'numeric')
# res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr24_gpnngpgp_bb_ig_beta5_init_c_minloss__jobid_",i,".csv"))$x)
  # res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_minloss__jobid_",i,".csv"))$x)
}
runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

plot(x=runs, y= sqrt(res1), col='blue',lwd=2, type = 'b',main = "Minimum Test RMSE across 2,000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
# lines(x = runs,y=sqrt(res2),col='darkgreen',lwd=2, type = 'b')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('BB','BB IG','GPR', 'response sd'),lty=c(1),col=c('blue','darkgreen','magenta','black'))
```

##look at the min of gp ols
```{r}
runs <- 2:6
res1 <- vector(mode = 'numeric')
# res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr24_gpnnols_bb_ig_beta5_init_com_minloss__jobid_",i,".csv"))$x)
  # res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_minloss__jobid_",i,".csv"))$x)
}
runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

plot(x=runs, y= sqrt(res1), col='blue',lwd=2, type = 'b',main = "Minimum Test RMSE across 2,000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
# lines(x = runs,y=sqrt(res2),col='darkgreen',lwd=2, type = 'b')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('BB','BB IG','GPR', 'response sd'),lty=c(1),col=c('blue','darkgreen','magenta','black'))
```

Currently ruynning
//apr24_gpnngpgp_bbig_init_ext_bbs_c 15246037
//apr24_gpnnols_bbig_init_ext_bbs_c 15246040
//ridgr apr25  15271571
//lasso apr25 15272934


#25 April

##BBS 
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-1000*4
runs <- c(2:4,7,10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr24_gpnngpgp_bbig_init_ext_bbs_c_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- 1:10
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr24_gpnnols_bbig_init_ext_bbs_c_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c("GP+GP","GP+OLS","GPR","Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','magenta','black'))
```
With Ridge + GP
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <- c(2:4,7,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr24_gpnngpgp_bbig_init_ext_bbs_c_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr24_gpnnols_bbig_init_ext_bbs_c_loss__jobid_",i,".csv")))[,1:num.it]
} 


runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c(paste0("Ridge+GP")
                             ,paste0("GP+GP")
                             ,paste0("GP+OLS"), 'GPR','Noise')

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,7))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)
res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('bottomright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
``` 






##Ridge and LASSO

```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-2000
runs <- c(1:4,7:10)
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb27_gpnn_bb_ig_init_ext_bbs_test_loss__jobid_",i,".csv")))[,1:num.it]
 }
#lasso
runs.hs <- 1:20
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_nov14_lasso_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))
#ridge
runs.hs2 <- 1:10
hs.int2<-matrix(,nrow=length(runs.hs2),ncol=13)
for(i in runs.hs2){
  hs.int2[which(i==runs.hs2),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr10_ridge_noscale_",i,".csv"))))
}
hs.train2 <- quantile(hs.int2[,5],c(0.25,0.5,0.75))
hs.test2 <-quantile(hs.int2[,6],c(0.25,0.5,0.75))
#gpr
runs.hs3 <- c(1,2,4:10)
hs.int3<-matrix(,nrow=length(runs.hs3),ncol=13)
for(i in runs.hs3){
  hs.int3[which(i==runs.hs3),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr25_lasso_noscale_",i,".csv"))))
}
hs.train3 <- quantile(hs.int3[,5],c(0.25,0.5,0.75))
hs.test3 <-quantile(hs.int3[,6],c(0.25,0.5,0.75))

runs.hs4 <- c(1:10)
hs.int4<-matrix(,nrow=length(runs.hs4),ncol=13)
for(i in runs.hs4){
  hs.int4[which(i==runs.hs4),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr25_ridge_noscale_",i,".csv"))))
}
hs.train4 <- quantile(hs.int4[,5],c(0.25,0.5,0.75))
hs.test4 <-quantile(hs.int4[,6],c(0.25,0.5,0.75))


#define legends
leglab <- c(paste0("GPNN: Optimisation")
                             ,paste0("LASSO")
                             ,paste0("Ridge"), 'LASSO_N','Ridge_N',"Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.2,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

abline(h=hs.test[2], col='blue',lwd=2)
abline(h=hs.test[1], col='blue',lwd=0.5)
abline(h=hs.test[3], col='blue',lwd=0.5)

abline(h=hs.test2[2], col='darkgreen',lwd=2)
abline(h=hs.test2[1], col='darkgreen',lwd=0.5)
abline(h=hs.test2[3], col='darkgreen',lwd=0.5)

abline(h=hs.test3[2], col='magenta',lwd=2)
abline(h=hs.test3[1], col='magenta',lwd=0.5)
abline(h=hs.test3[3], col='magenta',lwd=0.5)

abline(h=hs.test4[2], col='orange',lwd=2)
abline(h=hs.test4[1], col='orange',lwd=0.5)
abline(h=hs.test4[3], col='orange',lwd=0.5)

abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','orange','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)

abline(h=hs.train[2], col='blue',lwd=2)
abline(h=hs.train[1], col='blue',lwd=0.5)
abline(h=hs.train[3], col='blue',lwd=0.5)

abline(h=hs.train2[2], col='darkgreen',lwd=2)
abline(h=hs.train2[1], col='darkgreen',lwd=0.5)
abline(h=hs.train2[3], col='darkgreen',lwd=0.5)

abline(h=hs.train3[2], col='magenta',lwd=2)
abline(h=hs.train3[1], col='magenta',lwd=0.5)
abline(h=hs.train3[3], col='magenta',lwd=0.5)

abline(h=hs.train4[2], col='orange',lwd=2)
abline(h=hs.train4[1], col='orange',lwd=0.5)
abline(h=hs.train4[3], col='orange',lwd=0.5)

grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','orange','black'))
``` 




#26 Apr
Currently running
Standardisation
//apr26_gpnngpgp_beta5_init_s 15302204
//apr26_gpnnols_beta5_init_s 15302237
apr26_gpnn_beta5_init_s 15309987
SGLD with 200
apr26_sgld_bb_ig_a7_b0_V_200 15311214
apr26_sgld_bb_ig_a6_b0_V_200 15311249

apr26_gpgp_init_ext_bbs_s. 15327286
apr26_ols_init_ext_bbs_s.  15327277

Perhaps try looking at the gradient noise in sgld?

##Look at Standardised gpgp and ols
```{r}
#IG with alpha = 6 and initialisation with mean
num.it <-500*4
runs <- 1:10
res.mat <- array(,dim=c(2,length(runs),num.it))
for(i in runs){
  res.mat[,which(i==runs),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_loss__jobid_",i,".csv")))[,1:num.it]
 }
#GPNN adj
runs2 <-c(2,3,8,10)
res.mat2 <- array(,dim=c(2,length(runs2),num.it))
for(i in runs2){
  res.mat2[,which(i==runs2),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr26_gpnngpgp_beta5_init_s_loss__jobid_",i,".csv")))[,1:num.it]
}
#SGD
runs3 <- 1:10
res.mat3 <- array(,dim=c(2,length(runs3),num.it))
for(i in runs3){
  res.mat3[,which(i==runs3),] <- as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr26_gpnnols_beta5_init_s_loss__jobid_",i,".csv")))[,1:num.it]
} 

runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

#define legends
leglab <- c("Ridge+GP", "GP+OLS","GP+GP","GPR","Data Noise")

#Test
res.iqr <- apply(res.mat[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x=1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Test RMSE", ylab="RMSE", xlab="iteration",ylim=c(4.565,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[2,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=1, type = 'l',lty=2)
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)
legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','orange','magenta','black'))
 
#Train
res.iqr <- apply(res.mat[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
plot(x =1:num.it,y=sqrt(res.iqr[2,]),col='red',lwd=2, type = 'l',main = "Train RMSE", ylab="RMSE", xlab="iteration",ylim=c(0,8))
lines(x=1:num.it,y=sqrt(res.iqr[1,]),col='pink',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr[3,]),col='pink',lwd=0.5)
res.iqr2 <- apply(res.mat2[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x = 1:num.it,y=sqrt(res.iqr2[2,]),col='blue',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr2[1,]),col='lightblue',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr2[3,]),col='lightblue',lwd=0.5)

res.iqr3 <- apply(res.mat3[1,,], MARGIN = 2, FUN = quantile, probs= c(0.25,0.5,0.75))
lines(x =1:num.it,y=sqrt(res.iqr3[2,]),col='darkgreen',lwd=2, type = 'l')
lines(x=1:num.it,y=sqrt(res.iqr3[1,]),col='green',lwd=0.5)
lines(x=1:num.it,y=sqrt(res.iqr3[3,]),col='green',lwd=0.5)
abline(h=hs.train[2], col='magenta',lwd=2)
abline(h=hs.train[1], col='magenta',lwd=0.5)
abline(h=hs.train[3], col='magenta',lwd=0.5)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
abline(h=5.904118, lwd = 2)

legend('topright',legend = leglab,lty=c(1),col=c("red",'blue','darkgreen','magenta','black'))
```
Min loss
```{r}
runs <- c(2,3,8,10)
res1 <- vector(mode = 'numeric')
# res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr26_gpnngpgp_beta5_init_s_minloss__jobid_",i,".csv"))$x)
  # res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_minloss__jobid_",i,".csv"))$x)
}
runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

plot(x=runs, y= sqrt(res1), col='blue',lwd=2, type = 'b',main = "Minimum Test RMSE across 2,000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
# lines(x = runs,y=sqrt(res2),col='darkgreen',lwd=2, type = 'b')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('BB','BB IG','GPR', 'response sd'),lty=c(1),col=c('blue','darkgreen','magenta','black'))
```
10
```{r}
runs <- 1:10
res1 <- vector(mode = 'numeric')
# res2 <- vector(mode = 'numeric')
for (i in runs){ 
  res1 <- c(res1,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_apr26_gpnnols_beta5_init_s_minloss__jobid_",i,".csv"))$x)
  # res2 <- c(res2,read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_feb9_gpnn_bb_ig_beta5_init_minloss__jobid_",i,".csv"))$x)
}
runs.hs <- c(1,2,4:10)
hs.int<-matrix(,nrow=length(runs.hs),ncol=13)
for(i in runs.hs){
  hs.int[which(i==runs.hs),] <- t(as.matrix(read.csv(paste0("/well/nichols/users/qcv214/bnn2/res3/pile/re_aug16_gpr_noscale_",i,".csv"))))
}
hs.train <- quantile(hs.int[,5],c(0.25,0.5,0.75))
hs.test <-quantile(hs.int[,6],c(0.25,0.5,0.75))

plot(x=runs, y= sqrt(res1), col='blue',lwd=2, type = 'b',main = "Minimum Test RMSE across 2,000 iterations", ylab="RMSE", xlab="Run Number",ylim=c(4,8))
# lines(x = runs,y=sqrt(res2),col='darkgreen',lwd=2, type = 'b')
abline(h=hs.test[2], col='magenta',lwd=2)
abline(h=hs.test[1], col='magenta',lwd=0.5)
abline(h=hs.test[3], col='magenta',lwd=0.5)
abline(h=6.035854, lwd = 2)
grid(nx = NULL, ny = NULL,lty = 2,  col = "gray",lwd = 2)   
legend('topright',legend = c('BB','BB IG','GPR', 'response sd'),lty=c(1),col=c('blue','darkgreen','magenta','black'))
```



